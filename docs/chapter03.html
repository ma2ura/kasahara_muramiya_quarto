<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Soichi Matsuura">
<title>3&nbsp; R言語入門 – 実証会計・ファイナンスの勉強ノート</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter04.html" rel="next">
<link href="./chapter02.html" rel="prev">
<link href="./img/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-0907bcc31431a373ae96853dfe16c1d2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-9b98439fbe4ae1eb56616ecad9777bd3.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-0907bcc31431a373ae96853dfe16c1d2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SFB56VHK63"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SFB56VHK63', { 'anonymize_ip': true});
</script><style>
.marky {
  background: linear-gradient(transparent 60%, #FCFFC1 0%);
}
.markb {
  background: linear-gradient(transparent 60%, #88E2EA 0%);
}
.markp{
  background: linear-gradient(transparent 70%, #ffcdd2 0%)
}
</style>
<script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">
<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta name="twitter:title" content="3&nbsp; R言語入門 – 実証会計・ファイナンスの勉強ノート">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="chapter03_files/figure-html/unnamed-chunk-13-1.png">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-sidebar docked slimcontent quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter03.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R言語入門</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">実証会計・ファイナンスの勉強ノート</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">はじめに</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">ファイナンス入門</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter03.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R言語入門</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">財務データの取得と可視化</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">株式データの取得と可視化</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">ファクターモデルの導入</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#r%E3%81%AE%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E6%A9%9F%E8%83%BD" id="toc-rの基本的な機能" class="nav-link active" data-scroll-target="#r%E3%81%AE%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E6%A9%9F%E8%83%BD"><span class="header-section-number">3.1</span> Rの基本的な機能</a>
  <ul class="collapse">
<li><a href="#%E3%82%B9%E3%82%AB%E3%83%A9%E3%83%BC%E5%A4%89%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9" id="toc-スカラー変数の定義" class="nav-link" data-scroll-target="#%E3%82%B9%E3%82%AB%E3%83%A9%E3%83%BC%E5%A4%89%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9"><span class="header-section-number">3.1.1</span> スカラー変数の定義</a></li>
  <li><a href="#%E3%83%99%E3%82%AF%E3%83%88%E3%83%AB%E5%A4%89%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9" id="toc-ベクトル変数の定義" class="nav-link" data-scroll-target="#%E3%83%99%E3%82%AF%E3%83%88%E3%83%AB%E5%A4%89%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9"><span class="header-section-number">3.1.2</span> ベクトル変数の定義</a></li>
  <li><a href="#%E5%9F%BA%E6%9C%AC%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8plot%E3%81%AB%E3%82%88%E3%82%8B%E4%BD%9C%E5%9B%B3" id="toc-基本パッケージplotによる作図" class="nav-link" data-scroll-target="#%E5%9F%BA%E6%9C%AC%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8plot%E3%81%AB%E3%82%88%E3%82%8B%E4%BD%9C%E5%9B%B3"><span class="header-section-number">3.1.3</span> 基本パッケージ<code>plot</code>による作図</a></li>
  </ul>
</li>
  <li>
<a href="#for%E6%96%87%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9" id="toc-for文の使い方" class="nav-link" data-scroll-target="#for%E6%96%87%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9"><span class="header-section-number">3.2</span> <code>for</code>文の使い方</a>
  <ul class="collapse">
<li><a href="#if%E6%96%87" id="toc-if文" class="nav-link" data-scroll-target="#if%E6%96%87"><span class="header-section-number">3.2.1</span> <code>if</code>文</a></li>
  </ul>
</li>
  <li><a href="#npv%E3%81%A8%E5%89%B2%E5%BC%95%E7%8E%87%E3%81%AE%E9%96%A2%E4%BF%82%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96" id="toc-npvと割引率の関係の可視化" class="nav-link" data-scroll-target="#npv%E3%81%A8%E5%89%B2%E5%BC%95%E7%8E%87%E3%81%AE%E9%96%A2%E4%BF%82%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96"><span class="header-section-number">3.3</span> NPVと割引率の関係の可視化</a></li>
  <li><a href="#%E7%8B%AC%E8%87%AA%E9%96%A2%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9%E3%81%AE%E4%BB%95%E6%96%B9" id="toc-独自関数の定義の仕方" class="nav-link" data-scroll-target="#%E7%8B%AC%E8%87%AA%E9%96%A2%E6%95%B0%E3%81%AE%E5%AE%9A%E7%BE%A9%E3%81%AE%E4%BB%95%E6%96%B9"><span class="header-section-number">3.4</span> 独自関数の定義の仕方</a></li>
  <li><a href="#%E6%BC%94%E7%BF%92" id="toc-演習" class="nav-link" data-scroll-target="#%E6%BC%94%E7%BF%92"><span class="header-section-number">3.5</span> 演習</a></li>
  <li>
<a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E5%85%A5%E9%96%80" id="toc-データフレーム入門" class="nav-link" data-scroll-target="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E5%85%A5%E9%96%80"><span class="header-section-number">3.6</span> データフレーム入門</a>
  <ul class="collapse">
<li><a href="#csv%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF" id="toc-csvファイルの読み込み" class="nav-link" data-scroll-target="#csv%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><span class="header-section-number">3.6.1</span> CSVファイルの読み込み</a></li>
  </ul>
</li>
  <li>
<a href="#%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E5%9E%8B%E3%81%A8%E6%97%A5%E4%BB%98%E5%9E%8B" id="toc-ファクター型と日付型" class="nav-link" data-scroll-target="#%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E5%9E%8B%E3%81%A8%E6%97%A5%E4%BB%98%E5%9E%8B"><span class="header-section-number">3.7</span> ファクター型と日付型</a>
  <ul class="collapse">
<li><a href="#%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E5%9E%8B%E5%85%A5%E9%96%80" id="toc-ファクター型入門" class="nav-link" data-scroll-target="#%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E5%9E%8B%E5%85%A5%E9%96%80"><span class="header-section-number">3.7.1</span> ファクター型入門</a></li>
  <li><a href="#%E6%97%A5%E4%BB%98%E5%9E%8B%E5%85%A5%E9%96%80" id="toc-日付型入門" class="nav-link" data-scroll-target="#%E6%97%A5%E4%BB%98%E5%9E%8B%E5%85%A5%E9%96%80"><span class="header-section-number">3.7.2</span> 日付型入門</a></li>
  </ul>
</li>
  <li><a href="#%E5%A4%96%E9%83%A8%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8" id="toc-外部パッケージ" class="nav-link" data-scroll-target="#%E5%A4%96%E9%83%A8%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8"><span class="header-section-number">3.8</span> 外部パッケージ</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R言語入門</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="cell" data-layout-align="center">
<div class="code-with-filename">
<details class="code-fold"><summary>Code</summary><div class="code-with-filename-file">
<pre><strong>いろいろな設定</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, ggthemes, microbenchmark)</span>
<span id="cb1-2"><a href="#cb1-2"></a>mystyle <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="fu">theme_economist_white</span>(</span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="co"># gray_bg = FALSE,</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="at">base_family =</span> <span class="st">"HiraKakuProN-W3"</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    ),</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="fu">scale_colour_economist</span>(),</span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="fu">theme</span>(</span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>), <span class="co"># フォントファミリーは上で指定済みなので省略可</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb1-11"><a href="#cb1-11"></a>  )</span>
<span id="cb1-12"><a href="#cb1-12"></a>)</span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-15"><a href="#cb1-15"></a>  <span class="at">class.source =</span> <span class="st">"numberLines lineAnchors"</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">#   class.output = "numberLines lineAnchors chunkout"</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
<p>プログラミング言語にはいろんな種類があるけれど、今回学習する<strong>R言語</strong>は、インタプリタ型とよばれるもので、コンパイルという作業の必要が無く、書いたらすぐ実行できる仕様となっています。たとえば、教科書にあるように</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="dv">100</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 90.90909</code></pre>
</div>
</div>
<p>を実行すれば、結果がすぐ表示されます。 RstudioとかVisual Studio CodeとかAntigravityを使って、上のようなRソースコードを一気に書いてまとめて実行するための<strong>スクリプト・ファイル</strong>を作成します。</p>
<p>ソースコードを書くにあたり注意する点が4つあります。</p>
<ol type="1">
<li>
<strong>大文字と小文字は区別される</strong>ので、<code>x</code>と<code>X</code>は別の変数として扱われます。</li>
<li>
<strong>半角スペース</strong>は、<strong>区切り文字</strong>として扱われるので、<code>x &lt;- 100</code>と<code>x&lt;-100</code>は同じ意味になります。</li>
<li>
<strong>改行</strong>も、<strong>区切り文字</strong>として扱われます。長いソースコードは改行して読みやすくしましょう。</li>
<li>
<strong>コメント</strong>は、<code>#</code>から行末までの文字列がコメントとして扱われ、実行されません。プログラムの内容を説明するためにたくさん書いて残しておきましょう。</li>
</ol>
<section id="rの基本的な機能" class="level2 page-columns page-full" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="rの基本的な機能">
<span class="header-section-number">3.1</span> Rの基本的な機能</h2>
<section id="スカラー変数の定義" class="level3 page-columns page-full" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="スカラー変数の定義">
<span class="header-section-number">3.1.1</span> スカラー変数の定義</h3>
<p>この学習を通じて<strong>変数</strong>(variable)とは、<strong>数値や文字といったデータを格納するための箱</strong>を表し、中に何が入っているのかにより、スカラー変数、ベクトル、行列、データフレームなどに分類されます。まずは、スカラー変数の定義を学びます。</p>
<p>スカラー(scalar)とは、大きさだけで決まる量のことで、つまり、<strong>1つの数値</strong>を指します。 R言語ではスカラー変数を定義するには、<code>&lt;-</code>を使います。たとえば、<code>x &lt;- 100</code>と書けば、xというスカラー変数に100という数値を格納できます。このとき、<code>&lt;-</code>は代入演算子と呼ばれ、右辺の値を左辺の変数に代入するという意味です。また、<code>x</code>という変数を<strong>左辺値</strong>(left-hand side)、<code>100</code>という数値を<strong>右辺値</strong>(right-hand side)と呼びます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>x <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># 代入演算子&lt;- の前後に半角スペースを入れるのがお作法</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>この中身を表示されるには、<code><a href="https://rdrr.io/r/base/print.html">print()</a></code>関数を使います。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">print</span>(x) <span class="co"># xの中身を表示</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100</code></pre>
</div>
</div>
<p>あるいは</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>x</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100</code></pre>
</div>
</div>
<p>でも表示されます。</p>
<aside>
Rでは<code>#</code>の後ろの文章はコメントとして扱われ、実行されません。コメントはプログラムの内容を説明するためにたくさん書いて残しておきましょう。
</aside></section><section id="ベクトル変数の定義" class="level3" data-number="3.1.2"><h3 data-number="3.1.2" class="anchored" data-anchor-id="ベクトル変数の定義">
<span class="header-section-number">3.1.2</span> ベクトル変数の定義</h3>
<p><strong>ベクトル</strong>(vector)とは、大きさと向きで決まる量のことで、つまり、<strong>複数の数値</strong>を指します。R言語ではベクトル変数を定義するには、<code><a href="https://rdrr.io/r/base/c.html">c()</a></code>を使います。たとえば、<code>x &lt;- c(1, 2, 3)</code>と書けば、xというベクトル変数に1, 2, 3という数値を格納できます。このとき、<code><a href="https://rdrr.io/r/base/c.html">c()</a></code>はベクトルを作る関数と呼ばれ、<code>1, 2, 3</code>という数値を引数として与えています。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">9</span>) <span class="co"># xに1と5と9を要素とするベクトルを代入</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">print</span>(x)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 5 9</code></pre>
</div>
</div>
<p>等差数列を作る関数に<code><a href="https://rdrr.io/r/base/seq.html">seq()</a></code>関数があります。<code><a href="https://rdrr.io/r/base/seq.html">seq()</a></code>は3つの引数をとり、</p>
<ul>
<li>
<code>from</code> : 始点</li>
<li>
<code>to</code> : 終点</li>
<li>
<code>by</code> : 差分</li>
</ul>
<p>を指定します。たとえば、2000年から2020年を表す年度の変数を<code>year</code>として定義するには、</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>year <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2000</span>, <span class="at">to =</span> <span class="dv">2020</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">print</span>(year)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014
[16] 2015 2016 2017 2018 2019 2020</code></pre>
</div>
</div>
<p>と書けば、2000から2020までの公差1の等差数列を作ります。 <code><a href="https://rdrr.io/r/base/seq.html">seq()</a></code>変数の引数には、<code>from</code>と<code>to</code>と<code>by</code>の3つの引数を指定することができますが、<code>from</code>と<code>to</code>のみを指定することもできます。このとき、<code>by</code>の値は1となります。次のように書いても、上と同じ結果を得ることができます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014
[16] 2015 2016 2017 2018 2019 2020</code></pre>
</div>
</div>
<p>ベクトルの要素数を知るには、<code><a href="https://rdrr.io/r/base/length.html">length()</a></code>関数を使います。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">length</span>(year) <span class="co"># yearの要素数を表示</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 21</code></pre>
</div>
</div>
<p>ベクトル変数<code>year</code>の中には21個の要素があることがわかります。</p>
<section id="ベクトルの要素の取り出し" class="level4" data-number="3.1.2.1"><h4 data-number="3.1.2.1" class="anchored" data-anchor-id="ベクトルの要素の取り出し">
<span class="header-section-number">3.1.2.1</span> ベクトルの要素の取り出し</h4>
<p>複数の要素をもつベクトルから、一部の要素を取り出すには、<code>[]</code>を使います。たとえば、<code>x</code>の2番目の要素を取り出すには、<code>x[2]</code>と書きます。このとき、<code>[]</code>は添字演算子と呼ばれ、<code>2</code>という添字を引数として与えています。添字は1から始まります。</p>
<p>上の<code>year</code>から2000を取り出すには、<code>year[1]</code>、2020を取り出すには<code>year[20]</code>と書きます。 次のような書き方で、好きな要素を指定して取り出すことができます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>year[<span class="dv">1</span>] <span class="co"># 1番目のデータを取り出す</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2000</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>year[<span class="dv">20</span>] <span class="co"># 20番目のデータを取り出す</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2019</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>year[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>] <span class="co"># 2番目から5番目のデータを取り出す</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2001 2002 2003 2004</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>year[<span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">10</span>)] <span class="co"># 1番目と20番目のデータを取り出す</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2004 2009</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>year[<span class="dv">6</span><span class="sc">:</span><span class="fu">length</span>(year)] <span class="co"># 6番目から最後のデータを取り出す</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019
[16] 2020</code></pre>
</div>
</div>
</section><section id="現在価値の計算" class="level4" data-number="3.1.2.2"><h4 data-number="3.1.2.2" class="anchored" data-anchor-id="現在価値の計算">
<span class="header-section-number">3.1.2.2</span> 現在価値の計算</h4>
<p>今の時点を<span class="math inline">t=0</span>として、<span class="math inline">T</span>年後に確実に得られるキャッシュ・フロー<span class="math inline">CF_T</span>の現在価値<span class="math inline">PV_0</span>は、</p>
<p><span class="math display">
PV_0 = \frac{CF_T}{(1+r)^T}
</span></p>
<p>と書けます。たとえば1年後に確実に受け取れる100万円の現在価値<span class="math inline">PV_0</span>を計算してみます。 いま、無リスク利子率<span class="math inline">r</span>は10%とします。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="dv">100</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)<span class="sc">^</span><span class="dv">1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 90.90909</code></pre>
</div>
</div>
<p>次に、この無リスク利子率<span class="math inline">r</span>が変化した場合の現在価値の計算を考えます。まず、無リスク利子率のベクトルを定義します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># 下の２つは同じ結果</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>R <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.1</span>, <span class="at">to =</span> <span class="fl">0.2</span>, <span class="at">by =</span> <span class="fl">0.01</span>)　<span class="co"># 省略せずに書いた場合</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>R <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>) <span class="co"># 略した場合</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>次に、無リスク利子率が変化した場合の現在価値を計算します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>PV <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">1</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="fu">print</span>(PV)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 90.90909 90.09009 89.28571 88.49558 87.71930 86.95652 86.20690 85.47009
 [9] 84.74576 84.03361 83.33333</code></pre>
</div>
</div>
<p>無リスク利子率が0.1から0.2まで0.01ずつ変化した場合の現在価値が計算されました。この結果をグラフにしてみます。</p>
</section></section><section id="基本パッケージplotによる作図" class="level3" data-number="3.1.3"><h3 data-number="3.1.3" class="anchored" data-anchor-id="基本パッケージplotによる作図">
<span class="header-section-number">3.1.3</span> 基本パッケージ<code>plot</code>による作図</h3>
<p>とりあえずサクッと作図してデータをチェックしたいとき、もとからR言語に組み込まれている基本関数<code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>が便利です。先ほど作成したベクトル変数<code>PV</code>をグラフにしてみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">plot</span>(PV)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter03_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="chapter03_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>いま、<code>PV</code>は11個の要素をもつベクトル変数なので、データを左から順番に並べた散布図(scatter diagram)が作成されています。これだと何のグラフか分かりづらいので、いろいろとオプションを指定してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">plot</span>(</span>
<span id="cb33-2"><a href="#cb33-2"></a>    <span class="at">x =</span> R, <span class="co"># x軸のデータ</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>    <span class="at">y =</span> PV, <span class="co"># y軸のデータ</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>    <span class="at">xlab =</span> <span class="st">"無リスク利子率"</span>,</span>
<span id="cb33-5"><a href="#cb33-5"></a>    <span class="at">ylab =</span> <span class="st">"現在価値"</span>,</span>
<span id="cb33-6"><a href="#cb33-6"></a>    <span class="at">main =</span> <span class="st">"無リスク利子率と現在価値の関係"</span>,</span>
<span id="cb33-7"><a href="#cb33-7"></a>    <span class="at">type =</span> <span class="st">"l"</span> <span class="co"># 線グラフ</span></span>
<span id="cb33-8"><a href="#cb33-8"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter03_files/figure-html/unnamed-chunk-14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="chapter03_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>Macだと文字化けしてしまいました。そこで文字コードを指定します。Windowsだとこの作業は不要です。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">par</span>(<span class="at">family =</span> <span class="st">"HiraKakuProN-W3"</span>) <span class="co"># Macの場合のみ</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="fu">plot</span>(</span>
<span id="cb34-3"><a href="#cb34-3"></a>    <span class="at">x =</span> R, <span class="co"># x軸のデータ</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>    <span class="at">y =</span> PV, <span class="co"># y軸のデータ</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>    <span class="at">xlab =</span> <span class="st">"無リスク利子率"</span>, <span class="co"># x軸のラベル</span></span>
<span id="cb34-6"><a href="#cb34-6"></a>    <span class="at">ylab =</span> <span class="st">"現在価値"</span>, <span class="co"># y軸のラベル</span></span>
<span id="cb34-7"><a href="#cb34-7"></a>    <span class="at">main =</span> <span class="st">"無リスク利子率と現在価値の関係"</span>, <span class="co"># グラフのタイトル</span></span>
<span id="cb34-8"><a href="#cb34-8"></a>    <span class="at">type =</span> <span class="st">"l"</span> <span class="co"># 折れ線グラフ</span></span>
<span id="cb34-9"><a href="#cb34-9"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter03_files/figure-html/unnamed-chunk-15-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="chapter03_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
</section></section><section id="for文の使い方" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="for文の使い方">
<span class="header-section-number">3.2</span> <code>for</code>文の使い方</h2>
<p>プログラミングの基本要素である</p>
<ul>
<li>繰り返し</li>
<li>分岐</li>
<li>関数</li>
</ul>
<p>の最初の要素である「繰り返し」を行うための文法が<code>for</code>文です。<code>for</code>文は、ある処理を繰り返し行うための文法です。たとえば、1から10までの整数を順番に表示するには、次のように書きます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) { <span class="co"># iは1から10まで</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>    <span class="fu">print</span>(i) <span class="co"># iを表示</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1
[1] 2
[1] 3
[1] 4
[1] 5
[1] 6
[1] 7
[1] 8
[1] 9
[1] 10</code></pre>
</div>
</div>
<p>この文の構造は、基本的には</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="cf">for</span> (好きな変数 <span class="cf">in</span> 繰り返す範囲) {</span>
<span id="cb37-2"><a href="#cb37-2"></a>    繰り返したい処理</span>
<span id="cb37-3"><a href="#cb37-3"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>となっています。</p>
<p>たとえば、教科書のように、</p>
<ul>
<li>初期投資100万円</li>
<li>1年後に50万円のキャッシュ・フロー</li>
<li>2年後に50万円のキャッシュ・フロー</li>
<li>3年後に50万円のキャッシュ・フロー</li>
</ul>
<p>という投資プロジェクトの現在価値を計算する場合、愚直に書くと次のようになります。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>NPV1 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="sc">+</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)<span class="sc">^</span><span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb38-4"><a href="#cb38-4"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)<span class="sc">^</span><span class="dv">3</span></span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="fu">print</span>(NPV1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24.3426</code></pre>
</div>
</div>
<p>この上のコードの2行目から4行目はほぼ同じ内容なので、数字が変化しているところに注目し、<code>for</code>文を使って書き換えてみます。ここでは<code>^1</code>のところが1ずつ大きくなってます。この部分を<code>i</code>という変数に置き換えてみます。 ついでに、後で変化させることがあるかもしれない部分をすべて変数として定義しておきます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>CF <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="co"># キャッシュ・フロー</span></span>
<span id="cb40-4"><a href="#cb40-4"></a></span>
<span id="cb40-5"><a href="#cb40-5"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) { <span class="co"># iは1から3まで</span></span>
<span id="cb40-6"><a href="#cb40-6"></a>    NPV <span class="ot">&lt;-</span> NPV <span class="sc">+</span> CF <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>i <span class="co"># 現在価値の計算</span></span>
<span id="cb40-7"><a href="#cb40-7"></a>}</span>
<span id="cb40-8"><a href="#cb40-8"></a><span class="fu">print</span>(NPV)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24.3426</code></pre>
</div>
</div>
<p>愚直に計算した場合の同じ結果となりました。 これを10年間の現在価値を計算する場合だとすると、</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb42-3"><a href="#cb42-3"></a>NPV1 <span class="ot">&lt;-</span> NPV <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">4</span> <span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">5</span> <span class="sc">+</span></span>
<span id="cb42-9"><a href="#cb42-9"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">6</span> <span class="sc">+</span></span>
<span id="cb42-10"><a href="#cb42-10"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">7</span> <span class="sc">+</span></span>
<span id="cb42-11"><a href="#cb42-11"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">8</span> <span class="sc">+</span></span>
<span id="cb42-12"><a href="#cb42-12"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">9</span> <span class="sc">+</span></span>
<span id="cb42-13"><a href="#cb42-13"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">10</span></span>
<span id="cb42-14"><a href="#cb42-14"></a><span class="fu">print</span>(NPV1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 207.2284</code></pre>
</div>
</div>
<p>と面倒くさいことこの上ないですが、<code>for</code>文を使えば、</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) { <span class="co"># iは1から10まで</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>    NPV <span class="ot">&lt;-</span> NPV <span class="sc">+</span> <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>i</span>
<span id="cb44-5"><a href="#cb44-5"></a>}</span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="fu">print</span>(NPV)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 207.2284</code></pre>
</div>
</div>
<p>と短く書くことができます。 使いこなせるように練習しておきましょう。 次のように、<code><a href="https://rdrr.io/r/base/print.html">print()</a></code>関数の位置を変えた場合、どうなるか考えてみてください。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) { <span class="co"># iは1から10まで</span></span>
<span id="cb46-4"><a href="#cb46-4"></a>    <span class="fu">print</span>(NPV)</span>
<span id="cb46-5"><a href="#cb46-5"></a>    NPV <span class="ot">&lt;-</span> NPV <span class="sc">+</span> <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>i</span>
<span id="cb46-6"><a href="#cb46-6"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -100
[1] -54.54545
[1] -13.22314</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">print</span>(NPV)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24.3426</code></pre>
</div>
</div>
<p>この場合、最初にNPVの中を表示し、次に1期目の現在価値を計算し、またその結果を表示し、2期目の現在価値を計算し・・・という順番で繰り返しが行われるので、計算の途中経過が表示されることになります。</p>
<section id="if文" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="if文">
<span class="header-section-number">3.2.1</span> <code>if</code>文</h3>
<p>次に、プログラミングの基本要素である</p>
<ul>
<li>繰り返し</li>
<li><strong>分岐</strong></li>
<li>関数</li>
</ul>
<p>のうち分岐を行うための文法が<code>if</code>文です。<code>if</code>文は、ある条件を満たす場合にのみ処理を行うための文法です。たとえば、ある変数<code>x</code>が0より大きい場合にのみ、その変数を表示するには、次のように書きます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>x <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co"># xが0より大きい場合</span></span>
<span id="cb50-3"><a href="#cb50-3"></a>    <span class="fu">print</span>(x) <span class="co"># xを表示</span></span>
<span id="cb50-4"><a href="#cb50-4"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>この文の構造は、基本的には</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="cf">if</span> (条件) {</span>
<span id="cb51-2"><a href="#cb51-2"></a>    条件を満たす場合に実行する処理</span>
<span id="cb51-3"><a href="#cb51-3"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>のようになっています。 この<code>if</code>文を使って、NPVが0より大きい場合にのみ、「プロジェクトを実行！」と表示されるようにしてみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) { <span class="co"># iは1から10まで</span></span>
<span id="cb52-4"><a href="#cb52-4"></a>    NPV <span class="ot">&lt;-</span> NPV <span class="sc">+</span> <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>i</span>
<span id="cb52-5"><a href="#cb52-5"></a>}</span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="cf">if</span> (NPV <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co"># NPVが0より大きい場合</span></span>
<span id="cb52-7"><a href="#cb52-7"></a>    <span class="fu">print</span>(<span class="st">"プロジェクトを実行！"</span>) <span class="co"># 文字列を表示</span></span>
<span id="cb52-8"><a href="#cb52-8"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "プロジェクトを実行！"</code></pre>
</div>
</div>
<p>ここではNPVの値が<code>207.2284</code>となりプラスになっているので、「プロジェクトを実行！」と表示されます。</p>
</section></section><section id="npvと割引率の関係の可視化" class="level2 page-columns page-full" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="npvと割引率の関係の可視化">
<span class="header-section-number">3.3</span> NPVと割引率の関係の可視化</h2>
<p>無リスク利子率が0.1から0.2まで0.01ずつ変化した場合の現在価値NPVの値を計算してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>R <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>) <span class="co"># 無リスク利子率</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(R) <span class="co"># 無リスク利子率の要素数 11個</span></span>
<span id="cb54-3"><a href="#cb54-3"></a>NPV <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, N) <span class="co"># ベクトル変数にN個のNAを代入</span></span>
<span id="cb54-4"><a href="#cb54-4"></a></span>
<span id="cb54-5"><a href="#cb54-5"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) { <span class="co"># iは1からNまで</span></span>
<span id="cb54-6"><a href="#cb54-6"></a>    NPV[i] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb54-7"><a href="#cb54-7"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) { <span class="co"># jは1から3まで</span></span>
<span id="cb54-8"><a href="#cb54-8"></a>        NPV[i] <span class="ot">&lt;-</span> NPV[i] <span class="sc">+</span> <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R[i])<span class="sc">^</span>j <span class="co"># 現在価値</span></span>
<span id="cb54-9"><a href="#cb54-9"></a>    }</span>
<span id="cb54-10"><a href="#cb54-10"></a>}</span>
<span id="cb54-11"><a href="#cb54-11"></a><span class="fu">print</span>(NPV) <span class="co"># 11個の現在価値を表示</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 24.342600 22.185736 20.091563 18.057630 16.081601 14.161256 12.294477
 [8] 10.479248  8.713646  6.995838  5.324074</code></pre>
</div>
</div>
<p>少し複雑な構造しているので、順番に説明します。</p>
<ul>
<li>1行目は、無リスク利子率のベクトル変数<code>R</code>を定義しています。ここでは、0.1から0.2まで0.01刻みのデータを作成しています。</li>
<li>2行目は、ベクトル変数<code>R</code>の要素数を<code>N</code>として定義しています。ここでは、<code>N</code>は11となります。</li>
<li>3行目は、ベクトル変数<code>NPV</code>に<code>N</code>個の<code>NA</code>を代入しています。<code>NA</code>はNot Availableの略で、欠損値を表します。<code>NA</code>を代入することで、空っぽの箱が11個入ったベクトル変数<code>NPV</code>を用意します。</li>
<li>4行目から9行目は、<code>for</code>文を使って、<code>NPV</code>の中身を計算しています。 <code>for</code>が2回出てきているので、二重に繰り返しの処理を行っています。これを<strong>ネスト</strong>と呼びます。 1つのめ<code>for</code>は<code>i</code>が1からN(ここでは11)まで変化し、2つめの<code>for</code>は<code>j</code>が1から3まで変化します。1つめの<code>for</code>文のiが1のとき、次の<code>for</code>文の<code>j</code>が1から3までの処理を繰り返し、次に1つめの<code>for</code>文の<code>i</code>が2のとき、次の<code>for</code>文の<code>j</code>が1から3までの処理を繰り返し・・・という順番で処理が行われます。</li>
<li>10行目は、<code>NPV</code>の中身を表示しています。</li>
</ul>
<aside>
TABキーを使って、インデントを行い、ソースコードのまとまりをわかりやすくしています。インデントは、プログラムの構造をわかりやすくするために行います。インデントを行うときは、半角スペース2つか4つを使います。どちらを使っても構いませんが、どちらかに統一することが大切です。
</aside><p>この結果をグラフにしてみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="fu">plot</span>(</span>
<span id="cb56-2"><a href="#cb56-2"></a>    <span class="at">x =</span> R, <span class="co"># x軸のデータ</span></span>
<span id="cb56-3"><a href="#cb56-3"></a>    <span class="at">y =</span> NPV, <span class="co"># y軸のデータ</span></span>
<span id="cb56-4"><a href="#cb56-4"></a>    <span class="at">xlab =</span> <span class="st">"無リスク利子率"</span>, <span class="co"># x軸のラベル</span></span>
<span id="cb56-5"><a href="#cb56-5"></a>    <span class="at">ylab =</span> <span class="st">"現在価値"</span>, <span class="co"># y軸のラベル</span></span>
<span id="cb56-6"><a href="#cb56-6"></a>    <span class="at">main =</span> <span class="st">"図：無リスク利子率と現在価値"</span>, <span class="co"># グラフのタイトル</span></span>
<span id="cb56-7"><a href="#cb56-7"></a>    <span class="at">type =</span> <span class="st">"l"</span> <span class="co"># 線グラフ</span></span>
<span id="cb56-8"><a href="#cb56-8"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter03_files/figure-html/unnamed-chunk-27-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="chapter03_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<section id="ベクトル化" class="level4" data-number="3.3.0.1"><h4 data-number="3.3.0.1" class="anchored" data-anchor-id="ベクトル化">
<span class="header-section-number">3.3.0.1</span> ベクトル化</h4>
<p>上のコードは、<code>for</code>文を使って、<code>NPV</code>の中身を計算しています。しかし、R言語では、<code>for</code>文を使わずに、ベクトルを使って、同じことを行うことができます。このように、<code>for</code>文を使わずに、ベクトルを使って処理を行うことを<strong>ベクトル化</strong>と呼びます。ベクトル化を行うと、処理が高速化されることがあります。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率 10%</span></span>
<span id="cb57-2"><a href="#cb57-2"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>) <span class="co"># キャッシュ・フローのベクトル</span></span>
<span id="cb57-3"><a href="#cb57-3"></a>year <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span> <span class="co"># 年度のベクトル</span></span>
<span id="cb57-4"><a href="#cb57-4"></a>PV_CF <span class="ot">&lt;-</span> CF <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>year <span class="co"># 各期の現在価値を計算</span></span>
<span id="cb57-5"><a href="#cb57-5"></a>NPV <span class="ot">&lt;-</span> <span class="fu">sum</span>(PV_CF) <span class="co"># 現在価値の合計</span></span>
<span id="cb57-6"><a href="#cb57-6"></a><span class="fu">print</span>(NPV)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24.3426</code></pre>
</div>
</div>
</section></section><section id="独自関数の定義の仕方" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="独自関数の定義の仕方">
<span class="header-section-number">3.4</span> 独自関数の定義の仕方</h2>
<p>プログラミングの基本要素である</p>
<ul>
<li>繰り返し</li>
<li>分岐</li>
<li><strong>関数</strong></li>
</ul>
<p>の作り方について説明します。 Rでは自分で関数を定義することができます。関数を定義することで、同じ処理を何度も書く必要がなくなり、プログラムの見通しがよくなります。 例えば、足し算をする関数<code>my_add()</code>を定義してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>my_add <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y){</span>
<span id="cb59-2"><a href="#cb59-2"></a>    x <span class="sc">+</span> y</span>
<span id="cb59-3"><a href="#cb59-3"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>この関数の構造は、</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>好きな関数名 <span class="ot">&lt;-</span> <span class="cf">function</span>(引数1, 引数2){</span>
<span id="cb60-2"><a href="#cb60-2"></a>    処理内容</span>
<span id="cb60-3"><a href="#cb60-3"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>となっています。つまり、この独自関数<code>my_add()</code>は、<code>x</code>と<code>y</code>という2つの引数(ひきすう)を足し合わせる関数です。数学的に書くなら、</p>
<p><span class="math display">
f(x, y) = x + y
</span></p>
<p>となります。これは<span class="math inline">f</span>という関数は2つの引数を足す関数であるという意味になっています。 作成した独自関数<code>my_add()</code>を使ってみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="fu">my_add</span>(<span class="dv">1</span>, <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
</div>
<p>3が出力されました。</p>
<p>このように、独自関数を作成する場合には、</p>
<ol type="1">
<li>どのような引数を与えるのか？</li>
<li>それに対してどのような処理を行うのか？</li>
<li>最終的にどの値を返す(出力させる)のか？</li>
</ol>
<p>を考えておく必要があります。</p>
<p>では今までの流れで、現在価値を計算する関数を作成してみます。変化させたい値は、キャッシュフロー<code>CF</code>と無リスク利子率<code>R</code>なので、その2つを引数とする独自関数を作成します。 少し注意する必要がある点として、以下の計算例では<code>CF</code>の1番目の要素は初期投資額となることに注意しましょう。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>calc_PV <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, R) {</span>
<span id="cb63-2"><a href="#cb63-2"></a>    PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>] <span class="co"># 初期投資額なのでマイナスの値</span></span>
<span id="cb63-3"><a href="#cb63-3"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(CF)) { <span class="co"># iは2からCFの要素数まで</span></span>
<span id="cb63-4"><a href="#cb63-4"></a>        PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>) <span class="co"># 現在価値</span></span>
<span id="cb63-5"><a href="#cb63-5"></a>    }</span>
<span id="cb63-6"><a href="#cb63-6"></a>    <span class="fu">return</span>(PV) <span class="co"># 現在価値を返す</span></span>
<span id="cb63-7"><a href="#cb63-7"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>この関数<code>calc_PV()</code>を使って、現在価値を計算してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a><span class="fu">calc_PV</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>), <span class="fl">0.1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24.3426</code></pre>
</div>
</div>
<p>ちゃんと計算されました。この関数を使って、無リスク利子率が0.1から0.2まで0.01ずつ変化した場合の現在価値を計算してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>) <span class="co"># キャッシュ・フローのベクトル</span></span>
<span id="cb66-2"><a href="#cb66-2"></a>R <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>) <span class="co"># 無リスク利子率のベクトル</span></span>
<span id="cb66-3"><a href="#cb66-3"></a><span class="fu">calc_PV</span>(CF,R)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 24.342600 22.185736 20.091563 18.057630 16.081601 14.161256 12.294477
 [8] 10.479248  8.713646  6.995838  5.324074</code></pre>
</div>
</div>
<p>計算されました。 関数の引数にデフォルトで値を設定することで、入力を楽にすることができます。例えば、無リスク利子率のデフォルト値を0.1に設定してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>calc_PV <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>) {</span>
<span id="cb68-2"><a href="#cb68-2"></a>    PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>] <span class="co"># 初期投資額なのでマイナスの値</span></span>
<span id="cb68-3"><a href="#cb68-3"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(CF)) { <span class="co"># iは2からCFの要素数まで</span></span>
<span id="cb68-4"><a href="#cb68-4"></a>        PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>) <span class="co"># 現在価値</span></span>
<span id="cb68-5"><a href="#cb68-5"></a>    }</span>
<span id="cb68-6"><a href="#cb68-6"></a>    <span class="fu">return</span>(PV) <span class="co"># 現在価値を返す</span></span>
<span id="cb68-7"><a href="#cb68-7"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>すると、無リスク利子率を指定しなくても、デフォルト値が使われるようになります。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>) <span class="co"># キャッシュ・フローのベクトル</span></span>
<span id="cb69-2"><a href="#cb69-2"></a><span class="fu">calc_PV</span>(CF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24.3426</code></pre>
</div>
</div>
<p>ただ計算を間違えるもとにもなるので、なるべく省略せずに、しっかり書くことが大事です。</p>
<section id="もっと凝った独自関数" class="level4" data-number="3.4.0.1"><h4 data-number="3.4.0.1" class="anchored" data-anchor-id="もっと凝った独自関数">
<span class="header-section-number">3.4.0.1</span> もっと凝った独自関数</h4>
<p>繰り返し、分岐、関数というプログラミングの基本要素を勉強したので、もう少し複雑なプログラムを作成してみます。</p>
<p>まずは、引数に正の数字以外のもの、あるいは文字列を入力した場合にエラーを表示する関数を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a>calc_PV_new <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, R) {</span>
<span id="cb71-2"><a href="#cb71-2"></a>    <span class="cf">if</span> (R <span class="sc">&lt;=</span> <span class="dv">0</span>) {</span>
<span id="cb71-3"><a href="#cb71-3"></a>        <span class="fu">stop</span>(<span class="st">"無リスク利子率は正の値を入力してください。"</span>) <span class="co"># エラー処理</span></span>
<span id="cb71-4"><a href="#cb71-4"></a>    }</span>
<span id="cb71-5"><a href="#cb71-5"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.numeric</span>(CF) ) {</span>
<span id="cb71-6"><a href="#cb71-6"></a>        <span class="fu">stop</span>(<span class="st">"キャッシュ・フローは数値を入力してください。"</span>)</span>
<span id="cb71-7"><a href="#cb71-7"></a>    }</span>
<span id="cb71-8"><a href="#cb71-8"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.numeric</span>(R) ) {</span>
<span id="cb71-9"><a href="#cb71-9"></a>        <span class="fu">stop</span>(<span class="st">"無リスク利子率は数値を入力してください。"</span>)</span>
<span id="cb71-10"><a href="#cb71-10"></a>    }</span>
<span id="cb71-11"><a href="#cb71-11"></a></span>
<span id="cb71-12"><a href="#cb71-12"></a>    PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>]</span>
<span id="cb71-13"><a href="#cb71-13"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(CF)) {</span>
<span id="cb71-14"><a href="#cb71-14"></a>        PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb71-15"><a href="#cb71-15"></a>    }</span>
<span id="cb71-16"><a href="#cb71-16"></a>    <span class="fu">return</span>(PV)</span>
<span id="cb71-17"><a href="#cb71-17"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>できました。ついでに、NPVの計算結果とともに、NPVが0より大きい場合にのみ、「プロジェクトを実行！」と表示する機能も実装してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a>calc_PV_new <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>) {</span>
<span id="cb72-2"><a href="#cb72-2"></a>    <span class="cf">if</span> (R <span class="sc">&lt;=</span> <span class="dv">0</span>) {</span>
<span id="cb72-3"><a href="#cb72-3"></a>        <span class="fu">stop</span>(<span class="st">"無リスク利子率は正の値を入力してください。"</span>) <span class="co"># エラー処理</span></span>
<span id="cb72-4"><a href="#cb72-4"></a>    }</span>
<span id="cb72-5"><a href="#cb72-5"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.numeric</span>(CF) ) {</span>
<span id="cb72-6"><a href="#cb72-6"></a>        <span class="fu">stop</span>(<span class="st">"キャッシュ・フローは数値を入力してください。"</span>)</span>
<span id="cb72-7"><a href="#cb72-7"></a>    }</span>
<span id="cb72-8"><a href="#cb72-8"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.numeric</span>(R) ) {</span>
<span id="cb72-9"><a href="#cb72-9"></a>        <span class="fu">stop</span>(<span class="st">"無リスク利子率は数値を入力してください。"</span>)</span>
<span id="cb72-10"><a href="#cb72-10"></a>    }</span>
<span id="cb72-11"><a href="#cb72-11"></a></span>
<span id="cb72-12"><a href="#cb72-12"></a>    PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>]</span>
<span id="cb72-13"><a href="#cb72-13"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(CF)) {</span>
<span id="cb72-14"><a href="#cb72-14"></a>        PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb72-15"><a href="#cb72-15"></a>    }</span>
<span id="cb72-16"><a href="#cb72-16"></a></span>
<span id="cb72-17"><a href="#cb72-17"></a>    <span class="cf">if</span> (PV <span class="sc">&gt;=</span> <span class="dv">0</span>) { <span class="co"># NPVが0より大きい場合</span></span>
<span id="cb72-18"><a href="#cb72-18"></a>    <span class="fu">paste0</span>(<span class="st">"NPVが"</span>, <span class="fu">round</span>(PV, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">"なので、プロジェクトを実行！"</span>) <span class="co"># 文字列を表示</span></span>
<span id="cb72-19"><a href="#cb72-19"></a>    } <span class="cf">else</span> {</span>
<span id="cb72-20"><a href="#cb72-20"></a>    <span class="fu">paste0</span>(<span class="st">"NPVが"</span>, <span class="fu">round</span>(PV, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">"なのでプロジェクト中止！"</span>) <span class="co"># 文字列を表示</span></span>
<span id="cb72-21"><a href="#cb72-21"></a>    }</span>
<span id="cb72-22"><a href="#cb72-22"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>いろいろ駆使してより短く簡単に書くなら、</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a>calc_PV <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>) {</span>
<span id="cb73-2"><a href="#cb73-2"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.numeric</span>(CF) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.numeric</span>(R) <span class="sc">||</span> R <span class="sc">&lt;=</span> <span class="dv">0</span>) {</span>
<span id="cb73-3"><a href="#cb73-3"></a>    <span class="fu">stop</span>(<span class="st">"キャッシュ・フローと無リスク利子率は数値を入力し、無リスク利子率は正の値を入力してください。"</span>)</span>
<span id="cb73-4"><a href="#cb73-4"></a>  }</span>
<span id="cb73-5"><a href="#cb73-5"></a>  PV <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(CF), <span class="cf">function</span>(i) CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>)))</span>
<span id="cb73-6"><a href="#cb73-6"></a></span>
<span id="cb73-7"><a href="#cb73-7"></a>  <span class="cf">if</span> (PV <span class="sc">&gt;=</span> <span class="dv">0</span>) {</span>
<span id="cb73-8"><a href="#cb73-8"></a>    <span class="fu">paste0</span>(<span class="st">"NPVが"</span>, <span class="fu">round</span>(PV, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">"なので、プロジェクトを実行！"</span>)</span>
<span id="cb73-9"><a href="#cb73-9"></a>  } <span class="cf">else</span> {</span>
<span id="cb73-10"><a href="#cb73-10"></a>    <span class="fu">paste0</span>(<span class="st">"NPVが"</span>, <span class="fu">round</span>(PV, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">"なのでプロジェクト中止！"</span>)</span>
<span id="cb73-11"><a href="#cb73-11"></a>  }</span>
<span id="cb73-12"><a href="#cb73-12"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>)</span>
<span id="cb74-2"><a href="#cb74-2"></a><span class="fu">calc_PV</span>(CF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "NPVが24.34なので、プロジェクトを実行！"</code></pre>
</div>
</div>
<p>うまくいきました。 ちょっとキャッシュフローのベクトルを変化させて、初期投資を-200にすると、</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">200</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>)</span>
<span id="cb76-2"><a href="#cb76-2"></a><span class="fu">calc_PV</span>(CF)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "NPVが-75.66なのでプロジェクト中止！"</code></pre>
</div>
</div>
<p>ちゃんと中止のメッセージが出ました。</p>
<p>このように、分岐、繰り返し、関数を駆使して、様々なプログラムを作成することができます。プログラミングの基本要素を使いこなせるように、練習を重ねてください。まずは教科書に書いてあるソースコードを自分のPC上で実行してみてください。その際は、コピペせずに自分で入力するようにしてください。</p>
</section><section id="付録ベクトル化で早くなるのか" class="level4" data-number="3.4.0.2"><h4 data-number="3.4.0.2" class="anchored" data-anchor-id="付録ベクトル化で早くなるのか">
<span class="header-section-number">3.4.0.2</span> 付録：ベクトル化で早くなるのか？</h4>
<p>どれほど高速化されるのかを確認するため、100万年分の現在価値を計算してみます。 最初に松浦のR環境を確認してみます。 コンピューターはMac miniで、CPUはM4 Pro、メモリは24GB、MacOS Tahoe 26.3です。 Rやパッケージのバージョンは以下の通りです。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a><span class="fu">sessionInfo</span>() </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.0 (2025-04-11)
Platform: aarch64-apple-darwin20
Running under: macOS 26.3

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] C.UTF-8/C.UTF-8/C.UTF-8/C/C.UTF-8/C.UTF-8

time zone: Asia/Tokyo
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] microbenchmark_1.5.0 ggthemes_5.1.0       lubridate_1.9.4     
 [4] forcats_1.0.1        stringr_1.6.0        dplyr_1.1.4         
 [7] purrr_1.2.0          readr_2.1.5          tidyr_1.3.1         
[10] tibble_3.3.0         ggplot2_4.0.0        tidyverse_2.0.0     

loaded via a namespace (and not attached):
 [1] gtable_0.3.6       jsonlite_2.0.0     compiler_4.5.0     tidyselect_1.2.1  
 [5] systemfonts_1.3.1  scales_1.4.0       textshaping_1.0.3  yaml_2.3.10       
 [9] fastmap_1.2.0      R6_2.6.1           generics_0.1.4     knitr_1.50        
[13] htmlwidgets_1.6.4  pillar_1.11.1      RColorBrewer_1.1-3 tzdb_0.5.0        
[17] rlang_1.1.6        stringi_1.8.7      xfun_0.53          S7_0.2.0          
[21] timechange_0.3.0   cli_3.6.5          withr_3.0.2        magrittr_2.0.4    
[25] digest_0.6.37      grid_4.5.0         hms_1.1.3          lifecycle_1.0.4   
[29] vctrs_0.6.5        evaluate_1.0.5     glue_1.8.0         farver_2.1.2      
[33] ragg_1.5.0         pacman_0.5.1       rmarkdown_2.29     tools_4.5.0       
[37] pkgconfig_2.0.3    htmltools_0.5.8.1 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a>R.version</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               _                           
platform       aarch64-apple-darwin20      
arch           aarch64                     
os             darwin20                    
system         aarch64, darwin20           
status                                     
major          4                           
minor          5.0                         
year           2025                        
month          04                          
day            11                          
svn rev        88135                       
language       R                           
version.string R version 4.5.0 (2025-04-11)
nickname       How About a Twenty-Six      </code></pre>
</div>
</div>
<p>今回比較した4つの手法について、それぞれの特徴と、どのような場面で使うべきかをまとめました。 適切な手法を選択する際の参考にしてください。</p>
<ol type="1">
<li><p><code>for</code>ループ：1つずつ順番に計算する、最も基本的で直感的な方法です。 プログラムの構造が分かりやすく、複雑な条件分岐を書きやすいです。 しかし、Rは繰り返し処理のたびに「解釈」を行うため、回数が増えると極端に時間がかかります。データ数が少ない場合や、計算ロジックが非常に複雑でベクトル化が難しい場合に使います。</p></li>
<li><p><strong>ベクトル化</strong> : Rの得意技で、データを「まとめて」一気に計算する方法です。 <code>for</code>ループに比べて劇的に高速で、コードも短くシンプルになります。 しかし、計算のために巨大な一時データをメモリ上に作成するため、メモリ消費量が大きいです。データが巨大すぎるとメモリ不足で停止することがありますが、Rでは通常はこの方法が推奨されます。</p></li>
<li><p><strong>分割計算</strong> / チャンク化 : データを一定のサイズ（例：100万件ずつ）に区切って、少しずつベクトル化計算を行う方法です。ベクトル化の速さを活かしつつ、メモリ消費量を低く抑えることができますが、コードが少し複雑になります。また、区切る処理が入る分、純粋なベクトル化よりわずかに遅くなります。億単位のデータなど、一気に計算するとメモリ不足になるような大規模データを扱う場合に有効です。</p></li>
<li><p><code>Rcpp</code> (C++連携) : Rの中から、より高速なプログラミング言語である「C++」を呼び出して計算する方法です。圧倒的に最速です。また、メモリ管理も効率的なので、大規模データでも軽快に動作します。C++の知識が必要で、コードを書く難易度が高いですが、生成AIを活用すれば初心者でも比較的簡単に導入できます。非常に大規模なシミュレーションや、計算速度が最重要となる場合に適しています。</p></li>
</ol>
<p>以下では、それぞれの手法で現在価値を計算する関数を定義します。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>for文とベクトル化の比較</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a><span class="co"># for文版</span></span>
<span id="cb82-2"><a href="#cb82-2"></a>calc_PV_for <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>) {</span>
<span id="cb82-3"><a href="#cb82-3"></a>  PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>]</span>
<span id="cb82-4"><a href="#cb82-4"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(CF)</span>
<span id="cb82-5"><a href="#cb82-5"></a>  <span class="cf">if</span> (n <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="fu">return</span>(PV) <span class="co"># 要素数が1以下の場合は即リターン</span></span>
<span id="cb82-6"><a href="#cb82-6"></a>  </span>
<span id="cb82-7"><a href="#cb82-7"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb82-8"><a href="#cb82-8"></a>    PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb82-9"><a href="#cb82-9"></a>  }</span>
<span id="cb82-10"><a href="#cb82-10"></a>  <span class="fu">return</span>(PV)</span>
<span id="cb82-11"><a href="#cb82-11"></a>}</span>
<span id="cb82-12"><a href="#cb82-12"></a></span>
<span id="cb82-13"><a href="#cb82-13"></a><span class="co"># ベクトル版</span></span>
<span id="cb82-14"><a href="#cb82-14"></a>calc_PV_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>){</span>
<span id="cb82-15"><a href="#cb82-15"></a>  year <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">length</span>(CF) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb82-16"><a href="#cb82-16"></a></span>
<span id="cb82-17"><a href="#cb82-17"></a>  PV_CF <span class="ot">&lt;-</span> CF <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>year</span>
<span id="cb82-18"><a href="#cb82-18"></a>  NPV <span class="ot">&lt;-</span> <span class="fu">sum</span>(PV_CF)</span>
<span id="cb82-19"><a href="#cb82-19"></a>  <span class="fu">return</span>(NPV)</span>
<span id="cb82-20"><a href="#cb82-20"></a>}</span>
<span id="cb82-21"><a href="#cb82-21"></a></span>
<span id="cb82-22"><a href="#cb82-22"></a><span class="co"># ベクトル版一気に計算版</span></span>
<span id="cb82-23"><a href="#cb82-23"></a>calc_PV_chunk <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>, <span class="at">chunk_size =</span> <span class="fl">1e6</span>) { <span class="co"># デフォルトで100万件ずつ処理</span></span>
<span id="cb82-24"><a href="#cb82-24"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(CF)</span>
<span id="cb82-25"><a href="#cb82-25"></a>  total_npv <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb82-26"><a href="#cb82-26"></a>  </span>
<span id="cb82-27"><a href="#cb82-27"></a>  <span class="co"># チャンクの開始位置を作成 (例: 1, 1000001, 2000001...)</span></span>
<span id="cb82-28"><a href="#cb82-28"></a>  starts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, n, <span class="at">by =</span> chunk_size)</span>
<span id="cb82-29"><a href="#cb82-29"></a>  </span>
<span id="cb82-30"><a href="#cb82-30"></a>  <span class="cf">for</span> (start <span class="cf">in</span> starts) {</span>
<span id="cb82-31"><a href="#cb82-31"></a>    <span class="co"># 終了位置を計算（データの最後を超えないようにminを使う）</span></span>
<span id="cb82-32"><a href="#cb82-32"></a>    end <span class="ot">&lt;-</span> <span class="fu">min</span>(start <span class="sc">+</span> chunk_size <span class="sc">-</span> <span class="dv">1</span>, n)</span>
<span id="cb82-33"><a href="#cb82-33"></a>    </span>
<span id="cb82-34"><a href="#cb82-34"></a>    <span class="co"># 1. 必要な部分だけデータを切り出す（ここでメモリ消費を抑える）</span></span>
<span id="cb82-35"><a href="#cb82-35"></a>    cf_part <span class="ot">&lt;-</span> CF[start<span class="sc">:</span>end]</span>
<span id="cb82-36"><a href="#cb82-36"></a>    </span>
<span id="cb82-37"><a href="#cb82-37"></a>    <span class="co"># 2. 時間tのベクトルを作成（全体の位置に合わせて調整）</span></span>
<span id="cb82-38"><a href="#cb82-38"></a>    <span class="co"># CF[1]がt=0に対応するため、インデックスから1を引く</span></span>
<span id="cb82-39"><a href="#cb82-39"></a>    t_part <span class="ot">&lt;-</span> (start<span class="sc">:</span>end) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb82-40"><a href="#cb82-40"></a>    </span>
<span id="cb82-41"><a href="#cb82-41"></a>    <span class="co"># 3. 部分的な現在価値を計算して合計に加算</span></span>
<span id="cb82-42"><a href="#cb82-42"></a>    <span class="co"># ベクトル化の恩恵を受けつつ、メモリ消費はchunk_size分だけで済む</span></span>
<span id="cb82-43"><a href="#cb82-43"></a>    total_npv <span class="ot">&lt;-</span> total_npv <span class="sc">+</span> <span class="fu">sum</span>(cf_part <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>t_part)</span>
<span id="cb82-44"><a href="#cb82-44"></a>  }</span>
<span id="cb82-45"><a href="#cb82-45"></a>  </span>
<span id="cb82-46"><a href="#cb82-46"></a>  <span class="fu">return</span>(total_npv)</span>
<span id="cb82-47"><a href="#cb82-47"></a>}</span>
<span id="cb82-48"><a href="#cb82-48"></a></span>
<span id="cb82-49"><a href="#cb82-49"></a><span class="co"># Rcppを使ってC++で高速化版</span></span>
<span id="cb82-50"><a href="#cb82-50"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb82-51"><a href="#cb82-51"></a><span class="co"># C++のコードをRの中でコンパイルして関数化</span></span>
<span id="cb82-52"><a href="#cb82-52"></a><span class="fu">cppFunction</span>(<span class="st">'</span></span>
<span id="cb82-53"><a href="#cb82-53"></a><span class="st">double calc_PV_cpp(NumericVector CF, double R) {</span></span>
<span id="cb82-54"><a href="#cb82-54"></a><span class="st">  double npv = 0;</span></span>
<span id="cb82-55"><a href="#cb82-55"></a><span class="st">  double discount_factor = 1.0;</span></span>
<span id="cb82-56"><a href="#cb82-56"></a><span class="st">  double r_plus_1 = 1.0 + R;</span></span>
<span id="cb82-57"><a href="#cb82-57"></a><span class="st">  int n = CF.size();</span></span>
<span id="cb82-58"><a href="#cb82-58"></a><span class="st">  </span></span>
<span id="cb82-59"><a href="#cb82-59"></a><span class="st">  for(int i = 0; i &lt; n; ++i) {</span></span>
<span id="cb82-60"><a href="#cb82-60"></a><span class="st">    // 毎回 pow(1+R, i) を計算すると遅いので、</span></span>
<span id="cb82-61"><a href="#cb82-61"></a><span class="st">    // 割引率を掛け合わせて更新していく（これが最速）</span></span>
<span id="cb82-62"><a href="#cb82-62"></a><span class="st">    npv += CF[i] / discount_factor;</span></span>
<span id="cb82-63"><a href="#cb82-63"></a><span class="st">    discount_factor *= r_plus_1;</span></span>
<span id="cb82-64"><a href="#cb82-64"></a><span class="st">  }</span></span>
<span id="cb82-65"><a href="#cb82-65"></a><span class="st">  return npv;</span></span>
<span id="cb82-66"><a href="#cb82-66"></a><span class="st">}</span></span>
<span id="cb82-67"><a href="#cb82-67"></a><span class="st">'</span>)</span>
<span id="cb82-68"><a href="#cb82-68"></a></span>
<span id="cb82-69"><a href="#cb82-69"></a><span class="co"># 使い方</span></span>
<span id="cb82-70"><a href="#cb82-70"></a><span class="co"># calc_PV_cpp(CF, 0.1)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>比較してみます。 ランダムな将来キャッシュフローを1万年分用意します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a><span class="fu">set.seed</span>(<span class="dv">121</span>)</span>
<span id="cb83-2"><a href="#cb83-2"></a>n_years <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">6</span> <span class="co"># 100万年分</span></span>
<span id="cb83-3"><a href="#cb83-3"></a><span class="co"># 初期投資-100とランダムなキャッシュフロー</span></span>
<span id="cb83-4"><a href="#cb83-4"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="fu">runif</span>(n_years <span class="sc">-</span> <span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>)) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>では、それぞれの方法で計算した速度を比較してみましょう。 正確に比較するため、<code>microbenchmark</code>パッケージを使って、それぞれ10回ずつ計測し、その分布を確認します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a><span class="co"># 全ての手法をまとめて計測</span></span>
<span id="cb84-2"><a href="#cb84-2"></a>res <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb84-3"><a href="#cb84-3"></a>    <span class="st">"For Loop"</span>   <span class="ot">=</span> <span class="fu">calc_PV_for</span>(CF),</span>
<span id="cb84-4"><a href="#cb84-4"></a>    <span class="st">"Vectorized"</span> <span class="ot">=</span> <span class="fu">calc_PV_vec</span>(CF),</span>
<span id="cb84-5"><a href="#cb84-5"></a>    <span class="st">"Chunked"</span>    <span class="ot">=</span> <span class="fu">calc_PV_chunk</span>(CF),</span>
<span id="cb84-6"><a href="#cb84-6"></a>    <span class="st">"Rcpp (C++)"</span> <span class="ot">=</span> <span class="fu">calc_PV_cpp</span>(CF, <span class="fl">0.1</span>),</span>
<span id="cb84-7"><a href="#cb84-7"></a>    <span class="at">times =</span> <span class="dv">10</span>, <span class="co"># 10回繰り返して計測</span></span>
<span id="cb84-8"><a href="#cb84-8"></a>    <span class="at">unit =</span> <span class="st">"ms"</span> <span class="co"># 単位をミリ秒に統一</span></span>
<span id="cb84-9"><a href="#cb84-9"></a>)</span>
<span id="cb84-10"><a href="#cb84-10"></a></span>
<span id="cb84-11"><a href="#cb84-11"></a><span class="co"># 結果の数値表示</span></span>
<span id="cb84-12"><a href="#cb84-12"></a><span class="fu">print</span>(res)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
       expr       min        lq       mean    median        uq       max neval
   For Loop 26.606130 27.050529 27.2618717 27.176153 27.269879 28.676425    10
 Vectorized  6.241307  6.332040  7.0152886  6.508033  7.818290  8.541899    10
    Chunked 10.097398 10.197643 18.3769011 10.915799 13.053252 48.693240    10
 Rcpp (C++)  0.709095  0.713318  0.7726286  0.737180  0.757721  1.120448    10</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a><span class="co"># 結果の可視化（箱ひげ図）</span></span>
<span id="cb86-2"><a href="#cb86-2"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(<span class="at">x =</span> expr, <span class="at">y =</span> time <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">fill =</span> expr)) <span class="sc">+</span> <span class="co"># timeを1e6(100万)で割ってミリ秒に変換</span></span>
<span id="cb86-3"><a href="#cb86-3"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> <span class="co"># 箱ひげ図を指定</span></span>
<span id="cb86-4"><a href="#cb86-4"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma) <span class="sc">+</span> <span class="co"># 軸の数値をカンマ区切りに（見やすくするため）</span></span>
<span id="cb86-5"><a href="#cb86-5"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"計算手法による実行速度の比較 (100万件)"</span>, </span>
<span id="cb86-6"><a href="#cb86-6"></a>       <span class="at">y =</span> <span class="st">"実行時間 (ミリ秒)"</span>,</span>
<span id="cb86-7"><a href="#cb86-7"></a>       <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span> <span class="co"># x軸ラベル（手法名）は自明なので空欄に</span></span>
<span id="cb86-8"><a href="#cb86-8"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="co"># ベーステーマ（mystyleがあればそちらに置き換えてください）</span></span>
<span id="cb86-9"><a href="#cb86-9"></a>  mystyle <span class="sc">+</span></span>
<span id="cb86-10"><a href="#cb86-10"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="co"># 色分けの凡例は不要なら消す</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter03_files/figure-html/run_benchmark-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="chapter03_files/figure-html/run_benchmark-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>実行結果の解釈:</p>
<ul>
<li>
<code>for</code>ループ: 最も遅くなります。Rでのループ処理はオーバーヘッドが大きいためです。</li>
<li>ベクトル化: for文に比べて劇的に高速化します。<strong>通常はこの方法が推奨</strong>されます。</li>
<li>Chunked: ベクトル化より少し遅くなりますが、メモリ消費を抑えられるメリットがあります。</li>
<li>
<code>Rcpp</code>: 圧倒的に高速です。C++のレベルで最適化されるため、大規模なシミュレーションや反復計算では威力を発揮します。</li>
</ul>
<p>これがベクトル化による実行速度の効率化です。とはいえ、演算に時間がかかるような大規模データや複雑なシミュレーションをするようになるまで、ベクトル化の恩恵はそれほど大きくないですし、巨大な中間ベクトルをメモリ上に生成するため、計算速度は速くなるがメモリ消費量は増えるます。 ということなので今は気にせずに、読みやすく、確実に動くプログラムを書くことを心がけましょう。</p>
</section></section><section id="演習" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="演習">
<span class="header-section-number">3.5</span> 演習</h2>
<p>各自でやってみてください。</p>
</section><section id="データフレーム入門" class="level2 page-columns page-full" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="データフレーム入門">
<span class="header-section-number">3.6</span> データフレーム入門</h2>
<section id="csvファイルの読み込み" class="level3 page-columns page-full" data-number="3.6.1"><h3 data-number="3.6.1" class="anchored" data-anchor-id="csvファイルの読み込み">
<span class="header-section-number">3.6.1</span> CSVファイルの読み込み</h3>
<p>RでCSVファイルを読み込むには、<code>readr</code>パッケージの<code>read_csv()</code>関数を使うのがよいでしょう。 たとえば、<code>data.csv</code>というファイルを読み込むには、次のように書きます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"data/ch03_daily_stock_return.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>この<code>df</code>というオブジェクトの型を見てみると，</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1"></a><span class="fu">class</span>(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "spec_tbl_df" "tbl_df"      "tbl"         "data.frame" </code></pre>
</div>
</div>
<p><code>spec_tbl_df</code>，<code>tbl_df</code>，<code>tbl</code>，<code>data.frame</code>という4つの型が表示されます。 <code>data.frame</code>という属性が含まれており，<code>df</code>が<strong>データフレーム</strong>であることを示しています。</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><code>spec_tbl_df</code>は，<code>readr</code>パッケージが読み込んだデータフレームに付与する属性で，データの仕様情報を保持しています。 <code>tbl_df</code>は，<code>tibble</code>パッケージが提供するデータフレームの拡張型で，表示や操作がしやすくなっています。 <code>tbl</code>は，<code>dplyr</code>パッケージが提供するデータフレームの拡張型で，データ操作が効率的に行えるようになっています。 基本的には，<code>data.frame</code>として扱うことができます。</p>
</div></div><p>あとは，</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/nrow.html">nrow()</a></code>関数で行数を確認</li>
<li>
<code><a href="https://rdrr.io/r/utils/str.html">str()</a></code>関数で構造を確認</li>
<li>
<code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>関数で平均を計算</li>
<li>
<code><a href="https://rdrr.io/r/stats/sd.html">sd()</a></code>関数で標準偏差を計算</li>
<li>
<code><a href="https://rdrr.io/r/stats/cor.html">cor()</a></code>関数で相関係数を計算</li>
</ul>
<p>などを使って，データの中身を確認してみましょう。</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/which.min.html">which.min()</a></code>関数や<code><a href="https://rdrr.io/r/base/which.min.html">which.max()</a></code>関数で最小値・最大値のインデックスを取得</li>
</ul>
<p>例えば，最も日次リターンが高い日付を調べるには，次のようにします。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1"></a>best_day_ID <span class="ot">&lt;-</span> <span class="fu">which.max</span>(df<span class="sc">$</span>firm1)</span>
<span id="cb90-2"><a href="#cb90-2"></a>best_day_ID</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13</code></pre>
</div>
</div>
<p>13行目が最も日次リターンが高い日付なので，<code>df</code>からその行を取り出してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a>df<span class="sc">$</span>date[best_day_ID]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-04-17"</code></pre>
</div>
</div>
</section></section><section id="ファクター型と日付型" class="level2" data-number="3.7"><h2 data-number="3.7" class="anchored" data-anchor-id="ファクター型と日付型">
<span class="header-section-number">3.7</span> ファクター型と日付型</h2>
<section id="ファクター型入門" class="level3" data-number="3.7.1"><h3 data-number="3.7.1" class="anchored" data-anchor-id="ファクター型入門">
<span class="header-section-number">3.7.1</span> ファクター型入門</h3>
<p>ファクター型あるいは因子型(factor)は，カテゴリカル変数を表現するためのデータ型で，分かりづらいものの，非常に便利かつ重要なデータの型なので，しっかり理解しておきましょう。</p>
<p>数値型や文字列型を因子型に変換する方法には，</p>
<ol type="1">
<li>基本関数 <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code>
</li>
<li>
<code>forcats</code>パッケージの<code>as_factor()</code>関数</li>
<li>
<code>forcats</code>パッケージの<code>fct_relevel()</code>関数</li>
</ol>
<p>先ほど読み込んだデータの<code>industry</code>変数は，文字列型ですが，これを因子型に変換してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a>firm_ID <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb94-2"><a href="#cb94-2"></a>name <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Firm A"</span>, <span class="st">"Firm B"</span>, <span class="st">"Firm C"</span>)</span>
<span id="cb94-3"><a href="#cb94-3"></a>industry <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Machinery"</span>, <span class="st">"Chemicals"</span>, <span class="st">"Machinery"</span>)</span>
<span id="cb94-4"><a href="#cb94-4"></a></span>
<span id="cb94-5"><a href="#cb94-5"></a>firm_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb94-6"><a href="#cb94-6"></a>  <span class="at">firm_ID =</span> firm_ID,</span>
<span id="cb94-7"><a href="#cb94-7"></a>  <span class="at">name =</span> name,</span>
<span id="cb94-8"><a href="#cb94-8"></a>  <span class="at">industry =</span> industry</span>
<span id="cb94-9"><a href="#cb94-9"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>この<code>industry</code>変数はカテゴリー変数ですが，文字列型になっているので，因子型に変換してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a>firm_data <span class="ot">&lt;-</span> firm_data <span class="sc">|&gt;</span></span>
<span id="cb95-2"><a href="#cb95-2"></a>    <span class="fu">mutate</span>(</span>
<span id="cb95-3"><a href="#cb95-3"></a>        <span class="at">industry =</span> forcats<span class="sc">::</span><span class="fu">fct_inorder</span>(industry)</span>
<span id="cb95-4"><a href="#cb95-4"></a>        )</span>
<span id="cb95-5"><a href="#cb95-5"></a><span class="fu">class</span>(firm_data<span class="sc">$</span>industry)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "factor"</code></pre>
</div>
</div>
<p><code>forcats</code>パッケージには非常に便利な関数がたくさんあるので，ぜひドキュメントを参照してみてください。代表的なものに</p>
<ul>
<li>
<code>as_factor()</code> : 他の型から因子型に変換</li>
<li>
<code>fct_inorder()</code> : 出現順にレベルを設定</li>
<li>
<code>fct_order()</code> : 頻度順にレベルを設定</li>
<li>
<code>fct_relevel()</code> : レベルの順序を変更</li>
<li>
<code>fct_recode()</code> : レベルの名前を変更</li>
<li>
<code>fct_collapse()</code> : レベルをまとめる</li>
<li>
<code>fct_lump()</code> : 頻度の低いレベルをまとめる</li>
</ul>
<p>があります。</p>
</section><section id="日付型入門" class="level3" data-number="3.7.2"><h3 data-number="3.7.2" class="anchored" data-anchor-id="日付型入門">
<span class="header-section-number">3.7.2</span> 日付型入門</h3>
<p>日付データとは、年月日や時間を表すデータです。 たとえば、“2026-02-03”や”2025-01-01 00:00:01”のような形式で表されます。 日付データは、文字列として記録されていることが多いので、日付型に変換する必要があります。 日付データの操作には<code>tidyverse</code>の<code>lubridate</code>パッケージを使うと便利です。 <code>lubridate</code>パッケージには、日付データを簡単に操作するための関数がたくさんあります。</p>
<ul>
<li>
<code>ymd()</code> : 年月日形式の文字列を日付型に変換</li>
<li>
<code>mdy()</code> : 月日年形式の文字列を日付型に変換</li>
<li>
<code>hms()</code> : 時分秒形式の文字列を時刻型に変換</li>
<li>
<code>ymd_hms()</code> : 年月日時分秒形式の文字列を日付型に変換</li>
<li>
<code>today()</code> : 今日の日付を取得</li>
<li>
<code>now()</code> : 現在の日付と時刻を取得</li>
</ul>
<p>たとえば，次のように日付っぽい値になっている文字列型なら、<code>lubridate</code>パッケージが判別して日付型に変換してくれます。 今回は、<code>2022-01-15</code>のように年月日の形式なので<code>ymd()</code>関数を使います。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a>date <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2022-01-15"</span>, <span class="st">"2023/01/15"</span>)</span>
<span id="cb97-2"><a href="#cb97-2"></a><span class="fu">class</span>(date)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<!-- `read_csv()`関数で読み込んだ`date`変数は，すでに`Date`型になっています。 -->
<p>文字列型の日付データを<code>Date</code>型に変換したい場合は，次のようにします。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a>date <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(date) <span class="co"># 年月日</span></span>
<span id="cb99-2"><a href="#cb99-2"></a>date</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2022-01-15" "2023-01-15"</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a><span class="fu">class</span>(date)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Date"</code></pre>
</div>
</div>
</section></section><section id="外部パッケージ" class="level2" data-number="3.8"><h2 data-number="3.8" class="anchored" data-anchor-id="外部パッケージ">
<span class="header-section-number">3.8</span> 外部パッケージ</h2>
<p><code>pacman</code>パッケージの<code>p_load()</code>関数を使うと，CRANに登録されているパッケージのうち，必要なパッケージを一括でインストール・読み込みできます。 未インストールのパッケージなら自動でインストールして読み込み、インストール済みのパッケージならそのまま読み込みます。 たとえば，<code>tidyverse</code>パッケージと<code>skimr</code>パッケージをインストール・読み込みするには，次のようにします。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, skimr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>まれに，開発中のパッケージをGitHubからインストールしたい場合があります。その場合は，<code>pacman</code>パッケージの<code>p_load_gh()</code>関数を使います。たとえば，<code>username/repo</code>というGitHubリポジトリからパッケージをインストール・読み込みするには，次のようにします。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource r numberLines lineAnchors number-lines code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1"></a>pacman<span class="sc">::</span><span class="fu">p_load_gh</span>(<span class="st">"username/repo"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>これで，GitHubからパッケージがインストールされ，読み込まれます。 <span class="markp">GitHubリポジトリにあるパッケージはCRANに登録されていないため、自己責任で使用してください。</span></p>


<!-- -->

</section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./chapter02.html" class="pagination-link" aria-label="ファイナンス入門">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">ファイナンス入門</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter04.html" class="pagination-link" aria-label="財務データの取得と可視化">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">財務データの取得と可視化</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb105" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb105-1"><a href="#cb105-1"></a><span class="fu">## R言語入門</span></span>
<span id="cb105-2"><a href="#cb105-2"></a></span>
<span id="cb105-3"><a href="#cb105-3"></a><span class="in">```{r setup, filename = "いろいろな設定"}</span></span>
<span id="cb105-4"><a href="#cb105-4"></a><span class="co">#| code-fold: true</span></span>
<span id="cb105-5"><a href="#cb105-5"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, ggthemes, microbenchmark)</span>
<span id="cb105-6"><a href="#cb105-6"></a>mystyle <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb105-7"><a href="#cb105-7"></a>  <span class="fu">theme_economist_white</span>(</span>
<span id="cb105-8"><a href="#cb105-8"></a>    <span class="co"># gray_bg = FALSE,</span></span>
<span id="cb105-9"><a href="#cb105-9"></a>    <span class="at">base_family =</span> <span class="st">"HiraKakuProN-W3"</span></span>
<span id="cb105-10"><a href="#cb105-10"></a>    ),</span>
<span id="cb105-11"><a href="#cb105-11"></a>  <span class="fu">scale_colour_economist</span>(),</span>
<span id="cb105-12"><a href="#cb105-12"></a>  <span class="fu">theme</span>(</span>
<span id="cb105-13"><a href="#cb105-13"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>), <span class="co"># フォントファミリーは上で指定済みなので省略可</span></span>
<span id="cb105-14"><a href="#cb105-14"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb105-15"><a href="#cb105-15"></a>  )</span>
<span id="cb105-16"><a href="#cb105-16"></a>)</span>
<span id="cb105-17"><a href="#cb105-17"></a></span>
<span id="cb105-18"><a href="#cb105-18"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb105-19"><a href="#cb105-19"></a>  <span class="at">class.source =</span> <span class="st">"numberLines lineAnchors"</span></span>
<span id="cb105-20"><a href="#cb105-20"></a><span class="co">#   class.output = "numberLines lineAnchors chunkout"</span></span>
<span id="cb105-21"><a href="#cb105-21"></a>  )</span>
<span id="cb105-22"><a href="#cb105-22"></a><span class="in">```</span></span>
<span id="cb105-23"><a href="#cb105-23"></a></span>
<span id="cb105-24"><a href="#cb105-24"></a>プログラミング言語にはいろんな種類があるけれど、今回学習する**R言語**は、インタプリタ型とよばれるもので、コンパイルという作業の必要が無く、書いたらすぐ実行できる仕様となっています。たとえば、教科書にあるように</span>
<span id="cb105-25"><a href="#cb105-25"></a></span>
<span id="cb105-28"><a href="#cb105-28"></a><span class="in">```{r}</span></span>
<span id="cb105-29"><a href="#cb105-29"></a><span class="dv">100</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb105-30"><a href="#cb105-30"></a><span class="in">```</span></span>
<span id="cb105-31"><a href="#cb105-31"></a></span>
<span id="cb105-32"><a href="#cb105-32"></a>を実行すれば、結果がすぐ表示されます。 RstudioとかVisual Studio CodeとかAntigravityを使って、上のようなRソースコードを一気に書いてまとめて実行するための**スクリプト・ファイル**を作成します。</span>
<span id="cb105-33"><a href="#cb105-33"></a></span>
<span id="cb105-34"><a href="#cb105-34"></a>ソースコードを書くにあたり注意する点が4つあります。</span>
<span id="cb105-35"><a href="#cb105-35"></a></span>
<span id="cb105-36"><a href="#cb105-36"></a><span class="ss">1.  </span>**大文字と小文字は区別される**ので、<span class="in">`x`</span>と<span class="in">`X`</span>は別の変数として扱われます。</span>
<span id="cb105-37"><a href="#cb105-37"></a><span class="ss">2.  </span>**半角スペース**は、**区切り文字**として扱われるので、<span class="in">`x &lt;- 100`</span>と<span class="in">`x&lt;-100`</span>は同じ意味になります。</span>
<span id="cb105-38"><a href="#cb105-38"></a><span class="ss">3.  </span>**改行**も、**区切り文字**として扱われます。長いソースコードは改行して読みやすくしましょう。</span>
<span id="cb105-39"><a href="#cb105-39"></a><span class="ss">4.  </span>**コメント**は、<span class="in">`#`</span>から行末までの文字列がコメントとして扱われ、実行されません。プログラムの内容を説明するためにたくさん書いて残しておきましょう。</span>
<span id="cb105-40"><a href="#cb105-40"></a></span>
<span id="cb105-41"><a href="#cb105-41"></a></span>
<span id="cb105-42"><a href="#cb105-42"></a></span>
<span id="cb105-43"><a href="#cb105-43"></a></span>
<span id="cb105-44"><a href="#cb105-44"></a><span class="fu">## Rの基本的な機能</span></span>
<span id="cb105-45"><a href="#cb105-45"></a></span>
<span id="cb105-46"><a href="#cb105-46"></a><span class="fu">### スカラー変数の定義</span></span>
<span id="cb105-47"><a href="#cb105-47"></a></span>
<span id="cb105-48"><a href="#cb105-48"></a>この学習を通じて**変数**(variable)とは、**数値や文字といったデータを格納するための箱**を表し、中に何が入っているのかにより、スカラー変数、ベクトル、行列、データフレームなどに分類されます。まずは、スカラー変数の定義を学びます。</span>
<span id="cb105-49"><a href="#cb105-49"></a></span>
<span id="cb105-50"><a href="#cb105-50"></a>スカラー(scalar)とは、大きさだけで決まる量のことで、つまり、**1つの数値**を指します。 R言語ではスカラー変数を定義するには、`&lt;-`を使います。たとえば、`x &lt;- 100`と書けば、xというスカラー変数に100という数値を格納できます。このとき、`&lt;-`は代入演算子と呼ばれ、右辺の値を左辺の変数に代入するという意味です。また、`x`という変数を**左辺値**(left-hand side)、`100`という数値を**右辺値**(right-hand side)と呼びます。</span>
<span id="cb105-51"><a href="#cb105-51"></a></span>
<span id="cb105-54"><a href="#cb105-54"></a><span class="in">```{r}</span></span>
<span id="cb105-55"><a href="#cb105-55"></a>x <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># 代入演算子&lt;- の前後に半角スペースを入れるのがお作法</span></span>
<span id="cb105-56"><a href="#cb105-56"></a><span class="in">```</span></span>
<span id="cb105-57"><a href="#cb105-57"></a></span>
<span id="cb105-58"><a href="#cb105-58"></a>この中身を表示されるには、<span class="in">`print()`</span>関数を使います。</span>
<span id="cb105-59"><a href="#cb105-59"></a></span>
<span id="cb105-62"><a href="#cb105-62"></a><span class="in">```{r}</span></span>
<span id="cb105-63"><a href="#cb105-63"></a><span class="fu">print</span>(x) <span class="co"># xの中身を表示</span></span>
<span id="cb105-64"><a href="#cb105-64"></a><span class="in">```</span></span>
<span id="cb105-65"><a href="#cb105-65"></a></span>
<span id="cb105-66"><a href="#cb105-66"></a>あるいは</span>
<span id="cb105-67"><a href="#cb105-67"></a></span>
<span id="cb105-70"><a href="#cb105-70"></a><span class="in">```{r}</span></span>
<span id="cb105-71"><a href="#cb105-71"></a>x</span>
<span id="cb105-72"><a href="#cb105-72"></a><span class="in">```</span></span>
<span id="cb105-73"><a href="#cb105-73"></a></span>
<span id="cb105-74"><a href="#cb105-74"></a>でも表示されます。</span>
<span id="cb105-75"><a href="#cb105-75"></a></span>
<span id="cb105-76"><a href="#cb105-76"></a><span class="dt">&lt;</span><span class="kw">aside</span><span class="dt">&gt;</span>Rでは<span class="in">`#`</span>の後ろの文章はコメントとして扱われ、実行されません。コメントはプログラムの内容を説明するためにたくさん書いて残しておきましょう。<span class="dt">&lt;/</span><span class="kw">aside</span><span class="dt">&gt;</span></span>
<span id="cb105-77"><a href="#cb105-77"></a></span>
<span id="cb105-78"><a href="#cb105-78"></a><span class="fu">### ベクトル変数の定義</span></span>
<span id="cb105-79"><a href="#cb105-79"></a></span>
<span id="cb105-80"><a href="#cb105-80"></a>**ベクトル**(vector)とは、大きさと向きで決まる量のことで、つまり、**複数の数値**を指します。R言語ではベクトル変数を定義するには、<span class="in">`c()`</span>を使います。たとえば、<span class="in">`x &lt;- c(1, 2, 3)`</span>と書けば、xというベクトル変数に1, 2, 3という数値を格納できます。このとき、<span class="in">`c()`</span>はベクトルを作る関数と呼ばれ、<span class="in">`1, 2, 3`</span>という数値を引数として与えています。</span>
<span id="cb105-81"><a href="#cb105-81"></a></span>
<span id="cb105-84"><a href="#cb105-84"></a><span class="in">```{r}</span></span>
<span id="cb105-85"><a href="#cb105-85"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">9</span>) <span class="co"># xに1と5と9を要素とするベクトルを代入</span></span>
<span id="cb105-86"><a href="#cb105-86"></a><span class="fu">print</span>(x)</span>
<span id="cb105-87"><a href="#cb105-87"></a><span class="in">```</span></span>
<span id="cb105-88"><a href="#cb105-88"></a></span>
<span id="cb105-89"><a href="#cb105-89"></a>等差数列を作る関数に<span class="in">`seq()`</span>関数があります。<span class="in">`seq()`</span>は3つの引数をとり、</span>
<span id="cb105-90"><a href="#cb105-90"></a></span>
<span id="cb105-91"><a href="#cb105-91"></a><span class="ss">-   </span><span class="in">`from`</span> : 始点</span>
<span id="cb105-92"><a href="#cb105-92"></a><span class="ss">-   </span><span class="in">`to`</span> : 終点</span>
<span id="cb105-93"><a href="#cb105-93"></a><span class="ss">-   </span><span class="in">`by`</span> : 差分</span>
<span id="cb105-94"><a href="#cb105-94"></a></span>
<span id="cb105-95"><a href="#cb105-95"></a>を指定します。たとえば、2000年から2020年を表す年度の変数を<span class="in">`year`</span>として定義するには、</span>
<span id="cb105-96"><a href="#cb105-96"></a></span>
<span id="cb105-99"><a href="#cb105-99"></a><span class="in">```{r}</span></span>
<span id="cb105-100"><a href="#cb105-100"></a>year <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">2000</span>, <span class="at">to =</span> <span class="dv">2020</span>, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb105-101"><a href="#cb105-101"></a><span class="fu">print</span>(year)</span>
<span id="cb105-102"><a href="#cb105-102"></a><span class="in">```</span></span>
<span id="cb105-103"><a href="#cb105-103"></a></span>
<span id="cb105-104"><a href="#cb105-104"></a>と書けば、2000から2020までの公差1の等差数列を作ります。 <span class="in">`seq()`</span>変数の引数には、<span class="in">`from`</span>と<span class="in">`to`</span>と<span class="in">`by`</span>の3つの引数を指定することができますが、<span class="in">`from`</span>と<span class="in">`to`</span>のみを指定することもできます。このとき、<span class="in">`by`</span>の値は1となります。次のように書いても、上と同じ結果を得ることができます。</span>
<span id="cb105-105"><a href="#cb105-105"></a></span>
<span id="cb105-108"><a href="#cb105-108"></a><span class="in">```{r}</span></span>
<span id="cb105-109"><a href="#cb105-109"></a><span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>)</span>
<span id="cb105-110"><a href="#cb105-110"></a><span class="in">```</span></span>
<span id="cb105-111"><a href="#cb105-111"></a></span>
<span id="cb105-112"><a href="#cb105-112"></a>ベクトルの要素数を知るには、<span class="in">`length()`</span>関数を使います。</span>
<span id="cb105-113"><a href="#cb105-113"></a></span>
<span id="cb105-116"><a href="#cb105-116"></a><span class="in">```{r}</span></span>
<span id="cb105-117"><a href="#cb105-117"></a><span class="fu">length</span>(year) <span class="co"># yearの要素数を表示</span></span>
<span id="cb105-118"><a href="#cb105-118"></a><span class="in">```</span></span>
<span id="cb105-119"><a href="#cb105-119"></a></span>
<span id="cb105-120"><a href="#cb105-120"></a>ベクトル変数<span class="in">`year`</span>の中には21個の要素があることがわかります。</span>
<span id="cb105-121"><a href="#cb105-121"></a></span>
<span id="cb105-122"><a href="#cb105-122"></a><span class="fu">#### ベクトルの要素の取り出し</span></span>
<span id="cb105-123"><a href="#cb105-123"></a></span>
<span id="cb105-124"><a href="#cb105-124"></a>複数の要素をもつベクトルから、一部の要素を取り出すには、<span class="in">`[]`</span>を使います。たとえば、<span class="in">`x`</span>の2番目の要素を取り出すには、<span class="in">`x[2]`</span>と書きます。このとき、<span class="in">`[]`</span>は添字演算子と呼ばれ、<span class="in">`2`</span>という添字を引数として与えています。添字は1から始まります。</span>
<span id="cb105-125"><a href="#cb105-125"></a></span>
<span id="cb105-126"><a href="#cb105-126"></a>上の<span class="in">`year`</span>から2000を取り出すには、<span class="in">`year[1]`</span>、2020を取り出すには<span class="in">`year[20]`</span>と書きます。 次のような書き方で、好きな要素を指定して取り出すことができます。</span>
<span id="cb105-127"><a href="#cb105-127"></a></span>
<span id="cb105-130"><a href="#cb105-130"></a><span class="in">```{r}</span></span>
<span id="cb105-131"><a href="#cb105-131"></a>year[<span class="dv">1</span>] <span class="co"># 1番目のデータを取り出す</span></span>
<span id="cb105-132"><a href="#cb105-132"></a>year[<span class="dv">20</span>] <span class="co"># 20番目のデータを取り出す</span></span>
<span id="cb105-133"><a href="#cb105-133"></a>year[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>] <span class="co"># 2番目から5番目のデータを取り出す</span></span>
<span id="cb105-134"><a href="#cb105-134"></a>year[<span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">10</span>)] <span class="co"># 1番目と20番目のデータを取り出す</span></span>
<span id="cb105-135"><a href="#cb105-135"></a>year[<span class="dv">6</span><span class="sc">:</span><span class="fu">length</span>(year)] <span class="co"># 6番目から最後のデータを取り出す</span></span>
<span id="cb105-136"><a href="#cb105-136"></a><span class="in">```</span></span>
<span id="cb105-137"><a href="#cb105-137"></a></span>
<span id="cb105-138"><a href="#cb105-138"></a><span class="fu">#### 現在価値の計算</span></span>
<span id="cb105-139"><a href="#cb105-139"></a></span>
<span id="cb105-140"><a href="#cb105-140"></a>今の時点を$t=0$として、$T$年後に確実に得られるキャッシュ・フロー$CF_T$の現在価値$PV_0$は、</span>
<span id="cb105-141"><a href="#cb105-141"></a></span>
<span id="cb105-142"><a href="#cb105-142"></a>$$</span>
<span id="cb105-143"><a href="#cb105-143"></a>PV_0 = \frac{CF_T}{(1+r)^T}</span>
<span id="cb105-144"><a href="#cb105-144"></a>$$</span>
<span id="cb105-145"><a href="#cb105-145"></a></span>
<span id="cb105-146"><a href="#cb105-146"></a>と書けます。たとえば1年後に確実に受け取れる100万円の現在価値$PV_0$を計算してみます。</span>
<span id="cb105-147"><a href="#cb105-147"></a>いま、無リスク利子率$r$は10%とします。</span>
<span id="cb105-148"><a href="#cb105-148"></a></span>
<span id="cb105-151"><a href="#cb105-151"></a><span class="in">```{r}</span></span>
<span id="cb105-152"><a href="#cb105-152"></a><span class="dv">100</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)<span class="sc">^</span><span class="dv">1</span></span>
<span id="cb105-153"><a href="#cb105-153"></a><span class="in">```</span></span>
<span id="cb105-154"><a href="#cb105-154"></a></span>
<span id="cb105-155"><a href="#cb105-155"></a>次に、この無リスク利子率$r$が変化した場合の現在価値の計算を考えます。まず、無リスク利子率のベクトルを定義します。</span>
<span id="cb105-156"><a href="#cb105-156"></a></span>
<span id="cb105-159"><a href="#cb105-159"></a><span class="in">```{r}</span></span>
<span id="cb105-160"><a href="#cb105-160"></a><span class="co"># 下の２つは同じ結果</span></span>
<span id="cb105-161"><a href="#cb105-161"></a>R <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.1</span>, <span class="at">to =</span> <span class="fl">0.2</span>, <span class="at">by =</span> <span class="fl">0.01</span>)　<span class="co"># 省略せずに書いた場合</span></span>
<span id="cb105-162"><a href="#cb105-162"></a>R <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>) <span class="co"># 略した場合</span></span>
<span id="cb105-163"><a href="#cb105-163"></a><span class="in">```</span></span>
<span id="cb105-164"><a href="#cb105-164"></a></span>
<span id="cb105-165"><a href="#cb105-165"></a>次に、無リスク利子率が変化した場合の現在価値を計算します。</span>
<span id="cb105-166"><a href="#cb105-166"></a></span>
<span id="cb105-169"><a href="#cb105-169"></a><span class="in">```{r}</span></span>
<span id="cb105-170"><a href="#cb105-170"></a>PV <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">1</span></span>
<span id="cb105-171"><a href="#cb105-171"></a><span class="fu">print</span>(PV)</span>
<span id="cb105-172"><a href="#cb105-172"></a><span class="in">```</span></span>
<span id="cb105-173"><a href="#cb105-173"></a></span>
<span id="cb105-174"><a href="#cb105-174"></a>無リスク利子率が0.1から0.2まで0.01ずつ変化した場合の現在価値が計算されました。この結果をグラフにしてみます。</span>
<span id="cb105-175"><a href="#cb105-175"></a></span>
<span id="cb105-176"><a href="#cb105-176"></a><span class="fu">### 基本パッケージ`plot`による作図</span></span>
<span id="cb105-177"><a href="#cb105-177"></a></span>
<span id="cb105-178"><a href="#cb105-178"></a>とりあえずサクッと作図してデータをチェックしたいとき、もとからR言語に組み込まれている基本関数<span class="in">`plot()`</span>が便利です。先ほど作成したベクトル変数<span class="in">`PV`</span>をグラフにしてみます。</span>
<span id="cb105-179"><a href="#cb105-179"></a></span>
<span id="cb105-182"><a href="#cb105-182"></a><span class="in">```{r}</span></span>
<span id="cb105-183"><a href="#cb105-183"></a><span class="fu">plot</span>(PV)</span>
<span id="cb105-184"><a href="#cb105-184"></a><span class="in">```</span></span>
<span id="cb105-185"><a href="#cb105-185"></a></span>
<span id="cb105-186"><a href="#cb105-186"></a>いま、<span class="in">`PV`</span>は11個の要素をもつベクトル変数なので、データを左から順番に並べた散布図(scatter diagram)が作成されています。これだと何のグラフか分かりづらいので、いろいろとオプションを指定してみます。</span>
<span id="cb105-187"><a href="#cb105-187"></a></span>
<span id="cb105-190"><a href="#cb105-190"></a><span class="in">```{r}</span></span>
<span id="cb105-191"><a href="#cb105-191"></a><span class="fu">plot</span>(</span>
<span id="cb105-192"><a href="#cb105-192"></a>    <span class="at">x =</span> R, <span class="co"># x軸のデータ</span></span>
<span id="cb105-193"><a href="#cb105-193"></a>    <span class="at">y =</span> PV, <span class="co"># y軸のデータ</span></span>
<span id="cb105-194"><a href="#cb105-194"></a>    <span class="at">xlab =</span> <span class="st">"無リスク利子率"</span>,</span>
<span id="cb105-195"><a href="#cb105-195"></a>    <span class="at">ylab =</span> <span class="st">"現在価値"</span>,</span>
<span id="cb105-196"><a href="#cb105-196"></a>    <span class="at">main =</span> <span class="st">"無リスク利子率と現在価値の関係"</span>,</span>
<span id="cb105-197"><a href="#cb105-197"></a>    <span class="at">type =</span> <span class="st">"l"</span> <span class="co"># 線グラフ</span></span>
<span id="cb105-198"><a href="#cb105-198"></a>)</span>
<span id="cb105-199"><a href="#cb105-199"></a><span class="in">```</span></span>
<span id="cb105-200"><a href="#cb105-200"></a></span>
<span id="cb105-201"><a href="#cb105-201"></a>Macだと文字化けしてしまいました。そこで文字コードを指定します。Windowsだとこの作業は不要です。</span>
<span id="cb105-202"><a href="#cb105-202"></a></span>
<span id="cb105-205"><a href="#cb105-205"></a><span class="in">```{r}</span></span>
<span id="cb105-206"><a href="#cb105-206"></a><span class="fu">par</span>(<span class="at">family =</span> <span class="st">"HiraKakuProN-W3"</span>) <span class="co"># Macの場合のみ</span></span>
<span id="cb105-207"><a href="#cb105-207"></a><span class="fu">plot</span>(</span>
<span id="cb105-208"><a href="#cb105-208"></a>    <span class="at">x =</span> R, <span class="co"># x軸のデータ</span></span>
<span id="cb105-209"><a href="#cb105-209"></a>    <span class="at">y =</span> PV, <span class="co"># y軸のデータ</span></span>
<span id="cb105-210"><a href="#cb105-210"></a>    <span class="at">xlab =</span> <span class="st">"無リスク利子率"</span>, <span class="co"># x軸のラベル</span></span>
<span id="cb105-211"><a href="#cb105-211"></a>    <span class="at">ylab =</span> <span class="st">"現在価値"</span>, <span class="co"># y軸のラベル</span></span>
<span id="cb105-212"><a href="#cb105-212"></a>    <span class="at">main =</span> <span class="st">"無リスク利子率と現在価値の関係"</span>, <span class="co"># グラフのタイトル</span></span>
<span id="cb105-213"><a href="#cb105-213"></a>    <span class="at">type =</span> <span class="st">"l"</span> <span class="co"># 折れ線グラフ</span></span>
<span id="cb105-214"><a href="#cb105-214"></a>)</span>
<span id="cb105-215"><a href="#cb105-215"></a><span class="in">```</span></span>
<span id="cb105-216"><a href="#cb105-216"></a></span>
<span id="cb105-217"><a href="#cb105-217"></a><span class="fu">## `for`文の使い方</span></span>
<span id="cb105-218"><a href="#cb105-218"></a></span>
<span id="cb105-219"><a href="#cb105-219"></a>プログラミングの基本要素である</span>
<span id="cb105-220"><a href="#cb105-220"></a></span>
<span id="cb105-221"><a href="#cb105-221"></a><span class="ss">-   </span>繰り返し</span>
<span id="cb105-222"><a href="#cb105-222"></a><span class="ss">-   </span>分岐</span>
<span id="cb105-223"><a href="#cb105-223"></a><span class="ss">-   </span>関数</span>
<span id="cb105-224"><a href="#cb105-224"></a></span>
<span id="cb105-225"><a href="#cb105-225"></a>の最初の要素である「繰り返し」を行うための文法が<span class="in">`for`</span>文です。<span class="in">`for`</span>文は、ある処理を繰り返し行うための文法です。たとえば、1から10までの整数を順番に表示するには、次のように書きます。</span>
<span id="cb105-226"><a href="#cb105-226"></a></span>
<span id="cb105-229"><a href="#cb105-229"></a><span class="in">```{r}</span></span>
<span id="cb105-230"><a href="#cb105-230"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) { <span class="co"># iは1から10まで</span></span>
<span id="cb105-231"><a href="#cb105-231"></a>    <span class="fu">print</span>(i) <span class="co"># iを表示</span></span>
<span id="cb105-232"><a href="#cb105-232"></a>}</span>
<span id="cb105-233"><a href="#cb105-233"></a><span class="in">```</span></span>
<span id="cb105-234"><a href="#cb105-234"></a></span>
<span id="cb105-235"><a href="#cb105-235"></a>この文の構造は、基本的には</span>
<span id="cb105-236"><a href="#cb105-236"></a></span>
<span id="cb105-237"><a href="#cb105-237"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb105-238"><a href="#cb105-238"></a><span class="cf">for</span> (好きな変数 <span class="cf">in</span> 繰り返す範囲) {</span>
<span id="cb105-239"><a href="#cb105-239"></a>    繰り返したい処理</span>
<span id="cb105-240"><a href="#cb105-240"></a>}</span>
<span id="cb105-241"><a href="#cb105-241"></a><span class="in">```</span></span>
<span id="cb105-242"><a href="#cb105-242"></a></span>
<span id="cb105-243"><a href="#cb105-243"></a>となっています。</span>
<span id="cb105-244"><a href="#cb105-244"></a></span>
<span id="cb105-245"><a href="#cb105-245"></a>たとえば、教科書のように、</span>
<span id="cb105-246"><a href="#cb105-246"></a></span>
<span id="cb105-247"><a href="#cb105-247"></a><span class="ss">-   </span>初期投資100万円</span>
<span id="cb105-248"><a href="#cb105-248"></a><span class="ss">-   </span>1年後に50万円のキャッシュ・フロー</span>
<span id="cb105-249"><a href="#cb105-249"></a><span class="ss">-   </span>2年後に50万円のキャッシュ・フロー</span>
<span id="cb105-250"><a href="#cb105-250"></a><span class="ss">-   </span>3年後に50万円のキャッシュ・フロー</span>
<span id="cb105-251"><a href="#cb105-251"></a></span>
<span id="cb105-252"><a href="#cb105-252"></a>という投資プロジェクトの現在価値を計算する場合、愚直に書くと次のようになります。</span>
<span id="cb105-253"><a href="#cb105-253"></a></span>
<span id="cb105-256"><a href="#cb105-256"></a><span class="in">```{r}</span></span>
<span id="cb105-257"><a href="#cb105-257"></a>NPV1 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="sc">+</span></span>
<span id="cb105-258"><a href="#cb105-258"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)<span class="sc">^</span><span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb105-259"><a href="#cb105-259"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb105-260"><a href="#cb105-260"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.1</span>)<span class="sc">^</span><span class="dv">3</span></span>
<span id="cb105-261"><a href="#cb105-261"></a><span class="fu">print</span>(NPV1)</span>
<span id="cb105-262"><a href="#cb105-262"></a><span class="in">```</span></span>
<span id="cb105-263"><a href="#cb105-263"></a></span>
<span id="cb105-264"><a href="#cb105-264"></a>この上のコードの2行目から4行目はほぼ同じ内容なので、数字が変化しているところに注目し、<span class="in">`for`</span>文を使って書き換えてみます。ここでは<span class="in">`^1`</span>のところが1ずつ大きくなってます。この部分を<span class="in">`i`</span>という変数に置き換えてみます。 ついでに、後で変化させることがあるかもしれない部分をすべて変数として定義しておきます。</span>
<span id="cb105-265"><a href="#cb105-265"></a></span>
<span id="cb105-268"><a href="#cb105-268"></a><span class="in">```{r}</span></span>
<span id="cb105-269"><a href="#cb105-269"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb105-270"><a href="#cb105-270"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb105-271"><a href="#cb105-271"></a>CF <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="co"># キャッシュ・フロー</span></span>
<span id="cb105-272"><a href="#cb105-272"></a></span>
<span id="cb105-273"><a href="#cb105-273"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) { <span class="co"># iは1から3まで</span></span>
<span id="cb105-274"><a href="#cb105-274"></a>    NPV <span class="ot">&lt;-</span> NPV <span class="sc">+</span> CF <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>i <span class="co"># 現在価値の計算</span></span>
<span id="cb105-275"><a href="#cb105-275"></a>}</span>
<span id="cb105-276"><a href="#cb105-276"></a><span class="fu">print</span>(NPV)</span>
<span id="cb105-277"><a href="#cb105-277"></a><span class="in">```</span></span>
<span id="cb105-278"><a href="#cb105-278"></a></span>
<span id="cb105-279"><a href="#cb105-279"></a>愚直に計算した場合の同じ結果となりました。 これを10年間の現在価値を計算する場合だとすると、</span>
<span id="cb105-280"><a href="#cb105-280"></a></span>
<span id="cb105-283"><a href="#cb105-283"></a><span class="in">```{r}</span></span>
<span id="cb105-284"><a href="#cb105-284"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb105-285"><a href="#cb105-285"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb105-286"><a href="#cb105-286"></a>NPV1 <span class="ot">&lt;-</span> NPV <span class="sc">+</span></span>
<span id="cb105-287"><a href="#cb105-287"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb105-288"><a href="#cb105-288"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb105-289"><a href="#cb105-289"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb105-290"><a href="#cb105-290"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">4</span> <span class="sc">+</span></span>
<span id="cb105-291"><a href="#cb105-291"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">5</span> <span class="sc">+</span></span>
<span id="cb105-292"><a href="#cb105-292"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">6</span> <span class="sc">+</span></span>
<span id="cb105-293"><a href="#cb105-293"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">7</span> <span class="sc">+</span></span>
<span id="cb105-294"><a href="#cb105-294"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">8</span> <span class="sc">+</span></span>
<span id="cb105-295"><a href="#cb105-295"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">9</span> <span class="sc">+</span></span>
<span id="cb105-296"><a href="#cb105-296"></a>    <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span><span class="dv">10</span></span>
<span id="cb105-297"><a href="#cb105-297"></a><span class="fu">print</span>(NPV1)</span>
<span id="cb105-298"><a href="#cb105-298"></a><span class="in">```</span></span>
<span id="cb105-299"><a href="#cb105-299"></a></span>
<span id="cb105-300"><a href="#cb105-300"></a>と面倒くさいことこの上ないですが、<span class="in">`for`</span>文を使えば、</span>
<span id="cb105-301"><a href="#cb105-301"></a></span>
<span id="cb105-304"><a href="#cb105-304"></a><span class="in">```{r}</span></span>
<span id="cb105-305"><a href="#cb105-305"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb105-306"><a href="#cb105-306"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb105-307"><a href="#cb105-307"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) { <span class="co"># iは1から10まで</span></span>
<span id="cb105-308"><a href="#cb105-308"></a>    NPV <span class="ot">&lt;-</span> NPV <span class="sc">+</span> <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>i</span>
<span id="cb105-309"><a href="#cb105-309"></a>}</span>
<span id="cb105-310"><a href="#cb105-310"></a><span class="fu">print</span>(NPV)</span>
<span id="cb105-311"><a href="#cb105-311"></a><span class="in">```</span></span>
<span id="cb105-312"><a href="#cb105-312"></a></span>
<span id="cb105-313"><a href="#cb105-313"></a>と短く書くことができます。</span>
<span id="cb105-314"><a href="#cb105-314"></a>使いこなせるように練習しておきましょう。</span>
<span id="cb105-315"><a href="#cb105-315"></a>次のように、<span class="in">`print()`</span>関数の位置を変えた場合、どうなるか考えてみてください。</span>
<span id="cb105-316"><a href="#cb105-316"></a></span>
<span id="cb105-319"><a href="#cb105-319"></a><span class="in">```{r}</span></span>
<span id="cb105-320"><a href="#cb105-320"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb105-321"><a href="#cb105-321"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb105-322"><a href="#cb105-322"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) { <span class="co"># iは1から10まで</span></span>
<span id="cb105-323"><a href="#cb105-323"></a>    <span class="fu">print</span>(NPV)</span>
<span id="cb105-324"><a href="#cb105-324"></a>    NPV <span class="ot">&lt;-</span> NPV <span class="sc">+</span> <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>i</span>
<span id="cb105-325"><a href="#cb105-325"></a>}</span>
<span id="cb105-326"><a href="#cb105-326"></a><span class="fu">print</span>(NPV)</span>
<span id="cb105-327"><a href="#cb105-327"></a><span class="in">```</span></span>
<span id="cb105-328"><a href="#cb105-328"></a></span>
<span id="cb105-329"><a href="#cb105-329"></a>この場合、最初にNPVの中を表示し、次に1期目の現在価値を計算し、またその結果を表示し、2期目の現在価値を計算し・・・という順番で繰り返しが行われるので、計算の途中経過が表示されることになります。</span>
<span id="cb105-330"><a href="#cb105-330"></a></span>
<span id="cb105-331"><a href="#cb105-331"></a><span class="fu">### `if`文</span></span>
<span id="cb105-332"><a href="#cb105-332"></a></span>
<span id="cb105-333"><a href="#cb105-333"></a>次に、プログラミングの基本要素である</span>
<span id="cb105-334"><a href="#cb105-334"></a></span>
<span id="cb105-335"><a href="#cb105-335"></a><span class="ss">-   </span>繰り返し</span>
<span id="cb105-336"><a href="#cb105-336"></a><span class="ss">-   </span>**分岐**</span>
<span id="cb105-337"><a href="#cb105-337"></a><span class="ss">-   </span>関数</span>
<span id="cb105-338"><a href="#cb105-338"></a></span>
<span id="cb105-339"><a href="#cb105-339"></a>のうち分岐を行うための文法が<span class="in">`if`</span>文です。<span class="in">`if`</span>文は、ある条件を満たす場合にのみ処理を行うための文法です。たとえば、ある変数<span class="in">`x`</span>が0より大きい場合にのみ、その変数を表示するには、次のように書きます。</span>
<span id="cb105-340"><a href="#cb105-340"></a></span>
<span id="cb105-343"><a href="#cb105-343"></a><span class="in">```{r}</span></span>
<span id="cb105-344"><a href="#cb105-344"></a>x <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb105-345"><a href="#cb105-345"></a><span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co"># xが0より大きい場合</span></span>
<span id="cb105-346"><a href="#cb105-346"></a>    <span class="fu">print</span>(x) <span class="co"># xを表示</span></span>
<span id="cb105-347"><a href="#cb105-347"></a>}</span>
<span id="cb105-348"><a href="#cb105-348"></a><span class="in">```</span></span>
<span id="cb105-349"><a href="#cb105-349"></a></span>
<span id="cb105-350"><a href="#cb105-350"></a>この文の構造は、基本的には</span>
<span id="cb105-351"><a href="#cb105-351"></a></span>
<span id="cb105-352"><a href="#cb105-352"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb105-353"><a href="#cb105-353"></a><span class="cf">if</span> (条件) {</span>
<span id="cb105-354"><a href="#cb105-354"></a>    条件を満たす場合に実行する処理</span>
<span id="cb105-355"><a href="#cb105-355"></a>}</span>
<span id="cb105-356"><a href="#cb105-356"></a><span class="in">```</span></span>
<span id="cb105-357"><a href="#cb105-357"></a></span>
<span id="cb105-358"><a href="#cb105-358"></a>のようになっています。 この<span class="in">`if`</span>文を使って、NPVが0より大きい場合にのみ、「プロジェクトを実行！」と表示されるようにしてみます。</span>
<span id="cb105-359"><a href="#cb105-359"></a></span>
<span id="cb105-362"><a href="#cb105-362"></a><span class="in">```{r}</span></span>
<span id="cb105-363"><a href="#cb105-363"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率</span></span>
<span id="cb105-364"><a href="#cb105-364"></a>NPV <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb105-365"><a href="#cb105-365"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) { <span class="co"># iは1から10まで</span></span>
<span id="cb105-366"><a href="#cb105-366"></a>    NPV <span class="ot">&lt;-</span> NPV <span class="sc">+</span> <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>i</span>
<span id="cb105-367"><a href="#cb105-367"></a>}</span>
<span id="cb105-368"><a href="#cb105-368"></a><span class="cf">if</span> (NPV <span class="sc">&gt;</span> <span class="dv">0</span>) { <span class="co"># NPVが0より大きい場合</span></span>
<span id="cb105-369"><a href="#cb105-369"></a>    <span class="fu">print</span>(<span class="st">"プロジェクトを実行！"</span>) <span class="co"># 文字列を表示</span></span>
<span id="cb105-370"><a href="#cb105-370"></a>}</span>
<span id="cb105-371"><a href="#cb105-371"></a></span>
<span id="cb105-372"><a href="#cb105-372"></a><span class="in">```</span></span>
<span id="cb105-373"><a href="#cb105-373"></a></span>
<span id="cb105-374"><a href="#cb105-374"></a>ここではNPVの値が<span class="in">`207.2284`</span>となりプラスになっているので、「プロジェクトを実行！」と表示されます。</span>
<span id="cb105-375"><a href="#cb105-375"></a></span>
<span id="cb105-376"><a href="#cb105-376"></a><span class="fu">## NPVと割引率の関係の可視化</span></span>
<span id="cb105-377"><a href="#cb105-377"></a></span>
<span id="cb105-378"><a href="#cb105-378"></a>無リスク利子率が0.1から0.2まで0.01ずつ変化した場合の現在価値NPVの値を計算してみます。</span>
<span id="cb105-379"><a href="#cb105-379"></a></span>
<span id="cb105-382"><a href="#cb105-382"></a><span class="in">```{r}</span></span>
<span id="cb105-383"><a href="#cb105-383"></a>R <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>) <span class="co"># 無リスク利子率</span></span>
<span id="cb105-384"><a href="#cb105-384"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(R) <span class="co"># 無リスク利子率の要素数 11個</span></span>
<span id="cb105-385"><a href="#cb105-385"></a>NPV <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, N) <span class="co"># ベクトル変数にN個のNAを代入</span></span>
<span id="cb105-386"><a href="#cb105-386"></a></span>
<span id="cb105-387"><a href="#cb105-387"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) { <span class="co"># iは1からNまで</span></span>
<span id="cb105-388"><a href="#cb105-388"></a>    NPV[i] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">100</span> <span class="co"># 初期投資</span></span>
<span id="cb105-389"><a href="#cb105-389"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) { <span class="co"># jは1から3まで</span></span>
<span id="cb105-390"><a href="#cb105-390"></a>        NPV[i] <span class="ot">&lt;-</span> NPV[i] <span class="sc">+</span> <span class="dv">50</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R[i])<span class="sc">^</span>j <span class="co"># 現在価値</span></span>
<span id="cb105-391"><a href="#cb105-391"></a>    }</span>
<span id="cb105-392"><a href="#cb105-392"></a>}</span>
<span id="cb105-393"><a href="#cb105-393"></a><span class="fu">print</span>(NPV) <span class="co"># 11個の現在価値を表示</span></span>
<span id="cb105-394"><a href="#cb105-394"></a><span class="in">```</span></span>
<span id="cb105-395"><a href="#cb105-395"></a></span>
<span id="cb105-396"><a href="#cb105-396"></a>少し複雑な構造しているので、順番に説明します。</span>
<span id="cb105-397"><a href="#cb105-397"></a></span>
<span id="cb105-398"><a href="#cb105-398"></a><span class="ss">-   </span>1行目は、無リスク利子率のベクトル変数<span class="in">`R`</span>を定義しています。ここでは、0.1から0.2まで0.01刻みのデータを作成しています。</span>
<span id="cb105-399"><a href="#cb105-399"></a><span class="ss">-   </span>2行目は、ベクトル変数<span class="in">`R`</span>の要素数を<span class="in">`N`</span>として定義しています。ここでは、<span class="in">`N`</span>は11となります。</span>
<span id="cb105-400"><a href="#cb105-400"></a><span class="ss">-   </span>3行目は、ベクトル変数<span class="in">`NPV`</span>に<span class="in">`N`</span>個の<span class="in">`NA`</span>を代入しています。<span class="in">`NA`</span>はNot Availableの略で、欠損値を表します。<span class="in">`NA`</span>を代入することで、空っぽの箱が11個入ったベクトル変数<span class="in">`NPV`</span>を用意します。</span>
<span id="cb105-401"><a href="#cb105-401"></a><span class="ss">-   </span>4行目から9行目は、<span class="in">`for`</span>文を使って、<span class="in">`NPV`</span>の中身を計算しています。 <span class="in">`for`</span>が2回出てきているので、二重に繰り返しの処理を行っています。これを**ネスト**と呼びます。 1つのめ<span class="in">`for`</span>は<span class="in">`i`</span>が1からN(ここでは11)まで変化し、2つめの<span class="in">`for`</span>は<span class="in">`j`</span>が1から3まで変化します。1つめの<span class="in">`for`</span>文のiが1のとき、次の<span class="in">`for`</span>文の<span class="in">`j`</span>が1から3までの処理を繰り返し、次に1つめの<span class="in">`for`</span>文の<span class="in">`i`</span>が2のとき、次の<span class="in">`for`</span>文の<span class="in">`j`</span>が1から3までの処理を繰り返し・・・という順番で処理が行われます。</span>
<span id="cb105-402"><a href="#cb105-402"></a><span class="ss">-   </span>10行目は、<span class="in">`NPV`</span>の中身を表示しています。</span>
<span id="cb105-403"><a href="#cb105-403"></a></span>
<span id="cb105-404"><a href="#cb105-404"></a><span class="dt">&lt;</span><span class="kw">aside</span><span class="dt">&gt;</span>TABキーを使って、インデントを行い、ソースコードのまとまりをわかりやすくしています。インデントは、プログラムの構造をわかりやすくするために行います。インデントを行うときは、半角スペース2つか4つを使います。どちらを使っても構いませんが、どちらかに統一することが大切です。<span class="dt">&lt;/</span><span class="kw">aside</span><span class="dt">&gt;</span></span>
<span id="cb105-405"><a href="#cb105-405"></a></span>
<span id="cb105-406"><a href="#cb105-406"></a>この結果をグラフにしてみます。</span>
<span id="cb105-407"><a href="#cb105-407"></a></span>
<span id="cb105-410"><a href="#cb105-410"></a><span class="in">```{r}</span></span>
<span id="cb105-411"><a href="#cb105-411"></a><span class="fu">plot</span>(</span>
<span id="cb105-412"><a href="#cb105-412"></a>    <span class="at">x =</span> R, <span class="co"># x軸のデータ</span></span>
<span id="cb105-413"><a href="#cb105-413"></a>    <span class="at">y =</span> NPV, <span class="co"># y軸のデータ</span></span>
<span id="cb105-414"><a href="#cb105-414"></a>    <span class="at">xlab =</span> <span class="st">"無リスク利子率"</span>, <span class="co"># x軸のラベル</span></span>
<span id="cb105-415"><a href="#cb105-415"></a>    <span class="at">ylab =</span> <span class="st">"現在価値"</span>, <span class="co"># y軸のラベル</span></span>
<span id="cb105-416"><a href="#cb105-416"></a>    <span class="at">main =</span> <span class="st">"図：無リスク利子率と現在価値"</span>, <span class="co"># グラフのタイトル</span></span>
<span id="cb105-417"><a href="#cb105-417"></a>    <span class="at">type =</span> <span class="st">"l"</span> <span class="co"># 線グラフ</span></span>
<span id="cb105-418"><a href="#cb105-418"></a>)</span>
<span id="cb105-419"><a href="#cb105-419"></a><span class="in">```</span></span>
<span id="cb105-420"><a href="#cb105-420"></a></span>
<span id="cb105-421"><a href="#cb105-421"></a><span class="fu">#### ベクトル化</span></span>
<span id="cb105-422"><a href="#cb105-422"></a></span>
<span id="cb105-423"><a href="#cb105-423"></a>上のコードは、<span class="in">`for`</span>文を使って、<span class="in">`NPV`</span>の中身を計算しています。しかし、R言語では、<span class="in">`for`</span>文を使わずに、ベクトルを使って、同じことを行うことができます。このように、<span class="in">`for`</span>文を使わずに、ベクトルを使って処理を行うことを**ベクトル化**と呼びます。ベクトル化を行うと、処理が高速化されることがあります。</span>
<span id="cb105-424"><a href="#cb105-424"></a></span>
<span id="cb105-427"><a href="#cb105-427"></a><span class="in">```{r}</span></span>
<span id="cb105-428"><a href="#cb105-428"></a>R <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># 無リスク利子率 10%</span></span>
<span id="cb105-429"><a href="#cb105-429"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>) <span class="co"># キャッシュ・フローのベクトル</span></span>
<span id="cb105-430"><a href="#cb105-430"></a>year <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span> <span class="co"># 年度のベクトル</span></span>
<span id="cb105-431"><a href="#cb105-431"></a>PV_CF <span class="ot">&lt;-</span> CF <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>year <span class="co"># 各期の現在価値を計算</span></span>
<span id="cb105-432"><a href="#cb105-432"></a>NPV <span class="ot">&lt;-</span> <span class="fu">sum</span>(PV_CF) <span class="co"># 現在価値の合計</span></span>
<span id="cb105-433"><a href="#cb105-433"></a><span class="fu">print</span>(NPV)</span>
<span id="cb105-434"><a href="#cb105-434"></a><span class="in">```</span></span>
<span id="cb105-435"><a href="#cb105-435"></a></span>
<span id="cb105-436"><a href="#cb105-436"></a><span class="fu">## 独自関数の定義の仕方</span></span>
<span id="cb105-437"><a href="#cb105-437"></a></span>
<span id="cb105-438"><a href="#cb105-438"></a>プログラミングの基本要素である</span>
<span id="cb105-439"><a href="#cb105-439"></a></span>
<span id="cb105-440"><a href="#cb105-440"></a><span class="ss">-   </span>繰り返し</span>
<span id="cb105-441"><a href="#cb105-441"></a><span class="ss">-   </span>分岐</span>
<span id="cb105-442"><a href="#cb105-442"></a><span class="ss">-   </span>**関数**</span>
<span id="cb105-443"><a href="#cb105-443"></a></span>
<span id="cb105-444"><a href="#cb105-444"></a>の作り方について説明します。 Rでは自分で関数を定義することができます。関数を定義することで、同じ処理を何度も書く必要がなくなり、プログラムの見通しがよくなります。 例えば、足し算をする関数<span class="in">`my_add()`</span>を定義してみます。</span>
<span id="cb105-445"><a href="#cb105-445"></a></span>
<span id="cb105-448"><a href="#cb105-448"></a><span class="in">```{r}</span></span>
<span id="cb105-449"><a href="#cb105-449"></a>my_add <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y){</span>
<span id="cb105-450"><a href="#cb105-450"></a>    x <span class="sc">+</span> y</span>
<span id="cb105-451"><a href="#cb105-451"></a>}</span>
<span id="cb105-452"><a href="#cb105-452"></a><span class="in">```</span></span>
<span id="cb105-453"><a href="#cb105-453"></a></span>
<span id="cb105-454"><a href="#cb105-454"></a>この関数の構造は、</span>
<span id="cb105-455"><a href="#cb105-455"></a></span>
<span id="cb105-456"><a href="#cb105-456"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb105-457"><a href="#cb105-457"></a>好きな関数名 <span class="ot">&lt;-</span> <span class="cf">function</span>(引数1, 引数2){</span>
<span id="cb105-458"><a href="#cb105-458"></a>    処理内容</span>
<span id="cb105-459"><a href="#cb105-459"></a>}</span>
<span id="cb105-460"><a href="#cb105-460"></a><span class="in">```</span></span>
<span id="cb105-461"><a href="#cb105-461"></a></span>
<span id="cb105-462"><a href="#cb105-462"></a>となっています。つまり、この独自関数<span class="in">`my_add()`</span>は、<span class="in">`x`</span>と<span class="in">`y`</span>という2つの引数(ひきすう)を足し合わせる関数です。数学的に書くなら、</span>
<span id="cb105-463"><a href="#cb105-463"></a></span>
<span id="cb105-464"><a href="#cb105-464"></a>$$</span>
<span id="cb105-465"><a href="#cb105-465"></a>f(x, y) = x + y</span>
<span id="cb105-466"><a href="#cb105-466"></a>$$</span>
<span id="cb105-467"><a href="#cb105-467"></a></span>
<span id="cb105-468"><a href="#cb105-468"></a>となります。これは$f$という関数は2つの引数を足す関数であるという意味になっています。 作成した独自関数<span class="in">`my_add()`</span>を使ってみます。</span>
<span id="cb105-469"><a href="#cb105-469"></a></span>
<span id="cb105-472"><a href="#cb105-472"></a><span class="in">```{r}</span></span>
<span id="cb105-473"><a href="#cb105-473"></a><span class="fu">my_add</span>(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb105-474"><a href="#cb105-474"></a><span class="in">```</span></span>
<span id="cb105-475"><a href="#cb105-475"></a></span>
<span id="cb105-476"><a href="#cb105-476"></a>3が出力されました。</span>
<span id="cb105-477"><a href="#cb105-477"></a></span>
<span id="cb105-478"><a href="#cb105-478"></a>このように、独自関数を作成する場合には、</span>
<span id="cb105-479"><a href="#cb105-479"></a></span>
<span id="cb105-480"><a href="#cb105-480"></a><span class="ss">1.  </span>どのような引数を与えるのか？</span>
<span id="cb105-481"><a href="#cb105-481"></a><span class="ss">2.  </span>それに対してどのような処理を行うのか？</span>
<span id="cb105-482"><a href="#cb105-482"></a><span class="ss">3.  </span>最終的にどの値を返す(出力させる)のか？</span>
<span id="cb105-483"><a href="#cb105-483"></a></span>
<span id="cb105-484"><a href="#cb105-484"></a>を考えておく必要があります。</span>
<span id="cb105-485"><a href="#cb105-485"></a></span>
<span id="cb105-486"><a href="#cb105-486"></a>では今までの流れで、現在価値を計算する関数を作成してみます。変化させたい値は、キャッシュフロー<span class="in">`CF`</span>と無リスク利子率<span class="in">`R`</span>なので、その2つを引数とする独自関数を作成します。 少し注意する必要がある点として、以下の計算例では<span class="in">`CF`</span>の1番目の要素は初期投資額となることに注意しましょう。</span>
<span id="cb105-487"><a href="#cb105-487"></a></span>
<span id="cb105-490"><a href="#cb105-490"></a><span class="in">```{r}</span></span>
<span id="cb105-491"><a href="#cb105-491"></a>calc_PV <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, R) {</span>
<span id="cb105-492"><a href="#cb105-492"></a>    PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>] <span class="co"># 初期投資額なのでマイナスの値</span></span>
<span id="cb105-493"><a href="#cb105-493"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(CF)) { <span class="co"># iは2からCFの要素数まで</span></span>
<span id="cb105-494"><a href="#cb105-494"></a>        PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>) <span class="co"># 現在価値</span></span>
<span id="cb105-495"><a href="#cb105-495"></a>    }</span>
<span id="cb105-496"><a href="#cb105-496"></a>    <span class="fu">return</span>(PV) <span class="co"># 現在価値を返す</span></span>
<span id="cb105-497"><a href="#cb105-497"></a>}</span>
<span id="cb105-498"><a href="#cb105-498"></a><span class="in">```</span></span>
<span id="cb105-499"><a href="#cb105-499"></a></span>
<span id="cb105-500"><a href="#cb105-500"></a>この関数<span class="in">`calc_PV()`</span>を使って、現在価値を計算してみます。</span>
<span id="cb105-501"><a href="#cb105-501"></a></span>
<span id="cb105-504"><a href="#cb105-504"></a><span class="in">```{r}</span></span>
<span id="cb105-505"><a href="#cb105-505"></a><span class="fu">calc_PV</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>), <span class="fl">0.1</span>)</span>
<span id="cb105-506"><a href="#cb105-506"></a><span class="in">```</span></span>
<span id="cb105-507"><a href="#cb105-507"></a></span>
<span id="cb105-508"><a href="#cb105-508"></a>ちゃんと計算されました。この関数を使って、無リスク利子率が0.1から0.2まで0.01ずつ変化した場合の現在価値を計算してみます。</span>
<span id="cb105-509"><a href="#cb105-509"></a></span>
<span id="cb105-512"><a href="#cb105-512"></a><span class="in">```{r}</span></span>
<span id="cb105-513"><a href="#cb105-513"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>) <span class="co"># キャッシュ・フローのベクトル</span></span>
<span id="cb105-514"><a href="#cb105-514"></a>R <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>) <span class="co"># 無リスク利子率のベクトル</span></span>
<span id="cb105-515"><a href="#cb105-515"></a><span class="fu">calc_PV</span>(CF,R)</span>
<span id="cb105-516"><a href="#cb105-516"></a><span class="in">```</span></span>
<span id="cb105-517"><a href="#cb105-517"></a></span>
<span id="cb105-518"><a href="#cb105-518"></a>計算されました。 関数の引数にデフォルトで値を設定することで、入力を楽にすることができます。例えば、無リスク利子率のデフォルト値を0.1に設定してみます。</span>
<span id="cb105-519"><a href="#cb105-519"></a></span>
<span id="cb105-522"><a href="#cb105-522"></a><span class="in">```{r}</span></span>
<span id="cb105-523"><a href="#cb105-523"></a>calc_PV <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>) {</span>
<span id="cb105-524"><a href="#cb105-524"></a>    PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>] <span class="co"># 初期投資額なのでマイナスの値</span></span>
<span id="cb105-525"><a href="#cb105-525"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(CF)) { <span class="co"># iは2からCFの要素数まで</span></span>
<span id="cb105-526"><a href="#cb105-526"></a>        PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>) <span class="co"># 現在価値</span></span>
<span id="cb105-527"><a href="#cb105-527"></a>    }</span>
<span id="cb105-528"><a href="#cb105-528"></a>    <span class="fu">return</span>(PV) <span class="co"># 現在価値を返す</span></span>
<span id="cb105-529"><a href="#cb105-529"></a>}</span>
<span id="cb105-530"><a href="#cb105-530"></a><span class="in">```</span></span>
<span id="cb105-531"><a href="#cb105-531"></a></span>
<span id="cb105-532"><a href="#cb105-532"></a>すると、無リスク利子率を指定しなくても、デフォルト値が使われるようになります。</span>
<span id="cb105-533"><a href="#cb105-533"></a></span>
<span id="cb105-536"><a href="#cb105-536"></a><span class="in">```{r}</span></span>
<span id="cb105-537"><a href="#cb105-537"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>) <span class="co"># キャッシュ・フローのベクトル</span></span>
<span id="cb105-538"><a href="#cb105-538"></a><span class="fu">calc_PV</span>(CF)</span>
<span id="cb105-539"><a href="#cb105-539"></a><span class="in">```</span></span>
<span id="cb105-540"><a href="#cb105-540"></a></span>
<span id="cb105-541"><a href="#cb105-541"></a>ただ計算を間違えるもとにもなるので、なるべく省略せずに、しっかり書くことが大事です。</span>
<span id="cb105-542"><a href="#cb105-542"></a></span>
<span id="cb105-543"><a href="#cb105-543"></a><span class="fu">#### もっと凝った独自関数</span></span>
<span id="cb105-544"><a href="#cb105-544"></a></span>
<span id="cb105-545"><a href="#cb105-545"></a>繰り返し、分岐、関数というプログラミングの基本要素を勉強したので、もう少し複雑なプログラムを作成してみます。</span>
<span id="cb105-546"><a href="#cb105-546"></a></span>
<span id="cb105-547"><a href="#cb105-547"></a>まずは、引数に正の数字以外のもの、あるいは文字列を入力した場合にエラーを表示する関数を作成します。</span>
<span id="cb105-548"><a href="#cb105-548"></a></span>
<span id="cb105-551"><a href="#cb105-551"></a><span class="in">```{r}</span></span>
<span id="cb105-552"><a href="#cb105-552"></a>calc_PV_new <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, R) {</span>
<span id="cb105-553"><a href="#cb105-553"></a>    <span class="cf">if</span> (R <span class="sc">&lt;=</span> <span class="dv">0</span>) {</span>
<span id="cb105-554"><a href="#cb105-554"></a>        <span class="fu">stop</span>(<span class="st">"無リスク利子率は正の値を入力してください。"</span>) <span class="co"># エラー処理</span></span>
<span id="cb105-555"><a href="#cb105-555"></a>    }</span>
<span id="cb105-556"><a href="#cb105-556"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.numeric</span>(CF) ) {</span>
<span id="cb105-557"><a href="#cb105-557"></a>        <span class="fu">stop</span>(<span class="st">"キャッシュ・フローは数値を入力してください。"</span>)</span>
<span id="cb105-558"><a href="#cb105-558"></a>    }</span>
<span id="cb105-559"><a href="#cb105-559"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.numeric</span>(R) ) {</span>
<span id="cb105-560"><a href="#cb105-560"></a>        <span class="fu">stop</span>(<span class="st">"無リスク利子率は数値を入力してください。"</span>)</span>
<span id="cb105-561"><a href="#cb105-561"></a>    }</span>
<span id="cb105-562"><a href="#cb105-562"></a></span>
<span id="cb105-563"><a href="#cb105-563"></a>    PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>]</span>
<span id="cb105-564"><a href="#cb105-564"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(CF)) {</span>
<span id="cb105-565"><a href="#cb105-565"></a>        PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb105-566"><a href="#cb105-566"></a>    }</span>
<span id="cb105-567"><a href="#cb105-567"></a>    <span class="fu">return</span>(PV)</span>
<span id="cb105-568"><a href="#cb105-568"></a>}</span>
<span id="cb105-569"><a href="#cb105-569"></a><span class="in">```</span></span>
<span id="cb105-570"><a href="#cb105-570"></a></span>
<span id="cb105-571"><a href="#cb105-571"></a>できました。ついでに、NPVの計算結果とともに、NPVが0より大きい場合にのみ、「プロジェクトを実行！」と表示する機能も実装してみます。</span>
<span id="cb105-572"><a href="#cb105-572"></a></span>
<span id="cb105-575"><a href="#cb105-575"></a><span class="in">```{r}</span></span>
<span id="cb105-576"><a href="#cb105-576"></a>calc_PV_new <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>) {</span>
<span id="cb105-577"><a href="#cb105-577"></a>    <span class="cf">if</span> (R <span class="sc">&lt;=</span> <span class="dv">0</span>) {</span>
<span id="cb105-578"><a href="#cb105-578"></a>        <span class="fu">stop</span>(<span class="st">"無リスク利子率は正の値を入力してください。"</span>) <span class="co"># エラー処理</span></span>
<span id="cb105-579"><a href="#cb105-579"></a>    }</span>
<span id="cb105-580"><a href="#cb105-580"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.numeric</span>(CF) ) {</span>
<span id="cb105-581"><a href="#cb105-581"></a>        <span class="fu">stop</span>(<span class="st">"キャッシュ・フローは数値を入力してください。"</span>)</span>
<span id="cb105-582"><a href="#cb105-582"></a>    }</span>
<span id="cb105-583"><a href="#cb105-583"></a>    <span class="cf">if</span> ( <span class="sc">!</span><span class="fu">is.numeric</span>(R) ) {</span>
<span id="cb105-584"><a href="#cb105-584"></a>        <span class="fu">stop</span>(<span class="st">"無リスク利子率は数値を入力してください。"</span>)</span>
<span id="cb105-585"><a href="#cb105-585"></a>    }</span>
<span id="cb105-586"><a href="#cb105-586"></a></span>
<span id="cb105-587"><a href="#cb105-587"></a>    PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>]</span>
<span id="cb105-588"><a href="#cb105-588"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(CF)) {</span>
<span id="cb105-589"><a href="#cb105-589"></a>        PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb105-590"><a href="#cb105-590"></a>    }</span>
<span id="cb105-591"><a href="#cb105-591"></a></span>
<span id="cb105-592"><a href="#cb105-592"></a>    <span class="cf">if</span> (PV <span class="sc">&gt;=</span> <span class="dv">0</span>) { <span class="co"># NPVが0より大きい場合</span></span>
<span id="cb105-593"><a href="#cb105-593"></a>    <span class="fu">paste0</span>(<span class="st">"NPVが"</span>, <span class="fu">round</span>(PV, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">"なので、プロジェクトを実行！"</span>) <span class="co"># 文字列を表示</span></span>
<span id="cb105-594"><a href="#cb105-594"></a>    } <span class="cf">else</span> {</span>
<span id="cb105-595"><a href="#cb105-595"></a>    <span class="fu">paste0</span>(<span class="st">"NPVが"</span>, <span class="fu">round</span>(PV, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">"なのでプロジェクト中止！"</span>) <span class="co"># 文字列を表示</span></span>
<span id="cb105-596"><a href="#cb105-596"></a>    }</span>
<span id="cb105-597"><a href="#cb105-597"></a>}</span>
<span id="cb105-598"><a href="#cb105-598"></a><span class="in">```</span></span>
<span id="cb105-599"><a href="#cb105-599"></a></span>
<span id="cb105-600"><a href="#cb105-600"></a>いろいろ駆使してより短く簡単に書くなら、</span>
<span id="cb105-601"><a href="#cb105-601"></a></span>
<span id="cb105-604"><a href="#cb105-604"></a><span class="in">```{r}</span></span>
<span id="cb105-605"><a href="#cb105-605"></a>calc_PV <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>) {</span>
<span id="cb105-606"><a href="#cb105-606"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.numeric</span>(CF) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.numeric</span>(R) <span class="sc">||</span> R <span class="sc">&lt;=</span> <span class="dv">0</span>) {</span>
<span id="cb105-607"><a href="#cb105-607"></a>    <span class="fu">stop</span>(<span class="st">"キャッシュ・フローと無リスク利子率は数値を入力し、無リスク利子率は正の値を入力してください。"</span>)</span>
<span id="cb105-608"><a href="#cb105-608"></a>  }</span>
<span id="cb105-609"><a href="#cb105-609"></a>  PV <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(CF), <span class="cf">function</span>(i) CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>)))</span>
<span id="cb105-610"><a href="#cb105-610"></a></span>
<span id="cb105-611"><a href="#cb105-611"></a>  <span class="cf">if</span> (PV <span class="sc">&gt;=</span> <span class="dv">0</span>) {</span>
<span id="cb105-612"><a href="#cb105-612"></a>    <span class="fu">paste0</span>(<span class="st">"NPVが"</span>, <span class="fu">round</span>(PV, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">"なので、プロジェクトを実行！"</span>)</span>
<span id="cb105-613"><a href="#cb105-613"></a>  } <span class="cf">else</span> {</span>
<span id="cb105-614"><a href="#cb105-614"></a>    <span class="fu">paste0</span>(<span class="st">"NPVが"</span>, <span class="fu">round</span>(PV, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">"なのでプロジェクト中止！"</span>)</span>
<span id="cb105-615"><a href="#cb105-615"></a>  }</span>
<span id="cb105-616"><a href="#cb105-616"></a>}</span>
<span id="cb105-617"><a href="#cb105-617"></a><span class="in">```</span></span>
<span id="cb105-618"><a href="#cb105-618"></a></span>
<span id="cb105-621"><a href="#cb105-621"></a><span class="in">```{r}</span></span>
<span id="cb105-622"><a href="#cb105-622"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>)</span>
<span id="cb105-623"><a href="#cb105-623"></a><span class="fu">calc_PV</span>(CF)</span>
<span id="cb105-624"><a href="#cb105-624"></a><span class="in">```</span></span>
<span id="cb105-625"><a href="#cb105-625"></a></span>
<span id="cb105-626"><a href="#cb105-626"></a>うまくいきました。 ちょっとキャッシュフローのベクトルを変化させて、初期投資を-200にすると、</span>
<span id="cb105-627"><a href="#cb105-627"></a></span>
<span id="cb105-630"><a href="#cb105-630"></a><span class="in">```{r}</span></span>
<span id="cb105-631"><a href="#cb105-631"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">200</span>, <span class="dv">50</span>, <span class="dv">50</span>, <span class="dv">50</span>)</span>
<span id="cb105-632"><a href="#cb105-632"></a><span class="fu">calc_PV</span>(CF)</span>
<span id="cb105-633"><a href="#cb105-633"></a><span class="in">```</span></span>
<span id="cb105-634"><a href="#cb105-634"></a></span>
<span id="cb105-635"><a href="#cb105-635"></a>ちゃんと中止のメッセージが出ました。</span>
<span id="cb105-636"><a href="#cb105-636"></a></span>
<span id="cb105-637"><a href="#cb105-637"></a>このように、分岐、繰り返し、関数を駆使して、様々なプログラムを作成することができます。プログラミングの基本要素を使いこなせるように、練習を重ねてください。まずは教科書に書いてあるソースコードを自分のPC上で実行してみてください。その際は、コピペせずに自分で入力するようにしてください。</span>
<span id="cb105-638"><a href="#cb105-638"></a></span>
<span id="cb105-639"><a href="#cb105-639"></a><span class="fu">#### 付録：ベクトル化で早くなるのか？</span></span>
<span id="cb105-640"><a href="#cb105-640"></a></span>
<span id="cb105-641"><a href="#cb105-641"></a>どれほど高速化されるのかを確認するため、100万年分の現在価値を計算してみます。</span>
<span id="cb105-642"><a href="#cb105-642"></a>最初に松浦のR環境を確認してみます。 コンピューターはMac miniで、CPUはM4 Pro、メモリは24GB、MacOS Tahoe 26.3です。</span>
<span id="cb105-643"><a href="#cb105-643"></a>Rやパッケージのバージョンは以下の通りです。</span>
<span id="cb105-646"><a href="#cb105-646"></a><span class="in">```{r}</span></span>
<span id="cb105-647"><a href="#cb105-647"></a><span class="fu">sessionInfo</span>() </span>
<span id="cb105-648"><a href="#cb105-648"></a>R.version</span>
<span id="cb105-649"><a href="#cb105-649"></a><span class="in">```</span></span>
<span id="cb105-650"><a href="#cb105-650"></a></span>
<span id="cb105-651"><a href="#cb105-651"></a>今回比較した4つの手法について、それぞれの特徴と、どのような場面で使うべきかをまとめました。</span>
<span id="cb105-652"><a href="#cb105-652"></a>適切な手法を選択する際の参考にしてください。</span>
<span id="cb105-653"><a href="#cb105-653"></a></span>
<span id="cb105-654"><a href="#cb105-654"></a><span class="ss">1. </span><span class="in">`for`</span>ループ：1つずつ順番に計算する、最も基本的で直感的な方法です。</span>
<span id="cb105-655"><a href="#cb105-655"></a>    プログラムの構造が分かりやすく、複雑な条件分岐を書きやすいです。</span>
<span id="cb105-656"><a href="#cb105-656"></a>    しかし、Rは繰り返し処理のたびに「解釈」を行うため、回数が増えると極端に時間がかかります。データ数が少ない場合や、計算ロジックが非常に複雑でベクトル化が難しい場合に使います。</span>
<span id="cb105-657"><a href="#cb105-657"></a></span>
<span id="cb105-658"><a href="#cb105-658"></a><span class="ss">2. </span>**ベクトル化** : Rの得意技で、データを「まとめて」一気に計算する方法です。</span>
<span id="cb105-659"><a href="#cb105-659"></a>   <span class="in">`for`</span>ループに比べて劇的に高速で、コードも短くシンプルになります。</span>
<span id="cb105-660"><a href="#cb105-660"></a>   しかし、計算のために巨大な一時データをメモリ上に作成するため、メモリ消費量が大きいです。データが巨大すぎるとメモリ不足で停止することがありますが、Rでは通常はこの方法が推奨されます。</span>
<span id="cb105-661"><a href="#cb105-661"></a></span>
<span id="cb105-662"><a href="#cb105-662"></a><span class="ss">3. </span>**分割計算** / チャンク化 : データを一定のサイズ（例：100万件ずつ）に区切って、少しずつベクトル化計算を行う方法です。ベクトル化の速さを活かしつつ、メモリ消費量を低く抑えることができますが、コードが少し複雑になります。また、区切る処理が入る分、純粋なベクトル化よりわずかに遅くなります。億単位のデータなど、一気に計算するとメモリ不足になるような大規模データを扱う場合に有効です。</span>
<span id="cb105-663"><a href="#cb105-663"></a></span>
<span id="cb105-664"><a href="#cb105-664"></a><span class="ss">4. </span><span class="in">`Rcpp`</span> (C++連携) : Rの中から、より高速なプログラミング言語である「C++」を呼び出して計算する方法です。圧倒的に最速です。また、メモリ管理も効率的なので、大規模データでも軽快に動作します。C++の知識が必要で、コードを書く難易度が高いですが、生成AIを活用すれば初心者でも比較的簡単に導入できます。非常に大規模なシミュレーションや、計算速度が最重要となる場合に適しています。</span>
<span id="cb105-665"><a href="#cb105-665"></a></span>
<span id="cb105-666"><a href="#cb105-666"></a>以下では、それぞれの手法で現在価値を計算する関数を定義します。</span>
<span id="cb105-667"><a href="#cb105-667"></a></span>
<span id="cb105-668"><a href="#cb105-668"></a><span class="in">```{r compare_for_vec, filename="for文とベクトル化の比較"}</span></span>
<span id="cb105-669"><a href="#cb105-669"></a><span class="co"># for文版</span></span>
<span id="cb105-670"><a href="#cb105-670"></a>calc_PV_for <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>) {</span>
<span id="cb105-671"><a href="#cb105-671"></a>  PV <span class="ot">&lt;-</span> CF[<span class="dv">1</span>]</span>
<span id="cb105-672"><a href="#cb105-672"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(CF)</span>
<span id="cb105-673"><a href="#cb105-673"></a>  <span class="cf">if</span> (n <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="fu">return</span>(PV) <span class="co"># 要素数が1以下の場合は即リターン</span></span>
<span id="cb105-674"><a href="#cb105-674"></a>  </span>
<span id="cb105-675"><a href="#cb105-675"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb105-676"><a href="#cb105-676"></a>    PV <span class="ot">&lt;-</span> PV <span class="sc">+</span> CF[i] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb105-677"><a href="#cb105-677"></a>  }</span>
<span id="cb105-678"><a href="#cb105-678"></a>  <span class="fu">return</span>(PV)</span>
<span id="cb105-679"><a href="#cb105-679"></a>}</span>
<span id="cb105-680"><a href="#cb105-680"></a></span>
<span id="cb105-681"><a href="#cb105-681"></a><span class="co"># ベクトル版</span></span>
<span id="cb105-682"><a href="#cb105-682"></a>calc_PV_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>){</span>
<span id="cb105-683"><a href="#cb105-683"></a>  year <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">length</span>(CF) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb105-684"><a href="#cb105-684"></a></span>
<span id="cb105-685"><a href="#cb105-685"></a>  PV_CF <span class="ot">&lt;-</span> CF <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>year</span>
<span id="cb105-686"><a href="#cb105-686"></a>  NPV <span class="ot">&lt;-</span> <span class="fu">sum</span>(PV_CF)</span>
<span id="cb105-687"><a href="#cb105-687"></a>  <span class="fu">return</span>(NPV)</span>
<span id="cb105-688"><a href="#cb105-688"></a>}</span>
<span id="cb105-689"><a href="#cb105-689"></a></span>
<span id="cb105-690"><a href="#cb105-690"></a><span class="co"># ベクトル版一気に計算版</span></span>
<span id="cb105-691"><a href="#cb105-691"></a>calc_PV_chunk <span class="ot">&lt;-</span> <span class="cf">function</span>(CF, <span class="at">R =</span> <span class="fl">0.1</span>, <span class="at">chunk_size =</span> <span class="fl">1e6</span>) { <span class="co"># デフォルトで100万件ずつ処理</span></span>
<span id="cb105-692"><a href="#cb105-692"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(CF)</span>
<span id="cb105-693"><a href="#cb105-693"></a>  total_npv <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb105-694"><a href="#cb105-694"></a>  </span>
<span id="cb105-695"><a href="#cb105-695"></a>  <span class="co"># チャンクの開始位置を作成 (例: 1, 1000001, 2000001...)</span></span>
<span id="cb105-696"><a href="#cb105-696"></a>  starts <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, n, <span class="at">by =</span> chunk_size)</span>
<span id="cb105-697"><a href="#cb105-697"></a>  </span>
<span id="cb105-698"><a href="#cb105-698"></a>  <span class="cf">for</span> (start <span class="cf">in</span> starts) {</span>
<span id="cb105-699"><a href="#cb105-699"></a>    <span class="co"># 終了位置を計算（データの最後を超えないようにminを使う）</span></span>
<span id="cb105-700"><a href="#cb105-700"></a>    end <span class="ot">&lt;-</span> <span class="fu">min</span>(start <span class="sc">+</span> chunk_size <span class="sc">-</span> <span class="dv">1</span>, n)</span>
<span id="cb105-701"><a href="#cb105-701"></a>    </span>
<span id="cb105-702"><a href="#cb105-702"></a>    <span class="co"># 1. 必要な部分だけデータを切り出す（ここでメモリ消費を抑える）</span></span>
<span id="cb105-703"><a href="#cb105-703"></a>    cf_part <span class="ot">&lt;-</span> CF[start<span class="sc">:</span>end]</span>
<span id="cb105-704"><a href="#cb105-704"></a>    </span>
<span id="cb105-705"><a href="#cb105-705"></a>    <span class="co"># 2. 時間tのベクトルを作成（全体の位置に合わせて調整）</span></span>
<span id="cb105-706"><a href="#cb105-706"></a>    <span class="co"># CF[1]がt=0に対応するため、インデックスから1を引く</span></span>
<span id="cb105-707"><a href="#cb105-707"></a>    t_part <span class="ot">&lt;-</span> (start<span class="sc">:</span>end) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb105-708"><a href="#cb105-708"></a>    </span>
<span id="cb105-709"><a href="#cb105-709"></a>    <span class="co"># 3. 部分的な現在価値を計算して合計に加算</span></span>
<span id="cb105-710"><a href="#cb105-710"></a>    <span class="co"># ベクトル化の恩恵を受けつつ、メモリ消費はchunk_size分だけで済む</span></span>
<span id="cb105-711"><a href="#cb105-711"></a>    total_npv <span class="ot">&lt;-</span> total_npv <span class="sc">+</span> <span class="fu">sum</span>(cf_part <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> R)<span class="sc">^</span>t_part)</span>
<span id="cb105-712"><a href="#cb105-712"></a>  }</span>
<span id="cb105-713"><a href="#cb105-713"></a>  </span>
<span id="cb105-714"><a href="#cb105-714"></a>  <span class="fu">return</span>(total_npv)</span>
<span id="cb105-715"><a href="#cb105-715"></a>}</span>
<span id="cb105-716"><a href="#cb105-716"></a></span>
<span id="cb105-717"><a href="#cb105-717"></a><span class="co"># Rcppを使ってC++で高速化版</span></span>
<span id="cb105-718"><a href="#cb105-718"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb105-719"><a href="#cb105-719"></a><span class="co"># C++のコードをRの中でコンパイルして関数化</span></span>
<span id="cb105-720"><a href="#cb105-720"></a><span class="fu">cppFunction</span>(<span class="st">'</span></span>
<span id="cb105-721"><a href="#cb105-721"></a><span class="st">double calc_PV_cpp(NumericVector CF, double R) {</span></span>
<span id="cb105-722"><a href="#cb105-722"></a><span class="st">  double npv = 0;</span></span>
<span id="cb105-723"><a href="#cb105-723"></a><span class="st">  double discount_factor = 1.0;</span></span>
<span id="cb105-724"><a href="#cb105-724"></a><span class="st">  double r_plus_1 = 1.0 + R;</span></span>
<span id="cb105-725"><a href="#cb105-725"></a><span class="st">  int n = CF.size();</span></span>
<span id="cb105-726"><a href="#cb105-726"></a><span class="st">  </span></span>
<span id="cb105-727"><a href="#cb105-727"></a><span class="st">  for(int i = 0; i &lt; n; ++i) {</span></span>
<span id="cb105-728"><a href="#cb105-728"></a><span class="st">    // 毎回 pow(1+R, i) を計算すると遅いので、</span></span>
<span id="cb105-729"><a href="#cb105-729"></a><span class="st">    // 割引率を掛け合わせて更新していく（これが最速）</span></span>
<span id="cb105-730"><a href="#cb105-730"></a><span class="st">    npv += CF[i] / discount_factor;</span></span>
<span id="cb105-731"><a href="#cb105-731"></a><span class="st">    discount_factor *= r_plus_1;</span></span>
<span id="cb105-732"><a href="#cb105-732"></a><span class="st">  }</span></span>
<span id="cb105-733"><a href="#cb105-733"></a><span class="st">  return npv;</span></span>
<span id="cb105-734"><a href="#cb105-734"></a><span class="st">}</span></span>
<span id="cb105-735"><a href="#cb105-735"></a><span class="st">'</span>)</span>
<span id="cb105-736"><a href="#cb105-736"></a></span>
<span id="cb105-737"><a href="#cb105-737"></a><span class="co"># 使い方</span></span>
<span id="cb105-738"><a href="#cb105-738"></a><span class="co"># calc_PV_cpp(CF, 0.1)</span></span>
<span id="cb105-739"><a href="#cb105-739"></a><span class="in">```</span></span>
<span id="cb105-740"><a href="#cb105-740"></a></span>
<span id="cb105-741"><a href="#cb105-741"></a>比較してみます。</span>
<span id="cb105-742"><a href="#cb105-742"></a>ランダムな将来キャッシュフローを1万年分用意します。</span>
<span id="cb105-743"><a href="#cb105-743"></a></span>
<span id="cb105-744"><a href="#cb105-744"></a><span class="in">```{r prep_data}</span></span>
<span id="cb105-745"><a href="#cb105-745"></a><span class="fu">set.seed</span>(<span class="dv">121</span>)</span>
<span id="cb105-746"><a href="#cb105-746"></a>n_years <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">6</span> <span class="co"># 100万年分</span></span>
<span id="cb105-747"><a href="#cb105-747"></a><span class="co"># 初期投資-100とランダムなキャッシュフロー</span></span>
<span id="cb105-748"><a href="#cb105-748"></a>CF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="fu">runif</span>(n_years <span class="sc">-</span> <span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>)) </span>
<span id="cb105-749"><a href="#cb105-749"></a><span class="in">```</span></span>
<span id="cb105-750"><a href="#cb105-750"></a></span>
<span id="cb105-751"><a href="#cb105-751"></a>では、それぞれの方法で計算した速度を比較してみましょう。</span>
<span id="cb105-752"><a href="#cb105-752"></a>正確に比較するため、<span class="in">`microbenchmark`</span>パッケージを使って、それぞれ10回ずつ計測し、その分布を確認します。</span>
<span id="cb105-753"><a href="#cb105-753"></a></span>
<span id="cb105-754"><a href="#cb105-754"></a><span class="in">```{r run_benchmark}</span></span>
<span id="cb105-755"><a href="#cb105-755"></a><span class="co"># 全ての手法をまとめて計測</span></span>
<span id="cb105-756"><a href="#cb105-756"></a>res <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb105-757"><a href="#cb105-757"></a>    <span class="st">"For Loop"</span>   <span class="ot">=</span> <span class="fu">calc_PV_for</span>(CF),</span>
<span id="cb105-758"><a href="#cb105-758"></a>    <span class="st">"Vectorized"</span> <span class="ot">=</span> <span class="fu">calc_PV_vec</span>(CF),</span>
<span id="cb105-759"><a href="#cb105-759"></a>    <span class="st">"Chunked"</span>    <span class="ot">=</span> <span class="fu">calc_PV_chunk</span>(CF),</span>
<span id="cb105-760"><a href="#cb105-760"></a>    <span class="st">"Rcpp (C++)"</span> <span class="ot">=</span> <span class="fu">calc_PV_cpp</span>(CF, <span class="fl">0.1</span>),</span>
<span id="cb105-761"><a href="#cb105-761"></a>    <span class="at">times =</span> <span class="dv">10</span>, <span class="co"># 10回繰り返して計測</span></span>
<span id="cb105-762"><a href="#cb105-762"></a>    <span class="at">unit =</span> <span class="st">"ms"</span> <span class="co"># 単位をミリ秒に統一</span></span>
<span id="cb105-763"><a href="#cb105-763"></a>)</span>
<span id="cb105-764"><a href="#cb105-764"></a></span>
<span id="cb105-765"><a href="#cb105-765"></a><span class="co"># 結果の数値表示</span></span>
<span id="cb105-766"><a href="#cb105-766"></a><span class="fu">print</span>(res)</span>
<span id="cb105-767"><a href="#cb105-767"></a></span>
<span id="cb105-768"><a href="#cb105-768"></a><span class="co"># 結果の可視化（箱ひげ図）</span></span>
<span id="cb105-769"><a href="#cb105-769"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(<span class="at">x =</span> expr, <span class="at">y =</span> time <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">fill =</span> expr)) <span class="sc">+</span> <span class="co"># timeを1e6(100万)で割ってミリ秒に変換</span></span>
<span id="cb105-770"><a href="#cb105-770"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> <span class="co"># 箱ひげ図を指定</span></span>
<span id="cb105-771"><a href="#cb105-771"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma) <span class="sc">+</span> <span class="co"># 軸の数値をカンマ区切りに（見やすくするため）</span></span>
<span id="cb105-772"><a href="#cb105-772"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"計算手法による実行速度の比較 (100万件)"</span>, </span>
<span id="cb105-773"><a href="#cb105-773"></a>       <span class="at">y =</span> <span class="st">"実行時間 (ミリ秒)"</span>,</span>
<span id="cb105-774"><a href="#cb105-774"></a>       <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span> <span class="co"># x軸ラベル（手法名）は自明なので空欄に</span></span>
<span id="cb105-775"><a href="#cb105-775"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="co"># ベーステーマ（mystyleがあればそちらに置き換えてください）</span></span>
<span id="cb105-776"><a href="#cb105-776"></a>  mystyle <span class="sc">+</span></span>
<span id="cb105-777"><a href="#cb105-777"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="co"># 色分けの凡例は不要なら消す</span></span>
<span id="cb105-778"><a href="#cb105-778"></a><span class="in">```</span></span>
<span id="cb105-779"><a href="#cb105-779"></a></span>
<span id="cb105-780"><a href="#cb105-780"></a>実行結果の解釈:</span>
<span id="cb105-781"><a href="#cb105-781"></a></span>
<span id="cb105-782"><a href="#cb105-782"></a><span class="ss">- </span><span class="in">`for`</span>ループ: 最も遅くなります。Rでのループ処理はオーバーヘッドが大きいためです。</span>
<span id="cb105-783"><a href="#cb105-783"></a><span class="ss">- </span>ベクトル化: for文に比べて劇的に高速化します。**通常はこの方法が推奨**されます。</span>
<span id="cb105-784"><a href="#cb105-784"></a><span class="ss">- </span>Chunked: ベクトル化より少し遅くなりますが、メモリ消費を抑えられるメリットがあります。</span>
<span id="cb105-785"><a href="#cb105-785"></a><span class="ss">- </span><span class="in">`Rcpp`</span>: 圧倒的に高速です。C++のレベルで最適化されるため、大規模なシミュレーションや反復計算では威力を発揮します。</span>
<span id="cb105-786"><a href="#cb105-786"></a></span>
<span id="cb105-787"><a href="#cb105-787"></a></span>
<span id="cb105-788"><a href="#cb105-788"></a>これがベクトル化による実行速度の効率化です。とはいえ、演算に時間がかかるような大規模データや複雑なシミュレーションをするようになるまで、ベクトル化の恩恵はそれほど大きくないですし、巨大な中間ベクトルをメモリ上に生成するため、計算速度は速くなるがメモリ消費量は増えるます。</span>
<span id="cb105-789"><a href="#cb105-789"></a>ということなので今は気にせずに、読みやすく、確実に動くプログラムを書くことを心がけましょう。</span>
<span id="cb105-790"><a href="#cb105-790"></a></span>
<span id="cb105-791"><a href="#cb105-791"></a></span>
<span id="cb105-792"><a href="#cb105-792"></a><span class="fu">## 演習</span></span>
<span id="cb105-793"><a href="#cb105-793"></a></span>
<span id="cb105-794"><a href="#cb105-794"></a>各自でやってみてください。</span>
<span id="cb105-795"><a href="#cb105-795"></a></span>
<span id="cb105-796"><a href="#cb105-796"></a><span class="fu">## データフレーム入門</span></span>
<span id="cb105-797"><a href="#cb105-797"></a></span>
<span id="cb105-798"><a href="#cb105-798"></a><span class="fu">### CSVファイルの読み込み</span></span>
<span id="cb105-799"><a href="#cb105-799"></a></span>
<span id="cb105-800"><a href="#cb105-800"></a>RでCSVファイルを読み込むには、<span class="in">`readr`</span>パッケージの<span class="in">`read_csv()`</span>関数を使うのがよいでしょう。</span>
<span id="cb105-801"><a href="#cb105-801"></a>たとえば、<span class="in">`data.csv`</span>というファイルを読み込むには、次のように書きます。</span>
<span id="cb105-802"><a href="#cb105-802"></a></span>
<span id="cb105-805"><a href="#cb105-805"></a><span class="in">```{r}</span></span>
<span id="cb105-806"><a href="#cb105-806"></a>df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"data/ch03_daily_stock_return.csv"</span>)</span>
<span id="cb105-807"><a href="#cb105-807"></a><span class="in">```</span></span>
<span id="cb105-808"><a href="#cb105-808"></a></span>
<span id="cb105-809"><a href="#cb105-809"></a>この<span class="in">`df`</span>というオブジェクトの型を見てみると，</span>
<span id="cb105-810"><a href="#cb105-810"></a></span>
<span id="cb105-813"><a href="#cb105-813"></a><span class="in">```{r}</span></span>
<span id="cb105-814"><a href="#cb105-814"></a><span class="fu">class</span>(df)</span>
<span id="cb105-815"><a href="#cb105-815"></a><span class="in">```</span></span>
<span id="cb105-816"><a href="#cb105-816"></a></span>
<span id="cb105-817"><a href="#cb105-817"></a><span class="in">`spec_tbl_df`</span>，<span class="in">`tbl_df`</span>，<span class="in">`tbl`</span>，<span class="in">`data.frame`</span>という4つの型が表示されます。</span>
<span id="cb105-818"><a href="#cb105-818"></a><span class="in">`data.frame`</span>という属性が含まれており，<span class="in">`df`</span>が**データフレーム**であることを示しています。</span>
<span id="cb105-819"><a href="#cb105-819"></a></span>
<span id="cb105-820"><a href="#cb105-820"></a>:::{.column-margin}</span>
<span id="cb105-821"><a href="#cb105-821"></a><span class="in">`spec_tbl_df`</span>は，<span class="in">`readr`</span>パッケージが読み込んだデータフレームに付与する属性で，データの仕様情報を保持しています。</span>
<span id="cb105-822"><a href="#cb105-822"></a><span class="in">`tbl_df`</span>は，<span class="in">`tibble`</span>パッケージが提供するデータフレームの拡張型で，表示や操作がしやすくなっています。</span>
<span id="cb105-823"><a href="#cb105-823"></a><span class="in">`tbl`</span>は，<span class="in">`dplyr`</span>パッケージが提供するデータフレームの拡張型で，データ操作が効率的に行えるようになっています。</span>
<span id="cb105-824"><a href="#cb105-824"></a>基本的には，<span class="in">`data.frame`</span>として扱うことができます。</span>
<span id="cb105-825"><a href="#cb105-825"></a>:::</span>
<span id="cb105-826"><a href="#cb105-826"></a></span>
<span id="cb105-827"><a href="#cb105-827"></a></span>
<span id="cb105-828"><a href="#cb105-828"></a>あとは，</span>
<span id="cb105-829"><a href="#cb105-829"></a></span>
<span id="cb105-830"><a href="#cb105-830"></a><span class="ss">- </span><span class="in">`nrow()`</span>関数で行数を確認</span>
<span id="cb105-831"><a href="#cb105-831"></a><span class="ss">- </span><span class="in">`str()`</span>関数で構造を確認</span>
<span id="cb105-832"><a href="#cb105-832"></a><span class="ss">- </span><span class="in">`mean()`</span>関数で平均を計算</span>
<span id="cb105-833"><a href="#cb105-833"></a><span class="ss">- </span><span class="in">`sd()`</span>関数で標準偏差を計算</span>
<span id="cb105-834"><a href="#cb105-834"></a><span class="ss">- </span><span class="in">`cor()`</span>関数で相関係数を計算</span>
<span id="cb105-835"><a href="#cb105-835"></a></span>
<span id="cb105-836"><a href="#cb105-836"></a>などを使って，データの中身を確認してみましょう。</span>
<span id="cb105-837"><a href="#cb105-837"></a></span>
<span id="cb105-838"><a href="#cb105-838"></a><span class="ss">- </span><span class="in">`which.min()`</span>関数や<span class="in">`which.max()`</span>関数で最小値・最大値のインデックスを取得</span>
<span id="cb105-839"><a href="#cb105-839"></a></span>
<span id="cb105-840"><a href="#cb105-840"></a>例えば，最も日次リターンが高い日付を調べるには，次のようにします。</span>
<span id="cb105-841"><a href="#cb105-841"></a></span>
<span id="cb105-844"><a href="#cb105-844"></a><span class="in">```{r}</span></span>
<span id="cb105-845"><a href="#cb105-845"></a>best_day_ID <span class="ot">&lt;-</span> <span class="fu">which.max</span>(df<span class="sc">$</span>firm1)</span>
<span id="cb105-846"><a href="#cb105-846"></a>best_day_ID</span>
<span id="cb105-847"><a href="#cb105-847"></a><span class="in">```</span></span>
<span id="cb105-848"><a href="#cb105-848"></a></span>
<span id="cb105-849"><a href="#cb105-849"></a><span class="in">`r best_day_ID`</span>行目が最も日次リターンが高い日付なので，<span class="in">`df`</span>からその行を取り出してみます。</span>
<span id="cb105-850"><a href="#cb105-850"></a></span>
<span id="cb105-853"><a href="#cb105-853"></a><span class="in">```{r}</span></span>
<span id="cb105-854"><a href="#cb105-854"></a>df<span class="sc">$</span>date[best_day_ID]</span>
<span id="cb105-855"><a href="#cb105-855"></a><span class="in">```</span></span>
<span id="cb105-856"><a href="#cb105-856"></a></span>
<span id="cb105-857"><a href="#cb105-857"></a></span>
<span id="cb105-858"><a href="#cb105-858"></a><span class="fu">## ファクター型と日付型</span></span>
<span id="cb105-859"><a href="#cb105-859"></a></span>
<span id="cb105-860"><a href="#cb105-860"></a><span class="fu">### ファクター型入門</span></span>
<span id="cb105-861"><a href="#cb105-861"></a></span>
<span id="cb105-862"><a href="#cb105-862"></a>ファクター型あるいは因子型(factor)は，カテゴリカル変数を表現するためのデータ型で，分かりづらいものの，非常に便利かつ重要なデータの型なので，しっかり理解しておきましょう。</span>
<span id="cb105-863"><a href="#cb105-863"></a></span>
<span id="cb105-864"><a href="#cb105-864"></a>数値型や文字列型を因子型に変換する方法には，</span>
<span id="cb105-865"><a href="#cb105-865"></a></span>
<span id="cb105-866"><a href="#cb105-866"></a><span class="ss">1. </span>基本関数 <span class="in">`factor()`</span></span>
<span id="cb105-867"><a href="#cb105-867"></a><span class="ss">2. </span><span class="in">`forcats`</span>パッケージの<span class="in">`as_factor()`</span>関数</span>
<span id="cb105-868"><a href="#cb105-868"></a><span class="ss">3. </span><span class="in">`forcats`</span>パッケージの<span class="in">`fct_relevel()`</span>関数</span>
<span id="cb105-869"><a href="#cb105-869"></a></span>
<span id="cb105-870"><a href="#cb105-870"></a>先ほど読み込んだデータの<span class="in">`industry`</span>変数は，文字列型ですが，これを因子型に変換してみます。</span>
<span id="cb105-871"><a href="#cb105-871"></a></span>
<span id="cb105-872"><a href="#cb105-872"></a></span>
<span id="cb105-875"><a href="#cb105-875"></a><span class="in">```{r}</span></span>
<span id="cb105-876"><a href="#cb105-876"></a>firm_ID <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb105-877"><a href="#cb105-877"></a>name <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Firm A"</span>, <span class="st">"Firm B"</span>, <span class="st">"Firm C"</span>)</span>
<span id="cb105-878"><a href="#cb105-878"></a>industry <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Machinery"</span>, <span class="st">"Chemicals"</span>, <span class="st">"Machinery"</span>)</span>
<span id="cb105-879"><a href="#cb105-879"></a></span>
<span id="cb105-880"><a href="#cb105-880"></a>firm_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb105-881"><a href="#cb105-881"></a>  <span class="at">firm_ID =</span> firm_ID,</span>
<span id="cb105-882"><a href="#cb105-882"></a>  <span class="at">name =</span> name,</span>
<span id="cb105-883"><a href="#cb105-883"></a>  <span class="at">industry =</span> industry</span>
<span id="cb105-884"><a href="#cb105-884"></a>)</span>
<span id="cb105-885"><a href="#cb105-885"></a><span class="in">```</span></span>
<span id="cb105-886"><a href="#cb105-886"></a></span>
<span id="cb105-887"><a href="#cb105-887"></a>この<span class="in">`industry`</span>変数はカテゴリー変数ですが，文字列型になっているので，因子型に変換してみます。</span>
<span id="cb105-888"><a href="#cb105-888"></a></span>
<span id="cb105-891"><a href="#cb105-891"></a><span class="in">```{r}</span></span>
<span id="cb105-892"><a href="#cb105-892"></a>firm_data <span class="ot">&lt;-</span> firm_data <span class="sc">|&gt;</span></span>
<span id="cb105-893"><a href="#cb105-893"></a>    <span class="fu">mutate</span>(</span>
<span id="cb105-894"><a href="#cb105-894"></a>        <span class="at">industry =</span> forcats<span class="sc">::</span><span class="fu">fct_inorder</span>(industry)</span>
<span id="cb105-895"><a href="#cb105-895"></a>        )</span>
<span id="cb105-896"><a href="#cb105-896"></a><span class="fu">class</span>(firm_data<span class="sc">$</span>industry)</span>
<span id="cb105-897"><a href="#cb105-897"></a><span class="in">```</span></span>
<span id="cb105-898"><a href="#cb105-898"></a></span>
<span id="cb105-899"><a href="#cb105-899"></a><span class="in">`forcats`</span>パッケージには非常に便利な関数がたくさんあるので，ぜひドキュメントを参照してみてください。代表的なものに</span>
<span id="cb105-900"><a href="#cb105-900"></a></span>
<span id="cb105-901"><a href="#cb105-901"></a><span class="ss">- </span><span class="in">`as_factor()`</span> : 他の型から因子型に変換</span>
<span id="cb105-902"><a href="#cb105-902"></a><span class="ss">- </span><span class="in">`fct_inorder()`</span> : 出現順にレベルを設定</span>
<span id="cb105-903"><a href="#cb105-903"></a><span class="ss">- </span><span class="in">`fct_order()`</span> : 頻度順にレベルを設定</span>
<span id="cb105-904"><a href="#cb105-904"></a><span class="ss">- </span><span class="in">`fct_relevel()`</span> : レベルの順序を変更</span>
<span id="cb105-905"><a href="#cb105-905"></a><span class="ss">- </span><span class="in">`fct_recode()`</span> : レベルの名前を変更</span>
<span id="cb105-906"><a href="#cb105-906"></a><span class="ss">- </span><span class="in">`fct_collapse()`</span> : レベルをまとめる</span>
<span id="cb105-907"><a href="#cb105-907"></a><span class="ss">- </span><span class="in">`fct_lump()`</span> : 頻度の低いレベルをまとめる</span>
<span id="cb105-908"><a href="#cb105-908"></a></span>
<span id="cb105-909"><a href="#cb105-909"></a>があります。</span>
<span id="cb105-910"><a href="#cb105-910"></a></span>
<span id="cb105-911"><a href="#cb105-911"></a><span class="fu">### 日付型入門</span></span>
<span id="cb105-912"><a href="#cb105-912"></a></span>
<span id="cb105-913"><a href="#cb105-913"></a></span>
<span id="cb105-914"><a href="#cb105-914"></a>日付データとは、年月日や時間を表すデータです。</span>
<span id="cb105-915"><a href="#cb105-915"></a>たとえば、"2026-02-03"や"2025-01-01 00<span class="sc">:00:</span>01"のような形式で表されます。</span>
<span id="cb105-916"><a href="#cb105-916"></a>日付データは、文字列として記録されていることが多いので、日付型に変換する必要があります。</span>
<span id="cb105-917"><a href="#cb105-917"></a>日付データの操作には<span class="in">`tidyverse`</span>の<span class="in">`lubridate`</span>パッケージを使うと便利です。</span>
<span id="cb105-918"><a href="#cb105-918"></a><span class="in">`lubridate`</span>パッケージには、日付データを簡単に操作するための関数がたくさんあります。</span>
<span id="cb105-919"><a href="#cb105-919"></a></span>
<span id="cb105-920"><a href="#cb105-920"></a><span class="ss">- </span><span class="in">`ymd()`</span> : 年月日形式の文字列を日付型に変換</span>
<span id="cb105-921"><a href="#cb105-921"></a><span class="ss">- </span><span class="in">`mdy()`</span> : 月日年形式の文字列を日付型に変換</span>
<span id="cb105-922"><a href="#cb105-922"></a><span class="ss">- </span><span class="in">`hms()`</span> : 時分秒形式の文字列を時刻型に変換</span>
<span id="cb105-923"><a href="#cb105-923"></a><span class="ss">- </span><span class="in">`ymd_hms()`</span> : 年月日時分秒形式の文字列を日付型に変換</span>
<span id="cb105-924"><a href="#cb105-924"></a><span class="ss">- </span><span class="in">`today()`</span> : 今日の日付を取得</span>
<span id="cb105-925"><a href="#cb105-925"></a><span class="ss">- </span><span class="in">`now()`</span> : 現在の日付と時刻を取得</span>
<span id="cb105-926"><a href="#cb105-926"></a></span>
<span id="cb105-927"><a href="#cb105-927"></a>たとえば，次のように日付っぽい値になっている文字列型なら、<span class="in">`lubridate`</span>パッケージが判別して日付型に変換してくれます。</span>
<span id="cb105-928"><a href="#cb105-928"></a>今回は、<span class="in">`2022-01-15`</span>のように年月日の形式なので<span class="in">`ymd()`</span>関数を使います。</span>
<span id="cb105-929"><a href="#cb105-929"></a></span>
<span id="cb105-932"><a href="#cb105-932"></a><span class="in">```{r}</span></span>
<span id="cb105-933"><a href="#cb105-933"></a>date <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2022-01-15"</span>, <span class="st">"2023/01/15"</span>)</span>
<span id="cb105-934"><a href="#cb105-934"></a><span class="fu">class</span>(date)</span>
<span id="cb105-935"><a href="#cb105-935"></a><span class="in">```</span></span>
<span id="cb105-936"><a href="#cb105-936"></a></span>
<span id="cb105-937"><a href="#cb105-937"></a><span class="co">&lt;!-- `read_csv()`関数で読み込んだ`date`変数は，すでに`Date`型になっています。 --&gt;</span></span>
<span id="cb105-938"><a href="#cb105-938"></a>文字列型の日付データを<span class="in">`Date`</span>型に変換したい場合は，次のようにします。</span>
<span id="cb105-939"><a href="#cb105-939"></a></span>
<span id="cb105-942"><a href="#cb105-942"></a><span class="in">```{r}</span></span>
<span id="cb105-943"><a href="#cb105-943"></a>date <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(date) <span class="co"># 年月日</span></span>
<span id="cb105-944"><a href="#cb105-944"></a>date</span>
<span id="cb105-945"><a href="#cb105-945"></a><span class="fu">class</span>(date)</span>
<span id="cb105-946"><a href="#cb105-946"></a><span class="in">```</span></span>
<span id="cb105-947"><a href="#cb105-947"></a></span>
<span id="cb105-948"><a href="#cb105-948"></a></span>
<span id="cb105-949"><a href="#cb105-949"></a><span class="fu">## 外部パッケージ</span></span>
<span id="cb105-950"><a href="#cb105-950"></a></span>
<span id="cb105-951"><a href="#cb105-951"></a><span class="in">`pacman`</span>パッケージの<span class="in">`p_load()`</span>関数を使うと，CRANに登録されているパッケージのうち，必要なパッケージを一括でインストール・読み込みできます。</span>
<span id="cb105-952"><a href="#cb105-952"></a>未インストールのパッケージなら自動でインストールして読み込み、インストール済みのパッケージならそのまま読み込みます。</span>
<span id="cb105-953"><a href="#cb105-953"></a>たとえば，<span class="in">`tidyverse`</span>パッケージと<span class="in">`skimr`</span>パッケージをインストール・読み込みするには，次のようにします。</span>
<span id="cb105-954"><a href="#cb105-954"></a></span>
<span id="cb105-957"><a href="#cb105-957"></a><span class="in">```{r}</span></span>
<span id="cb105-958"><a href="#cb105-958"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, skimr)</span>
<span id="cb105-959"><a href="#cb105-959"></a><span class="in">```</span></span>
<span id="cb105-960"><a href="#cb105-960"></a></span>
<span id="cb105-961"><a href="#cb105-961"></a>まれに，開発中のパッケージをGitHubからインストールしたい場合があります。その場合は，<span class="in">`pacman`</span>パッケージの<span class="in">`p_load_gh()`</span>関数を使います。たとえば，<span class="in">`username/repo`</span>というGitHubリポジトリからパッケージをインストール・読み込みするには，次のようにします。</span>
<span id="cb105-962"><a href="#cb105-962"></a></span>
<span id="cb105-965"><a href="#cb105-965"></a><span class="in">```{r}</span></span>
<span id="cb105-966"><a href="#cb105-966"></a><span class="co">#| eval: false</span></span>
<span id="cb105-967"><a href="#cb105-967"></a>pacman<span class="sc">::</span><span class="fu">p_load_gh</span>(<span class="st">"username/repo"</span>)</span>
<span id="cb105-968"><a href="#cb105-968"></a><span class="in">```</span></span>
<span id="cb105-969"><a href="#cb105-969"></a></span>
<span id="cb105-970"><a href="#cb105-970"></a>これで，GitHubからパッケージがインストールされ，読み込まれます。</span>
<span id="cb105-971"><a href="#cb105-971"></a><span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> class</span><span class="op">=</span><span class="st">"markp"</span><span class="dt">&gt;</span>GitHubリポジトリにあるパッケージはCRANに登録されていないため、自己責任で使用してください。<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb105-972"><a href="#cb105-972"></a></span>
<span id="cb105-973"><a href="#cb105-973"></a></span>
<span id="cb105-974"><a href="#cb105-974"></a></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Soichi Matsuura</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link" href="https://so-ichi.com/r.html">
      <i class="bi bi-house" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ma2ura">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/matsuura_rits">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>