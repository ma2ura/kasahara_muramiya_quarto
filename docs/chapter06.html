<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Soichi Matsuura">
<title>7&nbsp; ファクターモデルの導入 – 実証会計・ファイナンスの勉強ノート</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter05.html" rel="prev">
<link href="./img/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-0907bcc31431a373ae96853dfe16c1d2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-9b98439fbe4ae1eb56616ecad9777bd3.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-0907bcc31431a373ae96853dfe16c1d2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SFB56VHK63"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SFB56VHK63', { 'anonymize_ip': true});
</script><style>
.marky {
  background: linear-gradient(transparent 60%, #FCFFC1 0%);
}
.markb {
  background: linear-gradient(transparent 60%, #88E2EA 0%);
}
.markp{
  background: linear-gradient(transparent 70%, #ffcdd2 0%)
}
</style>
<script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">
<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta name="twitter:title" content="7&nbsp; ファクターモデルの導入 – 実証会計・ファイナンスの勉強ノート">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="img/KM_fig_6-1.png">
<meta name="twitter:image:alt" content="図6.1 市場ポートフォリオを作成する際の各銘柄の保有比率">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter06.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">ファクターモデルの導入</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">実証会計・ファイナンスの勉強ノート</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">はじめに</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">ファイナンス入門</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R言語入門</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter03_02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">R言語入門 後半</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">財務データの取得と可視化</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">株式データの取得と可視化</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter06.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">ファクターモデルの導入</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E6%A7%8B%E7%AF%89%E3%81%AE%E6%BA%96%E5%82%99" id="toc-ファクター構築の準備" class="nav-link active" data-scroll-target="#%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E6%A7%8B%E7%AF%89%E3%81%AE%E6%BA%96%E5%82%99"><span class="header-section-number">7.1</span> ファクター構築の準備</a></li>
  <li><a href="#%E5%B8%82%E5%A0%B4%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AA%E3%82%AA%E3%81%AE%E6%A7%8B%E7%AF%89" id="toc-市場ポートフォリオの構築" class="nav-link" data-scroll-target="#%E5%B8%82%E5%A0%B4%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AA%E3%82%AA%E3%81%AE%E6%A7%8B%E7%AF%89"><span class="header-section-number">7.2</span> 市場ポートフォリオの構築</a></li>
  <li><a href="#%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AA%E3%82%AA%E3%82%BD%E3%83%BC%E3%83%88" id="toc-ポートフォリオソート" class="nav-link" data-scroll-target="#%E3%83%9D%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%AA%E3%82%AA%E3%82%BD%E3%83%BC%E3%83%88"><span class="header-section-number">7.3</span> ポートフォリオ・ソート</a></li>
  <li>
<a href="#capm%E3%81%AE%E5%AE%9F%E8%A8%BC%E7%9A%84%E3%81%AA%E6%A4%9C%E8%A8%BC" id="toc-capmの実証的な検証" class="nav-link" data-scroll-target="#capm%E3%81%AE%E5%AE%9F%E8%A8%BC%E7%9A%84%E3%81%AA%E6%A4%9C%E8%A8%BC"><span class="header-section-number">7.4</span> CAPMの実証的な検証</a>
  <ul class="collapse">
<li><a href="#capm%E3%82%92%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B%E6%84%8F%E7%BE%A9" id="toc-capmを検証する意義" class="nav-link" data-scroll-target="#capm%E3%82%92%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B%E6%84%8F%E7%BE%A9"><span class="header-section-number">7.4.1</span> CAPMを検証する意義</a></li>
  </ul>
</li>
  <li>
<a href="#ch06_22-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%94%E3%81%A8%E3%81%AE%E7%B7%9A%E5%BD%A2%E5%9B%9E%E5%B8%B0-2-map%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88" id="toc-ch06_22-グループごとの線形回帰-2-map関数を使う場合" class="nav-link" data-scroll-target="#ch06_22-%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%94%E3%81%A8%E3%81%AE%E7%B7%9A%E5%BD%A2%E5%9B%9E%E5%B8%B0-2-map%E9%96%A2%E6%95%B0%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88"><span class="header-section-number">8</span> ch06_22: グループごとの線形回帰 (2) map()関数を使う場合</a>
  <ul class="collapse">
<li><a href="#fama-french%E3%81%AE3%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E3%83%A2%E3%83%87%E3%83%AB" id="toc-fama-frenchの3ファクターモデル" class="nav-link" data-scroll-target="#fama-french%E3%81%AE3%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%BC%E3%83%A2%E3%83%87%E3%83%AB"><span class="header-section-number">8.0.1</span> 6.3 Fama-Frenchの3ファクター・モデル</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">7</span>&nbsp; <span class="chapter-title">ファクターモデルの導入</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2"></a>  tidyverse, ggthemes, ggpubr, plotly, patchwork, Rsolnp, broom</span>
<span id="cb1-3"><a href="#cb1-3"></a>)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a>mystyle <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="fu">theme_economist_white</span>(</span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="at">base_family =</span> <span class="st">"HiraKakuProN-W3"</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    ),</span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="fu">scale_colour_economist</span>(),</span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="fu">theme</span>(</span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb1-13"><a href="#cb1-13"></a>  )</span>
<span id="cb1-14"><a href="#cb1-14"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="ファクター構築の準備" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="ファクター構築の準備">
<span class="header-section-number">7.1</span> ファクター構築の準備</h2>
<ol type="1">
<li>CAPMの実証的検証に必要な市場ポートフォリオの構築</li>
<li>ある特徴に基づいて各銘柄をランキングにし，ランキングに応じたポートフォリオの構築</li>
</ol></section><section id="市場ポートフォリオの構築" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="市場ポートフォリオの構築">
<span class="header-section-number">7.2</span> 市場ポートフォリオの構築</h2>
<p>市場ポートフォリオ (market portfolio)とは，<strong>市場に存在する全ての危険資産を時価総額比率で保有したポートフォリオ</strong>をいいます。 厳密には，リスク資産には株式や債券に代表される金融資産の他、不動産や貴金属などの実物資産も含まれますが、実用上はTOPIXやS&amp;P500といった株価指数と同一視されることが多いです。</p>
<p>ここでは，データとして入手可能な<strong>全銘柄の時価総額と個別銘柄の時価総額の比率をウェイト</strong>として市場ポートフォリオを構築します。</p>
<p>毎年1月に年次リバランスを想定し，前年度末の時価総額に比例した保有費率の計算をします。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>monthly_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ch05_output1.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a>annual_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ch05_output2.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>ここでもデータの構造を確認しておきます。 <code>monthly_data</code>は<strong>月次の</strong>株価の終値，一株当り配当額，発行済株式数，調整係数，無リスク利子率，時価総額といった株式データが収録されています。 <code>annual_data</code>は<strong>年次の</strong>売上高や当期純利益など財務データが収録されています。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">glimpse</span>(monthly_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 95,040
Columns: 25
$ year                   &lt;dbl&gt; 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015,…
$ month                  &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3,…
$ month_ID               &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …
$ firm_ID                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ stock_price            &lt;dbl&gt; 954, 960, 1113, 1081, 1317, 1366, 1353, 1209, 1…
$ DPS                    &lt;dbl&gt; 0, 0, 0, 0, 0, 29, 0, 0, 0, 0, 0, 29, 0, 0, 0, …
$ shares_outstanding     &lt;dbl&gt; 2422000, 2422000, 2422000, 2422000, 2422000, 24…
$ adjustment_coefficient &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ R_F                    &lt;dbl&gt; 6.506826e-04, 5.834099e-04, 6.114423e-04, 6.848…
$ ME                     &lt;dbl&gt; 2310588000, 2325120000, 2695686000, 2618182000,…
$ lagged_stock_price     &lt;dbl&gt; NA, 954, 960, 1113, 1081, 1317, 1366, 1353, 120…
$ R                      &lt;dbl&gt; NA, 0.006289308, 0.159375000, -0.028751123, 0.2…
$ Re                     &lt;dbl&gt; NA, 0.005705898, 0.158763558, -0.029435941, 0.2…
$ industry_ID            &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ sales                  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ OX                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ NFE                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ X                      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ OA                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ FA                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ OL                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ FO                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ BE                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ lagged_BE              &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ ROE                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">glimpse</span>(annual_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 7,920
Columns: 18
$ firm_ID     &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4…
$ year        &lt;dbl&gt; 2015, 2016, 2017, 2018, 2019, 2020, 2015, 2016, 2017, 2018…
$ R           &lt;dbl&gt; NA, 0.99727265, 0.68786382, -0.21361287, 0.64683576, -0.28…
$ Re          &lt;dbl&gt; NA, 0.99670766, 0.68781497, -0.21939898, 0.64760569, -0.28…
$ R_F         &lt;dbl&gt; 7.432089e-03, 5.649890e-04, 4.884804e-05, 5.786109e-03, -7…
$ industry_ID &lt;dbl&gt; NA, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ sales       &lt;dbl&gt; NA, 5948.96, 6505.06, 6846.38, 7572.24, 7537.63, 3505.75, …
$ OX          &lt;dbl&gt; NA, 564.14, 691.18, 751.29, 958.53, 778.37, 45.82, 51.25, …
$ NFE         &lt;dbl&gt; NA, 50.667498, 29.543157, 86.486500, 298.049774, -65.45877…
$ X           &lt;dbl&gt; NA, 513.48, 661.64, 664.80, 660.48, 843.83, 40.07, 49.37, …
$ OA          &lt;dbl&gt; NA, 13865.58, 13952.58, 18818.48, 18190.00, 20462.86, 2977…
$ FA          &lt;dbl&gt; NA, 4642.16, 7743.99, 7284.72, 9735.13, 10274.25, 2258.33,…
$ OL          &lt;dbl&gt; NA, 4534.22, 5111.22, 5137.28, 5487.96, 5371.38, 1840.35, …
$ FO          &lt;dbl&gt; NA, 3959.70, 6159.02, 10123.91, 11362.22, 13772.15, 2340.8…
$ BE          &lt;dbl&gt; NA, 10013.82, 10426.33, 10842.01, 11074.95, 11593.58, 1054…
$ lagged_BE   &lt;dbl&gt; NA, NA, 10013.82, 10426.33, 10842.01, 11074.95, NA, 1054.9…
$ ROE         &lt;dbl&gt; NA, NA, 0.06607269, 0.06376165, 0.06091859, 0.07619267, NA…
$ ME          &lt;dbl&gt; 3577.294, 6883.324, 11376.990, 8694.752, 13957.518, 9708.9…</code></pre>
</div>
</div>
<p>市場ポートフォリオの構築に用いるウェイトは次のように計算します。<span class="math inline">ME_{i,t}</span>は<span class="math inline">t</span>期末における銘柄<span class="math inline">i</span>の時価総額を表します。 分母は，<span class="math inline">N</span>個ある全銘柄の時価総額を合計しています。 <span class="math display">
w_{i,t}^M = \frac{ME_{i,t-1}^{12\text{月}}}{\sum_{j = 1}^N ME_{j,t-1}^{12\text{月}}}
</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="img/KM_fig_6-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="図6.1 市場ポートフォリオを作成する際の各銘柄の保有比率"><img src="img/KM_fig_6-1.png" class="img-fluid figure-img" alt="図6.1 市場ポートフォリオを作成する際の各銘柄の保有比率"></a></p>
<figcaption>図6.1 市場ポートフォリオを作成する際の各銘柄の保有比率</figcaption></figure>
</div>
<p>この銘柄ごとの保有費率を計算するために，前年度末の時価総額を計算し，<code>lagged_ME</code>に代入します。 <code>annual_data</code>は2015年から2020年のデータが入っています。 <code><a href="https://rdrr.io/r/stats/lag.html">lag()</a></code>で前期末の時価総額を<code>lagged_ME</code>に代入しようとしても2015年の前年のデータは存在しないので，欠損値になることに注意しましょう。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>    <span class="fu">group_by</span>(firm_ID) <span class="sc">%&gt;%</span> <span class="co"># 企業ごとに</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="fu">mutate</span>(<span class="at">lagged_ME =</span> <span class="fu">lag</span>(ME)) <span class="sc">%&gt;%</span> <span class="co"># 前期末時価総額</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="fu">ungroup</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>この処理の結果がおおよそこんな感じになっているはずです。</p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: left;">firm_ID</th>
<th style="text-align: right;">year</th>
<th style="text-align: right;">ME</th>
<th style="text-align: right;">lagged_ME</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: right;">2015</td>
<td style="text-align: right;">3577.294</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: right;">2016</td>
<td style="text-align: right;">6883.324</td>
<td style="text-align: right;">3577.294</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: right;">2017</td>
<td style="text-align: right;">11376.990</td>
<td style="text-align: right;">6883.324</td>
</tr>
</tbody>
</table>
<p>この<code>lagged_ME</code>を使って保有費率を計算します。 年度ごとに時価総額を合計し、ある企業の前期末時価総額を合計時価総額で割ることで保有費率<code>w_M</code>を計算します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>    <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span> <span class="co"># 年度ごとに</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-4"><a href="#cb8-4"></a>        <span class="at">w_M =</span> lagged_ME <span class="sc">/</span> <span class="fu">sum</span>(lagged_ME, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># ウェイト</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>    <span class="fu">ungroup</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>2015年の<code>lagged_ME</code>は欠損値なので，<code>w_M</code>も欠損値になっていますが，2015年のデータはもう使わないので無視します。</p>
<p>次に，2016年以降の欠損値の行を削除するのではなく，保有費率<code>w_M</code>をゼロに置き換えることで投資しないことを表します。 <code>mutate()</code>と<code><a href="https://rdrr.io/r/base/replace.html">replace()</a></code>を用いて変数の置き換えをします。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>    <span class="fu">mutate</span>( <span class="co"># w_Mの欠損値を0に置き換える</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>        <span class="at">w_M =</span> <span class="fu">replace</span>(w_M, year <span class="sc">&gt;=</span> <span class="dv">2016</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(w_M), <span class="dv">0</span>)</span>
<span id="cb9-4"><a href="#cb9-4"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><code><a href="https://rdrr.io/r/base/replace.html">replace()</a></code>関数は，第1引数のデータに対して，第2引数の条件を満たす要素を，第3引数の値に置き換えます。 ここでは，<code>w_M</code>に対して，<code>year</code>が2016以上で，かつ<code>w_M</code>が欠損値の場合の<code>w_M</code>を0に置き換えています。</p>
<p>作成した保有費率を表すウェイト<code>w_M</code>の合計が1になっているかどうかを確認します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>annual_data <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>    <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="fu">summarise</span>(</span>
<span id="cb10-4"><a href="#cb10-4"></a>        <span class="at">weight_sum =</span> <span class="fu">sum</span>(w_M)</span>
<span id="cb10-5"><a href="#cb10-5"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
   year weight_sum
  &lt;dbl&gt;      &lt;dbl&gt;
1  2015      NA   
2  2016       1.00
3  2017       1.00
4  2018       1   
5  2019       1   
6  2020       1.00</code></pre>
</div>
</div>
<p>確認できました。 これまでの操作で変数を追加した<code>annual_data</code>に<code>monthly_data</code>に結合します。 <strong>完全外部結合</strong>(full outer join)を行います。 完全外部結合とは，データベースを連結する操作の1つで、2つのデータフレームからそれぞれ特定のキーとなる列を指定して，キーの値が一致する行同士は連結し、一致しない残りの行もそのまますべて抽出するものです。</p>
<p>では<code>full_join()</code>関数を使って，<code>annual_data</code>と<code>monthly_data</code>を<code>year</code>と<code>firm_ID</code>の2つのキーで結合し，その結果を<code>monthly_data</code>に代入します。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>月次データに保有費率のデータを追加</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>monthly_data <span class="ot">&lt;-</span> annual_data <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">select</span>(year, firm_ID, w_M) <span class="sc">|&gt;</span> <span class="co"># 必要な変数のみ</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">|&gt;</span> <span class="co"># 完全外部結合</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">select</span>(<span class="sc">-</span>w_M, w_M) <span class="co"># w_Mを最終列に移動</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>できあがった拡大データセット<code>monthly_data</code>を確認します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">glimpse</span>(monthly_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 95,040
Columns: 26
$ year                   &lt;dbl&gt; 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015,…
$ firm_ID                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ month                  &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3,…
$ month_ID               &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …
$ stock_price            &lt;dbl&gt; 954, 960, 1113, 1081, 1317, 1366, 1353, 1209, 1…
$ DPS                    &lt;dbl&gt; 0, 0, 0, 0, 0, 29, 0, 0, 0, 0, 0, 29, 0, 0, 0, …
$ shares_outstanding     &lt;dbl&gt; 2422000, 2422000, 2422000, 2422000, 2422000, 24…
$ adjustment_coefficient &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ R_F                    &lt;dbl&gt; 6.506826e-04, 5.834099e-04, 6.114423e-04, 6.848…
$ ME                     &lt;dbl&gt; 2310588000, 2325120000, 2695686000, 2618182000,…
$ lagged_stock_price     &lt;dbl&gt; NA, 954, 960, 1113, 1081, 1317, 1366, 1353, 120…
$ R                      &lt;dbl&gt; NA, 0.006289308, 0.159375000, -0.028751123, 0.2…
$ Re                     &lt;dbl&gt; NA, 0.005705898, 0.158763558, -0.029435941, 0.2…
$ industry_ID            &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ sales                  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ OX                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ NFE                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ X                      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ OA                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ FA                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ OL                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ FO                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ BE                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ lagged_BE              &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ ROE                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ w_M                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…</code></pre>
</div>
</div>
<p>準備が整ったので，市場ポートフォリオの月次リターンを計算します。 <span class="math inline">t</span>時点における市場ポートフォリオのリターン<span class="math inline">R_{M,t}</span>は、個別銘柄のリターン<span class="math inline">R_{i,t}</span>とウェイト<span class="math inline">w_{i,t}^M</span>の積の合計で表されます。</p>
<p><span class="math display">
R_{M,t} = \sum_{i=1}^{N} w_{i,t}^M R_{i,t}
</span></p>
<p>これをRで実装します。 <code>monthly_data</code>を<code>month_ID</code>でグループ化し，<code>summarise()</code>関数を用いて，<code>R_M</code>を計算し，その後で<code>mutate()</code>関数を用いて，<code>R_Me</code>を計算し，その結果を<code>factor_data</code>に代入します。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>市場ポートフォリオの月次リターンを計算</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>factor_data <span class="ot">&lt;-</span> monthly_data <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">filter</span>(month_ID <span class="sc">&gt;=</span> <span class="dv">13</span>) <span class="sc">|&gt;</span> <span class="co"># 2016以降のデータを抽出</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">group_by</span>(month_ID) <span class="sc">|&gt;</span> <span class="co"># 月次データを月ごとに</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="fu">summarise</span>(</span>
<span id="cb15-5"><a href="#cb15-5"></a>    <span class="at">R_F =</span> R_F[<span class="dv">1</span>], <span class="co"># 無リスク金利を抽出</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>    <span class="at">R_M =</span> <span class="fu">sum</span>(w_M <span class="sc">*</span> R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># 月次リターンの加重平均</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>  <span class="fu">mutate</span>(<span class="at">R_Me =</span> R_M <span class="sc">-</span> R_F) <span class="co"># 月次超過リターン変数を作成</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p><code>factor_data</code>の中身を<code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>で確認します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">summary</span>(factor_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    month_ID          R_F                  R_M                 R_Me          
 Min.   :13.00   Min.   :-2.329e-04   Min.   :-0.102438   Min.   :-0.102438  
 1st Qu.:27.75   1st Qu.:-4.107e-05   1st Qu.:-0.011056   1st Qu.:-0.010890  
 Median :42.50   Median : 3.870e-05   Median : 0.006081   Median : 0.006186  
 Mean   :42.50   Mean   : 9.991e-05   Mean   : 0.004100   Mean   : 0.004000  
 3rd Qu.:57.25   3rd Qu.: 1.323e-04   3rd Qu.: 0.031698   3rd Qu.: 0.031649  
 Max.   :72.00   Max.   : 6.326e-04   Max.   : 0.111043   Max.   : 0.110819  </code></pre>
</div>
</div>
<p>作成した市場ポートフォリオの超過リターンをヒストグラムにして分布を確認します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># 市場ポートフォリオの月次超過リターンをヒストグラムで可視化</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="fu">ggplot</span>(factor_data) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> R_Me) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"市場ポートフォリオの月次超過リターン"</span>, <span class="at">y =</span> <span class="st">"度数"</span>) <span class="sc">+</span> mystyle</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/ch06_08-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="chapter06_files/figure-html/ch06_08-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>次に、市場ポートフォリオの累積リターンを計算します。 計算の仮定は以下の通りです。</p>
<ol type="1">
<li>
<code>month_ID</code>が13の月初から運用スタートし、バイアンドホールドで運用すると仮定する。</li>
<li>毎年1月にコストなしでリバランスし、リバランス前後で元本の変動はないと仮定する。</li>
</ol>
<p>市場ポートフォリオの累積グロス・リターンを計算します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>df_g <span class="ot">&lt;-</span> factor_data <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="at">gross_R_M =</span> <span class="dv">1</span> <span class="sc">+</span> R_M, <span class="co"># rに1足してグラスリターン</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="at">cumulative_gross_R_M =</span> <span class="fu">cumprod</span>(gross_R_M) <span class="co"># 累積グロスリターン</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>作成した累積グロス・リターンを折れ線グラフで可視化します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_g) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> month_ID, <span class="at">y =</span> cumulative_gross_R_M) <span class="sc">+</span> <span class="fu">geom_line</span>()</span>
<span id="cb20-2"><a href="#cb20-2"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month ID"</span>, <span class="at">y =</span> <span class="st">"累積グロスリターン"</span>) <span class="sc">+</span> mystyle</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="fu">print</span>(g)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/ch06_09b-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="chapter06_files/figure-html/ch06_09b-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>累積リターンであることが一発で分かるように、始点を1として、折れ線グラフを描き直します。 <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code>で始点となるデータを追加し、<code>geom_hline()</code>で始点の水準を点線で図示します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># ch06_10: 市場ポートフォリオの累積リターンの可視化 (2)</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>df_g <span class="ot">&lt;-</span> factor_data <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="fu">mutate</span>(<span class="at">gross_R_M =</span> <span class="dv">1</span> <span class="sc">+</span> R_M,</span>
<span id="cb21-4"><a href="#cb21-4"></a>         <span class="at">cumulative_gross_R_M =</span> <span class="fu">cumprod</span>(gross_R_M)) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="fu">select</span>(month_ID, cumulative_gross_R_M) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">1</span>), .) <span class="co"># 折れ線グラフの始点を追加</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="co"># 折れ線グラフを作成</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_g) <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> month_ID, <span class="at">y =</span> cumulative_gross_R_M)) <span class="sc">+</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span> <span class="co"># 元本の水準を点線で図示</span></span>
<span id="cb21-11"><a href="#cb21-11"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month ID"</span>, <span class="at">y =</span> <span class="st">"Cumulative Gross Return"</span>) <span class="sc">+</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fl">0.5</span>,<span class="fl">1.5</span>) <span class="sc">+</span>  mystyle</span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="fu">print</span>(g)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/unnamed-chunk-1-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="chapter06_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="ポートフォリオソート" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="ポートフォリオソート">
<span class="header-section-number">7.3</span> ポートフォリオ・ソート</h2>
<p>ある特性に基づいて株式銘柄をランキングにし、そのランキングに基づいてポートフォリオを構築することを<strong>ポートフォリオ・ソート</strong>と呼びます。 ポートフォリオ・ソートは、ファクター・モデルの検証において重要な手法です。 ここでは<strong>前年度末の時価総額</strong>に基づいて、企業を10個のグループに分類して、実現リターンの比較をしてみましょう。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="img/KM_fig_6-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="図6.2 前年度末の時価総額に基づくポートフォリオ・ソート"><img src="img/KM_fig_6-2.png" class="img-fluid figure-img" alt="図6.2 前年度末の時価総額に基づくポートフォリオ・ソート"></a></p>
<figcaption>図6.2 前年度末の時価総額に基づくポートフォリオ・ソート</figcaption></figure>
</div>
<p>Rで時価総額ランキングを作成するには、<code>ntile()</code>関数を用います。 <code>ntile()</code>関数は、データを指定した数のグループに分類します。 以下のコードでは、<code>mutate()</code>関数で<code>ME_rank10</code>を新たに作成しています。 <code>ME_rank10</code>は、<code>lagged_ME</code>変数を<code>ntile()</code>関数で10個に分類し、<code><a href="https://rdrr.io/r/base/factor.html">as.factor()</a></code>関数で因子型に変換したものです。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># ch06_11: 前年度末の時価総額に基づくポートフォリオ・ソート (1)</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span> <span class="co"># 年度ごとに</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="at">ME_rank10 =</span> <span class="fu">as.factor</span>(<span class="fu">ntile</span>(lagged_ME, <span class="dv">10</span>))</span>
<span id="cb22-6"><a href="#cb22-6"></a>    ) <span class="sc">%&gt;%</span> <span class="co"># ntile()関数を用いて十個のグループに分類</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="fu">ungroup</span>() <span class="co"># グループ化解除</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="fu">head</span>(annual_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 21
  firm_ID  year      R     Re        R_F industry_ID sales    OX   NFE     X
    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1       1  2015 NA     NA      0.00743            NA   NA    NA   NA     NA 
2       1  2016  0.997  0.997  0.000565            1 5949.  564.  50.7  513.
3       1  2017  0.688  0.688  0.0000488           1 6505.  691.  29.5  662.
4       1  2018 -0.214 -0.219  0.00579             1 6846.  751.  86.5  665.
5       1  2019  0.647  0.648 -0.000770            1 7572.  959. 298.   660.
6       1  2020 -0.284 -0.285  0.000380            1 7538.  778. -65.5  844.
# ℹ 11 more variables: OA &lt;dbl&gt;, FA &lt;dbl&gt;, OL &lt;dbl&gt;, FO &lt;dbl&gt;, BE &lt;dbl&gt;,
#   lagged_BE &lt;dbl&gt;, ROE &lt;dbl&gt;, ME &lt;dbl&gt;, lagged_ME &lt;dbl&gt;, w_M &lt;dbl&gt;,
#   ME_rank10 &lt;fct&gt;</code></pre>
</div>
</div>
<p><code>ME_rank10</code>の値と、年・ランキングごとの会社数を確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">summary</span>(annual_data<span class="sc">$</span>ME_rank10)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   1    2    3    4    5    6    7    8    9   10 NA's 
 643  642  641  641  640  640  640  640  639  639 1515 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">table</span>(annual_data<span class="sc">$</span>year,  annual_data<span class="sc">$</span>ME_rank10)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      
         1   2   3   4   5   6   7   8   9  10
  2015   0   0   0   0   0   0   0   0   0   0
  2016 125 124 124 124 124 124 124 124 124 124
  2017 127 127 127 127 127 127 127 127 127 127
  2018 127 127 127 127 127 127 127 127 126 126
  2019 131 131 131 131 130 130 130 130 130 130
  2020 133 133 132 132 132 132 132 132 132 132</code></pre>
</div>
</div>
<p>ここでは、<code>ME_rank10</code>の値が10の企業が時価総額ランキングの上位10%に、1の企業が時価総額ランキングの下位10%に属することを意味します。</p>
<p>前回と同様に、<code>full_join()</code>関数で<code>monthly_data</code>と<code>annual_data</code>を結合します。 <code>drop_na()</code>関数で欠損行を削除し、<code>group_by()</code>関数で<code>month_ID</code>と<code>ME_rank10</code>に関してグループ化した上で、<code>summarize()</code>関数で月次超過リターン<code>Re</code>の平均値を計算して、<code>Re</code>変数としています。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>前年度末の時価総額に基づくポートフォリオ・ソート</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>ME_sorted_portfolio <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="fu">select</span>(year, firm_ID, ME_rank10) <span class="sc">%&gt;%</span> <span class="co"># 年次データから追加したい情報を抽出</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">%&gt;%</span> <span class="co"># yearとfirm_IDをキーに月次データと結合</span></span>
<span id="cb28-4"><a href="#cb28-4"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> <span class="co"># 欠損行を削除</span></span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="fu">group_by</span>(month_ID, ME_rank10) <span class="sc">%&gt;%</span> <span class="co"># month_IDとME_rank10に関してグループ化</span></span>
<span id="cb28-6"><a href="#cb28-6"></a>  <span class="fu">summarize</span>(<span class="at">Re =</span> <span class="fu">mean</span>(Re)) <span class="sc">%&gt;%</span> <span class="co"># 各グループで月次超過リターンの平均値を計算</span></span>
<span id="cb28-7"><a href="#cb28-7"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-8"><a href="#cb28-8"></a>ME_sorted_portfolio</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 600 × 3
   month_ID ME_rank10     Re
      &lt;dbl&gt; &lt;fct&gt;      &lt;dbl&gt;
 1       13 1         0.0291
 2       13 2         0.0272
 3       13 3         0.0353
 4       13 4         0.0545
 5       13 5         0.0460
 6       13 6         0.0438
 7       13 7         0.0530
 8       13 8         0.0398
 9       13 9         0.0536
10       13 10        0.0478
# ℹ 590 more rows</code></pre>
</div>
</div>
<p>準備が出来たので、各ポートフォリオの平均超過リターンを可視化してみましょう。 これにより、時価総額の大きい企業のポートフォリオが、時価総額の小さい企業のポートフォリオよりも高い、あるいは低いリターンを上げているかどうかを確認することができます。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>各ポートフォリオの平均超過リターンを可視化</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>ME_cross_sectional_return <span class="ot">&lt;-</span> ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">group_by</span>(ME_rank10) <span class="sc">%&gt;%</span> <span class="co"># ME_rank10に関してグループ化</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="fu">summarize</span>(<span class="at">mean_Re =</span> <span class="fu">mean</span>(Re)) <span class="co"># 月次超過リターンの平均値を計算</span></span>
<span id="cb30-4"><a href="#cb30-4"></a></span>
<span id="cb30-5"><a href="#cb30-5"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(ME_cross_sectional_return) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> ME_rank10, <span class="at">y =</span> mean_Re)</span>
<span id="cb30-6"><a href="#cb30-6"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">geom_col</span>() <span class="co"># 棒グラフ</span></span>
<span id="cb30-7"><a href="#cb30-7"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"時価総額ランク"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"平均月次超過リターン"</span>)</span>
<span id="cb30-8"><a href="#cb30-8"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fl">0.02</span>) <span class="sc">+</span> mystyle</span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="fu">print</span>(g)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/ch06_14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="chapter06_files/figure-html/ch06_14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>小型株ほど月次超過リターンの平均が高いことが分かりました。 このように、時価総額の大きい企業のポートフォリオと小さい企業のポートフォリオのリターンの差を<strong>サイズ・プレミアム</strong>と呼びます。</p>
<p>先ほどは各ポートフォリオの区分を同じウェイトで保有した場合のリターンを計算しましたが，コラムでは，時価総額の大きさに応じてウェイトを変えた時価総額加重ポートフォリオを作成して，先ほどの結果を再現してみる。</p>
<p>まずは等加重の場合のコードを確認する。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>BPRに基づくポートフォリオ・ソート（等加重の場合）</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>  <span class="fu">mutate</span>(<span class="at">lagged_BEME =</span> lagged_BE <span class="sc">/</span> lagged_ME) <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4"></a>  <span class="fu">mutate</span>(<span class="at">BEME_rank10 =</span> <span class="fu">as.factor</span>(<span class="fu">ntile</span>(lagged_BEME, <span class="dv">10</span>))) <span class="sc">%&gt;%</span> <span class="co"># 簿価時価比率に基づいて十個のグループに分類</span></span>
<span id="cb31-5"><a href="#cb31-5"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb31-6"><a href="#cb31-6"></a></span>
<span id="cb31-7"><a href="#cb31-7"></a>BEME_sorted_portfolio <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb31-8"><a href="#cb31-8"></a>  <span class="fu">select</span>(year, firm_ID, BEME_rank10, lagged_ME) <span class="sc">%&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-10"><a href="#cb31-10"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11"></a>  <span class="fu">group_by</span>(month_ID, BEME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb31-12"><a href="#cb31-12"></a>  <span class="fu">summarize</span>(<span class="at">Re =</span> <span class="fu">mean</span>(Re)) <span class="sc">%&gt;%</span> <span class="co"># 月次超過リターンの平均値を計算</span></span>
<span id="cb31-13"><a href="#cb31-13"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="co"># 作図</span></span>
<span id="cb31-15"><a href="#cb31-15"></a><span class="fu">group_by</span>(BEME_sorted_portfolio, BEME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb31-16"><a href="#cb31-16"></a>  <span class="fu">summarize</span>(<span class="at">mean_Re =</span> <span class="fu">mean</span>(Re)) <span class="sc">%&gt;%</span></span>
<span id="cb31-17"><a href="#cb31-17"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb31-18"><a href="#cb31-18"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank10, <span class="at">y =</span> mean_Re)) <span class="sc">+</span></span>
<span id="cb31-19"><a href="#cb31-19"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="co"># y = 0の直線を追加</span></span>
<span id="cb31-20"><a href="#cb31-20"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME Rank"</span>, <span class="at">y =</span> <span class="st">"Mean Monthly Excess Return"</span>) <span class="sc">+</span></span>
<span id="cb31-21"><a href="#cb31-21"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.005</span>, <span class="fl">0.02</span>)) <span class="sc">+</span> mystyle</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/ch06_15a-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="chapter06_files/figure-html/ch06_15a-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>次に時価総額加重の場合のコードを確認します。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>BPRに基づくポートフォリオ・ソート（時価総額加重の場合）</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># 中盤で保有比率wと月次超過リターンReを計算している箇所を除けば,ch06_15aと全く同じ</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3"></a>  <span class="fu">mutate</span>(<span class="at">lagged_BEME =</span> lagged_BE <span class="sc">/</span> lagged_ME) <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb32-5"><a href="#cb32-5"></a>  <span class="fu">mutate</span>(<span class="at">BEME_rank10 =</span> <span class="fu">as.factor</span>(<span class="fu">ntile</span>(lagged_BEME, <span class="dv">10</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb32-7"><a href="#cb32-7"></a></span>
<span id="cb32-8"><a href="#cb32-8"></a>BEME_sorted_portfolio <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>  <span class="fu">select</span>(year, firm_ID, BEME_rank10, lagged_ME) <span class="sc">%&gt;%</span></span>
<span id="cb32-10"><a href="#cb32-10"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-11"><a href="#cb32-11"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-12"><a href="#cb32-12"></a>  <span class="fu">group_by</span>(month_ID, BEME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb32-13"><a href="#cb32-13"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> lagged_ME <span class="sc">/</span> <span class="fu">sum</span>(lagged_ME)) <span class="sc">%&gt;%</span> <span class="co"># 各ポートフォリオで保有比率を計算</span></span>
<span id="cb32-14"><a href="#cb32-14"></a>  <span class="fu">summarize</span>(<span class="at">Re =</span> <span class="fu">sum</span>(w <span class="sc">*</span> Re)) <span class="sc">%&gt;%</span> <span class="co"># 時価総額加重の月次超過リターンを計算</span></span>
<span id="cb32-15"><a href="#cb32-15"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb32-16"><a href="#cb32-16"></a></span>
<span id="cb32-17"><a href="#cb32-17"></a><span class="fu">group_by</span>(BEME_sorted_portfolio, BEME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb32-18"><a href="#cb32-18"></a>  <span class="fu">summarize</span>(<span class="at">mean_Re =</span> <span class="fu">mean</span>(Re)) <span class="sc">%&gt;%</span></span>
<span id="cb32-19"><a href="#cb32-19"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-20"><a href="#cb32-20"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank10, <span class="at">y =</span> mean_Re)) <span class="sc">+</span></span>
<span id="cb32-21"><a href="#cb32-21"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb32-22"><a href="#cb32-22"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME Rank"</span>, <span class="at">y =</span> <span class="st">"Mean Monthly Excess Return"</span>) <span class="sc">+</span></span>
<span id="cb32-23"><a href="#cb32-23"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.005</span>, <span class="fl">0.02</span>)) <span class="sc">+</span> mystyle</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/ch06_15b-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="chapter06_files/figure-html/ch06_15b-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>結果が異なっていることに注意しましょう。</p>
<p>次節では，この現象を，資産価格モデルの1つであるCAPM(Capital Asset Pricing Model)が説明できるかどうかを検証します。</p>
</section><section id="capmの実証的な検証" class="level2" data-number="7.4"><h2 data-number="7.4" class="anchored" data-anchor-id="capmの実証的な検証">
<span class="header-section-number">7.4</span> CAPMの実証的な検証</h2>
<section id="capmを検証する意義" class="level3" data-number="7.4.1"><h3 data-number="7.4.1" class="anchored" data-anchor-id="capmを検証する意義">
<span class="header-section-number">7.4.1</span> CAPMを検証する意義</h3>
<p>まずはCAPMの復習から始めましょう。 CAPMは，資産の期待リターンを，市場ポートフォリオの期待リターンと市場ポートフォリオとの共分散で説明するモデルです。</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>CAPM
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>
<strong>第1命題</strong>: 市場ポートフォリオは接点ポートフォリオと一致し，効率的フ ロンティア(資本市場線)上に位置する.</li>
<li>
<strong>第2命題</strong>: 各証券のリスクプレミアムは，その証券のマーケット・ベータ に比例する.</li>
</ul>
<p><span class="math display">
\mathbb{E}[R_i] - R_F = \beta_i \left ( \mathbb{E}[R_M] - R_F \right )
</span> ただし， <span class="math display">
\beta_i = \frac{\mathrm{COV}_{R_i,  R_M}}{\mathrm{Var}_M}
</span></p>
</div>
</div>
<p>このCAPMを回帰式で表現すると次のようになります。</p>
<p><span class="math display">
R_{i,t}^e = \beta_i \times R_{M,t}^e + \varepsilon_{i,t}
</span> ここで、<span class="math inline">R^e_{i,t} = R_{i,t} - R_{F,t}</span>である。 つまり、<span class="math inline">t</span>時点における証券<span class="math inline">i</span>の実現超過リターン<span class="math inline">R_{i,t}^e</span>は、<span class="math inline">t</span>時点における市場ポートフォリオの実現超過リターン<span class="math inline">R_{M,t}^e</span>と、証券<span class="math inline">i</span>の市場ポートフォリオに対するベータ係数<span class="math inline">\beta_i</span>の積に、誤差項<span class="math inline">\varepsilon_{i,t}</span>を加えたものとして表現されます。</p>
<p>また、誤差項<span class="math inline">\varepsilon_{i,t}</span>に関して次の仮定を置きます。</p>
<ul>
<li>
<span class="math inline">varepsilon _{i,t}</span>は独立同一分布(i.i.d.)に従う</li>
<li><span class="math inline">E[\varepsilon_{i,t}] = 0</span></li>
<li><span class="math inline">E[R_{M,t}^e , \ \varepsilon_{i,t} ] = 0</span></li>
</ul>
<p>こうすることで、CAPM式を線形回帰モデルで表現できるので、<span class="math inline">\beta_i</span>の推定が可能となります。</p>
<section id="時系列回帰" class="level4" data-number="7.4.1.1"><h4 data-number="7.4.1.1" class="anchored" data-anchor-id="時系列回帰">
<span class="header-section-number">7.4.1.1</span> 6.2.2 時系列回帰</h4>
<p>CAPM式は任意の<span class="math inline">i</span>証券で成立するモデルのため、ポートフォリオにも応用できます。 つまりあるポートフォリオの超過リターンを、市場ポートフォリオの超過リターンと、そのポートフォリオに対するベータ係数の積で説明することができます。</p>
<p><span class="math display">
R_{P,t}^e = \alpha _P + \beta_P R_{M,t}^e + \varepsilon_{P,t}
</span></p>
<p>CAPMの式と比較すると、切片である<span class="math inline">\alpha _P</span>が追加されていることが分かります。 もし証券市場にCAPMの関係が成立しているなら、<span class="math inline">\alpha _P</span>はゼロとなっているはずです。 この$$を調べることで、CAPMの検証が可能となります。</p>
<p>ここでは、<strong>時系列回帰</strong>を使って、市場ポートフォリオの超過リターンを説明変数として、各ポートフォリオの超過リターンを説明するモデルを推定します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># ch06_16: 市場ポートフォリオの超過リターンを追加</span></span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a>ME_sorted_portfolio <span class="ot">&lt;-</span> factor_data <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>  <span class="fu">select</span>(<span class="sc">-</span>R_F) <span class="sc">%&gt;%</span> <span class="co"># 無リスク金利は重複するので結合前に削除</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>  <span class="fu">full_join</span>(ME_sorted_portfolio, <span class="at">by =</span> <span class="st">"month_ID"</span>) <span class="sc">%&gt;%</span> <span class="co"># month_IDをキーに</span></span>
<span id="cb33-6"><a href="#cb33-6"></a>  <span class="fu">select</span>(<span class="sc">-</span>R_Me, R_Me) <span class="co"># R_Meを最終列へ移動</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># ch06_17: 時系列回帰 (1)</span></span>
<span id="cb34-2"><a href="#cb34-2"></a></span>
<span id="cb34-3"><a href="#cb34-3"></a>ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>  <span class="fu">filter</span>(ME_rank10 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># 時価総額が最小のポートフォリオを抽出</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>  <span class="fu">lm</span>(Re <span class="sc">~</span> R_Me, <span class="at">data =</span> .) <span class="sc">%&gt;%</span> <span class="co"># .を使ってlm()関数の第二引数にデータを代入</span></span>
<span id="cb34-6"><a href="#cb34-6"></a>  <span class="fu">tidy</span>() <span class="co"># 線形回帰の結果をtidy()関数でデータフレームに変換</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term        estimate std.error statistic       p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;
1 (Intercept)   0.0121   0.00404      3.00 0.00395      
2 R_Me          0.654    0.0976       6.70 0.00000000937</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># ch06_18: 時系列回帰 (2)</span></span>
<span id="cb36-2"><a href="#cb36-2"></a></span>
<span id="cb36-3"><a href="#cb36-3"></a>ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="fu">filter</span>(ME_rank10 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-5"><a href="#cb36-5"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> R_Me, <span class="at">y =</span> Re)) <span class="sc">+</span> <span class="co"># aes()関数はggplot()関数の中にも代入可能</span></span>
<span id="cb36-6"><a href="#cb36-6"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span>  <span class="co"># geom_point()関数と次のgeom_smooth()関数で共通のaes()関数を受け取る</span></span>
<span id="cb36-7"><a href="#cb36-7"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Excess Return of Market Portfolio"</span>, <span class="at">y =</span> <span class="st">"Excess Return of Small Size Portfolio"</span>) <span class="sc">+</span></span>
<span id="cb36-9"><a href="#cb36-9"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/unnamed-chunk-6-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="chapter06_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="ポートフォリオごとの回帰" class="level4" data-number="7.4.1.2"><h4 data-number="7.4.1.2" class="anchored" data-anchor-id="ポートフォリオごとの回帰">
<span class="header-section-number">7.4.1.2</span> 6.2.3 ポートフォリオごとの回帰</h4>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># ch06_19: CAPMの実証的な検証 (1)</span></span>
<span id="cb37-2"><a href="#cb37-2"></a></span>
<span id="cb37-3"><a href="#cb37-3"></a>CAPM_results <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="cn">NA</span>) <span class="co"># 推定結果を保存するために空のリストを準備</span></span>
<span id="cb37-4"><a href="#cb37-4"></a></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb37-6"><a href="#cb37-6"></a></span>
<span id="cb37-7"><a href="#cb37-7"></a>  CAPM_results[[i]] <span class="ot">&lt;-</span> ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8"></a>    <span class="fu">filter</span>(ME_rank10 <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb37-9"><a href="#cb37-9"></a>    <span class="fu">lm</span>(Re <span class="sc">~</span> R_Me, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb37-10"><a href="#cb37-10"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-11"><a href="#cb37-11"></a>    <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> i) <span class="sc">%&gt;%</span> <span class="co"># 推定対象のポートフォリオ名を保存</span></span>
<span id="cb37-12"><a href="#cb37-12"></a>    <span class="fu">select</span>(ME_rank10, <span class="fu">everything</span>()) <span class="co"># ME_rank10を第一列に移動</span></span>
<span id="cb37-13"><a href="#cb37-13"></a></span>
<span id="cb37-14"><a href="#cb37-14"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># ch06_20: CAPMの実証的な検証 (2)</span></span>
<span id="cb38-2"><a href="#cb38-2"></a></span>
<span id="cb38-3"><a href="#cb38-3"></a>CAPM_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, CAPM_results) <span class="co"># do.call()関数を用いて複数のデータフレームから構成されるリストを一つのデータフレームに統合</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># ch06_21: グループごとの線形回帰 (1)  lapply()関数を使う場合</span></span>
<span id="cb39-2"><a href="#cb39-2"></a></span>
<span id="cb39-3"><a href="#cb39-3"></a>ME_sorted_portfolio_splitted <span class="ot">&lt;-</span> <span class="fu">split</span>(ME_sorted_portfolio, ME_sorted_portfolio<span class="sc">$</span>ME_rank10) <span class="co"># 元データをME_rank10の値に応じて十個のデータフレームに分割</span></span>
<span id="cb39-4"><a href="#cb39-4"></a></span>
<span id="cb39-5"><a href="#cb39-5"></a>estimate_CAPM <span class="ot">&lt;-</span> <span class="cf">function</span>(return_data) { <span class="co"># リターン・データを受け取り, CAPMの推定結果をデータフレームで返す関数を準備</span></span>
<span id="cb39-6"><a href="#cb39-6"></a>  lm_results <span class="ot">&lt;-</span> <span class="fu">lm</span>(Re <span class="sc">~</span> R_Me, <span class="at">data =</span> return_data)</span>
<span id="cb39-7"><a href="#cb39-7"></a>  tidied_lm_results <span class="ot">&lt;-</span> <span class="fu">tidy</span>(lm_results)</span>
<span id="cb39-8"><a href="#cb39-8"></a>}</span>
<span id="cb39-9"><a href="#cb39-9"></a></span>
<span id="cb39-10"><a href="#cb39-10"></a>CAPM_results_by_lapply <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ME_sorted_portfolio_splitted, estimate_CAPM) <span class="co"># lapply()関数は第一引数にリスト, 第二引数に関数を取る</span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="co"># lapplyの返り値はリストなので，一つのデータフレームにまとめたい場合はdo.call()関数を用いる</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section></section></section><section id="ch06_22-グループごとの線形回帰-2-map関数を使う場合" class="level1" data-number="8"><h1 data-number="8">
<span class="header-section-number">8</span> ch06_22: グループごとの線形回帰 (2) map()関数を使う場合</h1>
<p>ME_sorted_portfolio %&gt;% group_by(ME_rank10) %&gt;% nest() %&gt;% # nest()関数を用いて各グループを要素とするメタ・データフレームを作成 mutate(CAPM_regression = map(data, ~lm(Re ~ R_Me, data = .)), # map()関数を用いて各グループを線形回帰 CAPM_summary = map(CAPM_regression, tidy)) %&gt;% # tidy()関数を用いて線形回帰の結果を整理 select(-c(data, CAPM_regression)) %&gt;% # 線形回帰の結果のみを抽出 unnest(cols = CAPM_summary) %&gt;% # nest()関数による畳み込みを解除 ungroup()</p>
<pre><code>
#### 6.2.4 CAPMアルファ


::: {.cell layout-align="center"}

```{.r .cell-code}
# ch06_23: CAPMアルファの可視化

CAPM_results %&gt;%
  filter(term == "(Intercept)") %&gt;% # 定数項に関する推定結果のみを抽出
  mutate(ME_rank10 = as.factor(ME_rank10)) %&gt;% # ME_rank10を整数型からファクター型に
  ggplot() +
  geom_col(aes(x = ME_rank10, y = estimate)) + # 横軸をME_rank10, 縦軸をCAPM_alphaとする棒グラフ
  geom_hline(yintercept = 0) +
  labs(x = "ME Rank", y = "CAPM alpha") +
  scale_y_continuous(limits = c(-0.003, 0.013)) +
  theme_classic()</code></pre>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/unnamed-chunk-10-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="chapter06_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
<p>:::</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="co"># ch06_24: CAPMアルファの統計的な有意性を評価</span></span>
<span id="cb41-2"><a href="#cb41-2"></a></span>
<span id="cb41-3"><a href="#cb41-3"></a>CAPM_results <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span> <span class="co"># 定数項に関する推定結果のみを抽出</span></span>
<span id="cb41-5"><a href="#cb41-5"></a>  <span class="fu">rename</span>(<span class="at">CAPM_alpha =</span> estimate, <span class="at">p_value =</span> p.value) <span class="sc">%&gt;%</span> <span class="co"># 列名を変更</span></span>
<span id="cb41-6"><a href="#cb41-6"></a>  <span class="fu">mutate</span>(<span class="at">significance =</span> <span class="fu">cut</span>(p_value,</span>
<span id="cb41-7"><a href="#cb41-7"></a>                            <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="dv">1</span>),</span>
<span id="cb41-8"><a href="#cb41-8"></a>                            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"***"</span>, <span class="st">"**"</span>, <span class="st">"*"</span>, <span class="st">""</span>),</span>
<span id="cb41-9"><a href="#cb41-9"></a>                            <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> <span class="co"># 統計的に有意な結果を*で強調</span></span>
<span id="cb41-10"><a href="#cb41-10"></a>  <span class="fu">select</span>(ME_rank10, CAPM_alpha, p_value, significance) <span class="co"># 出力したい列を指定</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
   ME_rank10 CAPM_alpha  p_value significance
       &lt;int&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;       
 1         1   0.0121   0.00395  "***"       
 2         2   0.0106   0.00644  "***"       
 3         3   0.0120   0.000290 "***"       
 4         4   0.00957  0.00162  "***"       
 5         5   0.00728  0.00286  "***"       
 6         6   0.00653  0.00145  "***"       
 7         7   0.00284  0.106    ""          
 8         8   0.00122  0.473    ""          
 9         9   0.000406 0.779    ""          
10        10  -0.000659 0.563    ""          </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># ch06_25: 証券市場線の推定</span></span>
<span id="cb43-2"><a href="#cb43-2"></a></span>
<span id="cb43-3"><a href="#cb43-3"></a>ME_cross_sectional_return <span class="ot">&lt;-</span> CAPM_results <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"R_Me"</span>) <span class="sc">%&gt;%</span> <span class="co"># R_Meの係数に関する推定結果のみを抽出</span></span>
<span id="cb43-5"><a href="#cb43-5"></a>  <span class="fu">rename</span>(<span class="at">CAPM_beta =</span> estimate) <span class="sc">%&gt;%</span> <span class="co"># 推定値をestimateからCAPM_betaに名称変更</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>  <span class="fu">select</span>(ME_rank10, CAPM_beta) <span class="sc">%&gt;%</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>  <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> <span class="fu">as.factor</span>(ME_rank10)) <span class="sc">%&gt;%</span> <span class="co"># ME_rank10を整数型からファクター型に</span></span>
<span id="cb43-8"><a href="#cb43-8"></a>  <span class="fu">full_join</span>(ME_cross_sectional_return, ., <span class="at">by =</span> <span class="st">"ME_rank10"</span>) <span class="co"># 超過リターンのデータと結合</span></span>
<span id="cb43-9"><a href="#cb43-9"></a></span>
<span id="cb43-10"><a href="#cb43-10"></a>mean_R_Me <span class="ot">&lt;-</span> <span class="fu">mean</span>(factor_data<span class="sc">$</span>R_Me) <span class="co"># 市場ポートフォリオの実現超過リターンにより証券市場線の傾きを推定</span></span>
<span id="cb43-11"><a href="#cb43-11"></a></span>
<span id="cb43-12"><a href="#cb43-12"></a><span class="fu">ggplot</span>(ME_cross_sectional_return) <span class="sc">+</span></span>
<span id="cb43-13"><a href="#cb43-13"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> CAPM_beta, <span class="at">y =</span> mean_Re)) <span class="sc">+</span></span>
<span id="cb43-14"><a href="#cb43-14"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> mean_R_Me) <span class="sc">+</span></span>
<span id="cb43-15"><a href="#cb43-15"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Market beta"</span>, <span class="at">y =</span> <span class="st">"Mean Excess Return"</span>) <span class="sc">+</span></span>
<span id="cb43-16"><a href="#cb43-16"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.2</span>), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb43-17"><a href="#cb43-17"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb43-18"><a href="#cb43-18"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/unnamed-chunk-12-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="chapter06_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<section id="fama-frenchの3ファクターモデル" class="level3" data-number="8.0.1"><h3 data-number="8.0.1" class="anchored" data-anchor-id="fama-frenchの3ファクターモデル">
<span class="header-section-number">8.0.1</span> 6.3 Fama-Frenchの3ファクター・モデル</h3>
<section id="銘柄のランク付け" class="level4" data-number="8.0.1.1"><h4 data-number="8.0.1.1" class="anchored" data-anchor-id="銘柄のランク付け">
<span class="header-section-number">8.0.1.1</span> 6.3.3 銘柄のランク付け</h4>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="co"># ch06_26: 前年度の時価総額に基づくランク付け</span></span>
<span id="cb44-2"><a href="#cb44-2"></a></span>
<span id="cb44-3"><a href="#cb44-3"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="fu">mutate</span>(<span class="at">lagged_ME =</span> <span class="fu">replace</span>(lagged_ME, <span class="fu">is.na</span>(lagged_BEME), <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> <span class="co"># lagged_BEMEが欠損している場合は欠損扱いに</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>  <span class="fu">mutate</span>(<span class="at">ME_rank2 =</span> <span class="fu">as.factor</span>(<span class="fu">ntile</span>(lagged_ME, <span class="dv">2</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb44-7"><a href="#cb44-7"></a>  <span class="fu">ungroup</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># ch06_27: 簿価時価比率に基づくランク付け (1)</span></span>
<span id="cb45-2"><a href="#cb45-2"></a></span>
<span id="cb45-3"><a href="#cb45-3"></a>annual_data <span class="sc">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb45-5"><a href="#cb45-5"></a>  <span class="fu">mutate</span>(<span class="at">BEME_percent_rank =</span> <span class="fu">percent_rank</span>(lagged_BEME)) <span class="sc">%&gt;%</span> <span class="co"># 年度ごとに簿価時価比率のパーセンタイル順位を計算</span></span>
<span id="cb45-6"><a href="#cb45-6"></a>  <span class="fu">ungroup</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,920 × 25
   firm_ID  year      R     Re        R_F industry_ID sales    OX    NFE     X
     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1       1  2015 NA     NA      0.00743            NA   NA   NA    NA     NA  
 2       1  2016  0.997  0.997  0.000565            1 5949. 564.   50.7  513. 
 3       1  2017  0.688  0.688  0.0000488           1 6505. 691.   29.5  662. 
 4       1  2018 -0.214 -0.219  0.00579             1 6846. 751.   86.5  665. 
 5       1  2019  0.647  0.648 -0.000770            1 7572. 959.  298.   660. 
 6       1  2020 -0.284 -0.285  0.000380            1 7538. 778.  -65.5  844. 
 7       2  2015 NA     NA      0.00579             1 3506.  45.8   5.75  40.1
 8       2  2016  0.375  0.376 -0.000770            1 3491.  51.2   1.88  49.4
 9       2  2017  0.641  0.640  0.000380            1 3946.  83.4   7.53  75.9
10       2  2018 -0.220 -0.223  0.00371             1 4139.  93.4   6.82  86.6
# ℹ 7,910 more rows
# ℹ 15 more variables: OA &lt;dbl&gt;, FA &lt;dbl&gt;, OL &lt;dbl&gt;, FO &lt;dbl&gt;, BE &lt;dbl&gt;,
#   lagged_BE &lt;dbl&gt;, ROE &lt;dbl&gt;, ME &lt;dbl&gt;, lagged_ME &lt;dbl&gt;, w_M &lt;dbl&gt;,
#   ME_rank10 &lt;fct&gt;, lagged_BEME &lt;dbl&gt;, BEME_rank10 &lt;fct&gt;, ME_rank2 &lt;fct&gt;,
#   BEME_percent_rank &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># ch06_28: 簿価時価比率に基づくランク付け (2)</span></span>
<span id="cb47-2"><a href="#cb47-2"></a></span>
<span id="cb47-3"><a href="#cb47-3"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="#cb47-4"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>  <span class="fu">mutate</span>(<span class="at">BEME_percent_rank =</span> <span class="fu">percent_rank</span>(lagged_BEME)) <span class="sc">%&gt;%</span> <span class="co"># 年度ごとに簿価時価比率のパーセンタイル順位を計算</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-7"><a href="#cb47-7"></a>  <span class="fu">mutate</span>(<span class="at">BEME_rank3 =</span> <span class="fu">cut</span>(BEME_percent_rank,</span>
<span id="cb47-8"><a href="#cb47-8"></a>                          <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb47-9"><a href="#cb47-9"></a>                          <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb47-10"><a href="#cb47-10"></a>                          <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="co"># BEME_percent_rankの値に応じて1から3までBEME_rank3の値を定義</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="時価総額とbemeに基づくポートフォリオソート" class="level4" data-number="8.0.1.2"><h4 data-number="8.0.1.2" class="anchored" data-anchor-id="時価総額とbemeに基づくポートフォリオソート">
<span class="header-section-number">8.0.1.2</span> 6.3.4 時価総額とBE/MEに基づくポートフォリオ・ソート</h4>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># ch06_29: 6 Size-BE/MEポートフォリオへの分類 (1)</span></span>
<span id="cb48-2"><a href="#cb48-2"></a></span>
<span id="cb48-3"><a href="#cb48-3"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4"></a>  <span class="fu">mutate</span>(<span class="at">FF_portfolio_type =</span> <span class="fu">interaction</span>(ME_rank2, BEME_rank3)) <span class="co"># ME_rank2とBEME_rank3の組合せで, ファクター型の変数FF_portfolio_typeを定義</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># ch06_30: 6 Size-BE/MEポートフォリオへの分類 (2)</span></span>
<span id="cb49-2"><a href="#cb49-2"></a></span>
<span id="cb49-3"><a href="#cb49-3"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4"></a>  <span class="fu">mutate</span>(<span class="at">FF_portfolio_type =</span> <span class="fu">fct_recode</span>(FF_portfolio_type, <span class="co"># FF_portfolio_typeの水準を変更</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>                                        <span class="at">SL =</span> <span class="st">"1.1"</span>,</span>
<span id="cb49-6"><a href="#cb49-6"></a>                                        <span class="at">BL =</span> <span class="st">"2.1"</span>,</span>
<span id="cb49-7"><a href="#cb49-7"></a>                                        <span class="at">SN =</span> <span class="st">"1.2"</span>,</span>
<span id="cb49-8"><a href="#cb49-8"></a>                                        <span class="at">BN =</span> <span class="st">"2.2"</span>,</span>
<span id="cb49-9"><a href="#cb49-9"></a>                                        <span class="at">SH =</span> <span class="st">"1.3"</span>,</span>
<span id="cb49-10"><a href="#cb49-10"></a>                                        <span class="at">BH =</span> <span class="st">"2.3"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="co"># ch06_31: 6 Size-BE/MEポートフォリオへの分類 (3)</span></span>
<span id="cb50-2"><a href="#cb50-2"></a></span>
<span id="cb50-3"><a href="#cb50-3"></a>annual_data <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4"></a>  <span class="fu">group_by</span>(ME_rank2, BEME_rank3) <span class="sc">%&gt;%</span> <span class="co"># ME_rank2とBEME_rank3のペアでグループ化</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>  <span class="fu">summarize</span>(<span class="at">FF_portfolio_type =</span> FF_portfolio_type[<span class="dv">1</span>],</span>
<span id="cb50-6"><a href="#cb50-6"></a>            <span class="at">mean_BEME =</span> <span class="fu">mean</span>(lagged_BEME),</span>
<span id="cb50-7"><a href="#cb50-7"></a>            <span class="at">mean_ME =</span> <span class="fu">mean</span>(lagged_ME),</span>
<span id="cb50-8"><a href="#cb50-8"></a>            <span class="at">mean_N_stocks =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="fu">length</span>(<span class="fu">unique</span>(year))) <span class="sc">%&gt;%</span></span>
<span id="cb50-9"><a href="#cb50-9"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-10"><a href="#cb50-10"></a>  <span class="fu">drop_na</span>() <span class="co"># 欠損データを削除</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  ME_rank2 BEME_rank3 FF_portfolio_type mean_BEME mean_ME mean_N_stocks
  &lt;fct&gt;    &lt;fct&gt;      &lt;fct&gt;                 &lt;dbl&gt;   &lt;dbl&gt;         &lt;dbl&gt;
1 1        1          SL                    0.416  11601.          155.
2 1        2          SN                    0.973  11868.          226 
3 1        3          SH                    1.97   11023.          260.
4 2        1          BL                    0.468 414941.          230.
5 2        2          BN                    0.960 211793.          286 
6 2        3          BH                    1.72  151135.          125.</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># ch06_32: 6 Size-BE/MEポートフォリオの構築 (1)</span></span>
<span id="cb52-2"><a href="#cb52-2"></a></span>
<span id="cb52-3"><a href="#cb52-3"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb52-4"><a href="#cb52-4"></a>  <span class="fu">group_by</span>(year, FF_portfolio_type) <span class="sc">%&gt;%</span> <span class="co"># yearとFF_portfolio_typeのペアでグループ化</span></span>
<span id="cb52-5"><a href="#cb52-5"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> lagged_ME  <span class="sc">/</span> <span class="fu">sum</span>(lagged_ME, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> <span class="co"># 各ポートフォリオ内で時価総額加重の保有比率を計算</span></span>
<span id="cb52-6"><a href="#cb52-6"></a>  <span class="fu">ungroup</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="co"># ch06_33: 6 Size-BE/MEポートフォリオの構築 (2)</span></span>
<span id="cb53-2"><a href="#cb53-2"></a></span>
<span id="cb53-3"><a href="#cb53-3"></a>FF_portfolio <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb53-4"><a href="#cb53-4"></a>  <span class="fu">select</span>(year, firm_ID, FF_portfolio_type, ME_rank2, BEME_rank3, w) <span class="sc">%&gt;%</span></span>
<span id="cb53-5"><a href="#cb53-5"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">%&gt;%</span> <span class="co"># 今までに準備したデータと月次データを結合</span></span>
<span id="cb53-6"><a href="#cb53-6"></a>  <span class="fu">group_by</span>(month_ID, FF_portfolio_type) <span class="sc">%&gt;%</span> <span class="co"># month_IDとFF_portfolio_typeでグループ化</span></span>
<span id="cb53-7"><a href="#cb53-7"></a>  <span class="fu">summarize</span>(<span class="at">ME_rank2 =</span> ME_rank2[<span class="dv">1</span>],</span>
<span id="cb53-8"><a href="#cb53-8"></a>            <span class="at">BEME_rank3 =</span> BEME_rank3[<span class="dv">1</span>],</span>
<span id="cb53-9"><a href="#cb53-9"></a>            <span class="at">R =</span> <span class="fu">sum</span>(w <span class="sc">*</span> R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 各ポートフォリオの月次リターンを計算</span></span>
<span id="cb53-10"><a href="#cb53-10"></a>            <span class="at">R_F =</span> R_F[<span class="dv">1</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb53-11"><a href="#cb53-11"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb53-12"><a href="#cb53-12"></a>  <span class="fu">drop_na</span>() <span class="co"># 欠損データを削除</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="co"># ch06_34: 6 Size-BE/MEポートフォリオのリターンの可視化 (1)</span></span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a>FF_portfolio_mean_return <span class="ot">&lt;-</span> FF_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="fu">mutate</span>(<span class="at">Re =</span> R <span class="sc">-</span> R_F) <span class="sc">%&gt;%</span></span>
<span id="cb54-5"><a href="#cb54-5"></a>  <span class="fu">group_by</span>(FF_portfolio_type) <span class="sc">%&gt;%</span> <span class="co"># FF_portfolio_typeでグループ化</span></span>
<span id="cb54-6"><a href="#cb54-6"></a>  <span class="fu">summarize</span>(<span class="at">ME_rank2 =</span> ME_rank2[<span class="dv">1</span>],</span>
<span id="cb54-7"><a href="#cb54-7"></a>            <span class="at">BEME_rank3 =</span> BEME_rank3[<span class="dv">1</span>],</span>
<span id="cb54-8"><a href="#cb54-8"></a>            <span class="at">mean_Re =</span> <span class="fu">mean</span>(Re)) <span class="co"># 各ポートフォリオの超過リターンの平均値を計算</span></span>
<span id="cb54-9"><a href="#cb54-9"></a></span>
<span id="cb54-10"><a href="#cb54-10"></a><span class="fu">ggplot</span>(FF_portfolio_mean_return) <span class="sc">+</span></span>
<span id="cb54-11"><a href="#cb54-11"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank3, <span class="at">y =</span> mean_Re, <span class="at">fill =</span> ME_rank2), <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span> <span class="co"># x軸をBEME_rank3, y軸をmean_Reに, ME_rank2のサブグループで色分け</span></span>
<span id="cb54-12"><a href="#cb54-12"></a>  <span class="fu">scale_fill_grey</span>() <span class="sc">+</span> <span class="co"># 棒グラフの色をモノトーンに</span></span>
<span id="cb54-13"><a href="#cb54-13"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME Rank"</span>, <span class="at">y =</span> <span class="st">"Mean Monthly Excess Return"</span>, <span class="at">fill =</span> <span class="st">"ME Rank"</span>) <span class="sc">+</span></span>
<span id="cb54-14"><a href="#cb54-14"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb54-15"><a href="#cb54-15"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/unnamed-chunk-21-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="chapter06_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="co"># ch06_35: 6 Size-BE/MEポートフォリオのリターンの可視化 (2)</span></span>
<span id="cb55-2"><a href="#cb55-2"></a></span>
<span id="cb55-3"><a href="#cb55-3"></a><span class="fu">ggplot</span>(FF_portfolio_mean_return) <span class="sc">+</span></span>
<span id="cb55-4"><a href="#cb55-4"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank3, <span class="at">y =</span> mean_Re, <span class="at">fill =</span> ME_rank2), <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb55-5"><a href="#cb55-5"></a>  <span class="fu">scale_fill_grey</span>() <span class="sc">+</span></span>
<span id="cb55-6"><a href="#cb55-6"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank3, <span class="at">y =</span> mean_Re, <span class="at">group =</span> ME_rank2, <span class="at">label =</span> FF_portfolio_type), <span class="co"># (x, y)座標を指定して各ポートフォリオの名前をグラフに挿入</span></span>
<span id="cb55-7"><a href="#cb55-7"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="co"># 棒グラフが重ならないよう文字ラベルを上にずらす</span></span>
<span id="cb55-8"><a href="#cb55-8"></a>            <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.9</span>)) <span class="sc">+</span> <span class="co"># ME_rank2のサブグループで文字ラベルが左右にずれるよう調整</span></span>
<span id="cb55-9"><a href="#cb55-9"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME Rank"</span>, <span class="at">y =</span> <span class="st">"Mean Monthly Excess Return"</span>, <span class="at">fill =</span> <span class="st">"ME Rank"</span>) <span class="sc">+</span></span>
<span id="cb55-10"><a href="#cb55-10"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.015</span>)) <span class="sc">+</span> <span class="co"># 文字ラベルがはみ出ないようy軸の範囲を指定</span></span>
<span id="cb55-11"><a href="#cb55-11"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/unnamed-chunk-22-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="chapter06_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="co"># ch06_36: 6 Size-BE/MEポートフォリオのリターンの可視化 (3)</span></span>
<span id="cb56-2"><a href="#cb56-2"></a></span>
<span id="cb56-3"><a href="#cb56-3"></a>initial_point <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">month_ID =</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">12</span>), <span class="co"># 累積リターンの起点を定義</span></span>
<span id="cb56-4"><a href="#cb56-4"></a>                            <span class="at">cumulative_gross_R =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb56-5"><a href="#cb56-5"></a>                            <span class="at">FF_portfolio_type =</span> <span class="fu">c</span>(<span class="st">"BL"</span>, <span class="st">"SH"</span>))</span>
<span id="cb56-6"><a href="#cb56-6"></a></span>
<span id="cb56-7"><a href="#cb56-7"></a>FF_portfolio_cumulative_return <span class="ot">&lt;-</span> FF_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb56-8"><a href="#cb56-8"></a>  <span class="fu">group_by</span>(FF_portfolio_type) <span class="sc">%&gt;%</span> <span class="co"># FF_portfolio_typeでグループ化</span></span>
<span id="cb56-9"><a href="#cb56-9"></a>  <span class="fu">mutate</span>(<span class="at">cumulative_gross_R =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">+</span> R)) <span class="sc">%&gt;%</span> <span class="co"># グロス・リターンを累積</span></span>
<span id="cb56-10"><a href="#cb56-10"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb56-11"><a href="#cb56-11"></a>  <span class="fu">filter</span>(FF_portfolio_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"BL"</span>, <span class="st">"SH"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb56-12"><a href="#cb56-12"></a>  <span class="fu">select</span>(month_ID, cumulative_gross_R, FF_portfolio_type) <span class="sc">%&gt;%</span></span>
<span id="cb56-13"><a href="#cb56-13"></a>  <span class="fu">rbind</span>(initial_point, .) <span class="co"># initial_pointを第一行に挿入</span></span>
<span id="cb56-14"><a href="#cb56-14"></a></span>
<span id="cb56-15"><a href="#cb56-15"></a><span class="fu">ggplot</span>(FF_portfolio_cumulative_return) <span class="sc">+</span></span>
<span id="cb56-16"><a href="#cb56-16"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> month_ID, <span class="at">y =</span> cumulative_gross_R, <span class="at">linetype =</span> FF_portfolio_type)) <span class="sc">+</span></span>
<span id="cb56-17"><a href="#cb56-17"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"longdash"</span>, <span class="st">"solid"</span>)) <span class="sc">+</span></span>
<span id="cb56-18"><a href="#cb56-18"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb56-19"><a href="#cb56-19"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month ID"</span>, <span class="at">y =</span> <span class="st">"Cumulative Gross Return"</span>, <span class="at">linetype =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb56-20"><a href="#cb56-20"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb56-21"><a href="#cb56-21"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/unnamed-chunk-23-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="chapter06_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="ファクターリターンの計算" class="level4" data-number="8.0.1.3"><h4 data-number="8.0.1.3" class="anchored" data-anchor-id="ファクターリターンの計算">
<span class="header-section-number">8.0.1.3</span> 6.3.5 ファクター・リターンの計算</h4>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="co"># ch06_37: SMBとHMLの構築 (1)</span></span>
<span id="cb57-2"><a href="#cb57-2"></a></span>
<span id="cb57-3"><a href="#cb57-3"></a>FF_portfolio <span class="ot">&lt;-</span> FF_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb57-4"><a href="#cb57-4"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> month_ID, <span class="at">names_from =</span> FF_portfolio_type, <span class="at">values_from =</span> R) <span class="co"># FF_portfolio_typeの値に基づく列を作成し, 縦長から横長のデータに変換</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="co"># ch06_38: SMBとHMLの構築 (2)</span></span>
<span id="cb58-2"><a href="#cb58-2"></a>factor_data <span class="ot">&lt;-</span> FF_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb58-3"><a href="#cb58-3"></a>  <span class="fu">mutate</span>(<span class="at">SMB =</span> (SH <span class="sc">+</span> SN <span class="sc">+</span> SL) <span class="sc">/</span> <span class="dv">3</span> <span class="sc">-</span> (BH <span class="sc">+</span> BN <span class="sc">+</span> BL) <span class="sc">/</span> <span class="dv">3</span>, <span class="co"># SMBとHMLを計算</span></span>
<span id="cb58-4"><a href="#cb58-4"></a>         <span class="at">HML =</span> (SH <span class="sc">+</span> BH) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">-</span> (SL <span class="sc">+</span> BL) <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-5"><a href="#cb58-5"></a>  <span class="fu">select</span>(month_ID, SMB, HML) <span class="sc">%&gt;%</span></span>
<span id="cb58-6"><a href="#cb58-6"></a>  <span class="fu">full_join</span>(factor_data, <span class="at">by =</span> <span class="st">"month_ID"</span>) <span class="sc">%&gt;%</span> <span class="co"># 3ファクターの実現値をfactor_dataに集約</span></span>
<span id="cb58-7"><a href="#cb58-7"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"SMB"</span>, <span class="st">"HML"</span>), <span class="fu">c</span>(<span class="st">"SMB"</span>, <span class="st">"HML"</span>)) <span class="co"># SMBとHMLを最後列に移動</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="ff3アルファ" class="level4" data-number="8.0.1.4"><h4 data-number="8.0.1.4" class="anchored" data-anchor-id="ff3アルファ">
<span class="header-section-number">8.0.1.4</span> 6.3.6 FF3アルファ</h4>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="co"># ch06_39: FF3モデルの推定</span></span>
<span id="cb59-2"><a href="#cb59-2"></a></span>
<span id="cb59-3"><a href="#cb59-3"></a>ME_sorted_portfolio <span class="ot">&lt;-</span> ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb59-4"><a href="#cb59-4"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(R_Me, R_M)) <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5"></a>  <span class="fu">full_join</span>(factor_data, <span class="at">by =</span> <span class="st">"month_ID"</span>) <span class="co"># 3ファクターの実現値をME_sorted_portfolioに追加</span></span>
<span id="cb59-6"><a href="#cb59-6"></a></span>
<span id="cb59-7"><a href="#cb59-7"></a>FF3_results <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="cn">NA</span>)  <span class="co"># 推定結果を保存するために空のリストを準備</span></span>
<span id="cb59-8"><a href="#cb59-8"></a></span>
<span id="cb59-9"><a href="#cb59-9"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb59-10"><a href="#cb59-10"></a>  FF3_results[[i]] <span class="ot">&lt;-</span> ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb59-11"><a href="#cb59-11"></a>    <span class="fu">filter</span>(ME_rank10 <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb59-12"><a href="#cb59-12"></a>    <span class="fu">lm</span>(Re <span class="sc">~</span> R_Me <span class="sc">+</span> SMB <span class="sc">+</span> HML, <span class="at">data =</span> .) <span class="sc">%&gt;%</span> <span class="co"># 3ファクターの実現値を独立変数として重回帰</span></span>
<span id="cb59-13"><a href="#cb59-13"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb59-14"><a href="#cb59-14"></a>    <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> i) <span class="sc">%&gt;%</span> <span class="co"># 推定対象のポートフォリオ名を保存</span></span>
<span id="cb59-15"><a href="#cb59-15"></a>    <span class="fu">select</span>(ME_rank10, <span class="fu">everything</span>()) <span class="co"># ME_rank10を第一列に移動</span></span>
<span id="cb59-16"><a href="#cb59-16"></a>}</span>
<span id="cb59-17"><a href="#cb59-17"></a></span>
<span id="cb59-18"><a href="#cb59-18"></a>FF3_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, FF3_results) <span class="co"># do.call()関数を用いて複数のデータフレームから構成されるリストを一つのデータフレームに統合</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a><span class="co"># ch06_40: FF3アルファの可視化</span></span>
<span id="cb60-2"><a href="#cb60-2"></a>FF3_results <span class="sc">%&gt;%</span></span>
<span id="cb60-3"><a href="#cb60-3"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span> <span class="co"># 定数項に関する推定結果のみを抽出</span></span>
<span id="cb60-4"><a href="#cb60-4"></a>  <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> <span class="fu">as.factor</span>(ME_rank10)) <span class="sc">%&gt;%</span> <span class="co"># ME_rank10を整数型からファクター型に</span></span>
<span id="cb60-5"><a href="#cb60-5"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb60-6"><a href="#cb60-6"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> ME_rank10, <span class="at">y =</span> estimate)) <span class="sc">+</span> <span class="co"># 横軸をME_rank10, 縦軸をFF3_alphaとする棒グラフ</span></span>
<span id="cb60-7"><a href="#cb60-7"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb60-8"><a href="#cb60-8"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"ME Rank"</span>, <span class="at">y =</span> <span class="st">"FF3 alpha"</span>) <span class="sc">+</span></span>
<span id="cb60-9"><a href="#cb60-9"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.003</span>, <span class="fl">0.013</span>)) <span class="sc">+</span></span>
<span id="cb60-10"><a href="#cb60-10"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter06_files/figure-html/unnamed-chunk-27-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="chapter06_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="co"># ch06_41: FF3アルファの統計的な有意性を評価</span></span>
<span id="cb61-2"><a href="#cb61-2"></a>FF3_results <span class="sc">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span> <span class="co"># 定数項に関する推定結果のみを抽出</span></span>
<span id="cb61-4"><a href="#cb61-4"></a>  <span class="fu">rename</span>(<span class="at">FF3_alpha =</span> estimate, <span class="at">p_value =</span> p.value) <span class="sc">%&gt;%</span> <span class="co"># 列名を変更</span></span>
<span id="cb61-5"><a href="#cb61-5"></a>  <span class="fu">mutate</span>(<span class="at">significance =</span> <span class="fu">cut</span>(p_value,</span>
<span id="cb61-6"><a href="#cb61-6"></a>                            <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="dv">1</span>),</span>
<span id="cb61-7"><a href="#cb61-7"></a>                            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"***"</span>, <span class="st">"**"</span>, <span class="st">"*"</span>, <span class="st">""</span>),</span>
<span id="cb61-8"><a href="#cb61-8"></a>                            <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> <span class="co"># 統計的に有意な結果を*で強調</span></span>
<span id="cb61-9"><a href="#cb61-9"></a>  <span class="fu">select</span>(ME_rank10, FF3_alpha, p_value, significance) <span class="co"># 出力したい列を指定</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
   ME_rank10 FF3_alpha p_value significance
       &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;       
 1         1  0.00244   0.181  ""          
 2         2  0.00134   0.412  ""          
 3         3  0.00246   0.0893 "*"         
 4         4 -0.000843  0.335  ""          
 5         5 -0.000924  0.336  ""          
 6         6  0.000957  0.456  ""          
 7         7 -0.00183   0.119  ""          
 8         8  0.000842  0.555  ""          
 9         9 -0.00100   0.522  ""          
10        10 -0.00228   0.0492 "**"        </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a><span class="co"># ch06_42: データの保存</span></span>
<span id="cb63-2"><a href="#cb63-2"></a><span class="fu">write_csv</span>(factor_data, <span class="st">"data/ch06_output.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


<!-- -->

</section></section></section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./chapter05.html" class="pagination-link" aria-label="株式データの取得と可視化">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">株式データの取得と可視化</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb64" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb64-1"><a href="#cb64-1"></a><span class="fu">## ファクターモデルの導入</span></span>
<span id="cb64-2"><a href="#cb64-2"></a></span>
<span id="cb64-3"><a href="#cb64-3"></a><span class="in">```{r setup}</span></span>
<span id="cb64-4"><a href="#cb64-4"></a><span class="co">#| code-fold: true</span></span>
<span id="cb64-5"><a href="#cb64-5"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb64-6"><a href="#cb64-6"></a>  tidyverse, ggthemes, ggpubr, plotly, patchwork, Rsolnp, broom</span>
<span id="cb64-7"><a href="#cb64-7"></a>)</span>
<span id="cb64-8"><a href="#cb64-8"></a></span>
<span id="cb64-9"><a href="#cb64-9"></a>mystyle <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb64-10"><a href="#cb64-10"></a>  <span class="fu">theme_economist_white</span>(</span>
<span id="cb64-11"><a href="#cb64-11"></a>    <span class="at">base_family =</span> <span class="st">"HiraKakuProN-W3"</span></span>
<span id="cb64-12"><a href="#cb64-12"></a>    ),</span>
<span id="cb64-13"><a href="#cb64-13"></a>  <span class="fu">scale_colour_economist</span>(),</span>
<span id="cb64-14"><a href="#cb64-14"></a>  <span class="fu">theme</span>(</span>
<span id="cb64-15"><a href="#cb64-15"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb64-16"><a href="#cb64-16"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb64-17"><a href="#cb64-17"></a>  )</span>
<span id="cb64-18"><a href="#cb64-18"></a>)</span>
<span id="cb64-19"><a href="#cb64-19"></a><span class="in">```</span></span>
<span id="cb64-20"><a href="#cb64-20"></a></span>
<span id="cb64-21"><a href="#cb64-21"></a><span class="fu">## ファクター構築の準備</span></span>
<span id="cb64-22"><a href="#cb64-22"></a></span>
<span id="cb64-23"><a href="#cb64-23"></a><span class="ss">1. </span>CAPMの実証的検証に必要な市場ポートフォリオの構築</span>
<span id="cb64-24"><a href="#cb64-24"></a><span class="ss">2. </span>ある特徴に基づいて各銘柄をランキングにし，ランキングに応じたポートフォリオの構築</span>
<span id="cb64-25"><a href="#cb64-25"></a></span>
<span id="cb64-26"><a href="#cb64-26"></a><span class="fu">## 市場ポートフォリオの構築</span></span>
<span id="cb64-27"><a href="#cb64-27"></a></span>
<span id="cb64-28"><a href="#cb64-28"></a></span>
<span id="cb64-29"><a href="#cb64-29"></a>市場ポートフォリオ (market portfolio)とは，**市場に存在する全ての危険資産を時価総額比率で保有したポートフォリオ**をいいます。</span>
<span id="cb64-30"><a href="#cb64-30"></a>厳密には，リスク資産には株式や債券に代表される金融資産の他、不動産や貴金属などの実物資産も含まれますが、実用上はTOPIXやS&amp;P500といった株価指数と同一視されることが多いです。</span>
<span id="cb64-31"><a href="#cb64-31"></a></span>
<span id="cb64-32"><a href="#cb64-32"></a>ここでは，データとして入手可能な**全銘柄の時価総額と個別銘柄の時価総額の比率をウェイト**として市場ポートフォリオを構築します。</span>
<span id="cb64-33"><a href="#cb64-33"></a></span>
<span id="cb64-34"><a href="#cb64-34"></a></span>
<span id="cb64-35"><a href="#cb64-35"></a></span>
<span id="cb64-36"><a href="#cb64-36"></a></span>
<span id="cb64-37"><a href="#cb64-37"></a></span>
<span id="cb64-38"><a href="#cb64-38"></a>毎年1月に年次リバランスを想定し，前年度末の時価総額に比例した保有費率の計算をします。</span>
<span id="cb64-39"><a href="#cb64-39"></a></span>
<span id="cb64-40"><a href="#cb64-40"></a><span class="in">```{r package}</span></span>
<span id="cb64-41"><a href="#cb64-41"></a>monthly_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ch05_output1.csv"</span>)</span>
<span id="cb64-42"><a href="#cb64-42"></a>annual_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ch05_output2.csv"</span>)</span>
<span id="cb64-43"><a href="#cb64-43"></a><span class="in">```</span></span>
<span id="cb64-44"><a href="#cb64-44"></a></span>
<span id="cb64-45"><a href="#cb64-45"></a>ここでもデータの構造を確認しておきます。</span>
<span id="cb64-46"><a href="#cb64-46"></a><span class="in">`monthly_data`</span>は**月次の**株価の終値，一株当り配当額，発行済株式数，調整係数，無リスク利子率，時価総額といった株式データが収録されています。</span>
<span id="cb64-47"><a href="#cb64-47"></a><span class="in">`annual_data`</span>は**年次の**売上高や当期純利益など財務データが収録されています。</span>
<span id="cb64-48"><a href="#cb64-48"></a></span>
<span id="cb64-49"><a href="#cb64-49"></a><span class="in">```{r data_check}</span></span>
<span id="cb64-50"><a href="#cb64-50"></a><span class="fu">glimpse</span>(monthly_data)</span>
<span id="cb64-51"><a href="#cb64-51"></a><span class="fu">glimpse</span>(annual_data)</span>
<span id="cb64-52"><a href="#cb64-52"></a><span class="in">```</span></span>
<span id="cb64-53"><a href="#cb64-53"></a></span>
<span id="cb64-54"><a href="#cb64-54"></a>市場ポートフォリオの構築に用いるウェイトは次のように計算します。$ME_{i,t}$は$t$期末における銘柄$i$の時価総額を表します。</span>
<span id="cb64-55"><a href="#cb64-55"></a>分母は，$N$個ある全銘柄の時価総額を合計しています。</span>
<span id="cb64-56"><a href="#cb64-56"></a>$$</span>
<span id="cb64-57"><a href="#cb64-57"></a>w_{i,t}^M = \frac{ME_{i,t-1}^{12\text{月}}}{\sum_{j = 1}^N ME_{j,t-1}^{12\text{月}}}</span>
<span id="cb64-58"><a href="#cb64-58"></a>$$</span>
<span id="cb64-59"><a href="#cb64-59"></a></span>
<span id="cb64-60"><a href="#cb64-60"></a><span class="al">![図6.1 市場ポートフォリオを作成する際の各銘柄の保有比率](img/KM_fig_6-1.png)</span></span>
<span id="cb64-61"><a href="#cb64-61"></a></span>
<span id="cb64-62"><a href="#cb64-62"></a>この銘柄ごとの保有費率を計算するために，前年度末の時価総額を計算し，<span class="in">`lagged_ME`</span>に代入します。</span>
<span id="cb64-63"><a href="#cb64-63"></a><span class="in">`annual_data`</span>は2015年から2020年のデータが入っています。</span>
<span id="cb64-64"><a href="#cb64-64"></a><span class="in">`lag()`</span>で前期末の時価総額を<span class="in">`lagged_ME`</span>に代入しようとしても2015年の前年のデータは存在しないので，欠損値になることに注意しましょう。</span>
<span id="cb64-65"><a href="#cb64-65"></a></span>
<span id="cb64-66"><a href="#cb64-66"></a><span class="in">```{r ch06_02}</span></span>
<span id="cb64-67"><a href="#cb64-67"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-68"><a href="#cb64-68"></a>    <span class="fu">group_by</span>(firm_ID) <span class="sc">%&gt;%</span> <span class="co"># 企業ごとに</span></span>
<span id="cb64-69"><a href="#cb64-69"></a>    <span class="fu">mutate</span>(<span class="at">lagged_ME =</span> <span class="fu">lag</span>(ME)) <span class="sc">%&gt;%</span> <span class="co"># 前期末時価総額</span></span>
<span id="cb64-70"><a href="#cb64-70"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb64-71"><a href="#cb64-71"></a><span class="in">```</span></span>
<span id="cb64-72"><a href="#cb64-72"></a></span>
<span id="cb64-73"><a href="#cb64-73"></a>この処理の結果がおおよそこんな感じになっているはずです。</span>
<span id="cb64-74"><a href="#cb64-74"></a></span>
<span id="cb64-75"><a href="#cb64-75"></a><span class="pp">|</span> firm_ID <span class="pp">|</span> year <span class="pp">|</span> ME <span class="pp">|</span> lagged_ME <span class="pp">|</span></span>
<span id="cb64-76"><a href="#cb64-76"></a><span class="pp">|:--------|-----:|---:|----------:|</span></span>
<span id="cb64-77"><a href="#cb64-77"></a><span class="pp">|</span> 1    <span class="pp">|</span> 2015 <span class="pp">|</span> 3577.294 <span class="pp">|</span>     NA <span class="pp">|</span></span>
<span id="cb64-78"><a href="#cb64-78"></a><span class="pp">|</span> 1    <span class="pp">|</span> 2016 <span class="pp">|</span> 6883.324 <span class="pp">|</span>  3577.294 <span class="pp">|</span></span>
<span id="cb64-79"><a href="#cb64-79"></a><span class="pp">|</span> 1    <span class="pp">|</span> 2017 <span class="pp">|</span>11376.990 <span class="pp">|</span> 6883.324 <span class="pp">|</span></span>
<span id="cb64-80"><a href="#cb64-80"></a></span>
<span id="cb64-81"><a href="#cb64-81"></a>この<span class="in">`lagged_ME`</span>を使って保有費率を計算します。</span>
<span id="cb64-82"><a href="#cb64-82"></a>年度ごとに時価総額を合計し、ある企業の前期末時価総額を合計時価総額で割ることで保有費率<span class="in">`w_M`</span>を計算します。</span>
<span id="cb64-83"><a href="#cb64-83"></a></span>
<span id="cb64-84"><a href="#cb64-84"></a><span class="in">```{r ch06_03}</span></span>
<span id="cb64-85"><a href="#cb64-85"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-86"><a href="#cb64-86"></a>    <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span> <span class="co"># 年度ごとに</span></span>
<span id="cb64-87"><a href="#cb64-87"></a>    <span class="fu">mutate</span>(</span>
<span id="cb64-88"><a href="#cb64-88"></a>        <span class="at">w_M =</span> lagged_ME <span class="sc">/</span> <span class="fu">sum</span>(lagged_ME, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># ウェイト</span></span>
<span id="cb64-89"><a href="#cb64-89"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb64-90"><a href="#cb64-90"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb64-91"><a href="#cb64-91"></a><span class="in">```</span></span>
<span id="cb64-92"><a href="#cb64-92"></a></span>
<span id="cb64-93"><a href="#cb64-93"></a>2015年の<span class="in">`lagged_ME`</span>は欠損値なので，<span class="in">`w_M`</span>も欠損値になっていますが，2015年のデータはもう使わないので無視します。</span>
<span id="cb64-94"><a href="#cb64-94"></a></span>
<span id="cb64-95"><a href="#cb64-95"></a>次に，2016年以降の欠損値の行を削除するのではなく，保有費率<span class="in">`w_M`</span>をゼロに置き換えることで投資しないことを表します。</span>
<span id="cb64-96"><a href="#cb64-96"></a><span class="in">`mutate()`</span>と<span class="in">`replace()`</span>を用いて変数の置き換えをします。</span>
<span id="cb64-97"><a href="#cb64-97"></a></span>
<span id="cb64-98"><a href="#cb64-98"></a><span class="in">```{r ch06_04}</span></span>
<span id="cb64-99"><a href="#cb64-99"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-100"><a href="#cb64-100"></a>    <span class="fu">mutate</span>( <span class="co"># w_Mの欠損値を0に置き換える</span></span>
<span id="cb64-101"><a href="#cb64-101"></a>        <span class="at">w_M =</span> <span class="fu">replace</span>(w_M, year <span class="sc">&gt;=</span> <span class="dv">2016</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(w_M), <span class="dv">0</span>)</span>
<span id="cb64-102"><a href="#cb64-102"></a>    )</span>
<span id="cb64-103"><a href="#cb64-103"></a><span class="in">```</span></span>
<span id="cb64-104"><a href="#cb64-104"></a></span>
<span id="cb64-105"><a href="#cb64-105"></a><span class="in">`replace()`</span>関数は，第1引数のデータに対して，第2引数の条件を満たす要素を，第3引数の値に置き換えます。</span>
<span id="cb64-106"><a href="#cb64-106"></a>ここでは，<span class="in">`w_M`</span>に対して，<span class="in">`year`</span>が2016以上で，かつ<span class="in">`w_M`</span>が欠損値の場合の<span class="in">`w_M`</span>を0に置き換えています。</span>
<span id="cb64-107"><a href="#cb64-107"></a></span>
<span id="cb64-108"><a href="#cb64-108"></a>作成した保有費率を表すウェイト<span class="in">`w_M`</span>の合計が1になっているかどうかを確認します。</span>
<span id="cb64-109"><a href="#cb64-109"></a></span>
<span id="cb64-110"><a href="#cb64-110"></a><span class="in">```{r ch06_05}</span></span>
<span id="cb64-111"><a href="#cb64-111"></a>annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-112"><a href="#cb64-112"></a>    <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb64-113"><a href="#cb64-113"></a>    <span class="fu">summarise</span>(</span>
<span id="cb64-114"><a href="#cb64-114"></a>        <span class="at">weight_sum =</span> <span class="fu">sum</span>(w_M)</span>
<span id="cb64-115"><a href="#cb64-115"></a>    )</span>
<span id="cb64-116"><a href="#cb64-116"></a><span class="in">```</span></span>
<span id="cb64-117"><a href="#cb64-117"></a></span>
<span id="cb64-118"><a href="#cb64-118"></a>確認できました。</span>
<span id="cb64-119"><a href="#cb64-119"></a>これまでの操作で変数を追加した<span class="in">`annual_data`</span>に<span class="in">`monthly_data`</span>に結合します。</span>
<span id="cb64-120"><a href="#cb64-120"></a>**完全外部結合**(full outer join)を行います。</span>
<span id="cb64-121"><a href="#cb64-121"></a>完全外部結合とは，データベースを連結する操作の1つで、2つのデータフレームからそれぞれ特定のキーとなる列を指定して，キーの値が一致する行同士は連結し、一致しない残りの行もそのまますべて抽出するものです。</span>
<span id="cb64-122"><a href="#cb64-122"></a></span>
<span id="cb64-123"><a href="#cb64-123"></a>では<span class="in">`full_join()`</span>関数を使って，<span class="in">`annual_data`</span>と<span class="in">`monthly_data`</span>を<span class="in">`year`</span>と<span class="in">`firm_ID`</span>の2つのキーで結合し，その結果を<span class="in">`monthly_data`</span>に代入します。</span>
<span id="cb64-124"><a href="#cb64-124"></a></span>
<span id="cb64-125"><a href="#cb64-125"></a><span class="in">```{r ch06_06, filename = "月次データに保有費率のデータを追加"}</span></span>
<span id="cb64-126"><a href="#cb64-126"></a>monthly_data <span class="ot">&lt;-</span> annual_data <span class="sc">|&gt;</span></span>
<span id="cb64-127"><a href="#cb64-127"></a>  <span class="fu">select</span>(year, firm_ID, w_M) <span class="sc">|&gt;</span> <span class="co"># 必要な変数のみ</span></span>
<span id="cb64-128"><a href="#cb64-128"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">|&gt;</span> <span class="co"># 完全外部結合</span></span>
<span id="cb64-129"><a href="#cb64-129"></a>  <span class="fu">select</span>(<span class="sc">-</span>w_M, w_M) <span class="co"># w_Mを最終列に移動</span></span>
<span id="cb64-130"><a href="#cb64-130"></a><span class="in">```</span></span>
<span id="cb64-131"><a href="#cb64-131"></a></span>
<span id="cb64-132"><a href="#cb64-132"></a>できあがった拡大データセット<span class="in">`monthly_data`</span>を確認します。</span>
<span id="cb64-133"><a href="#cb64-133"></a></span>
<span id="cb64-134"><a href="#cb64-134"></a><span class="in">```{r ch06_06b}</span></span>
<span id="cb64-135"><a href="#cb64-135"></a><span class="fu">glimpse</span>(monthly_data)</span>
<span id="cb64-136"><a href="#cb64-136"></a><span class="in">```</span></span>
<span id="cb64-137"><a href="#cb64-137"></a></span>
<span id="cb64-138"><a href="#cb64-138"></a>準備が整ったので，市場ポートフォリオの月次リターンを計算します。</span>
<span id="cb64-139"><a href="#cb64-139"></a>$t$時点における市場ポートフォリオのリターン$R_{M,t}$は、個別銘柄のリターン$R_{i,t}$とウェイト$w_{i,t}^M$の積の合計で表されます。</span>
<span id="cb64-140"><a href="#cb64-140"></a></span>
<span id="cb64-141"><a href="#cb64-141"></a>$$</span>
<span id="cb64-142"><a href="#cb64-142"></a>R_{M,t} = \sum_{i=1}^{N} w_{i,t}^M R_{i,t}</span>
<span id="cb64-143"><a href="#cb64-143"></a>$$</span>
<span id="cb64-144"><a href="#cb64-144"></a></span>
<span id="cb64-145"><a href="#cb64-145"></a>これをRで実装します。</span>
<span id="cb64-146"><a href="#cb64-146"></a><span class="in">`monthly_data`</span>を<span class="in">`month_ID`</span>でグループ化し，<span class="in">`summarise()`</span>関数を用いて，<span class="in">`R_M`</span>を計算し，その後で<span class="in">`mutate()`</span>関数を用いて，<span class="in">`R_Me`</span>を計算し，その結果を<span class="in">`factor_data`</span>に代入します。</span>
<span id="cb64-147"><a href="#cb64-147"></a></span>
<span id="cb64-148"><a href="#cb64-148"></a><span class="in">```{r ch06_07, filename="市場ポートフォリオの月次リターンを計算"}</span></span>
<span id="cb64-149"><a href="#cb64-149"></a>factor_data <span class="ot">&lt;-</span> monthly_data <span class="sc">|&gt;</span></span>
<span id="cb64-150"><a href="#cb64-150"></a>  <span class="fu">filter</span>(month_ID <span class="sc">&gt;=</span> <span class="dv">13</span>) <span class="sc">|&gt;</span> <span class="co"># 2016以降のデータを抽出</span></span>
<span id="cb64-151"><a href="#cb64-151"></a>  <span class="fu">group_by</span>(month_ID) <span class="sc">|&gt;</span> <span class="co"># 月次データを月ごとに</span></span>
<span id="cb64-152"><a href="#cb64-152"></a>  <span class="fu">summarise</span>(</span>
<span id="cb64-153"><a href="#cb64-153"></a>    <span class="at">R_F =</span> R_F[<span class="dv">1</span>], <span class="co"># 無リスク金利を抽出</span></span>
<span id="cb64-154"><a href="#cb64-154"></a>    <span class="at">R_M =</span> <span class="fu">sum</span>(w_M <span class="sc">*</span> R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># 月次リターンの加重平均</span></span>
<span id="cb64-155"><a href="#cb64-155"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb64-156"><a href="#cb64-156"></a>  <span class="fu">mutate</span>(<span class="at">R_Me =</span> R_M <span class="sc">-</span> R_F) <span class="co"># 月次超過リターン変数を作成</span></span>
<span id="cb64-157"><a href="#cb64-157"></a><span class="in">```</span></span>
<span id="cb64-158"><a href="#cb64-158"></a></span>
<span id="cb64-159"><a href="#cb64-159"></a><span class="in">`factor_data`</span>の中身を<span class="in">`summary()`</span>で確認します。</span>
<span id="cb64-160"><a href="#cb64-160"></a></span>
<span id="cb64-161"><a href="#cb64-161"></a><span class="in">```{r ch06_07b}</span></span>
<span id="cb64-162"><a href="#cb64-162"></a><span class="fu">summary</span>(factor_data)</span>
<span id="cb64-163"><a href="#cb64-163"></a><span class="in">```</span></span>
<span id="cb64-164"><a href="#cb64-164"></a></span>
<span id="cb64-165"><a href="#cb64-165"></a>作成した市場ポートフォリオの超過リターンをヒストグラムにして分布を確認します。</span>
<span id="cb64-166"><a href="#cb64-166"></a></span>
<span id="cb64-167"><a href="#cb64-167"></a><span class="in">```{r ch06_08}</span></span>
<span id="cb64-168"><a href="#cb64-168"></a><span class="co"># 市場ポートフォリオの月次超過リターンをヒストグラムで可視化</span></span>
<span id="cb64-169"><a href="#cb64-169"></a><span class="fu">ggplot</span>(factor_data) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> R_Me) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb64-170"><a href="#cb64-170"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"市場ポートフォリオの月次超過リターン"</span>, <span class="at">y =</span> <span class="st">"度数"</span>) <span class="sc">+</span> mystyle</span>
<span id="cb64-171"><a href="#cb64-171"></a><span class="in">```</span></span>
<span id="cb64-172"><a href="#cb64-172"></a></span>
<span id="cb64-173"><a href="#cb64-173"></a></span>
<span id="cb64-174"><a href="#cb64-174"></a>次に、市場ポートフォリオの累積リターンを計算します。</span>
<span id="cb64-175"><a href="#cb64-175"></a>計算の仮定は以下の通りです。</span>
<span id="cb64-176"><a href="#cb64-176"></a></span>
<span id="cb64-177"><a href="#cb64-177"></a><span class="ss">1. </span><span class="in">`month_ID`</span>が13の月初から運用スタートし、バイアンドホールドで運用すると仮定する。</span>
<span id="cb64-178"><a href="#cb64-178"></a><span class="ss">2. </span>毎年1月にコストなしでリバランスし、リバランス前後で元本の変動はないと仮定する。</span>
<span id="cb64-179"><a href="#cb64-179"></a></span>
<span id="cb64-180"><a href="#cb64-180"></a>市場ポートフォリオの累積グロス・リターンを計算します。</span>
<span id="cb64-181"><a href="#cb64-181"></a></span>
<span id="cb64-182"><a href="#cb64-182"></a><span class="in">```{r ch06_09}</span></span>
<span id="cb64-183"><a href="#cb64-183"></a><span class="co">#| label:  市場ポートフォリオの累積リターンの可視化 (1)</span></span>
<span id="cb64-184"><a href="#cb64-184"></a>df_g <span class="ot">&lt;-</span> factor_data <span class="sc">%&gt;%</span></span>
<span id="cb64-185"><a href="#cb64-185"></a>  <span class="fu">mutate</span>(</span>
<span id="cb64-186"><a href="#cb64-186"></a>    <span class="at">gross_R_M =</span> <span class="dv">1</span> <span class="sc">+</span> R_M, <span class="co"># rに1足してグラスリターン</span></span>
<span id="cb64-187"><a href="#cb64-187"></a>    <span class="at">cumulative_gross_R_M =</span> <span class="fu">cumprod</span>(gross_R_M) <span class="co"># 累積グロスリターン</span></span>
<span id="cb64-188"><a href="#cb64-188"></a>    )</span>
<span id="cb64-189"><a href="#cb64-189"></a><span class="in">```</span></span>
<span id="cb64-190"><a href="#cb64-190"></a></span>
<span id="cb64-191"><a href="#cb64-191"></a>作成した累積グロス・リターンを折れ線グラフで可視化します。</span>
<span id="cb64-192"><a href="#cb64-192"></a></span>
<span id="cb64-193"><a href="#cb64-193"></a><span class="in">```{r ch06_09b}</span></span>
<span id="cb64-194"><a href="#cb64-194"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_g) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> month_ID, <span class="at">y =</span> cumulative_gross_R_M) <span class="sc">+</span> <span class="fu">geom_line</span>()</span>
<span id="cb64-195"><a href="#cb64-195"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month ID"</span>, <span class="at">y =</span> <span class="st">"累積グロスリターン"</span>) <span class="sc">+</span> mystyle</span>
<span id="cb64-196"><a href="#cb64-196"></a><span class="fu">print</span>(g)</span>
<span id="cb64-197"><a href="#cb64-197"></a><span class="in">```</span></span>
<span id="cb64-198"><a href="#cb64-198"></a>累積リターンであることが一発で分かるように、始点を1として、折れ線グラフを描き直します。</span>
<span id="cb64-199"><a href="#cb64-199"></a><span class="in">`rbind()`</span>で始点となるデータを追加し、<span class="in">`geom_hline()`</span>で始点の水準を点線で図示します。</span>
<span id="cb64-200"><a href="#cb64-200"></a></span>
<span id="cb64-201"><a href="#cb64-201"></a><span class="in">```{r }</span></span>
<span id="cb64-202"><a href="#cb64-202"></a><span class="co"># ch06_10: 市場ポートフォリオの累積リターンの可視化 (2)</span></span>
<span id="cb64-203"><a href="#cb64-203"></a>df_g <span class="ot">&lt;-</span> factor_data <span class="sc">%&gt;%</span></span>
<span id="cb64-204"><a href="#cb64-204"></a>  <span class="fu">mutate</span>(<span class="at">gross_R_M =</span> <span class="dv">1</span> <span class="sc">+</span> R_M,</span>
<span id="cb64-205"><a href="#cb64-205"></a>         <span class="at">cumulative_gross_R_M =</span> <span class="fu">cumprod</span>(gross_R_M)) <span class="sc">%&gt;%</span></span>
<span id="cb64-206"><a href="#cb64-206"></a>  <span class="fu">select</span>(month_ID, cumulative_gross_R_M) <span class="sc">%&gt;%</span></span>
<span id="cb64-207"><a href="#cb64-207"></a>  <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">1</span>), .) <span class="co"># 折れ線グラフの始点を追加</span></span>
<span id="cb64-208"><a href="#cb64-208"></a><span class="co"># 折れ線グラフを作成</span></span>
<span id="cb64-209"><a href="#cb64-209"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_g) <span class="sc">+</span></span>
<span id="cb64-210"><a href="#cb64-210"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> month_ID, <span class="at">y =</span> cumulative_gross_R_M)) <span class="sc">+</span></span>
<span id="cb64-211"><a href="#cb64-211"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span> <span class="co"># 元本の水準を点線で図示</span></span>
<span id="cb64-212"><a href="#cb64-212"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month ID"</span>, <span class="at">y =</span> <span class="st">"Cumulative Gross Return"</span>) <span class="sc">+</span></span>
<span id="cb64-213"><a href="#cb64-213"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fl">0.5</span>,<span class="fl">1.5</span>) <span class="sc">+</span>  mystyle</span>
<span id="cb64-214"><a href="#cb64-214"></a><span class="fu">print</span>(g)</span>
<span id="cb64-215"><a href="#cb64-215"></a><span class="in">```</span></span>
<span id="cb64-216"><a href="#cb64-216"></a></span>
<span id="cb64-217"><a href="#cb64-217"></a><span class="fu">## ポートフォリオ・ソート</span></span>
<span id="cb64-218"><a href="#cb64-218"></a></span>
<span id="cb64-219"><a href="#cb64-219"></a></span>
<span id="cb64-220"><a href="#cb64-220"></a>ある特性に基づいて株式銘柄をランキングにし、そのランキングに基づいてポートフォリオを構築することを**ポートフォリオ・ソート**と呼びます。</span>
<span id="cb64-221"><a href="#cb64-221"></a>ポートフォリオ・ソートは、ファクター・モデルの検証において重要な手法です。</span>
<span id="cb64-222"><a href="#cb64-222"></a>ここでは**前年度末の時価総額**に基づいて、企業を10個のグループに分類して、実現リターンの比較をしてみましょう。</span>
<span id="cb64-223"><a href="#cb64-223"></a></span>
<span id="cb64-224"><a href="#cb64-224"></a><span class="al">![図6.2 前年度末の時価総額に基づくポートフォリオ・ソート](img/KM_fig_6-2.png)</span></span>
<span id="cb64-225"><a href="#cb64-225"></a></span>
<span id="cb64-226"><a href="#cb64-226"></a>Rで時価総額ランキングを作成するには、<span class="in">`ntile()`</span>関数を用います。</span>
<span id="cb64-227"><a href="#cb64-227"></a><span class="in">`ntile()`</span>関数は、データを指定した数のグループに分類します。</span>
<span id="cb64-228"><a href="#cb64-228"></a>以下のコードでは、<span class="in">`mutate()`</span>関数で<span class="in">`ME_rank10`</span>を新たに作成しています。</span>
<span id="cb64-229"><a href="#cb64-229"></a><span class="in">`ME_rank10`</span>は、<span class="in">`lagged_ME`</span>変数を<span class="in">`ntile()`</span>関数で10個に分類し、<span class="in">`as.factor()`</span>関数で因子型に変換したものです。</span>
<span id="cb64-230"><a href="#cb64-230"></a></span>
<span id="cb64-233"><a href="#cb64-233"></a><span class="in">```{r}</span></span>
<span id="cb64-234"><a href="#cb64-234"></a><span class="co"># ch06_11: 前年度末の時価総額に基づくポートフォリオ・ソート (1)</span></span>
<span id="cb64-235"><a href="#cb64-235"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-236"><a href="#cb64-236"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span> <span class="co"># 年度ごとに</span></span>
<span id="cb64-237"><a href="#cb64-237"></a>  <span class="fu">mutate</span>(</span>
<span id="cb64-238"><a href="#cb64-238"></a>    <span class="at">ME_rank10 =</span> <span class="fu">as.factor</span>(<span class="fu">ntile</span>(lagged_ME, <span class="dv">10</span>))</span>
<span id="cb64-239"><a href="#cb64-239"></a>    ) <span class="sc">%&gt;%</span> <span class="co"># ntile()関数を用いて十個のグループに分類</span></span>
<span id="cb64-240"><a href="#cb64-240"></a>  <span class="fu">ungroup</span>() <span class="co"># グループ化解除</span></span>
<span id="cb64-241"><a href="#cb64-241"></a><span class="fu">head</span>(annual_data)</span>
<span id="cb64-242"><a href="#cb64-242"></a><span class="in">```</span></span>
<span id="cb64-243"><a href="#cb64-243"></a><span class="in">`ME_rank10`</span>の値と、年・ランキングごとの会社数を確認してみましょう。</span>
<span id="cb64-244"><a href="#cb64-244"></a></span>
<span id="cb64-247"><a href="#cb64-247"></a><span class="in">```{r}</span></span>
<span id="cb64-248"><a href="#cb64-248"></a><span class="fu">summary</span>(annual_data<span class="sc">$</span>ME_rank10)</span>
<span id="cb64-249"><a href="#cb64-249"></a></span>
<span id="cb64-250"><a href="#cb64-250"></a><span class="fu">table</span>(annual_data<span class="sc">$</span>year,  annual_data<span class="sc">$</span>ME_rank10)</span>
<span id="cb64-251"><a href="#cb64-251"></a><span class="in">```</span></span>
<span id="cb64-252"><a href="#cb64-252"></a>ここでは、<span class="in">`ME_rank10`</span>の値が10の企業が時価総額ランキングの上位10%に、1の企業が時価総額ランキングの下位10%に属することを意味します。</span>
<span id="cb64-253"><a href="#cb64-253"></a></span>
<span id="cb64-254"><a href="#cb64-254"></a>前回と同様に、<span class="in">`full_join()`</span>関数で<span class="in">`monthly_data`</span>と<span class="in">`annual_data`</span>を結合します。</span>
<span id="cb64-255"><a href="#cb64-255"></a><span class="in">`drop_na()`</span>関数で欠損行を削除し、<span class="in">`group_by()`</span>関数で<span class="in">`month_ID`</span>と<span class="in">`ME_rank10`</span>に関してグループ化した上で、<span class="in">`summarize()`</span>関数で月次超過リターン<span class="in">`Re`</span>の平均値を計算して、<span class="in">`Re`</span>変数としています。</span>
<span id="cb64-256"><a href="#cb64-256"></a></span>
<span id="cb64-257"><a href="#cb64-257"></a><span class="in">```{r ch06-13, filename="前年度末の時価総額に基づくポートフォリオ・ソート"}</span></span>
<span id="cb64-258"><a href="#cb64-258"></a></span>
<span id="cb64-259"><a href="#cb64-259"></a>ME_sorted_portfolio <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-260"><a href="#cb64-260"></a>  <span class="fu">select</span>(year, firm_ID, ME_rank10) <span class="sc">%&gt;%</span> <span class="co"># 年次データから追加したい情報を抽出</span></span>
<span id="cb64-261"><a href="#cb64-261"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">%&gt;%</span> <span class="co"># yearとfirm_IDをキーに月次データと結合</span></span>
<span id="cb64-262"><a href="#cb64-262"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> <span class="co"># 欠損行を削除</span></span>
<span id="cb64-263"><a href="#cb64-263"></a>  <span class="fu">group_by</span>(month_ID, ME_rank10) <span class="sc">%&gt;%</span> <span class="co"># month_IDとME_rank10に関してグループ化</span></span>
<span id="cb64-264"><a href="#cb64-264"></a>  <span class="fu">summarize</span>(<span class="at">Re =</span> <span class="fu">mean</span>(Re)) <span class="sc">%&gt;%</span> <span class="co"># 各グループで月次超過リターンの平均値を計算</span></span>
<span id="cb64-265"><a href="#cb64-265"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-266"><a href="#cb64-266"></a>ME_sorted_portfolio</span>
<span id="cb64-267"><a href="#cb64-267"></a><span class="in">```</span></span>
<span id="cb64-268"><a href="#cb64-268"></a></span>
<span id="cb64-269"><a href="#cb64-269"></a>準備が出来たので、各ポートフォリオの平均超過リターンを可視化してみましょう。</span>
<span id="cb64-270"><a href="#cb64-270"></a>これにより、時価総額の大きい企業のポートフォリオが、時価総額の小さい企業のポートフォリオよりも高い、あるいは低いリターンを上げているかどうかを確認することができます。</span>
<span id="cb64-271"><a href="#cb64-271"></a></span>
<span id="cb64-272"><a href="#cb64-272"></a><span class="in">```{r ch06_14, filename="各ポートフォリオの平均超過リターンを可視化"}</span></span>
<span id="cb64-273"><a href="#cb64-273"></a>ME_cross_sectional_return <span class="ot">&lt;-</span> ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-274"><a href="#cb64-274"></a>  <span class="fu">group_by</span>(ME_rank10) <span class="sc">%&gt;%</span> <span class="co"># ME_rank10に関してグループ化</span></span>
<span id="cb64-275"><a href="#cb64-275"></a>  <span class="fu">summarize</span>(<span class="at">mean_Re =</span> <span class="fu">mean</span>(Re)) <span class="co"># 月次超過リターンの平均値を計算</span></span>
<span id="cb64-276"><a href="#cb64-276"></a></span>
<span id="cb64-277"><a href="#cb64-277"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(ME_cross_sectional_return) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> ME_rank10, <span class="at">y =</span> mean_Re)</span>
<span id="cb64-278"><a href="#cb64-278"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">geom_col</span>() <span class="co"># 棒グラフ</span></span>
<span id="cb64-279"><a href="#cb64-279"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"時価総額ランク"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"平均月次超過リターン"</span>)</span>
<span id="cb64-280"><a href="#cb64-280"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fl">0.02</span>) <span class="sc">+</span> mystyle</span>
<span id="cb64-281"><a href="#cb64-281"></a><span class="fu">print</span>(g)</span>
<span id="cb64-282"><a href="#cb64-282"></a><span class="in">```</span></span>
<span id="cb64-283"><a href="#cb64-283"></a></span>
<span id="cb64-284"><a href="#cb64-284"></a>小型株ほど月次超過リターンの平均が高いことが分かりました。</span>
<span id="cb64-285"><a href="#cb64-285"></a>このように、時価総額の大きい企業のポートフォリオと小さい企業のポートフォリオのリターンの差を**サイズ・プレミアム**と呼びます。</span>
<span id="cb64-286"><a href="#cb64-286"></a></span>
<span id="cb64-287"><a href="#cb64-287"></a>先ほどは各ポートフォリオの区分を同じウェイトで保有した場合のリターンを計算しましたが，コラムでは，時価総額の大きさに応じてウェイトを変えた時価総額加重ポートフォリオを作成して，先ほどの結果を再現してみる。</span>
<span id="cb64-288"><a href="#cb64-288"></a></span>
<span id="cb64-289"><a href="#cb64-289"></a>まずは等加重の場合のコードを確認する。</span>
<span id="cb64-290"><a href="#cb64-290"></a></span>
<span id="cb64-291"><a href="#cb64-291"></a><span class="in">```{r ch06_15a, filename="BPRに基づくポートフォリオ・ソート（等加重の場合）"}</span></span>
<span id="cb64-292"><a href="#cb64-292"></a></span>
<span id="cb64-293"><a href="#cb64-293"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-294"><a href="#cb64-294"></a>  <span class="fu">mutate</span>(<span class="at">lagged_BEME =</span> lagged_BE <span class="sc">/</span> lagged_ME) <span class="sc">%&gt;%</span></span>
<span id="cb64-295"><a href="#cb64-295"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb64-296"><a href="#cb64-296"></a>  <span class="fu">mutate</span>(<span class="at">BEME_rank10 =</span> <span class="fu">as.factor</span>(<span class="fu">ntile</span>(lagged_BEME, <span class="dv">10</span>))) <span class="sc">%&gt;%</span> <span class="co"># 簿価時価比率に基づいて十個のグループに分類</span></span>
<span id="cb64-297"><a href="#cb64-297"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-298"><a href="#cb64-298"></a></span>
<span id="cb64-299"><a href="#cb64-299"></a>BEME_sorted_portfolio <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-300"><a href="#cb64-300"></a>  <span class="fu">select</span>(year, firm_ID, BEME_rank10, lagged_ME) <span class="sc">%&gt;%</span></span>
<span id="cb64-301"><a href="#cb64-301"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb64-302"><a href="#cb64-302"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-303"><a href="#cb64-303"></a>  <span class="fu">group_by</span>(month_ID, BEME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb64-304"><a href="#cb64-304"></a>  <span class="fu">summarize</span>(<span class="at">Re =</span> <span class="fu">mean</span>(Re)) <span class="sc">%&gt;%</span> <span class="co"># 月次超過リターンの平均値を計算</span></span>
<span id="cb64-305"><a href="#cb64-305"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-306"><a href="#cb64-306"></a><span class="co"># 作図</span></span>
<span id="cb64-307"><a href="#cb64-307"></a><span class="fu">group_by</span>(BEME_sorted_portfolio, BEME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb64-308"><a href="#cb64-308"></a>  <span class="fu">summarize</span>(<span class="at">mean_Re =</span> <span class="fu">mean</span>(Re)) <span class="sc">%&gt;%</span></span>
<span id="cb64-309"><a href="#cb64-309"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb64-310"><a href="#cb64-310"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank10, <span class="at">y =</span> mean_Re)) <span class="sc">+</span></span>
<span id="cb64-311"><a href="#cb64-311"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="co"># y = 0の直線を追加</span></span>
<span id="cb64-312"><a href="#cb64-312"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME Rank"</span>, <span class="at">y =</span> <span class="st">"Mean Monthly Excess Return"</span>) <span class="sc">+</span></span>
<span id="cb64-313"><a href="#cb64-313"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.005</span>, <span class="fl">0.02</span>)) <span class="sc">+</span> mystyle</span>
<span id="cb64-314"><a href="#cb64-314"></a><span class="in">```</span></span>
<span id="cb64-315"><a href="#cb64-315"></a></span>
<span id="cb64-316"><a href="#cb64-316"></a>次に時価総額加重の場合のコードを確認します。</span>
<span id="cb64-317"><a href="#cb64-317"></a></span>
<span id="cb64-318"><a href="#cb64-318"></a><span class="in">```{r ch06_15b, filename="BPRに基づくポートフォリオ・ソート（時価総額加重の場合）"}</span></span>
<span id="cb64-319"><a href="#cb64-319"></a><span class="co"># 中盤で保有比率wと月次超過リターンReを計算している箇所を除けば,ch06_15aと全く同じ</span></span>
<span id="cb64-320"><a href="#cb64-320"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-321"><a href="#cb64-321"></a>  <span class="fu">mutate</span>(<span class="at">lagged_BEME =</span> lagged_BE <span class="sc">/</span> lagged_ME) <span class="sc">%&gt;%</span></span>
<span id="cb64-322"><a href="#cb64-322"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb64-323"><a href="#cb64-323"></a>  <span class="fu">mutate</span>(<span class="at">BEME_rank10 =</span> <span class="fu">as.factor</span>(<span class="fu">ntile</span>(lagged_BEME, <span class="dv">10</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb64-324"><a href="#cb64-324"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-325"><a href="#cb64-325"></a></span>
<span id="cb64-326"><a href="#cb64-326"></a>BEME_sorted_portfolio <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-327"><a href="#cb64-327"></a>  <span class="fu">select</span>(year, firm_ID, BEME_rank10, lagged_ME) <span class="sc">%&gt;%</span></span>
<span id="cb64-328"><a href="#cb64-328"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb64-329"><a href="#cb64-329"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-330"><a href="#cb64-330"></a>  <span class="fu">group_by</span>(month_ID, BEME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb64-331"><a href="#cb64-331"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> lagged_ME <span class="sc">/</span> <span class="fu">sum</span>(lagged_ME)) <span class="sc">%&gt;%</span> <span class="co"># 各ポートフォリオで保有比率を計算</span></span>
<span id="cb64-332"><a href="#cb64-332"></a>  <span class="fu">summarize</span>(<span class="at">Re =</span> <span class="fu">sum</span>(w <span class="sc">*</span> Re)) <span class="sc">%&gt;%</span> <span class="co"># 時価総額加重の月次超過リターンを計算</span></span>
<span id="cb64-333"><a href="#cb64-333"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-334"><a href="#cb64-334"></a></span>
<span id="cb64-335"><a href="#cb64-335"></a><span class="fu">group_by</span>(BEME_sorted_portfolio, BEME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb64-336"><a href="#cb64-336"></a>  <span class="fu">summarize</span>(<span class="at">mean_Re =</span> <span class="fu">mean</span>(Re)) <span class="sc">%&gt;%</span></span>
<span id="cb64-337"><a href="#cb64-337"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb64-338"><a href="#cb64-338"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank10, <span class="at">y =</span> mean_Re)) <span class="sc">+</span></span>
<span id="cb64-339"><a href="#cb64-339"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb64-340"><a href="#cb64-340"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME Rank"</span>, <span class="at">y =</span> <span class="st">"Mean Monthly Excess Return"</span>) <span class="sc">+</span></span>
<span id="cb64-341"><a href="#cb64-341"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.005</span>, <span class="fl">0.02</span>)) <span class="sc">+</span> mystyle</span>
<span id="cb64-342"><a href="#cb64-342"></a><span class="in">```</span></span>
<span id="cb64-343"><a href="#cb64-343"></a></span>
<span id="cb64-344"><a href="#cb64-344"></a>結果が異なっていることに注意しましょう。</span>
<span id="cb64-345"><a href="#cb64-345"></a></span>
<span id="cb64-346"><a href="#cb64-346"></a></span>
<span id="cb64-347"><a href="#cb64-347"></a>次節では，この現象を，資産価格モデルの1つであるCAPM(Capital Asset Pricing Model)が説明できるかどうかを検証します。</span>
<span id="cb64-348"><a href="#cb64-348"></a></span>
<span id="cb64-349"><a href="#cb64-349"></a><span class="fu">## CAPMの実証的な検証</span></span>
<span id="cb64-350"><a href="#cb64-350"></a></span>
<span id="cb64-351"><a href="#cb64-351"></a><span class="fu">### CAPMを検証する意義</span></span>
<span id="cb64-352"><a href="#cb64-352"></a></span>
<span id="cb64-353"><a href="#cb64-353"></a>まずはCAPMの復習から始めましょう。</span>
<span id="cb64-354"><a href="#cb64-354"></a>CAPMは，資産の期待リターンを，市場ポートフォリオの期待リターンと市場ポートフォリオとの共分散で説明するモデルです。</span>
<span id="cb64-355"><a href="#cb64-355"></a></span>
<span id="cb64-356"><a href="#cb64-356"></a>:::{.callout-important}</span>
<span id="cb64-357"><a href="#cb64-357"></a><span class="fu">## CAPM</span></span>
<span id="cb64-358"><a href="#cb64-358"></a></span>
<span id="cb64-359"><a href="#cb64-359"></a><span class="ss">- </span>**第1命題**: 市場ポートフォリオは接点ポートフォリオと一致し，効率的フ ロンティア(資本市場線)上に位置する.</span>
<span id="cb64-360"><a href="#cb64-360"></a><span class="ss">- </span>**第2命題**: 各証券のリスクプレミアムは，その証券のマーケット・ベータ に比例する.</span>
<span id="cb64-361"><a href="#cb64-361"></a></span>
<span id="cb64-362"><a href="#cb64-362"></a>$$</span>
<span id="cb64-363"><a href="#cb64-363"></a>\mathbb{E}<span class="co">[</span><span class="ot">R_i</span><span class="co">]</span> - R_F = \beta_i \left ( \mathbb{E}<span class="co">[</span><span class="ot">R_M</span><span class="co">]</span> - R_F \right )</span>
<span id="cb64-364"><a href="#cb64-364"></a>$$</span>
<span id="cb64-365"><a href="#cb64-365"></a>ただし，</span>
<span id="cb64-366"><a href="#cb64-366"></a>$$</span>
<span id="cb64-367"><a href="#cb64-367"></a>\beta_i = \frac{\mathrm{COV}_{R_i,  R_M}}{\mathrm{Var}_M}</span>
<span id="cb64-368"><a href="#cb64-368"></a>$$</span>
<span id="cb64-369"><a href="#cb64-369"></a>:::</span>
<span id="cb64-370"><a href="#cb64-370"></a></span>
<span id="cb64-371"><a href="#cb64-371"></a>このCAPMを回帰式で表現すると次のようになります。</span>
<span id="cb64-372"><a href="#cb64-372"></a></span>
<span id="cb64-373"><a href="#cb64-373"></a>$$</span>
<span id="cb64-374"><a href="#cb64-374"></a>R_{i,t}^e = \beta_i \times R_{M,t}^e + \varepsilon_{i,t}</span>
<span id="cb64-375"><a href="#cb64-375"></a>$$</span>
<span id="cb64-376"><a href="#cb64-376"></a>ここで、$R^e_{i,t} = R_{i,t} - R_{F,t}$である。</span>
<span id="cb64-377"><a href="#cb64-377"></a>つまり、$t$時点における証券$i$の実現超過リターン$R_{i,t}^e$は、$t$時点における市場ポートフォリオの実現超過リターン$R_{M,t}^e$と、証券$i$の市場ポートフォリオに対するベータ係数$\beta_i$の積に、誤差項$\varepsilon_{i,t}$を加えたものとして表現されます。</span>
<span id="cb64-378"><a href="#cb64-378"></a></span>
<span id="cb64-379"><a href="#cb64-379"></a>また、誤差項$\varepsilon_{i,t}$に関して次の仮定を置きます。</span>
<span id="cb64-380"><a href="#cb64-380"></a></span>
<span id="cb64-381"><a href="#cb64-381"></a><span class="ss">- </span>$varepsilon _{i,t}$は独立同一分布(i.i.d.)に従う</span>
<span id="cb64-382"><a href="#cb64-382"></a><span class="ss">- </span>$E<span class="co">[</span><span class="ot">\varepsilon_{i,t}</span><span class="co">]</span> = 0$</span>
<span id="cb64-383"><a href="#cb64-383"></a><span class="ss">- </span>$E<span class="co">[</span><span class="ot">R_{M,t}^e , \ \varepsilon_{i,t} </span><span class="co">]</span> = 0$</span>
<span id="cb64-384"><a href="#cb64-384"></a></span>
<span id="cb64-385"><a href="#cb64-385"></a>こうすることで、CAPM式を線形回帰モデルで表現できるので、$\beta_i$の推定が可能となります。</span>
<span id="cb64-386"><a href="#cb64-386"></a></span>
<span id="cb64-387"><a href="#cb64-387"></a><span class="fu">#### 6.2.2 時系列回帰</span></span>
<span id="cb64-388"><a href="#cb64-388"></a></span>
<span id="cb64-389"><a href="#cb64-389"></a>CAPM式は任意の$i$証券で成立するモデルのため、ポートフォリオにも応用できます。</span>
<span id="cb64-390"><a href="#cb64-390"></a>つまりあるポートフォリオの超過リターンを、市場ポートフォリオの超過リターンと、そのポートフォリオに対するベータ係数の積で説明することができます。</span>
<span id="cb64-391"><a href="#cb64-391"></a></span>
<span id="cb64-392"><a href="#cb64-392"></a>$$</span>
<span id="cb64-393"><a href="#cb64-393"></a>R_{P,t}^e = \alpha _P + \beta_P R_{M,t}^e + \varepsilon_{P,t}</span>
<span id="cb64-394"><a href="#cb64-394"></a>$$</span>
<span id="cb64-395"><a href="#cb64-395"></a></span>
<span id="cb64-396"><a href="#cb64-396"></a>CAPMの式と比較すると、切片である$\alpha _P$が追加されていることが分かります。</span>
<span id="cb64-397"><a href="#cb64-397"></a>もし証券市場にCAPMの関係が成立しているなら、$\alpha _P$はゼロとなっているはずです。</span>
<span id="cb64-398"><a href="#cb64-398"></a>この$\alpha $を調べることで、CAPMの検証が可能となります。</span>
<span id="cb64-399"><a href="#cb64-399"></a></span>
<span id="cb64-400"><a href="#cb64-400"></a></span>
<span id="cb64-401"><a href="#cb64-401"></a></span>
<span id="cb64-402"><a href="#cb64-402"></a>ここでは、**時系列回帰**を使って、市場ポートフォリオの超過リターンを説明変数として、各ポートフォリオの超過リターンを説明するモデルを推定します。</span>
<span id="cb64-403"><a href="#cb64-403"></a></span>
<span id="cb64-404"><a href="#cb64-404"></a></span>
<span id="cb64-407"><a href="#cb64-407"></a><span class="in">```{r}</span></span>
<span id="cb64-408"><a href="#cb64-408"></a><span class="co"># ch06_16: 市場ポートフォリオの超過リターンを追加</span></span>
<span id="cb64-409"><a href="#cb64-409"></a></span>
<span id="cb64-410"><a href="#cb64-410"></a>ME_sorted_portfolio <span class="ot">&lt;-</span> factor_data <span class="sc">%&gt;%</span></span>
<span id="cb64-411"><a href="#cb64-411"></a>  <span class="fu">select</span>(<span class="sc">-</span>R_F) <span class="sc">%&gt;%</span> <span class="co"># 無リスク金利は重複するので結合前に削除</span></span>
<span id="cb64-412"><a href="#cb64-412"></a>  <span class="fu">full_join</span>(ME_sorted_portfolio, <span class="at">by =</span> <span class="st">"month_ID"</span>) <span class="sc">%&gt;%</span> <span class="co"># month_IDをキーに</span></span>
<span id="cb64-413"><a href="#cb64-413"></a>  <span class="fu">select</span>(<span class="sc">-</span>R_Me, R_Me) <span class="co"># R_Meを最終列へ移動</span></span>
<span id="cb64-414"><a href="#cb64-414"></a><span class="in">```</span></span>
<span id="cb64-415"><a href="#cb64-415"></a></span>
<span id="cb64-416"><a href="#cb64-416"></a></span>
<span id="cb64-419"><a href="#cb64-419"></a><span class="in">```{r}</span></span>
<span id="cb64-420"><a href="#cb64-420"></a><span class="co"># ch06_17: 時系列回帰 (1)</span></span>
<span id="cb64-421"><a href="#cb64-421"></a></span>
<span id="cb64-422"><a href="#cb64-422"></a>ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-423"><a href="#cb64-423"></a>  <span class="fu">filter</span>(ME_rank10 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># 時価総額が最小のポートフォリオを抽出</span></span>
<span id="cb64-424"><a href="#cb64-424"></a>  <span class="fu">lm</span>(Re <span class="sc">~</span> R_Me, <span class="at">data =</span> .) <span class="sc">%&gt;%</span> <span class="co"># .を使ってlm()関数の第二引数にデータを代入</span></span>
<span id="cb64-425"><a href="#cb64-425"></a>  <span class="fu">tidy</span>() <span class="co"># 線形回帰の結果をtidy()関数でデータフレームに変換</span></span>
<span id="cb64-426"><a href="#cb64-426"></a><span class="in">```</span></span>
<span id="cb64-427"><a href="#cb64-427"></a></span>
<span id="cb64-428"><a href="#cb64-428"></a></span>
<span id="cb64-431"><a href="#cb64-431"></a><span class="in">```{r}</span></span>
<span id="cb64-432"><a href="#cb64-432"></a><span class="co"># ch06_18: 時系列回帰 (2)</span></span>
<span id="cb64-433"><a href="#cb64-433"></a></span>
<span id="cb64-434"><a href="#cb64-434"></a>ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-435"><a href="#cb64-435"></a>  <span class="fu">filter</span>(ME_rank10 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb64-436"><a href="#cb64-436"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> R_Me, <span class="at">y =</span> Re)) <span class="sc">+</span> <span class="co"># aes()関数はggplot()関数の中にも代入可能</span></span>
<span id="cb64-437"><a href="#cb64-437"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span>  <span class="co"># geom_point()関数と次のgeom_smooth()関数で共通のaes()関数を受け取る</span></span>
<span id="cb64-438"><a href="#cb64-438"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb64-439"><a href="#cb64-439"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Excess Return of Market Portfolio"</span>, <span class="at">y =</span> <span class="st">"Excess Return of Small Size Portfolio"</span>) <span class="sc">+</span></span>
<span id="cb64-440"><a href="#cb64-440"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb64-441"><a href="#cb64-441"></a><span class="in">```</span></span>
<span id="cb64-442"><a href="#cb64-442"></a></span>
<span id="cb64-443"><a href="#cb64-443"></a><span class="fu">#### 6.2.3 ポートフォリオごとの回帰</span></span>
<span id="cb64-444"><a href="#cb64-444"></a></span>
<span id="cb64-447"><a href="#cb64-447"></a><span class="in">```{r}</span></span>
<span id="cb64-448"><a href="#cb64-448"></a><span class="co"># ch06_19: CAPMの実証的な検証 (1)</span></span>
<span id="cb64-449"><a href="#cb64-449"></a></span>
<span id="cb64-450"><a href="#cb64-450"></a>CAPM_results <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="cn">NA</span>) <span class="co"># 推定結果を保存するために空のリストを準備</span></span>
<span id="cb64-451"><a href="#cb64-451"></a></span>
<span id="cb64-452"><a href="#cb64-452"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb64-453"><a href="#cb64-453"></a></span>
<span id="cb64-454"><a href="#cb64-454"></a>  CAPM_results[[i]] <span class="ot">&lt;-</span> ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-455"><a href="#cb64-455"></a>    <span class="fu">filter</span>(ME_rank10 <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb64-456"><a href="#cb64-456"></a>    <span class="fu">lm</span>(Re <span class="sc">~</span> R_Me, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb64-457"><a href="#cb64-457"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-458"><a href="#cb64-458"></a>    <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> i) <span class="sc">%&gt;%</span> <span class="co"># 推定対象のポートフォリオ名を保存</span></span>
<span id="cb64-459"><a href="#cb64-459"></a>    <span class="fu">select</span>(ME_rank10, <span class="fu">everything</span>()) <span class="co"># ME_rank10を第一列に移動</span></span>
<span id="cb64-460"><a href="#cb64-460"></a></span>
<span id="cb64-461"><a href="#cb64-461"></a>}</span>
<span id="cb64-462"><a href="#cb64-462"></a><span class="in">```</span></span>
<span id="cb64-463"><a href="#cb64-463"></a></span>
<span id="cb64-464"><a href="#cb64-464"></a></span>
<span id="cb64-467"><a href="#cb64-467"></a><span class="in">```{r}</span></span>
<span id="cb64-468"><a href="#cb64-468"></a><span class="co"># ch06_20: CAPMの実証的な検証 (2)</span></span>
<span id="cb64-469"><a href="#cb64-469"></a></span>
<span id="cb64-470"><a href="#cb64-470"></a>CAPM_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, CAPM_results) <span class="co"># do.call()関数を用いて複数のデータフレームから構成されるリストを一つのデータフレームに統合</span></span>
<span id="cb64-471"><a href="#cb64-471"></a><span class="in">```</span></span>
<span id="cb64-472"><a href="#cb64-472"></a></span>
<span id="cb64-473"><a href="#cb64-473"></a></span>
<span id="cb64-476"><a href="#cb64-476"></a><span class="in">```{r}</span></span>
<span id="cb64-477"><a href="#cb64-477"></a><span class="co"># ch06_21: グループごとの線形回帰 (1)  lapply()関数を使う場合</span></span>
<span id="cb64-478"><a href="#cb64-478"></a></span>
<span id="cb64-479"><a href="#cb64-479"></a>ME_sorted_portfolio_splitted <span class="ot">&lt;-</span> <span class="fu">split</span>(ME_sorted_portfolio, ME_sorted_portfolio<span class="sc">$</span>ME_rank10) <span class="co"># 元データをME_rank10の値に応じて十個のデータフレームに分割</span></span>
<span id="cb64-480"><a href="#cb64-480"></a></span>
<span id="cb64-481"><a href="#cb64-481"></a>estimate_CAPM <span class="ot">&lt;-</span> <span class="cf">function</span>(return_data) { <span class="co"># リターン・データを受け取り, CAPMの推定結果をデータフレームで返す関数を準備</span></span>
<span id="cb64-482"><a href="#cb64-482"></a>  lm_results <span class="ot">&lt;-</span> <span class="fu">lm</span>(Re <span class="sc">~</span> R_Me, <span class="at">data =</span> return_data)</span>
<span id="cb64-483"><a href="#cb64-483"></a>  tidied_lm_results <span class="ot">&lt;-</span> <span class="fu">tidy</span>(lm_results)</span>
<span id="cb64-484"><a href="#cb64-484"></a>}</span>
<span id="cb64-485"><a href="#cb64-485"></a></span>
<span id="cb64-486"><a href="#cb64-486"></a>CAPM_results_by_lapply <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ME_sorted_portfolio_splitted, estimate_CAPM) <span class="co"># lapply()関数は第一引数にリスト, 第二引数に関数を取る</span></span>
<span id="cb64-487"><a href="#cb64-487"></a><span class="co"># lapplyの返り値はリストなので，一つのデータフレームにまとめたい場合はdo.call()関数を用いる</span></span>
<span id="cb64-488"><a href="#cb64-488"></a><span class="in">```</span></span>
<span id="cb64-489"><a href="#cb64-489"></a></span>
<span id="cb64-490"><a href="#cb64-490"></a></span>
<span id="cb64-491"><a href="#cb64-491"></a><span class="in">````{r}</span></span>
<span id="cb64-492"><a href="#cb64-492"></a><span class="co"># ch06_22: グループごとの線形回帰 (2)  map()関数を使う場合</span></span>
<span id="cb64-493"><a href="#cb64-493"></a></span>
<span id="cb64-494"><a href="#cb64-494"></a>ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-495"><a href="#cb64-495"></a>  <span class="fu">group_by</span>(ME_rank10) <span class="sc">%&gt;%</span></span>
<span id="cb64-496"><a href="#cb64-496"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span> <span class="co"># nest()関数を用いて各グループを要素とするメタ・データフレームを作成</span></span>
<span id="cb64-497"><a href="#cb64-497"></a>  <span class="fu">mutate</span>(<span class="at">CAPM_regression =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(Re <span class="sc">~</span> R_Me, <span class="at">data =</span> .)), <span class="co"># map()関数を用いて各グループを線形回帰</span></span>
<span id="cb64-498"><a href="#cb64-498"></a>         <span class="at">CAPM_summary =</span> <span class="fu">map</span>(CAPM_regression, tidy)) <span class="sc">%&gt;%</span> <span class="co"># tidy()関数を用いて線形回帰の結果を整理</span></span>
<span id="cb64-499"><a href="#cb64-499"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(data, CAPM_regression)) <span class="sc">%&gt;%</span> <span class="co"># 線形回帰の結果のみを抽出</span></span>
<span id="cb64-500"><a href="#cb64-500"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> CAPM_summary) <span class="sc">%&gt;%</span> <span class="co"># nest()関数による畳み込みを解除</span></span>
<span id="cb64-501"><a href="#cb64-501"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-502"><a href="#cb64-502"></a><span class="st">```</span></span>
<span id="cb64-503"><a href="#cb64-503"></a></span>
<span id="cb64-504"><a href="#cb64-504"></a><span class="at">#### 6.2.4 CAPMアルファ</span></span>
<span id="cb64-505"><a href="#cb64-505"></a></span>
<span id="cb64-508"><a href="#cb64-508"></a><span class="in">```{r}</span></span>
<span id="cb64-509"><a href="#cb64-509"></a><span class="co"># ch06_23: CAPMアルファの可視化</span></span>
<span id="cb64-510"><a href="#cb64-510"></a></span>
<span id="cb64-511"><a href="#cb64-511"></a>CAPM_results <span class="sc">%&gt;%</span></span>
<span id="cb64-512"><a href="#cb64-512"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span> <span class="co"># 定数項に関する推定結果のみを抽出</span></span>
<span id="cb64-513"><a href="#cb64-513"></a>  <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> <span class="fu">as.factor</span>(ME_rank10)) <span class="sc">%&gt;%</span> <span class="co"># ME_rank10を整数型からファクター型に</span></span>
<span id="cb64-514"><a href="#cb64-514"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb64-515"><a href="#cb64-515"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> ME_rank10, <span class="at">y =</span> estimate)) <span class="sc">+</span> <span class="co"># 横軸をME_rank10, 縦軸をCAPM_alphaとする棒グラフ</span></span>
<span id="cb64-516"><a href="#cb64-516"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb64-517"><a href="#cb64-517"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"ME Rank"</span>, <span class="at">y =</span> <span class="st">"CAPM alpha"</span>) <span class="sc">+</span></span>
<span id="cb64-518"><a href="#cb64-518"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.003</span>, <span class="fl">0.013</span>)) <span class="sc">+</span></span>
<span id="cb64-519"><a href="#cb64-519"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb64-520"><a href="#cb64-520"></a><span class="st">```</span></span>
<span id="cb64-521"><a href="#cb64-521"></a></span>
<span id="cb64-522"><a href="#cb64-522"></a></span>
<span id="cb64-525"><a href="#cb64-525"></a><span class="in">```{r}</span></span>
<span id="cb64-526"><a href="#cb64-526"></a><span class="co"># ch06_24: CAPMアルファの統計的な有意性を評価</span></span>
<span id="cb64-527"><a href="#cb64-527"></a></span>
<span id="cb64-528"><a href="#cb64-528"></a>CAPM_results <span class="sc">%&gt;%</span></span>
<span id="cb64-529"><a href="#cb64-529"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span> <span class="co"># 定数項に関する推定結果のみを抽出</span></span>
<span id="cb64-530"><a href="#cb64-530"></a>  <span class="fu">rename</span>(<span class="at">CAPM_alpha =</span> estimate, <span class="at">p_value =</span> p.value) <span class="sc">%&gt;%</span> <span class="co"># 列名を変更</span></span>
<span id="cb64-531"><a href="#cb64-531"></a>  <span class="fu">mutate</span>(<span class="at">significance =</span> <span class="fu">cut</span>(p_value,</span>
<span id="cb64-532"><a href="#cb64-532"></a>                            <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="dv">1</span>),</span>
<span id="cb64-533"><a href="#cb64-533"></a>                            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"***"</span>, <span class="st">"**"</span>, <span class="st">"*"</span>, <span class="st">""</span>),</span>
<span id="cb64-534"><a href="#cb64-534"></a>                            <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> <span class="co"># 統計的に有意な結果を*で強調</span></span>
<span id="cb64-535"><a href="#cb64-535"></a>  <span class="fu">select</span>(ME_rank10, CAPM_alpha, p_value, significance) <span class="co"># 出力したい列を指定</span></span>
<span id="cb64-536"><a href="#cb64-536"></a><span class="st">```</span></span>
<span id="cb64-537"><a href="#cb64-537"></a></span>
<span id="cb64-538"><a href="#cb64-538"></a></span>
<span id="cb64-541"><a href="#cb64-541"></a><span class="in">```{r}</span></span>
<span id="cb64-542"><a href="#cb64-542"></a><span class="co"># ch06_25: 証券市場線の推定</span></span>
<span id="cb64-543"><a href="#cb64-543"></a></span>
<span id="cb64-544"><a href="#cb64-544"></a>ME_cross_sectional_return <span class="ot">&lt;-</span> CAPM_results <span class="sc">%&gt;%</span></span>
<span id="cb64-545"><a href="#cb64-545"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"R_Me"</span>) <span class="sc">%&gt;%</span> <span class="co"># R_Meの係数に関する推定結果のみを抽出</span></span>
<span id="cb64-546"><a href="#cb64-546"></a>  <span class="fu">rename</span>(<span class="at">CAPM_beta =</span> estimate) <span class="sc">%&gt;%</span> <span class="co"># 推定値をestimateからCAPM_betaに名称変更</span></span>
<span id="cb64-547"><a href="#cb64-547"></a>  <span class="fu">select</span>(ME_rank10, CAPM_beta) <span class="sc">%&gt;%</span></span>
<span id="cb64-548"><a href="#cb64-548"></a>  <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> <span class="fu">as.factor</span>(ME_rank10)) <span class="sc">%&gt;%</span> <span class="co"># ME_rank10を整数型からファクター型に</span></span>
<span id="cb64-549"><a href="#cb64-549"></a>  <span class="fu">full_join</span>(ME_cross_sectional_return, ., <span class="at">by =</span> <span class="st">"ME_rank10"</span>) <span class="co"># 超過リターンのデータと結合</span></span>
<span id="cb64-550"><a href="#cb64-550"></a></span>
<span id="cb64-551"><a href="#cb64-551"></a>mean_R_Me <span class="ot">&lt;-</span> <span class="fu">mean</span>(factor_data<span class="sc">$</span>R_Me) <span class="co"># 市場ポートフォリオの実現超過リターンにより証券市場線の傾きを推定</span></span>
<span id="cb64-552"><a href="#cb64-552"></a></span>
<span id="cb64-553"><a href="#cb64-553"></a><span class="fu">ggplot</span>(ME_cross_sectional_return) <span class="sc">+</span></span>
<span id="cb64-554"><a href="#cb64-554"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> CAPM_beta, <span class="at">y =</span> mean_Re)) <span class="sc">+</span></span>
<span id="cb64-555"><a href="#cb64-555"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> mean_R_Me) <span class="sc">+</span></span>
<span id="cb64-556"><a href="#cb64-556"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Market beta"</span>, <span class="at">y =</span> <span class="st">"Mean Excess Return"</span>) <span class="sc">+</span></span>
<span id="cb64-557"><a href="#cb64-557"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.2</span>), <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb64-558"><a href="#cb64-558"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.02</span>)) <span class="sc">+</span></span>
<span id="cb64-559"><a href="#cb64-559"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb64-560"><a href="#cb64-560"></a><span class="st">```</span></span>
<span id="cb64-561"><a href="#cb64-561"></a></span>
<span id="cb64-562"><a href="#cb64-562"></a><span class="at">### 6.3 Fama-Frenchの3ファクター・モデル</span></span>
<span id="cb64-563"><a href="#cb64-563"></a></span>
<span id="cb64-564"><a href="#cb64-564"></a><span class="at">#### 6.3.3 銘柄のランク付け</span></span>
<span id="cb64-565"><a href="#cb64-565"></a></span>
<span id="cb64-568"><a href="#cb64-568"></a><span class="in">```{r}</span></span>
<span id="cb64-569"><a href="#cb64-569"></a><span class="co"># ch06_26: 前年度の時価総額に基づくランク付け</span></span>
<span id="cb64-570"><a href="#cb64-570"></a></span>
<span id="cb64-571"><a href="#cb64-571"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-572"><a href="#cb64-572"></a>  <span class="fu">mutate</span>(<span class="at">lagged_ME =</span> <span class="fu">replace</span>(lagged_ME, <span class="fu">is.na</span>(lagged_BEME), <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> <span class="co"># lagged_BEMEが欠損している場合は欠損扱いに</span></span>
<span id="cb64-573"><a href="#cb64-573"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb64-574"><a href="#cb64-574"></a>  <span class="fu">mutate</span>(<span class="at">ME_rank2 =</span> <span class="fu">as.factor</span>(<span class="fu">ntile</span>(lagged_ME, <span class="dv">2</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb64-575"><a href="#cb64-575"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-576"><a href="#cb64-576"></a><span class="st">```</span></span>
<span id="cb64-577"><a href="#cb64-577"></a></span>
<span id="cb64-578"><a href="#cb64-578"></a></span>
<span id="cb64-581"><a href="#cb64-581"></a><span class="in">```{r}</span></span>
<span id="cb64-582"><a href="#cb64-582"></a><span class="co"># ch06_27: 簿価時価比率に基づくランク付け (1)</span></span>
<span id="cb64-583"><a href="#cb64-583"></a></span>
<span id="cb64-584"><a href="#cb64-584"></a>annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-585"><a href="#cb64-585"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb64-586"><a href="#cb64-586"></a>  <span class="fu">mutate</span>(<span class="at">BEME_percent_rank =</span> <span class="fu">percent_rank</span>(lagged_BEME)) <span class="sc">%&gt;%</span> <span class="co"># 年度ごとに簿価時価比率のパーセンタイル順位を計算</span></span>
<span id="cb64-587"><a href="#cb64-587"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-588"><a href="#cb64-588"></a><span class="st">```</span></span>
<span id="cb64-589"><a href="#cb64-589"></a></span>
<span id="cb64-590"><a href="#cb64-590"></a></span>
<span id="cb64-593"><a href="#cb64-593"></a><span class="in">```{r}</span></span>
<span id="cb64-594"><a href="#cb64-594"></a><span class="co"># ch06_28: 簿価時価比率に基づくランク付け (2)</span></span>
<span id="cb64-595"><a href="#cb64-595"></a></span>
<span id="cb64-596"><a href="#cb64-596"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-597"><a href="#cb64-597"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb64-598"><a href="#cb64-598"></a>  <span class="fu">mutate</span>(<span class="at">BEME_percent_rank =</span> <span class="fu">percent_rank</span>(lagged_BEME)) <span class="sc">%&gt;%</span> <span class="co"># 年度ごとに簿価時価比率のパーセンタイル順位を計算</span></span>
<span id="cb64-599"><a href="#cb64-599"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-600"><a href="#cb64-600"></a>  <span class="fu">mutate</span>(<span class="at">BEME_rank3 =</span> <span class="fu">cut</span>(BEME_percent_rank,</span>
<span id="cb64-601"><a href="#cb64-601"></a>                          <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span>, <span class="dv">1</span>),</span>
<span id="cb64-602"><a href="#cb64-602"></a>                          <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb64-603"><a href="#cb64-603"></a>                          <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="co"># BEME_percent_rankの値に応じて1から3までBEME_rank3の値を定義</span></span>
<span id="cb64-604"><a href="#cb64-604"></a><span class="st">```</span></span>
<span id="cb64-605"><a href="#cb64-605"></a></span>
<span id="cb64-606"><a href="#cb64-606"></a><span class="at">#### 6.3.4 時価総額とBE/MEに基づくポートフォリオ・ソート</span></span>
<span id="cb64-607"><a href="#cb64-607"></a></span>
<span id="cb64-610"><a href="#cb64-610"></a><span class="in">```{r}</span></span>
<span id="cb64-611"><a href="#cb64-611"></a><span class="co"># ch06_29: 6 Size-BE/MEポートフォリオへの分類 (1)</span></span>
<span id="cb64-612"><a href="#cb64-612"></a></span>
<span id="cb64-613"><a href="#cb64-613"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-614"><a href="#cb64-614"></a>  <span class="fu">mutate</span>(<span class="at">FF_portfolio_type =</span> <span class="fu">interaction</span>(ME_rank2, BEME_rank3)) <span class="co"># ME_rank2とBEME_rank3の組合せで, ファクター型の変数FF_portfolio_typeを定義</span></span>
<span id="cb64-615"><a href="#cb64-615"></a><span class="st">```</span></span>
<span id="cb64-616"><a href="#cb64-616"></a></span>
<span id="cb64-617"><a href="#cb64-617"></a></span>
<span id="cb64-620"><a href="#cb64-620"></a><span class="in">```{r}</span></span>
<span id="cb64-621"><a href="#cb64-621"></a><span class="co"># ch06_30: 6 Size-BE/MEポートフォリオへの分類 (2)</span></span>
<span id="cb64-622"><a href="#cb64-622"></a></span>
<span id="cb64-623"><a href="#cb64-623"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-624"><a href="#cb64-624"></a>  <span class="fu">mutate</span>(<span class="at">FF_portfolio_type =</span> <span class="fu">fct_recode</span>(FF_portfolio_type, <span class="co"># FF_portfolio_typeの水準を変更</span></span>
<span id="cb64-625"><a href="#cb64-625"></a>                                        <span class="at">SL =</span> <span class="st">"1.1"</span>,</span>
<span id="cb64-626"><a href="#cb64-626"></a>                                        <span class="at">BL =</span> <span class="st">"2.1"</span>,</span>
<span id="cb64-627"><a href="#cb64-627"></a>                                        <span class="at">SN =</span> <span class="st">"1.2"</span>,</span>
<span id="cb64-628"><a href="#cb64-628"></a>                                        <span class="at">BN =</span> <span class="st">"2.2"</span>,</span>
<span id="cb64-629"><a href="#cb64-629"></a>                                        <span class="at">SH =</span> <span class="st">"1.3"</span>,</span>
<span id="cb64-630"><a href="#cb64-630"></a>                                        <span class="at">BH =</span> <span class="st">"2.3"</span>))</span>
<span id="cb64-631"><a href="#cb64-631"></a><span class="st">```</span></span>
<span id="cb64-632"><a href="#cb64-632"></a></span>
<span id="cb64-633"><a href="#cb64-633"></a></span>
<span id="cb64-636"><a href="#cb64-636"></a><span class="in">```{r}</span></span>
<span id="cb64-637"><a href="#cb64-637"></a><span class="co"># ch06_31: 6 Size-BE/MEポートフォリオへの分類 (3)</span></span>
<span id="cb64-638"><a href="#cb64-638"></a></span>
<span id="cb64-639"><a href="#cb64-639"></a>annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-640"><a href="#cb64-640"></a>  <span class="fu">group_by</span>(ME_rank2, BEME_rank3) <span class="sc">%&gt;%</span> <span class="co"># ME_rank2とBEME_rank3のペアでグループ化</span></span>
<span id="cb64-641"><a href="#cb64-641"></a>  <span class="fu">summarize</span>(<span class="at">FF_portfolio_type =</span> FF_portfolio_type[<span class="dv">1</span>],</span>
<span id="cb64-642"><a href="#cb64-642"></a>            <span class="at">mean_BEME =</span> <span class="fu">mean</span>(lagged_BEME),</span>
<span id="cb64-643"><a href="#cb64-643"></a>            <span class="at">mean_ME =</span> <span class="fu">mean</span>(lagged_ME),</span>
<span id="cb64-644"><a href="#cb64-644"></a>            <span class="at">mean_N_stocks =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="fu">length</span>(<span class="fu">unique</span>(year))) <span class="sc">%&gt;%</span></span>
<span id="cb64-645"><a href="#cb64-645"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-646"><a href="#cb64-646"></a>  <span class="fu">drop_na</span>() <span class="co"># 欠損データを削除</span></span>
<span id="cb64-647"><a href="#cb64-647"></a><span class="st">```</span></span>
<span id="cb64-648"><a href="#cb64-648"></a></span>
<span id="cb64-649"><a href="#cb64-649"></a></span>
<span id="cb64-652"><a href="#cb64-652"></a><span class="in">```{r}</span></span>
<span id="cb64-653"><a href="#cb64-653"></a><span class="co"># ch06_32: 6 Size-BE/MEポートフォリオの構築 (1)</span></span>
<span id="cb64-654"><a href="#cb64-654"></a></span>
<span id="cb64-655"><a href="#cb64-655"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-656"><a href="#cb64-656"></a>  <span class="fu">group_by</span>(year, FF_portfolio_type) <span class="sc">%&gt;%</span> <span class="co"># yearとFF_portfolio_typeのペアでグループ化</span></span>
<span id="cb64-657"><a href="#cb64-657"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> lagged_ME  <span class="sc">/</span> <span class="fu">sum</span>(lagged_ME, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> <span class="co"># 各ポートフォリオ内で時価総額加重の保有比率を計算</span></span>
<span id="cb64-658"><a href="#cb64-658"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb64-659"><a href="#cb64-659"></a><span class="st">```</span></span>
<span id="cb64-660"><a href="#cb64-660"></a></span>
<span id="cb64-661"><a href="#cb64-661"></a></span>
<span id="cb64-664"><a href="#cb64-664"></a><span class="in">```{r}</span></span>
<span id="cb64-665"><a href="#cb64-665"></a><span class="co"># ch06_33: 6 Size-BE/MEポートフォリオの構築 (2)</span></span>
<span id="cb64-666"><a href="#cb64-666"></a></span>
<span id="cb64-667"><a href="#cb64-667"></a>FF_portfolio <span class="ot">&lt;-</span> annual_data <span class="sc">%&gt;%</span></span>
<span id="cb64-668"><a href="#cb64-668"></a>  <span class="fu">select</span>(year, firm_ID, FF_portfolio_type, ME_rank2, BEME_rank3, w) <span class="sc">%&gt;%</span></span>
<span id="cb64-669"><a href="#cb64-669"></a>  <span class="fu">full_join</span>(monthly_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">%&gt;%</span> <span class="co"># 今までに準備したデータと月次データを結合</span></span>
<span id="cb64-670"><a href="#cb64-670"></a>  <span class="fu">group_by</span>(month_ID, FF_portfolio_type) <span class="sc">%&gt;%</span> <span class="co"># month_IDとFF_portfolio_typeでグループ化</span></span>
<span id="cb64-671"><a href="#cb64-671"></a>  <span class="fu">summarize</span>(<span class="at">ME_rank2 =</span> ME_rank2[<span class="dv">1</span>],</span>
<span id="cb64-672"><a href="#cb64-672"></a>            <span class="at">BEME_rank3 =</span> BEME_rank3[<span class="dv">1</span>],</span>
<span id="cb64-673"><a href="#cb64-673"></a>            <span class="at">R =</span> <span class="fu">sum</span>(w <span class="sc">*</span> R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 各ポートフォリオの月次リターンを計算</span></span>
<span id="cb64-674"><a href="#cb64-674"></a>            <span class="at">R_F =</span> R_F[<span class="dv">1</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb64-675"><a href="#cb64-675"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-676"><a href="#cb64-676"></a>  <span class="fu">drop_na</span>() <span class="co"># 欠損データを削除</span></span>
<span id="cb64-677"><a href="#cb64-677"></a><span class="st">```</span></span>
<span id="cb64-678"><a href="#cb64-678"></a></span>
<span id="cb64-679"><a href="#cb64-679"></a></span>
<span id="cb64-682"><a href="#cb64-682"></a><span class="in">```{r}</span></span>
<span id="cb64-683"><a href="#cb64-683"></a><span class="co"># ch06_34: 6 Size-BE/MEポートフォリオのリターンの可視化 (1)</span></span>
<span id="cb64-684"><a href="#cb64-684"></a></span>
<span id="cb64-685"><a href="#cb64-685"></a>FF_portfolio_mean_return <span class="ot">&lt;-</span> FF_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-686"><a href="#cb64-686"></a>  <span class="fu">mutate</span>(<span class="at">Re =</span> R <span class="sc">-</span> R_F) <span class="sc">%&gt;%</span></span>
<span id="cb64-687"><a href="#cb64-687"></a>  <span class="fu">group_by</span>(FF_portfolio_type) <span class="sc">%&gt;%</span> <span class="co"># FF_portfolio_typeでグループ化</span></span>
<span id="cb64-688"><a href="#cb64-688"></a>  <span class="fu">summarize</span>(<span class="at">ME_rank2 =</span> ME_rank2[<span class="dv">1</span>],</span>
<span id="cb64-689"><a href="#cb64-689"></a>            <span class="at">BEME_rank3 =</span> BEME_rank3[<span class="dv">1</span>],</span>
<span id="cb64-690"><a href="#cb64-690"></a>            <span class="at">mean_Re =</span> <span class="fu">mean</span>(Re)) <span class="co"># 各ポートフォリオの超過リターンの平均値を計算</span></span>
<span id="cb64-691"><a href="#cb64-691"></a></span>
<span id="cb64-692"><a href="#cb64-692"></a><span class="fu">ggplot</span>(FF_portfolio_mean_return) <span class="sc">+</span></span>
<span id="cb64-693"><a href="#cb64-693"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank3, <span class="at">y =</span> mean_Re, <span class="at">fill =</span> ME_rank2), <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span> <span class="co"># x軸をBEME_rank3, y軸をmean_Reに, ME_rank2のサブグループで色分け</span></span>
<span id="cb64-694"><a href="#cb64-694"></a>  <span class="fu">scale_fill_grey</span>() <span class="sc">+</span> <span class="co"># 棒グラフの色をモノトーンに</span></span>
<span id="cb64-695"><a href="#cb64-695"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME Rank"</span>, <span class="at">y =</span> <span class="st">"Mean Monthly Excess Return"</span>, <span class="at">fill =</span> <span class="st">"ME Rank"</span>) <span class="sc">+</span></span>
<span id="cb64-696"><a href="#cb64-696"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb64-697"><a href="#cb64-697"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb64-698"><a href="#cb64-698"></a><span class="st">```</span></span>
<span id="cb64-699"><a href="#cb64-699"></a></span>
<span id="cb64-700"><a href="#cb64-700"></a></span>
<span id="cb64-703"><a href="#cb64-703"></a><span class="in">```{r}</span></span>
<span id="cb64-704"><a href="#cb64-704"></a><span class="co"># ch06_35: 6 Size-BE/MEポートフォリオのリターンの可視化 (2)</span></span>
<span id="cb64-705"><a href="#cb64-705"></a></span>
<span id="cb64-706"><a href="#cb64-706"></a><span class="fu">ggplot</span>(FF_portfolio_mean_return) <span class="sc">+</span></span>
<span id="cb64-707"><a href="#cb64-707"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank3, <span class="at">y =</span> mean_Re, <span class="at">fill =</span> ME_rank2), <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb64-708"><a href="#cb64-708"></a>  <span class="fu">scale_fill_grey</span>() <span class="sc">+</span></span>
<span id="cb64-709"><a href="#cb64-709"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> BEME_rank3, <span class="at">y =</span> mean_Re, <span class="at">group =</span> ME_rank2, <span class="at">label =</span> FF_portfolio_type), <span class="co"># (x, y)座標を指定して各ポートフォリオの名前をグラフに挿入</span></span>
<span id="cb64-710"><a href="#cb64-710"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="co"># 棒グラフが重ならないよう文字ラベルを上にずらす</span></span>
<span id="cb64-711"><a href="#cb64-711"></a>            <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.9</span>)) <span class="sc">+</span> <span class="co"># ME_rank2のサブグループで文字ラベルが左右にずれるよう調整</span></span>
<span id="cb64-712"><a href="#cb64-712"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME Rank"</span>, <span class="at">y =</span> <span class="st">"Mean Monthly Excess Return"</span>, <span class="at">fill =</span> <span class="st">"ME Rank"</span>) <span class="sc">+</span></span>
<span id="cb64-713"><a href="#cb64-713"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.015</span>)) <span class="sc">+</span> <span class="co"># 文字ラベルがはみ出ないようy軸の範囲を指定</span></span>
<span id="cb64-714"><a href="#cb64-714"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb64-715"><a href="#cb64-715"></a><span class="st">```</span></span>
<span id="cb64-716"><a href="#cb64-716"></a></span>
<span id="cb64-717"><a href="#cb64-717"></a></span>
<span id="cb64-720"><a href="#cb64-720"></a><span class="in">```{r}</span></span>
<span id="cb64-721"><a href="#cb64-721"></a><span class="co"># ch06_36: 6 Size-BE/MEポートフォリオのリターンの可視化 (3)</span></span>
<span id="cb64-722"><a href="#cb64-722"></a></span>
<span id="cb64-723"><a href="#cb64-723"></a>initial_point <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">month_ID =</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">12</span>), <span class="co"># 累積リターンの起点を定義</span></span>
<span id="cb64-724"><a href="#cb64-724"></a>                            <span class="at">cumulative_gross_R =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb64-725"><a href="#cb64-725"></a>                            <span class="at">FF_portfolio_type =</span> <span class="fu">c</span>(<span class="st">"BL"</span>, <span class="st">"SH"</span>))</span>
<span id="cb64-726"><a href="#cb64-726"></a></span>
<span id="cb64-727"><a href="#cb64-727"></a>FF_portfolio_cumulative_return <span class="ot">&lt;-</span> FF_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-728"><a href="#cb64-728"></a>  <span class="fu">group_by</span>(FF_portfolio_type) <span class="sc">%&gt;%</span> <span class="co"># FF_portfolio_typeでグループ化</span></span>
<span id="cb64-729"><a href="#cb64-729"></a>  <span class="fu">mutate</span>(<span class="at">cumulative_gross_R =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">+</span> R)) <span class="sc">%&gt;%</span> <span class="co"># グロス・リターンを累積</span></span>
<span id="cb64-730"><a href="#cb64-730"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-731"><a href="#cb64-731"></a>  <span class="fu">filter</span>(FF_portfolio_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"BL"</span>, <span class="st">"SH"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb64-732"><a href="#cb64-732"></a>  <span class="fu">select</span>(month_ID, cumulative_gross_R, FF_portfolio_type) <span class="sc">%&gt;%</span></span>
<span id="cb64-733"><a href="#cb64-733"></a>  <span class="fu">rbind</span>(initial_point, .) <span class="co"># initial_pointを第一行に挿入</span></span>
<span id="cb64-734"><a href="#cb64-734"></a></span>
<span id="cb64-735"><a href="#cb64-735"></a><span class="fu">ggplot</span>(FF_portfolio_cumulative_return) <span class="sc">+</span></span>
<span id="cb64-736"><a href="#cb64-736"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> month_ID, <span class="at">y =</span> cumulative_gross_R, <span class="at">linetype =</span> FF_portfolio_type)) <span class="sc">+</span></span>
<span id="cb64-737"><a href="#cb64-737"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"longdash"</span>, <span class="st">"solid"</span>)) <span class="sc">+</span></span>
<span id="cb64-738"><a href="#cb64-738"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb64-739"><a href="#cb64-739"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Month ID"</span>, <span class="at">y =</span> <span class="st">"Cumulative Gross Return"</span>, <span class="at">linetype =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb64-740"><a href="#cb64-740"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb64-741"><a href="#cb64-741"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb64-742"><a href="#cb64-742"></a><span class="st">```</span></span>
<span id="cb64-743"><a href="#cb64-743"></a></span>
<span id="cb64-744"><a href="#cb64-744"></a><span class="at">#### 6.3.5 ファクター・リターンの計算</span></span>
<span id="cb64-745"><a href="#cb64-745"></a></span>
<span id="cb64-746"><a href="#cb64-746"></a></span>
<span id="cb64-749"><a href="#cb64-749"></a><span class="in">```{r}</span></span>
<span id="cb64-750"><a href="#cb64-750"></a><span class="co"># ch06_37: SMBとHMLの構築 (1)</span></span>
<span id="cb64-751"><a href="#cb64-751"></a></span>
<span id="cb64-752"><a href="#cb64-752"></a>FF_portfolio <span class="ot">&lt;-</span> FF_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-753"><a href="#cb64-753"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> month_ID, <span class="at">names_from =</span> FF_portfolio_type, <span class="at">values_from =</span> R) <span class="co"># FF_portfolio_typeの値に基づく列を作成し, 縦長から横長のデータに変換</span></span>
<span id="cb64-754"><a href="#cb64-754"></a><span class="st">```</span></span>
<span id="cb64-755"><a href="#cb64-755"></a></span>
<span id="cb64-756"><a href="#cb64-756"></a></span>
<span id="cb64-759"><a href="#cb64-759"></a><span class="in">```{r}</span></span>
<span id="cb64-760"><a href="#cb64-760"></a><span class="co"># ch06_38: SMBとHMLの構築 (2)</span></span>
<span id="cb64-761"><a href="#cb64-761"></a>factor_data <span class="ot">&lt;-</span> FF_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-762"><a href="#cb64-762"></a>  <span class="fu">mutate</span>(<span class="at">SMB =</span> (SH <span class="sc">+</span> SN <span class="sc">+</span> SL) <span class="sc">/</span> <span class="dv">3</span> <span class="sc">-</span> (BH <span class="sc">+</span> BN <span class="sc">+</span> BL) <span class="sc">/</span> <span class="dv">3</span>, <span class="co"># SMBとHMLを計算</span></span>
<span id="cb64-763"><a href="#cb64-763"></a>         <span class="at">HML =</span> (SH <span class="sc">+</span> BH) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">-</span> (SL <span class="sc">+</span> BL) <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb64-764"><a href="#cb64-764"></a>  <span class="fu">select</span>(month_ID, SMB, HML) <span class="sc">%&gt;%</span></span>
<span id="cb64-765"><a href="#cb64-765"></a>  <span class="fu">full_join</span>(factor_data, <span class="at">by =</span> <span class="st">"month_ID"</span>) <span class="sc">%&gt;%</span> <span class="co"># 3ファクターの実現値をfactor_dataに集約</span></span>
<span id="cb64-766"><a href="#cb64-766"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"SMB"</span>, <span class="st">"HML"</span>), <span class="fu">c</span>(<span class="st">"SMB"</span>, <span class="st">"HML"</span>)) <span class="co"># SMBとHMLを最後列に移動</span></span>
<span id="cb64-767"><a href="#cb64-767"></a><span class="st">```</span></span>
<span id="cb64-768"><a href="#cb64-768"></a></span>
<span id="cb64-769"><a href="#cb64-769"></a><span class="at">#### 6.3.6 FF3アルファ</span></span>
<span id="cb64-770"><a href="#cb64-770"></a></span>
<span id="cb64-773"><a href="#cb64-773"></a><span class="in">```{r}</span></span>
<span id="cb64-774"><a href="#cb64-774"></a><span class="co"># ch06_39: FF3モデルの推定</span></span>
<span id="cb64-775"><a href="#cb64-775"></a></span>
<span id="cb64-776"><a href="#cb64-776"></a>ME_sorted_portfolio <span class="ot">&lt;-</span> ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-777"><a href="#cb64-777"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(R_Me, R_M)) <span class="sc">%&gt;%</span></span>
<span id="cb64-778"><a href="#cb64-778"></a>  <span class="fu">full_join</span>(factor_data, <span class="at">by =</span> <span class="st">"month_ID"</span>) <span class="co"># 3ファクターの実現値をME_sorted_portfolioに追加</span></span>
<span id="cb64-779"><a href="#cb64-779"></a></span>
<span id="cb64-780"><a href="#cb64-780"></a>FF3_results <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="cn">NA</span>)  <span class="co"># 推定結果を保存するために空のリストを準備</span></span>
<span id="cb64-781"><a href="#cb64-781"></a></span>
<span id="cb64-782"><a href="#cb64-782"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb64-783"><a href="#cb64-783"></a>  FF3_results[[i]] <span class="ot">&lt;-</span> ME_sorted_portfolio <span class="sc">%&gt;%</span></span>
<span id="cb64-784"><a href="#cb64-784"></a>    <span class="fu">filter</span>(ME_rank10 <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb64-785"><a href="#cb64-785"></a>    <span class="fu">lm</span>(Re <span class="sc">~</span> R_Me <span class="sc">+</span> SMB <span class="sc">+</span> HML, <span class="at">data =</span> .) <span class="sc">%&gt;%</span> <span class="co"># 3ファクターの実現値を独立変数として重回帰</span></span>
<span id="cb64-786"><a href="#cb64-786"></a>    <span class="fu">tidy</span>() <span class="sc">%&gt;%</span></span>
<span id="cb64-787"><a href="#cb64-787"></a>    <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> i) <span class="sc">%&gt;%</span> <span class="co"># 推定対象のポートフォリオ名を保存</span></span>
<span id="cb64-788"><a href="#cb64-788"></a>    <span class="fu">select</span>(ME_rank10, <span class="fu">everything</span>()) <span class="co"># ME_rank10を第一列に移動</span></span>
<span id="cb64-789"><a href="#cb64-789"></a>}</span>
<span id="cb64-790"><a href="#cb64-790"></a></span>
<span id="cb64-791"><a href="#cb64-791"></a>FF3_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, FF3_results) <span class="co"># do.call()関数を用いて複数のデータフレームから構成されるリストを一つのデータフレームに統合</span></span>
<span id="cb64-792"><a href="#cb64-792"></a><span class="st">```</span></span>
<span id="cb64-793"><a href="#cb64-793"></a></span>
<span id="cb64-794"><a href="#cb64-794"></a></span>
<span id="cb64-797"><a href="#cb64-797"></a><span class="in">```{r}</span></span>
<span id="cb64-798"><a href="#cb64-798"></a><span class="co"># ch06_40: FF3アルファの可視化</span></span>
<span id="cb64-799"><a href="#cb64-799"></a>FF3_results <span class="sc">%&gt;%</span></span>
<span id="cb64-800"><a href="#cb64-800"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span> <span class="co"># 定数項に関する推定結果のみを抽出</span></span>
<span id="cb64-801"><a href="#cb64-801"></a>  <span class="fu">mutate</span>(<span class="at">ME_rank10 =</span> <span class="fu">as.factor</span>(ME_rank10)) <span class="sc">%&gt;%</span> <span class="co"># ME_rank10を整数型からファクター型に</span></span>
<span id="cb64-802"><a href="#cb64-802"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb64-803"><a href="#cb64-803"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x =</span> ME_rank10, <span class="at">y =</span> estimate)) <span class="sc">+</span> <span class="co"># 横軸をME_rank10, 縦軸をFF3_alphaとする棒グラフ</span></span>
<span id="cb64-804"><a href="#cb64-804"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb64-805"><a href="#cb64-805"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"ME Rank"</span>, <span class="at">y =</span> <span class="st">"FF3 alpha"</span>) <span class="sc">+</span></span>
<span id="cb64-806"><a href="#cb64-806"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.003</span>, <span class="fl">0.013</span>)) <span class="sc">+</span></span>
<span id="cb64-807"><a href="#cb64-807"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb64-808"><a href="#cb64-808"></a><span class="st">```</span></span>
<span id="cb64-809"><a href="#cb64-809"></a></span>
<span id="cb64-810"><a href="#cb64-810"></a></span>
<span id="cb64-813"><a href="#cb64-813"></a><span class="in">```{r}</span></span>
<span id="cb64-814"><a href="#cb64-814"></a><span class="co"># ch06_41: FF3アルファの統計的な有意性を評価</span></span>
<span id="cb64-815"><a href="#cb64-815"></a>FF3_results <span class="sc">%&gt;%</span></span>
<span id="cb64-816"><a href="#cb64-816"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span> <span class="co"># 定数項に関する推定結果のみを抽出</span></span>
<span id="cb64-817"><a href="#cb64-817"></a>  <span class="fu">rename</span>(<span class="at">FF3_alpha =</span> estimate, <span class="at">p_value =</span> p.value) <span class="sc">%&gt;%</span> <span class="co"># 列名を変更</span></span>
<span id="cb64-818"><a href="#cb64-818"></a>  <span class="fu">mutate</span>(<span class="at">significance =</span> <span class="fu">cut</span>(p_value,</span>
<span id="cb64-819"><a href="#cb64-819"></a>                            <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="dv">1</span>),</span>
<span id="cb64-820"><a href="#cb64-820"></a>                            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"***"</span>, <span class="st">"**"</span>, <span class="st">"*"</span>, <span class="st">""</span>),</span>
<span id="cb64-821"><a href="#cb64-821"></a>                            <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> <span class="co"># 統計的に有意な結果を*で強調</span></span>
<span id="cb64-822"><a href="#cb64-822"></a>  <span class="fu">select</span>(ME_rank10, FF3_alpha, p_value, significance) <span class="co"># 出力したい列を指定</span></span>
<span id="cb64-823"><a href="#cb64-823"></a><span class="st">```</span></span>
<span id="cb64-824"><a href="#cb64-824"></a></span>
<span id="cb64-825"><a href="#cb64-825"></a></span>
<span id="cb64-828"><a href="#cb64-828"></a><span class="in">```{r}</span></span>
<span id="cb64-829"><a href="#cb64-829"></a><span class="co"># ch06_42: データの保存</span></span>
<span id="cb64-830"><a href="#cb64-830"></a><span class="fu">write_csv</span>(factor_data, <span class="st">"data/ch06_output.csv"</span>)</span>
<span id="cb64-831"><a href="#cb64-831"></a><span class="st">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Soichi Matsuura</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link" href="https://so-ichi.com/r.html">
      <i class="bi bi-house" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ma2ura">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/matsuura_rits">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>