<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Soichi Matsuura">
<title>6&nbsp; 株式データの取得と可視化 – 実証会計・ファイナンスの勉強ノート</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter06.html" rel="next">
<link href="./chapter04.html" rel="prev">
<link href="./img/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-0907bcc31431a373ae96853dfe16c1d2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-9b98439fbe4ae1eb56616ecad9777bd3.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-0907bcc31431a373ae96853dfe16c1d2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SFB56VHK63"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SFB56VHK63', { 'anonymize_ip': true});
</script><style>
.marky {
  background: linear-gradient(transparent 60%, #FCFFC1 0%);
}
.markb {
  background: linear-gradient(transparent 60%, #88E2EA 0%);
}
.markp{
  background: linear-gradient(transparent 70%, #ffcdd2 0%)
}
</style>
<script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script><script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">
<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta name="twitter:title" content="6&nbsp; 株式データの取得と可視化 – 実証会計・ファイナンスの勉強ノート">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="chapter05_files/figure-html/ch05_06-1.png">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapter05.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">株式データの取得と可視化</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">実証会計・ファイナンスの勉強ノート</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">はじめに</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">ファイナンス入門</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R言語入門</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter03_02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">R言語入門 後半</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">財務データの取得と可視化</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter05.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">株式データの取得と可視化</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">ファクターモデルの導入</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#%E6%A0%AA%E5%BC%8F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%8F%96%E5%BE%97%E3%81%A8%E5%8F%AF%E8%A6%96%E5%8C%96" id="toc-株式データの取得と可視化" class="nav-link active" data-scroll-target="#%E6%A0%AA%E5%BC%8F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%8F%96%E5%BE%97%E3%81%A8%E5%8F%AF%E8%A6%96%E5%8C%96"><span class="header-section-number">6.1</span> 株式データの取得と可視化</a>
  <ul class="collapse">
<li><a href="#%E6%A0%AA%E4%BE%A1%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%A8%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF" id="toc-株価データのダウンロードと読み込み" class="nav-link" data-scroll-target="#%E6%A0%AA%E4%BE%A1%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%81%A8%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><span class="header-section-number">6.1.1</span> 株価データのダウンロードと読み込み</a></li>
  </ul>
</li>
  <li>
<a href="#%E6%99%82%E4%BE%A1%E7%B7%8F%E9%A1%8D%E3%81%A8%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%88%E7%AE%97" id="toc-時価総額とリターンの計算" class="nav-link" data-scroll-target="#%E6%99%82%E4%BE%A1%E7%B7%8F%E9%A1%8D%E3%81%A8%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%88%E7%AE%97"><span class="header-section-number">6.2</span> 時価総額とリターンの計算</a>
  <ul class="collapse">
<li><a href="#%E3%83%88%E3%83%BC%E3%82%BF%E3%83%AB%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A8%E8%B6%85%E9%81%8E%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%88%E7%AE%97" id="toc-トータルリターンと超過リターンの計算" class="nav-link" data-scroll-target="#%E3%83%88%E3%83%BC%E3%82%BF%E3%83%AB%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%A8%E8%B6%85%E9%81%8E%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%88%E7%AE%97"><span class="header-section-number">6.2.1</span> トータル・リターンと超過リターンの計算</a></li>
  <li><a href="#%E6%A0%AA%E5%BC%8F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%8E%A2%E7%B4%A2%E7%9A%84%E3%83%87%E3%83%BC%E3%82%BF%E5%88%86%E6%9E%90" id="toc-株式データの探索的データ分析" class="nav-link" data-scroll-target="#%E6%A0%AA%E5%BC%8F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%8E%A2%E7%B4%A2%E7%9A%84%E3%83%87%E3%83%BC%E3%82%BF%E5%88%86%E6%9E%90"><span class="header-section-number">6.2.2</span> 株式データの探索的データ分析</a></li>
  </ul>
</li>
  <li>
<a href="#%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E7%B4%AF%E7%A9%8D" id="toc-リターンの累積" class="nav-link" data-scroll-target="#%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E7%B4%AF%E7%A9%8D"><span class="header-section-number">7</span> リターンの累積</a>
  <ul class="collapse">
<li><a href="#%E3%83%90%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%89%E3%83%9B%E3%83%BC%E3%83%AB%E3%83%89%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9" id="toc-バイアンドホールドリターンの考え方" class="nav-link" data-scroll-target="#%E3%83%90%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%89%E3%83%9B%E3%83%BC%E3%83%AB%E3%83%89%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9"><span class="header-section-number">7.1</span> バイ・アンド・ホールド・リターンの考え方</a></li>
  <li><a href="#%E5%B9%B4%E6%AC%A1%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%88%E7%AE%97" id="toc-年次リターンの計算" class="nav-link" data-scroll-target="#%E5%B9%B4%E6%AC%A1%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%88%E7%AE%97"><span class="header-section-number">7.2</span> 年次リターンの計算</a></li>
  </ul>
</li>
  <li>
<a href="#%E6%A0%AA%E5%BC%8F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%A8%E8%B2%A1%E5%8B%99%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B%E3%81%9F%E5%88%86%E6%9E%90" id="toc-株式データと財務データを組み合わせた分析" class="nav-link" data-scroll-target="#%E6%A0%AA%E5%BC%8F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%A8%E8%B2%A1%E5%8B%99%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B%E3%81%9F%E5%88%86%E6%9E%90"><span class="header-section-number">8</span> 株式データと財務データを組み合わせた分析</a>
  <ul class="collapse">
<li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%B5%90%E5%90%88" id="toc-データの結合" class="nav-link" data-scroll-target="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%B5%90%E5%90%88"><span class="header-section-number">8.1</span> データの結合</a></li>
  <li><a href="#%E3%83%90%E3%83%96%E3%83%AB%E3%83%81%E3%83%A3%E3%83%BC%E3%83%88" id="toc-バブルチャート" class="nav-link" data-scroll-target="#%E3%83%90%E3%83%96%E3%83%AB%E3%83%81%E3%83%A3%E3%83%BC%E3%83%88"><span class="header-section-number">8.2</span> バブルチャート</a></li>
  </ul>
</li>
  <li>
<a href="#%E7%B5%B1%E8%A8%88%E7%9A%84%E6%8E%A8%E8%AB%96%E5%85%A5%E9%96%80" id="toc-統計的推論入門" class="nav-link" data-scroll-target="#%E7%B5%B1%E8%A8%88%E7%9A%84%E6%8E%A8%E8%AB%96%E5%85%A5%E9%96%80"><span class="header-section-number">9</span> 統計的推論入門</a>
  <ul class="collapse">
<li><a href="#%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E4%BB%AE%E5%AE%9A" id="toc-リターンデータに関する仮定" class="nav-link" data-scroll-target="#%E3%83%AA%E3%82%BF%E3%83%BC%E3%83%B3%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E4%BB%AE%E5%AE%9A"><span class="header-section-number">9.1</span> リターン・データに関する仮定</a></li>
  <li>
<a href="#%E6%8E%A8%E5%AE%9A%E9%87%8F%E3%81%A8%E6%8E%A8%E5%AE%9A%E5%80%A4%E3%81%AE%E9%81%95%E3%81%84" id="toc-推定量と推定値の違い" class="nav-link" data-scroll-target="#%E6%8E%A8%E5%AE%9A%E9%87%8F%E3%81%A8%E6%8E%A8%E5%AE%9A%E5%80%A4%E3%81%AE%E9%81%95%E3%81%84"><span class="header-section-number">9.2</span> 推定量と推定値の違い</a>
  <ul class="collapse">
<li><a href="#%E5%A4%A7%E6%95%B0%E3%81%AE%E6%B3%95%E5%89%87" id="toc-大数の法則" class="nav-link" data-scroll-target="#%E5%A4%A7%E6%95%B0%E3%81%AE%E6%B3%95%E5%89%87"><span class="header-section-number">9.2.1</span> 大数の法則</a></li>
  </ul>
</li>
  <li>
<a href="#t%E5%80%A4%E3%81%AE%E8%A8%88%E7%AE%97" id="toc-t値の計算" class="nav-link" data-scroll-target="#t%E5%80%A4%E3%81%AE%E8%A8%88%E7%AE%97"><span class="header-section-number">9.3</span> <span class="math inline">t</span>値の計算</a>
  <ul class="collapse">
<li><a href="#%E7%B5%B1%E8%A8%88%E7%9A%84%E6%A4%9C%E5%AE%9A%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9" id="toc-統計的検定の考え方" class="nav-link" data-scroll-target="#%E7%B5%B1%E8%A8%88%E7%9A%84%E6%A4%9C%E5%AE%9A%E3%81%AE%E8%80%83%E3%81%88%E6%96%B9"><span class="header-section-number">9.3.1</span> 統計的検定の考え方</a></li>
  </ul>
</li>
  </ul>
</li>
  <li>
<a href="#%E7%B7%9A%E5%BD%A2%E5%9B%9E%E5%B8%B0%E5%85%A5%E9%96%80" id="toc-線形回帰入門" class="nav-link" data-scroll-target="#%E7%B7%9A%E5%BD%A2%E5%9B%9E%E5%B8%B0%E5%85%A5%E9%96%80"><span class="header-section-number">10</span> 線形回帰入門</a>
  <ul class="collapse">
<li><a href="#ols%E6%8E%A8%E5%AE%9A" id="toc-ols推定" class="nav-link" data-scroll-target="#ols%E6%8E%A8%E5%AE%9A"><span class="header-section-number">10.1</span> OLS推定</a></li>
  <li><a href="#%E5%AF%BE%E6%95%B0%E5%9B%9E%E5%B8%B0%E3%83%A2%E3%83%87%E3%83%AB" id="toc-対数回帰モデル" class="nav-link" data-scroll-target="#%E5%AF%BE%E6%95%B0%E5%9B%9E%E5%B8%B0%E3%83%A2%E3%83%87%E3%83%AB"><span class="header-section-number">10.2</span> 対数回帰モデル</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">株式データの取得と可視化</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>パッケージの読み込みとテーマ</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2"></a>  tidyverse,</span>
<span id="cb1-3"><a href="#cb1-3"></a>  ggthemes,</span>
<span id="cb1-4"><a href="#cb1-4"></a>  ggpubr,</span>
<span id="cb1-5"><a href="#cb1-5"></a>  plotly,</span>
<span id="cb1-6"><a href="#cb1-6"></a>  patchwork,</span>
<span id="cb1-7"><a href="#cb1-7"></a>  Rsolnp,</span>
<span id="cb1-8"><a href="#cb1-8"></a>  e1071,</span>
<span id="cb1-9"><a href="#cb1-9"></a>  broom</span>
<span id="cb1-10"><a href="#cb1-10"></a>)</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a>mystyle <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="fu">theme_economist_white</span>(</span>
<span id="cb1-14"><a href="#cb1-14"></a>    <span class="at">base_family =</span> <span class="st">"HiraKakuProN-W3"</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>    ),</span>
<span id="cb1-16"><a href="#cb1-16"></a>  <span class="fu">scale_colour_economist</span>(),</span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="fu">theme</span>(</span>
<span id="cb1-18"><a href="#cb1-18"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb1-19"><a href="#cb1-19"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb1-20"><a href="#cb1-20"></a>  )</span>
<span id="cb1-21"><a href="#cb1-21"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<section id="株式データの取得と可視化" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="株式データの取得と可視化">
<span class="header-section-number">6.1</span> 株式データの取得と可視化</h2>
<p>前章では財務データを題材に、クロスセクションデータを扱うために必要なデータの取得と操作と可視化について学習しました。 特に重要な操作として，<code>group_by()</code>関数と<code>mutate()</code>や<code>summarise()</code>関数の組み合わせて，グループごとの変数の値を計算する方法を学びました。 本章では株式データを題材に，株式データの理解に必要な株式の基礎知識とともに，リターンの定義や計算について学び，最後には統計的推論と線形回帰分析についても学習します。</p>
<!-- 株式データの理解を深めるために，株式市場の仕組みを理解する必要があるので，重要用語の説明を行います。

| 相場用語 | 解説 |
|:-- |:-------- |
| 成行注文 | 値段を指定せず，その時点の最良気配値で取引を希望すること |
| 指値注文 | 特定の値段を指定して取引を希望すること |
| 板 | その時点で有効な指値注文を売りと買いで分けて価格ごとにまとめた一覧表のこと |
| 板寄せ方式 | 取引開始時に板情報(それまでに提出された売りと買いの注文)に 基づいて取引価格を決定する方法のこと |
| ザラ場寄せ方式 | 取引時間(ザラ場)中に新規注文と板情報に基づいて取引価格を決 定する方法のこと(図 5.1 を参照) |
| 歩み値 | 取引時間中の売買履歴(約定価格や出来高)に関する時系列データのこと |
| 証拠金 | 信用取引を行う際に資金の貸し手に差し入れる担保のこと |
| 値洗い | 保有するポートフォリオ(ポジション)の価値を時価で再評価すること |
| 追証 | 値洗いの結果，追加の証拠金を求められること |
| 逆日歩 | 信用売りが殺到し株不足となった銘柄でショート・セラーが追加で 支払う費用のこと |
| 踏み上げ | 株価上昇で損失を抱えたショート・セラー(2.2.3 節を参照)のロス カットが一段の株高を招くこと | -->
<section id="株価データのダウンロードと読み込み" class="level3" data-number="6.1.1"><h3 data-number="6.1.1" class="anchored" data-anchor-id="株価データのダウンロードと読み込み">
<span class="header-section-number">6.1.1</span> 株価データのダウンロードと読み込み</h3>
<p>いままでと同じように、<code>readr</code>パッケージの<code>read_csv()</code>関数でCSVファイルを読み込みます。 ここでは、<code>ch05_stock_data.csv</code>を使います。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>株式データの読み込み</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>stock_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ch05_stock_data.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">print</span>(stock_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 95,040 × 9
    year month month_ID firm_ID stock_price   DPS shares_outstanding
   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;              &lt;dbl&gt;
 1  2015     1        1       1         954     0            2422000
 2  2015     2        2       1         960     0            2422000
 3  2015     3        3       1        1113     0            2422000
 4  2015     4        4       1        1081     0            2422000
 5  2015     5        5       1        1317     0            2422000
 6  2015     6        6       1        1366    29            2422000
 7  2015     7        7       1        1353     0            2422000
 8  2015     8        8       1        1209     0            2422000
 9  2015     9        9       1        1291     0            2422000
10  2015    10       10       1        1407     0            2422000
# ℹ 95,030 more rows
# ℹ 2 more variables: adjustment_coefficient &lt;dbl&gt;, R_F &lt;dbl&gt;</code></pre>
</div>
</div>
<p>9変数，95,040行という大規模なデータが読み込まれました。 紙面の都合上、長い変数名を短く省略します。変数名を変えるには、<code><a href="https://dplyr.tidyverse.org/reference/rename.html">dplyr::rename()</a></code>を使います。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>変数名の変更</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="fu">rename</span>(</span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="at">n_shares =</span> shares_outstanding, </span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="at">adj_coef =</span> adjustment_coefficient</span>
<span id="cb4-5"><a href="#cb4-5"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
<p>読み込まれたデータ<code>stock_data</code>の中には以下の変数が含まれています。</p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: left;">列名</th>
<th style="text-align: left;">データ型</th>
<th style="text-align: left;">説明</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>year</code></td>
<td style="text-align: left;">数値型<code>dbl</code>
</td>
<td style="text-align: left;">年度</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>month</code></td>
<td style="text-align: left;">数値型<code>dbl</code>
</td>
<td style="text-align: left;">月</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>month_ID</code></td>
<td style="text-align: left;">数値型<code>dbl</code>
</td>
<td style="text-align: left;">月ID</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>firm_ID</code></td>
<td style="text-align: left;">数値型<code>dbl</code>
</td>
<td style="text-align: left;">企業ID</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>stock_price</code></td>
<td style="text-align: left;">数値型<code>dbl</code>
</td>
<td style="text-align: left;">月末時点での終値</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>DPS</code></td>
<td style="text-align: left;">数値型<code>dbl</code>
</td>
<td style="text-align: left;">一株当たり配当額</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>n_shares</code></td>
<td style="text-align: left;">数値型<code>int</code>
</td>
<td style="text-align: left;">月末時点での発行済株式数</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>adj_coef</code></td>
<td style="text-align: left;">数値型<code>int</code>
</td>
<td style="text-align: left;">調整係数</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>R_F</code></td>
<td style="text-align: left;">数値型<code>dbl</code>
</td>
<td style="text-align: left;">月次無リスク金利</td>
</tr>
</tbody>
</table>
<p><code>year</code>〜<code>firm_ID</code>までは，時系列や企業の特定に必要なキーとなり， <code>stock_price</code>から<code>R_F</code>が分析する対象となる株価や配当，発行済株式数，調整係数，無リスク金利となります。 7列目の<code>n_shares</code>は発行済株式数です。 発行済株式数は随時，新株発行や自社株買い，株式分割で変動するため，株式数の変化を調整するためのデータとして<code>adj_coef</code>があります。 旧株式1に対して新株式2となる株式分割が行われた場合，この調整係数は2となります。</p>
<p>このような大規模データを前にした場合，とりあえずデータの構造を把握することから始めます。 ここでは基本関数よりも多機能な<code>tidyverse</code>の<code>dplyr</code>パッケージに含まれる<code>glimpse</code>関数を使って，データの構造を確認してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">glimpse</span>(stock_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 95,040
Columns: 9
$ year        &lt;dbl&gt; 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015…
$ month       &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7…
$ month_ID    &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,…
$ firm_ID     &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ stock_price &lt;dbl&gt; 954, 960, 1113, 1081, 1317, 1366, 1353, 1209, 1291, 1407, …
$ DPS         &lt;dbl&gt; 0, 0, 0, 0, 0, 29, 0, 0, 0, 0, 0, 29, 0, 0, 0, 0, 0, 40, 0…
$ n_shares    &lt;dbl&gt; 2422000, 2422000, 2422000, 2422000, 2422000, 2422000, 2422…
$ adj_coef    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ R_F         &lt;dbl&gt; 6.506826e-04, 5.834099e-04, 6.114423e-04, 6.848180e-04, 7.…</code></pre>
</div>
</div>
<p>データの型が<code>dbl</code>という初めて出てきた型になってますが，これは<code>double</code>の略で，数値型の一種です。<code>double</code>は64ビットの浮動小数点数を表し，小数点以下15桁までの精度を持ちます。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>数値型の種類
</div>
</div>
<div class="callout-body-container callout-body">
<p>数値型<code>numeric</code>は，<code>double</code>と<code>int</code>のどちらかになります。 <code>int</code>は整数(integer)型で，32ビットの整数を表し，小数点以下は切り捨てられます。 <code>dbl</code>は<code>int</code>の上位互換で，小数点以下の桁数が多い場合に使われます。</p>
</div>
</div>
<p>たとえば，<code>firm_ID</code>が74，<code>month_ID</code>が29から32（つまり2017年5月から8月）のデータを抽出してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>stock_data <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">filter</span>(firm_ID <span class="sc">==</span> <span class="dv">74</span> , month_ID <span class="sc">%in%</span> <span class="dv">29</span><span class="sc">:</span><span class="dv">32</span>) <span class="sc">|&gt;</span> <span class="co"># filterで条件を指定</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="fu">select</span>(year, firm_ID, month, month_ID,stock_price, DPS, n_shares, adj_coef) <span class="co"># selectで必要な変数を指定</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
   year firm_ID month month_ID stock_price   DPS n_shares adj_coef
  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1  2017      74     5       29        2816     0  4960000        1
2  2017      74     6       30        1402    11  9920000        2
3  2017      74     7       31        1420     0  9920000        1
4  2017      74     8       32        1502     0  9920000        1</code></pre>
</div>
</div>
<p>出力された結果の2行の<code>adj_coef</code>が2となっており、同時に<code>n_shares</code>が倍になっていることから、この会社は1株を2株に株式分割していることがわかります。</p>
</section></section><section id="時価総額とリターンの計算" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="時価総額とリターンの計算">
<span class="header-section-number">6.2</span> 時価総額とリターンの計算</h2>
<p>時価総額(market capitalization)を計算するためには、株式数に株価を掛けて計算します。 新しい変数を作成するときは<code>dplyr</code>パッケージの<code>mutate()</code>関数を使います。 <code>mutate()</code>で時価総額を表す新しい変数<code>ME</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">mutate</span>(<span class="at">ME =</span> stock_price <span class="sc">*</span> n_shares) <span class="co"># 時価総額</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>次に時価総額のヒストグラムを作成してみます。 前節で学習した内容に加えて、いろいろ見た目の指定を増やしてみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># 日本語を含むグラフを作成するときは，dev = "quartz_pdf"を指定する</span></span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">library</span>(scales) <span class="co"># 軸の表記を変えるパッケージを追加</span></span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(stock_data) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> ME)</span>
<span id="cb10-6"><a href="#cb10-6"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="co">#基本設定</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Market Equity"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="co">#軸ラベル</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(</span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">quantile</span>(stock_data<span class="sc">$</span>ME, <span class="fl">0.95</span>)), <span class="co"># x軸の範囲</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>  <span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">scale =</span> <span class="fl">1e-6</span>) <span class="co"># x軸の表記を百万円単位に</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>  ) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"時価総額"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"度数"</span>) <span class="sc">+</span>  mystyle</span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="fu">print</span>(g) <span class="co"># グラフを出力</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/ch05_06-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="chapter05_files/figure-html/ch05_06-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<section id="トータルリターンと超過リターンの計算" class="level3" data-number="6.2.1"><h3 data-number="6.2.1" class="anchored" data-anchor-id="トータルリターンと超過リターンの計算">
<span class="header-section-number">6.2.1</span> トータル・リターンと超過リターンの計算</h3>
<p>ある株式の<span class="math inline">t</span>期のトータル・リターン<span class="math inline">R_t</span>は、次式で定義されます。</p>
<p><span class="math display">
R_t = \frac{(\text{株価}_t + \text{1株当り配当}_t) \times \text{調整係数}_t - \text{株価}_{t-1}}{\text{株価}_{t-1}}
</span></p>
<p>たいていの場合，1株当り配当<span class="math inline">DPS_t</span>はゼロで，調整係数<span class="math inline">adjustment\_coefficient_t</span>は1となるため，次式のように簡略化できます。</p>
<p><span class="math display">
R_t = \frac{\text{株価}_t - \text{株価}_{t-1}}{\text{株価}_{t-1}}
</span></p>
<p>銘柄ごとにリターンを計算するので，<code>group_by()</code>と<code>mutate()</code>を使って計算します。ここでは，<code>firm_ID</code>ごとにトータルリターン<code>R</code>と， トータルリターンから無リスク利子率を除いた超過リターン<code>Re</code>を計算しています。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="fu">group_by</span>(firm_ID) <span class="sc">|&gt;</span> <span class="co"># 企業ごとに</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="fu">mutate</span>( <span class="co"># 新しい変数を作成</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>    <span class="co"># トータルリターン</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="at">R =</span> ( (stock_price <span class="sc">+</span> DPS) <span class="sc">*</span> adj_coef <span class="sc">-</span> <span class="fu">lag</span>(stock_price)) <span class="sc">/</span> <span class="fu">lag</span>(stock_price),</span>
<span id="cb11-6"><a href="#cb11-6"></a>    <span class="at">Re =</span> R <span class="sc">-</span> R_F <span class="co"># 月次超過リターン</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>  <span class="fu">ungroup</span>() <span class="co"># グループ化を解除</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>ここまでの処理で<code>stock_data</code>に時価総額<code>ME</code>，トータルリターン<code>R</code>，超過リターン<code>Re</code>が追加されました。 以下では，このデータを使って探索的データ分析を行います。</p>
</section><section id="株式データの探索的データ分析" class="level3" data-number="6.2.2"><h3 data-number="6.2.2" class="anchored" data-anchor-id="株式データの探索的データ分析">
<span class="header-section-number">6.2.2</span> 株式データの探索的データ分析</h3>
<p>探索的データ分析という名の，とりあえず何も考えずに目の前のデータから何が分かるのかを調べ倒してみる，という分析を行います。</p>
<p>とりあえず，<code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>で基本統計量を確認します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">summary</span>(stock_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      year          month          month_ID        firm_ID      
 Min.   :2015   Min.   : 1.00   Min.   : 1.00   Min.   :   1.0  
 1st Qu.:2016   1st Qu.: 3.75   1st Qu.:19.00   1st Qu.: 384.0  
 Median :2018   Median : 6.50   Median :37.00   Median : 760.0  
 Mean   :2018   Mean   : 6.50   Mean   :37.01   Mean   : 761.2  
 3rd Qu.:2019   3rd Qu.: 9.25   3rd Qu.:55.00   3rd Qu.:1147.0  
 Max.   :2020   Max.   :12.00   Max.   :72.00   Max.   :1515.0  
                                                                
  stock_price          DPS              n_shares            adj_coef     
 Min.   :   112   Min.   :   0.000   Min.   :3.700e+04   Min.   :0.1000  
 1st Qu.:  1417   1st Qu.:   0.000   1st Qu.:3.151e+06   1st Qu.:1.0000  
 Median :  2445   Median :   0.000   Median :1.014e+07   Median :1.0000  
 Mean   :  4685   Mean   :   6.802   Mean   :6.973e+07   Mean   :0.9999  
 3rd Qu.:  4558   3rd Qu.:   0.000   3rd Qu.:3.564e+07   3rd Qu.:1.0000  
 Max.   :622796   Max.   :1913.000   Max.   :2.111e+10   Max.   :2.0000  
                                                                         
      R_F                   ME                  R                  Re          
 Min.   :-2.329e-04   Min.   :1.459e+08   Min.   :-0.38028   Min.   :-0.38020  
 1st Qu.: 8.233e-06   1st Qu.:9.648e+09   1st Qu.:-0.04057   1st Qu.:-0.04076  
 Median : 8.203e-05   Median :2.563e+10   Median : 0.01033   Median : 0.01013  
 Mean   : 2.041e-04   Mean   :1.365e+11   Mean   : 0.01586   Mean   : 0.01565  
 3rd Qu.: 4.626e-04   3rd Qu.:7.987e+10   3rd Qu.: 0.06481   3rd Qu.: 0.06460  
 Max.   : 7.368e-04   Max.   :3.293e+13   Max.   : 0.51498   Max.   : 0.51448  
                                          NA's   :1515       NA's   :1515      </code></pre>
</div>
</div>
<p>さらに，分散と標準偏差も計算します。データには欠損値が含まれているため，<code>na.rm = TRUE</code>オプションをつけています。 教科書とは違いますが，<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code>関数を使って一気に複数の統計量を計算します。 ここでは，<code>stock_data &lt;- stock_data</code>としていないため，<code>stock_data</code>には新しい変数は追加されず，結果を表示するだけです。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>stock_data <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">summarise</span>(</span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="at">var_R =</span> <span class="fu">var</span>(R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 総リターンの分散</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="at">sd_R  =</span> <span class="fu">sd</span>(R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 総リターンの標準偏差</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="at">var_Re =</span> <span class="fu">var</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 超過リターンの分散</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="at">sd_Re =</span> <span class="fu">sd</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># 超過リターンの標準偏差</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
    var_R   sd_R  var_Re  sd_Re
    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
1 0.00830 0.0911 0.00830 0.0911</code></pre>
</div>
</div>
<p>データの分布の形を表す統計量である，3次のモーメントである歪度(skewness)と4次のモーメントである尖度(kurtosis)も計算してみます。 たとえば確率変数<span class="math inline">x</span>の歪度は <span class="math display">
\text{歪度} = \frac 1n \sum _{i = 1}^n \left( \frac{x_i - \bar x}{\hat \sigma_x} \right) ^3
</span> で表され，正の値をとるとき分布が右に歪んでいる(裾が右に長い)ことを示している。 尖度は， <span class="math display">
\text{尖度} = \frac 1n \sum _{i = 1}^n \left( \frac{x_i - \bar x}{\hat \sigma_x} \right) ^4
</span> で定義され，尖度が3のとき，正規分布と同じ尖度を持つことを示し，3より小さいとき，正規分布よりとがった分布をしていることを示します。</p>
<p>歪度と尖度を計算するには，<code>e1071</code>パッケージの<code>skewness()</code>関数を使います。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>stock_data <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="fu">summarise</span>(</span>
<span id="cb16-3"><a href="#cb16-3"></a>    <span class="at">skewness_R =</span> <span class="fu">skewness</span>(R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 総リターンの歪度</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>    <span class="at">kurtosis_R =</span> <span class="fu">kurtosis</span>(R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 総リターンの尖度</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>    <span class="at">skewness_Re =</span> <span class="fu">skewness</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 超過リターンの歪度</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>    <span class="at">kurtosis_Re =</span> <span class="fu">kurtosis</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># 超過リターンの尖度</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  skewness_R kurtosis_R skewness_Re kurtosis_Re
       &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
1      0.507       1.27       0.507        1.27</code></pre>
</div>
</div>
<p>トータルリターンの歪度が<span class="math inline">0.507 &gt;0</span>なので，右に裾の広い分布となっており，尖度が<span class="math inline">1.27 &lt; 3</span>なので正規分布よりもとがった形となっていることがわかります。</p>
<p>図でも確認するために，トータルリターン<code>R</code>のヒストグラムを書いてみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">ggplot</span>(stock_data) <span class="sc">+</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">aes</span>(<span class="at">x =</span> R) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> <span class="co"># トータルリターンのヒストグラム</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">xlab</span>(<span class="st">"Monthly Stock Return"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="co"># 軸ラベル</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/ch05_14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="chapter05_files/figure-html/ch05_14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>トータルリターンのヒストグラムに正規分布のグラフを重ねてみると，次のようになります。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># トータルリターン</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>R <span class="ot">&lt;-</span> stock_data<span class="sc">$</span>R</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co"># 正規分布データ作成</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>m <span class="ot">&lt;-</span> <span class="fu">mean</span>(stock_data<span class="sc">$</span>R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-6"><a href="#cb19-6"></a>sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(stock_data<span class="sc">$</span>R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-7"><a href="#cb19-7"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">95040</span>, <span class="at">mean =</span> m, <span class="at">sd =</span> sd)</span>
<span id="cb19-8"><a href="#cb19-8"></a></span>
<span id="cb19-9"><a href="#cb19-9"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(R,x) <span class="sc">|&gt;</span> <span class="fu">drop_na</span>() <span class="co"># 欠損値削除</span></span>
<span id="cb19-10"><a href="#cb19-10"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="fu">everything</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># トータルリターン</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>R <span class="ot">&lt;-</span> stock_data<span class="sc">$</span>R</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co"># 平均と標準偏差を計算</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>m <span class="ot">&lt;-</span> <span class="fu">mean</span>(stock_data<span class="sc">$</span>R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-5"><a href="#cb20-5"></a>s <span class="ot">&lt;-</span> <span class="fu">sd</span>(stock_data<span class="sc">$</span>R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="fu">ggplot</span>(stock_data) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8"></a>  <span class="fu">aes</span>(<span class="at">x =</span> R) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9"></a>  <span class="co"># y軸を密度(density)に設定</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11"></a>  <span class="co"># 正規分布の曲線を追加</span></span>
<span id="cb20-12"><a href="#cb20-12"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> m, <span class="at">sd =</span> s), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13"></a>  <span class="fu">xlab</span>(<span class="st">"Monthly Stock Return"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb20-14"><a href="#cb20-14"></a>  mystyle</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/unnamed-chunk-3-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="chapter05_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>トータルリターンと正規分布のヒストグラムを書いてみる。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># dev="quartz_pdf"</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name, <span class="at">group =</span> name) <span class="sc">+</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">position=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="fu">xlab</span>(<span class="st">"Monthly Stock Return"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Count"</span>)</span>
<span id="cb21-5"><a href="#cb21-5"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">annotate</span>( <span class="co"># 位置を指定して文字列を追加</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.3</span>, <span class="at">y =</span> <span class="dv">900</span>, <span class="at">label =</span> <span class="st">"fat tail"</span>) <span class="sc">+</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="fu">annotate</span>(<span class="co"># 始点や終点などを指定して矢印を追加</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>  <span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">0.3</span>, <span class="at">xend =</span> <span class="fl">0.3</span>,</span>
<span id="cb21-9"><a href="#cb21-9"></a>  <span class="at">y =</span> <span class="dv">800</span>, <span class="at">yend =</span> <span class="dv">300</span>,</span>
<span id="cb21-10"><a href="#cb21-10"></a>  <span class="at">color =</span> <span class="st">"black"</span>,  <span class="at">size =</span> <span class="fl">0.5</span>,</span>
<span id="cb21-11"><a href="#cb21-11"></a>  <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))</span>
<span id="cb21-12"><a href="#cb21-12"></a>  )</span>
<span id="cb21-13"><a href="#cb21-13"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">annotate</span>( <span class="co"># 位置を指定して文字列を追加</span></span>
<span id="cb21-14"><a href="#cb21-14"></a>  <span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.3</span>, <span class="at">y =</span> <span class="dv">4200</span>,</span>
<span id="cb21-15"><a href="#cb21-15"></a>  <span class="at">label =</span> <span class="st">"Sharp shape"</span></span>
<span id="cb21-16"><a href="#cb21-16"></a>  ) <span class="sc">+</span></span>
<span id="cb21-17"><a href="#cb21-17"></a>  <span class="fu">annotate</span>(<span class="co"># 始点や終点などを指定して矢印を追加</span></span>
<span id="cb21-18"><a href="#cb21-18"></a>  <span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">0.2</span>, <span class="at">xend =</span> <span class="fl">0.1</span>,</span>
<span id="cb21-19"><a href="#cb21-19"></a>  <span class="at">y =</span> <span class="dv">4200</span>, <span class="at">yend =</span> <span class="dv">4200</span>,</span>
<span id="cb21-20"><a href="#cb21-20"></a>  <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.5</span>,</span>
<span id="cb21-21"><a href="#cb21-21"></a>  <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))</span>
<span id="cb21-22"><a href="#cb21-22"></a>  )</span>
<span id="cb21-23"><a href="#cb21-23"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> mystyle</span>
<span id="cb21-24"><a href="#cb21-24"></a><span class="fu">print</span>(g)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/unnamed-chunk-4-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="chapter05_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>歪度と尖度の結果と整合的に、赤色で表されているトータルリターンのヒストグラムは正規分布よりも右に裾が長く，尖度も正規分布よりもとがった形となっています。</p>
</section></section><section id="リターンの累積" class="level1" data-number="7"><h1 data-number="7">
<span class="header-section-number">7</span> リターンの累積</h1>
<section id="バイアンドホールドリターンの考え方" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="バイアンドホールドリターンの考え方">
<span class="header-section-number">7.1</span> バイ・アンド・ホールド・リターンの考え方</h2>
<p><strong>バイ・アンド・ホールド・リターン</strong>(buy-and-hold-return)は，ある時点で株式を購入し，そのまま保有し続けたときのリターンのことを指します。 たとえば，<span class="math inline">12</span>月末に株式を購入し，<span class="math inline">3</span>月末に売却したときの、バイ・アンド・ホールド・リターンの累積は，次式で計算できます。ただし配当は無視します。 <span class="math display">
\begin{aligned}
\left ( \frac{W_{\text{3月}}}{W_{\text{12月}}} \right) =
\underbrace{\left ( \frac{W_{\text{1月}}}{W_{\text{12月}}} \right)}_{1 + R_{\text{1月}}} \times
\underbrace{\left ( \frac{W_{\text{2月}}}{W_{\text{1月}}} \right)}_{1 + R_{\text{2月}}} \times
\underbrace{\left ( \frac{W_{\text{3月}}}{W_{\text{2月}}} \right)}_{1 + R_{\text{3月}}} \times
\end{aligned}
</span></p>
<p>一般的に、月次で<span class="math inline">t</span>時点から<span class="math inline">T</span>時点までの年次リターンは、</p>
<p><span class="math display">
\left ( \frac{W_{\text{翌年12月末}}}{W_{\text{12月末}}} \right) = \prod_{t = \text{1月}}^{\text{12月}} (1 + R_t)
</span></p>
<p>と計算できます。</p>
</section><section id="年次リターンの計算" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="年次リターンの計算">
<span class="header-section-number">7.2</span> 年次リターンの計算</h2>
<p>では、<code>stock_data</code>をもとに年次リターンを計算してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>annual_stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="fu">group_by</span>(firm_ID, year) <span class="sc">|&gt;</span> <span class="co"># firm_IDとyearごとにグループ化</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="fu">summarise</span>(</span>
<span id="cb22-4"><a href="#cb22-4"></a>    <span class="at">annual_R =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> R) <span class="sc">-</span> <span class="dv">1</span>, <span class="co"># B&amp;H年次リターン</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="at">annual_R_F =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> R_F) <span class="sc">-</span> <span class="dv">1</span> <span class="co"># 年次超過リターン</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="fu">mutate</span>(<span class="at">annual_Re =</span> annual_R <span class="sc">-</span> annual_R_F) <span class="sc">|&gt;</span> <span class="co"># 年次超過リターン</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="fu">head</span>(annual_stock_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  firm_ID  year annual_R annual_R_F annual_Re
    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
1       1  2015   NA      0.00743      NA    
2       1  2016    0.997  0.000565      0.997
3       1  2017    0.688  0.0000488     0.688
4       1  2018   -0.214  0.00579      -0.219
5       1  2019    0.647 -0.000770      0.648
6       1  2020   -0.284  0.000380     -0.285</code></pre>
</div>
</div>
</section></section><section id="株式データと財務データを組み合わせた分析" class="level1" data-number="8"><h1 data-number="8">
<span class="header-section-number">8</span> 株式データと財務データを組み合わせた分析</h1>
<p>ここでは，株式データと財務データを組み合わせて分析を行います。</p>
<section id="データの結合" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="データの結合">
<span class="header-section-number">8.1</span> データの結合</h2>
<p>複数のデータフレームを結合する際に重要なところは、</p>
<ol type="1">
<li>データの頻度の違い</li>
<li>タイミングの一致</li>
</ol>
<p>となる。 今まで使ってきた財務データは年次データであるのに対して，株式データは月次データであるため，データの頻度が異なります。 確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>financial_data <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"data/ch04_output.csv"</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="fu">nrow</span>(financial_data) <span class="co"># 年次財務データの行数</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7919</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">nrow</span>(annual_stock_data) <span class="co"># 年次リターン・データの行数</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7920</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">nrow</span>(stock_data) <span class="co"># 月次リターン・データの行数</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 95040</code></pre>
</div>
</div>
<p>月次リターンの行数が上の年次データとは大きく異なっていることが分かります。</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>先読みバイアス</strong>(look-ahead bias)とは、ある時点での情報を使って、その時点よりも未来の情報を使っていることを指します。12月末決算の会社のディスクロジャージャーは、最速で決算日後45日以内に出される決算短信か、3ヶ月以内に出される有価証券報告書があります。 このため、年次データを使って同時期の年次リターンを計算すると、年次データの発表後に出される有価証券報告書の情報を使っていることになります。これを先読みバイアスといいます。</p>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>annual_data <span class="ot">&lt;-</span> annual_stock_data <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">full_join</span>(financial_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"firm_ID"</span>, <span class="st">"year"</span>)) <span class="co"># firm_IDとyearのペアをキーとして設定</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>annual_data <span class="ot">&lt;-</span> annual_stock_data <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>  <span class="fu">full_join</span>(financial_data) <span class="co"># キーを省略した場合，列名が同じ変数がキーになる</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>monthly_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>  <span class="fu">full_join</span>(financial_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"firm_ID"</span>, <span class="st">"year"</span>)) <span class="co"># firm_IDとyearのペアをキーとして設定</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="バブルチャート" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="バブルチャート">
<span class="header-section-number">8.2</span> バブルチャート</h2>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>annual_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">12</span>) <span class="sc">|&gt;</span> <span class="co"># 12月のみ</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>  <span class="fu">select</span>(year, firm_ID, ME) <span class="sc">|&gt;</span> <span class="co"># 変数を選択</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>  <span class="fu">full_join</span>(annual_data, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">|&gt;</span> <span class="co"># 年次データと結合</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>  <span class="fu">mutate</span>(<span class="at">ME =</span> ME <span class="sc">/</span> <span class="fl">1e6</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>year2015 <span class="ot">&lt;-</span> annual_data <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>   <span class="fu">filter</span>(</span>
<span id="cb34-3"><a href="#cb34-3"></a>      year <span class="sc">==</span> <span class="dv">2015</span>, <span class="co"># 2015年のみ</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>      firm_ID <span class="sc">%in%</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>, <span class="co"># firm_IDが2から20のデータを抽出</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>      X <span class="sc">&gt;</span> <span class="dv">0</span> <span class="co"># 対数を取るため当期純利益が正のデータのみ抽出</span></span>
<span id="cb34-6"><a href="#cb34-6"></a>      )</span>
<span id="cb34-7"><a href="#cb34-7"></a></span>
<span id="cb34-8"><a href="#cb34-8"></a><span class="fu">ggplot</span>(year2015) <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(sales), <span class="at">y =</span> <span class="fu">log</span>(X), <span class="at">size =</span> ME, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="co"># バブルチャートを描くにはsize引数を指定</span></span>
<span id="cb34-11"><a href="#cb34-11"></a>  <span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>), <span class="at">name =</span> <span class="st">"Market Equity"</span>) <span class="sc">+</span> <span class="co"># rangeでバブルの最小最大面積を指定</span></span>
<span id="cb34-12"><a href="#cb34-12"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">14</span>)) <span class="sc">+</span> <span class="co"># 両軸の範囲を指定</span></span>
<span id="cb34-13"><a href="#cb34-13"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">11</span>)) <span class="sc">+</span> mystyle</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/ch05_25-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="chapter05_files/figure-html/ch05_25-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
</section></section><section id="統計的推論入門" class="level1" data-number="9"><h1 data-number="9">
<span class="header-section-number">9</span> 統計的推論入門</h1>
<section id="リターンデータに関する仮定" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="リターンデータに関する仮定">
<span class="header-section-number">9.1</span> リターン・データに関する仮定</h2>
<p>統計的推論の内容に入る前に、<code>firm_ID</code>が1の企業の超過リターン<code>Re</code>のデータを眺めてみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>stock_data_1_month <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>  <span class="fu">filter</span>(firm_ID <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="fu">select</span>(month_ID, Re, R)</span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="fu">ggplot</span>(stock_data_1_month) <span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5"></a>  <span class="fu">aes</span>(<span class="at">x =</span> month_ID, <span class="at">y =</span> Re) <span class="sc">+</span> <span class="co"># 軸の設定</span></span>
<span id="cb35-6"><a href="#cb35-6"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> mystyle <span class="co"># 折れ線グラフ</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/ch05_27-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="chapter05_files/figure-html/ch05_27-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>このようなデータは時系列データと呼ばれ、ある個体(ここでは<code>firm_ID</code>が1の企業)の一定期間にわたって観測したデータのことを指します。</p>
<div class="callout callout-style-default callout-important callout-titled" title="仮定">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>仮定
</div>
</div>
<div class="callout-body-container callout-body">
<p>月次超過リターンの時系列データは、何らかの確率分布(モデル)から独立に生成されている。</p>
</div>
</div>
<ol type="1">
<li>株価そのものでは無く変化率であるリターンをモデル化する理由</li>
</ol>
<p>株価それ自体は株式分割などの要因でも変化するし、会社の成長に応じて上昇するため、その成長率をモデル化する方が、投資のリスクに対するリターンをより明確に評価することができるからである。</p>
<ol start="2" type="1">
<li>月次リターンではなく月次超過リターンをモデルかする理由</li>
</ol>
<p>投資リスクを取って得られる追加的なリターンであるリスクプレミアムを明確に評価するために、無リスク金利を差し引いた超過リターンをモデル化します。</p>
<ol start="3" type="1">
<li>月次超過リターンが独立であるとする理由</li>
</ol>
<p>半強度の効率的市場であれば、過去の情報はすでに株価に織り込まれているので、過去の超過リターンは将来の超過リターンと無関係である、とし、超過リターンに系列相関はない、と仮定します。 しかし、アノマリーの存在などにより、現実には系列相関があると考えられますが、モデルが複雑になるので、ここでは独立の仮定をおいて、モデルを単純化します。</p>
<ol start="4" type="1">
<li>月次超過リターンが正規分布に従うとする理由</li>
</ol>
<p>正規分布を仮定するといろいろ計算が楽になる、という理由とともに、 株価の動きは多くの独立した事象の結果であると考えられ、中心極限定理により、超過リターンは正規分布に従うと考えられます。</p>
<p>これらの仮定を受け入れると、超過リターンの確率分布は次式で表されます。</p>
<p><span class="math display">
Re_t \sim N(\mu, \sigma^2)
</span></p>
<p>これにより、母集団分布に対して統計的推論が可能になります。 <code>firm 1</code>の超過リターンのヒストグラムを書いてみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">ggplot</span>(stock_data_1_month) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> Re) <span class="sc">+</span> <span class="co"># データと変数</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="fu">geom_histogram</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/unnamed-chunk-5-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="chapter05_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>サンプルサイズが小さいため凸凹しているけれど、もっとサンプルを増やせば、正規分布に近い形をとるはずです。</p>
</section><section id="推定量と推定値の違い" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="推定量と推定値の違い">
<span class="header-section-number">9.2</span> 推定量と推定値の違い</h2>
<p>推定量(estimator)とは、母集団分布の母数(パラメータ)を推定するために使われる統計量のことです。 推定値(estimates)とは、推定量に実際のデータを代入して計算した値のことです。 たとえば母集団分布が正規分布<span class="math inline">N(\mu, \sigma^2)</span>に従うと仮定すると、母数は<span class="math inline">\mu</span>と<span class="math inline">\sigma^2</span>の2つです。この母数を推定するために使われる統計量が、それぞれ標本平均<span class="math inline">\bar x</span>と標本分散<span class="math inline">s^2</span>です。 このときの推定値とは、実際に観察された標本から計算された標本平均<span class="math inline">\bar x</span>と標本分散<span class="math inline">s^2</span>のことを指します。</p>
<p>次の問題を考えます。</p>
<div class="callout callout-style-default callout-important callout-titled" title="問題">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>問題
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>firm_ID</code>が1の銘柄の月次リターン<span class="math inline">R_{i,t}^e</span>は、期待値の意味で、ゼロより大きいのだろうか？</p>
</div>
</div>
<p>ここで「期待値の意味で」というのは平均的に、と言い換えても問題ないです。 企業1の月次超過リターンの平均は0より大きい、ということは、企業1の月次リターンは平均的に無リスク利子率よりも大きいかどうか、を比べるということです。</p>
<p>この問題を解くために、まずは母集団分布の母数である期待値<span class="math inline">\mu</span>を推定する必要があります。 期待値<span class="math inline">\mu</span>を推定するために使われる推定量は標本平均<span class="math inline">\bar x</span>なので、ここで標本平均を計算します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>stock_data_1_month <span class="sc">|&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="fu">summarise</span>(</span>
<span id="cb37-3"><a href="#cb37-3"></a>    <span class="at">mean_Re =</span> <span class="fu">mean</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-4"><a href="#cb37-4"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  mean_Re
    &lt;dbl&gt;
1  0.0291</code></pre>
</div>
</div>
<p>企業1の平均月次超過リターン<code>mean_Re</code>が<span class="math inline">0.0291</span>となりました。 これだけみるとゼロより大きい値ですが、これは母集団から抽出された1つのサンプルの平均ですので、他のサンプルの平均がゼロを超えるかどうかは分かりません。</p>
<section id="大数の法則" class="level3" data-number="9.2.1"><h3 data-number="9.2.1" class="anchored" data-anchor-id="大数の法則">
<span class="header-section-number">9.2.1</span> 大数の法則</h3>
<p>母集団から無限個の標本(sample)を抽出して、それぞれの標本平均(sample mean)を計算すると、その標本平均の平均は母集団の期待値<span class="math inline">\mu</span>に一致することが知られています。これを対数の法則(law of large number)といいます。</p>
<p>数式よりも前にシミュレーションで確認してみましょう。 まずは、母集団分布を平均が10、標準偏差が2の正規分布<span class="math inline">N(10, 4)</span>として、母集団から100のデータを抽出して標本を1つ作ります。そしてその標本の平均を計算します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># 乱数の種を固定</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>size <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># 標本サイズ</span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="co"># 母集団のパラメータの設定</span></span>
<span id="cb39-4"><a href="#cb39-4"></a>mu <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># 平均</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>sigma <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># 標準偏差</span></span>
<span id="cb39-6"><a href="#cb39-6"></a>population <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, mu, sigma) <span class="co"># 母集団からサンプルを抽出</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="fu">mean</span>(population) <span class="co"># 標本平均</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10.36162</code></pre>
</div>
</div>
<p>平均は10.3616236となりました。 母集団の平均10とは異なる数値になっています。 もう一度別の標本でやってみると、</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>population <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, mu, sigma) <span class="co"># 母集団からサンプルを抽出</span></span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="fu">mean</span>(population) <span class="co"># 標本平均</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9.569813</code></pre>
</div>
</div>
<p>また違う平均が計算されました。 この作業を何度も何度も繰り返し、標本平均をたくさん計算します。 ここでは、100個のデータをもつ標本を100個作って、それぞれの標本平均を計算します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>n_sample <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># サンプル数</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>sample_mean <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_sample) <span class="co"># 標本平均を格納するベクトル</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>sample_sd <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_sample) <span class="co"># 標本分散を格納するベクトル</span></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sample){</span>
<span id="cb43-5"><a href="#cb43-5"></a>  population <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, mu, sigma) <span class="co"># 母集団からサンプルを抽出</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>  sample_mean[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(population) <span class="co"># 標本平均を計算</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>  sample_sd[i] <span class="ot">&lt;-</span> <span class="fu">sd</span>(population)</span>
<span id="cb43-8"><a href="#cb43-8"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>サンプルの平均が100個計算できたので、ヒストグラムを書いてみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> sample_mean) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> mystyle</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/unnamed-chunk-10-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="chapter05_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>あまり正規分布のようには見えません。 ではサンプルの平均の平均を計算してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">mean</span>(sample_mean) <span class="co"># 標本平均の平均</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9.99003</code></pre>
</div>
</div>
<p>母集団の平均10に近い値になっていることが分かります。もっとサンプルの数を増やしてみます。 データの数が100のサンプルを1,000,000個(100万個)抽出して、それぞれのサンプルの平均値を計算します。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>n_sample <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">6</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="co"># 標本平均のシミュレーション</span></span>
<span id="cb47-3"><a href="#cb47-3"></a>sample_mean <span class="ot">&lt;-</span> <span class="fu">replicate</span>(n_sample, <span class="fu">mean</span>(<span class="fu">rnorm</span>(size, mu, sigma)))</span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="co"># 標本標準偏差のシミュレーション（必要な場合）</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>sample_sd <span class="ot">&lt;-</span> <span class="fu">replicate</span>(n_sample, <span class="fu">sd</span>(<span class="fu">rnorm</span>(size, mu, sigma)))</span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="co"># 作図</span></span>
<span id="cb47-7"><a href="#cb47-7"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> sample_mean) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> mystyle</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/unnamed-chunk-12-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="chapter05_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<p>ほぼ正規分布のような形をしていることが分かります。ではサンプルの平均の平均を計算してみます。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">mean</span>(sample_mean) <span class="co"># 標本平均の平均</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10.00063</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="fu">mean</span>(sample_sd) <span class="co"># 標本分散の平均</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.989758</code></pre>
</div>
</div>
<p>このように標本の数を無限に大きくしたとき、サンプルの平均の平均は母集団の平均10に一致するし，標本標準偏差は母集団の標準偏差4に一致する，というのが大数の法則です。</p>
</section></section><section id="t値の計算" class="level2" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="t値の計算">
<span class="header-section-number">9.3</span> <span class="math inline">t</span>値の計算</h2>
<p>先ほど計算した<code>firm_ID</code>が1の企業の超過リターンの平均値はNAでした。 これがゼロより大きいかどうかはすぐ分かりますが，この値はたまたま今手元にある1つのサンプルから計算された平均値なので，他の標本ではどうなるか分かりません。 このように推定量にばらつきがある場合には，その推定量の分布を考える必要があります。 ここでは，その分布を<strong>t分布</strong>(t distribution)と仮定して，<span class="math inline">t</span>値(t-value)を計算してみます。 <span class="math inline">t</span>値は次のように定義されます。</p>
<p><span class="math display">
t = \frac{\bar{X} - \mu_0}{\sqrt{s^2 / n} } \stackrel{d}{\approx} N(0,1)
</span></p>
<p>ここで，<span class="math inline">\bar X</span>は標本平均，<span class="math inline">\mu_0</span>は帰無仮説(null hypothesis)の値で，ここでは<span class="math inline">\mu_0 = 0</span>とします。<span class="math inline">s^2</span>は標本分散，<span class="math inline">n</span>は標本サイズです。 分子に注目すると，標本平均と帰無仮説の値の差となっており，もし標本平均が0に近いなら，<span class="math inline">t</span>値は0に近い値になります。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>Re_firm_ID_1 <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>  <span class="fu">filter</span>(firm_ID <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="co"># firm_IDが1の企業のデータを抽出</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>  <span class="fu">select</span>(Re) <span class="sc">|&gt;</span> <span class="co">#超過リターンのみ選択</span></span>
<span id="cb52-4"><a href="#cb52-4"></a>  <span class="fu">drop_na</span>() <span class="sc">|&gt;</span> <span class="co"># 欠損値を除去</span></span>
<span id="cb52-5"><a href="#cb52-5"></a>  <span class="fu">unlist</span>() <span class="co"># データフレームをベクトルに変換</span></span>
<span id="cb52-6"><a href="#cb52-6"></a></span>
<span id="cb52-7"><a href="#cb52-7"></a>mu0 <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># 帰無仮説の値</span></span>
<span id="cb52-8"><a href="#cb52-8"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(Re_firm_ID_1) <span class="co"># 標本サイズ</span></span>
<span id="cb52-9"><a href="#cb52-9"></a></span>
<span id="cb52-10"><a href="#cb52-10"></a>t_value <span class="ot">&lt;-</span> (<span class="fu">mean</span>(Re_firm_ID_1) <span class="sc">-</span> mu0) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(Re_firm_ID_1) <span class="sc">/</span> n) <span class="co"># $t$値の計算</span></span>
<span id="cb52-11"><a href="#cb52-11"></a><span class="fu">print</span>(t_value)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.121296</code></pre>
</div>
</div>
<section id="統計的検定の考え方" class="level3" data-number="9.3.1"><h3 data-number="9.3.1" class="anchored" data-anchor-id="統計的検定の考え方">
<span class="header-section-number">9.3.1</span> 統計的検定の考え方</h3>
<p>あなたがサイコロを投げるゲームをしていて、あるプレイヤーが非常に幸運だと主張しています。彼は6回サイコロを投げて、5回も「6」が出たとします。これはただの偶然なのか、それとも何か他の要因（例えば、サイコロがいかさまであるとか）が関与しているのでしょうか？</p>
<p>この問いに答えるために、我々は<strong>統計的検定</strong>(statistical test)を用いることができます。 まず<strong>帰無仮説</strong>(null hypothesis)を設定します。 この例では、帰無仮説は「サイコロは公正であり、すべての出目が等確率（<span class="math inline">1/6</span>）で出る」とすることが適切です。</p>
<p>次に、この帰無仮説が真(true)である場合に、我々が観察した結果（5回の「6」）がどれほどあり得ないかを計算します。これが<span class="math inline">p</span>値(p value)です。この場合、6回投げて5回「6」が出る確率を計算します。</p>
<p>これを計算すると、<span class="math inline">p</span>値は非常に小さいことが分かり（つまり、この結果は帰無仮説の下ではほぼあり得ない），帰無仮説が棄却されます。 帰無仮説が棄却されるとは，<strong>帰無仮説が正しいと仮定したときに，観測されたデータが得られる確率が小さいことを意味します</strong>。 したがって、我々はこの結果が偶然生じたとは考えにくく、その代わりにサイコロがいかさまである、または何か他の非ランダムな要因が作用している可能性を強く疑うことになります。これが<span class="math inline">p</span>値を用いて統計的検定の考え方です。</p>
<p><span class="math inline">p</span>値が<span class="math inline">0.05</span>より小さい場合，帰無仮説は棄却され，対立仮説が採択される，というケースが多いです。 この場合，有意水準5%で帰無仮説は棄却されます。 有意水準は，帰無仮説が正しいと仮定したときに，観測されたデータが得られる確率が小さいと判断する基準値です。 有意水準は，5%や1%がよく使われます。</p>
<p>Rでは，<code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code>関数を使って，<span class="math inline">t</span>値と<span class="math inline">p</span>値を計算することができます。 ここでは，<code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code>関数を使って，<code>firm_ID</code>が1の企業の超過リターンがゼロなのかどうなのか，を検定するために，<span class="math inline">t</span>値と<span class="math inline">p</span>値を計算してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="fu">t.test</span>(Re_firm_ID_1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    One Sample t-test

data:  Re_firm_ID_1
t = 2.1213, df = 70, p-value = 0.03744
alternative hypothesis: true mean is not equal to 0
95 percent confidence interval:
 0.001737894 0.056383256
sample estimates:
 mean of x 
0.02906058 </code></pre>
</div>
</div>
</section></section></section><section id="線形回帰入門" class="level1" data-number="10"><h1 data-number="10">
<span class="header-section-number">10</span> 線形回帰入門</h1>
<p>年次財務データ<code>annual_data</code>を使って線形回帰(linear regression)について学習します。 線形(linear)とは，<span class="math inline">X</span>と<span class="math inline">\beta</span>の積が線形であることを意味します。回帰(regression)とは，<span class="math inline">X</span>と<span class="math inline">\beta</span>の積が<span class="math inline">Y</span>を説明することを意味します。 回帰は，2変数間の間で、一方の変数が他方の変数に対して影響を与えるという関係を想定できる場合に用いられます。 しかし因果関係を直接調べているのではないことに注意しましょう。</p>
<p>影響を与える変数を説明変数(explanatory variable)や独立変数(independent variable)といい、 影響を与えられる変数を目的変数(response variable)や従属変数(dependent variable)といいます。 分野などでどっちを使うのかは異なりますが、ここでは説明変数と目的変数を使います。</p>
<p>線形関係を仮定した関係を式にすると，次のようになります。 <span class="math display">
Y = \alpha + \beta X
</span> ここで， <span class="math inline">\alpha</span>は定数項(constant term)と呼ばれ，切片(intercept)とも呼ばれます。 <span class="math inline">\beta</span>は回帰係数(regression coefficient)と呼ばれ，傾き(slope)とも呼ばれます。</p>
<p>実際のデータが上のモデルを満たす、つまりすべてのデータが直線上に並んでいるわけではないのです。 実際のデータとモデルとの間には<strong>ずれ</strong>があることを考慮して、上のモデルを次のように書き換えます。</p>
<p><span class="math display">
Y = \alpha + \beta X + u
</span> ここで<span class="math inline">u</span>は誤差項(error term)とか観察不可能項(unobservable term)と呼ばれます。</p>
<p>線形回帰の目的は，<span class="math inline">X</span>と<span class="math inline">Y</span>の関係を表す<span class="math inline">\alpha</span>と<span class="math inline">\beta</span>を推定することです。 推定するために，観測できるデータを使います。 観測できるデータは<span class="math inline">X</span>と<span class="math inline">Y</span>のペアで<span class="math inline">(X_i, Y_i)</span>と表記します。 このペアを<strong>観測値</strong>(observed value)と呼びます。 この観測値は，<span class="math inline">X</span>と<span class="math inline">Y</span>の関係を表す<span class="math inline">\alpha</span>と<span class="math inline">\beta</span>を推定するために使われます。 推定するために使われる<span class="math inline">\alpha</span>と<span class="math inline">\beta</span>を<strong>推定値</strong>(estimated value)と呼びます。 推定値は，<span class="math inline">\hat{\alpha}</span>と<span class="math inline">\hat{\beta}</span>と表記して，観察値と区別します。</p>
<section id="ols推定" class="level2" data-number="10.1"><h2 data-number="10.1" class="anchored" data-anchor-id="ols推定">
<span class="header-section-number">10.1</span> OLS推定</h2>
<p>推定方法として最も有名なものが<strong>最小二乗法</strong>(ordinary least squares; OLS)です。 最小二乗法では，観測値と推定値の差の二乗の和が最小になるように<span class="math inline">\alpha</span>と<span class="math inline">\beta</span>を推定します。 このとき，観測値と推定値の差を<strong>残差</strong>(residual)と呼びます。 最小二乗法では，残差の二乗の和である<strong>残差平方和</strong>(sum of squared residuals; SSR)が最小になるように<span class="math inline">\alpha</span>と<span class="math inline">\beta</span>を推定します。</p>
<p><span class="math display">
\min _{\alpha, \beta} \sum _{i=1}^n (Y_i - \alpha - \beta X_i)^2
</span></p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="co"># 線形回帰分析のための事前準備</span></span>
<span id="cb56-2"><a href="#cb56-2"></a><span class="co"># ch05_24ですでにME（時価総額）が結合されていることが前提</span></span>
<span id="cb56-3"><a href="#cb56-3"></a></span>
<span id="cb56-4"><a href="#cb56-4"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">|&gt;</span></span>
<span id="cb56-5"><a href="#cb56-5"></a>  <span class="fu">arrange</span>(firm_ID, year) <span class="sc">|&gt;</span> <span class="co"># 時系列順に並べ替え（lag計算に必須）</span></span>
<span id="cb56-6"><a href="#cb56-6"></a>  <span class="fu">group_by</span>(firm_ID) <span class="sc">|&gt;</span></span>
<span id="cb56-7"><a href="#cb56-7"></a>  <span class="fu">mutate</span>(</span>
<span id="cb56-8"><a href="#cb56-8"></a>    <span class="at">lag_ME =</span> <span class="fu">lag</span>(ME),</span>
<span id="cb56-9"><a href="#cb56-9"></a>    <span class="at">lagged_BEME =</span> lagged_BE <span class="sc">/</span> lag_ME <span class="co"># ここでBEMEを計算</span></span>
<span id="cb56-10"><a href="#cb56-10"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb56-11"><a href="#cb56-11"></a>  <span class="fu">ungroup</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>lm_sample_data <span class="ot">&lt;-</span> annual_data <span class="sc">|&gt;</span></span>
<span id="cb57-2"><a href="#cb57-2"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2016</span>, firm_ID <span class="sc">&lt;=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3"></a>  <span class="co"># lagged_BEMEは計算済みなので、selectで選ぶだけにする</span></span>
<span id="cb57-4"><a href="#cb57-4"></a>  <span class="fu">select</span>(firm_ID, year, <span class="at">Re =</span> annual_Re, lagged_BEME) <span class="sc">|&gt;</span></span>
<span id="cb57-5"><a href="#cb57-5"></a>  <span class="fu">drop_na</span>() <span class="co"># 欠損値を除去</span></span>
<span id="cb57-6"><a href="#cb57-6"></a></span>
<span id="cb57-7"><a href="#cb57-7"></a><span class="fu">ggplot</span>(lm_sample_data) <span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lagged_BEME, <span class="at">y =</span> Re)) <span class="sc">+</span> <span class="co"># 散布図</span></span>
<span id="cb57-9"><a href="#cb57-9"></a>  <span class="fu">xlab</span>(<span class="st">"簿価時価比率"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"超過リターン"</span>) <span class="sc">+</span> mystyle</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/ch05_31-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="chapter05_files/figure-html/ch05_31-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="co"># ch05_32: 簿価時価比率と株式リターンの散布図に回帰直線を追加</span></span>
<span id="cb58-2"><a href="#cb58-2"></a></span>
<span id="cb58-3"><a href="#cb58-3"></a><span class="fu">ggplot</span>(lm_sample_data) <span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lagged_BEME, <span class="at">y =</span> Re)) <span class="sc">+</span></span>
<span id="cb58-5"><a href="#cb58-5"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x =</span> lagged_BEME, <span class="at">y =</span> Re), <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="co"># 回帰直線を追加するにはgeom_smooth()関数を用いる</span></span>
<span id="cb58-6"><a href="#cb58-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME at the End of Year t"</span>, <span class="at">y =</span> <span class="st">"Excess Return for Year t + 1"</span>) <span class="sc">+</span></span>
<span id="cb58-7"><a href="#cb58-7"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="chapter05_files/figure-html/ch05_32-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="chapter05_files/figure-html/ch05_32-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="3150"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a><span class="co"># ch05_33: lm()関数を用いた線形回帰</span></span>
<span id="cb59-2"><a href="#cb59-2"></a></span>
<span id="cb59-3"><a href="#cb59-3"></a>lm_results <span class="ot">&lt;-</span> <span class="fu">lm</span>(Re <span class="sc">~</span> lagged_BEME, <span class="at">data =</span> lm_sample_data) <span class="co"># 従属変数 ~ 独立変数</span></span>
<span id="cb59-4"><a href="#cb59-4"></a><span class="fu">names</span>(lm_results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "coefficients"  "residuals"     "effects"       "rank"         
 [5] "fitted.values" "assign"        "qr"            "df.residual"  
 [9] "xlevels"       "call"          "terms"         "model"        </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="fu">print</span>(lm_results<span class="sc">$</span>coefficients)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) lagged_BEME 
 0.05513385  0.07552921 </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a><span class="co"># ch05_35: broomパッケージのtidy()関数で係数の推定値に関する結果を確認</span></span>
<span id="cb63-2"><a href="#cb63-2"></a><span class="fu">tidy</span>(lm_results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term        estimate std.error statistic p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
1 (Intercept)   0.0551    0.156      0.354   0.736
2 lagged_BEME   0.0755    0.0844     0.895   0.405</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a><span class="fu">glance</span>(lm_results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic p.value    df logLik   AIC   BIC
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0.118       -0.0294 0.223     0.800   0.405     1   1.81  2.37  2.61
# ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
</div>
</section><section id="対数回帰モデル" class="level2" data-number="10.2"><h2 data-number="10.2" class="anchored" data-anchor-id="対数回帰モデル">
<span class="header-section-number">10.2</span> 対数回帰モデル</h2>
<p>独立変数<span class="math inline">X</span>が変化したときの従属変数<span class="math inline">Y</span>への影響は一定(つまり傾きが一定)と仮定してきましたが、 実際には傾きが一定でない場合もあります。 回帰式が非線形であることが想定される場合、対処法として</p>
<ul>
<li>多項式回帰(polynomial regression) ：独立変数に<span class="math inline">X^2</span>とか<span class="math inline">X^3</span>を加える</li>
<li>
<strong>対数回帰</strong>(logarithmic regression) ：独立変数や従属変数の対数をとる</li>
</ul>
<p>たとえば、独立変数を対数変換した場合は、次のようなモデルになる。</p>
<p><span class="math display">
Y_i = \beta_0 + \beta_1 \log (X_i) + \varepsilon_i
</span></p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>線形・対数モデルによる推定</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="fu">tidy</span>(<span class="fu">lm</span>(Re <span class="sc">~</span> <span class="fu">log</span>(lagged_BEME), <span class="at">data =</span> lm_sample_data)) <span class="co"># 右辺のみlog()関数で自然対数を取る</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term             estimate std.error statistic p.value
  &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
1 (Intercept)        0.167     0.0868     1.93    0.102
2 log(lagged_BEME)   0.0355    0.109      0.326   0.756</code></pre>
</div>
</div>
<p>作成したデータフレームをcsvファイルとして保存するには，<code>write_csv()</code>関数を用います。 前処理が終わった後や新しい変数を作った後に、データを保存しておくと便利です。 6章以降では、以下のデータを継続して使うので、csvファイルとして保存しておきます。</p>
<div class="cell" data-layout-align="center">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>データの保存</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a><span class="fu">write_csv</span>(monthly_data, <span class="st">"data/ch05_output1.csv"</span>)</span>
<span id="cb69-2"><a href="#cb69-2"></a><span class="fu">write_csv</span>(annual_data, <span class="st">"data/ch05_output2.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>


<!-- -->

</section></section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./chapter04.html" class="pagination-link" aria-label="財務データの取得と可視化">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">財務データの取得と可視化</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter06.html" class="pagination-link" aria-label="ファクターモデルの導入">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">ファクターモデルの導入</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb70-1"><a href="#cb70-1"></a><span class="fu">## 株式データの取得と可視化</span></span>
<span id="cb70-2"><a href="#cb70-2"></a></span>
<span id="cb70-3"><a href="#cb70-3"></a></span>
<span id="cb70-4"><a href="#cb70-4"></a><span class="in">```{r setup, filename="パッケージの読み込みとテーマ"}</span></span>
<span id="cb70-5"><a href="#cb70-5"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb70-6"><a href="#cb70-6"></a>  tidyverse,</span>
<span id="cb70-7"><a href="#cb70-7"></a>  ggthemes,</span>
<span id="cb70-8"><a href="#cb70-8"></a>  ggpubr,</span>
<span id="cb70-9"><a href="#cb70-9"></a>  plotly,</span>
<span id="cb70-10"><a href="#cb70-10"></a>  patchwork,</span>
<span id="cb70-11"><a href="#cb70-11"></a>  Rsolnp,</span>
<span id="cb70-12"><a href="#cb70-12"></a>  e1071,</span>
<span id="cb70-13"><a href="#cb70-13"></a>  broom</span>
<span id="cb70-14"><a href="#cb70-14"></a>)</span>
<span id="cb70-15"><a href="#cb70-15"></a></span>
<span id="cb70-16"><a href="#cb70-16"></a>mystyle <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb70-17"><a href="#cb70-17"></a>  <span class="fu">theme_economist_white</span>(</span>
<span id="cb70-18"><a href="#cb70-18"></a>    <span class="at">base_family =</span> <span class="st">"HiraKakuProN-W3"</span></span>
<span id="cb70-19"><a href="#cb70-19"></a>    ),</span>
<span id="cb70-20"><a href="#cb70-20"></a>  <span class="fu">scale_colour_economist</span>(),</span>
<span id="cb70-21"><a href="#cb70-21"></a>  <span class="fu">theme</span>(</span>
<span id="cb70-22"><a href="#cb70-22"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb70-23"><a href="#cb70-23"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb70-24"><a href="#cb70-24"></a>  )</span>
<span id="cb70-25"><a href="#cb70-25"></a>)</span>
<span id="cb70-26"><a href="#cb70-26"></a><span class="in">```</span></span>
<span id="cb70-27"><a href="#cb70-27"></a></span>
<span id="cb70-28"><a href="#cb70-28"></a><span class="fu">## 株式データの取得と可視化</span></span>
<span id="cb70-29"><a href="#cb70-29"></a></span>
<span id="cb70-30"><a href="#cb70-30"></a>前章では財務データを題材に、クロスセクションデータを扱うために必要なデータの取得と操作と可視化について学習しました。</span>
<span id="cb70-31"><a href="#cb70-31"></a>特に重要な操作として，<span class="in">`group_by()`</span>関数と<span class="in">`mutate()`</span>や<span class="in">`summarise()`</span>関数の組み合わせて，グループごとの変数の値を計算する方法を学びました。</span>
<span id="cb70-32"><a href="#cb70-32"></a>本章では株式データを題材に，株式データの理解に必要な株式の基礎知識とともに，リターンの定義や計算について学び，最後には統計的推論と線形回帰分析についても学習します。</span>
<span id="cb70-33"><a href="#cb70-33"></a></span>
<span id="cb70-34"><a href="#cb70-34"></a><span class="co">&lt;!-- 株式データの理解を深めるために，株式市場の仕組みを理解する必要があるので，重要用語の説明を行います。</span></span>
<span id="cb70-35"><a href="#cb70-35"></a></span>
<span id="cb70-36"><a href="#cb70-36"></a><span class="co">| 相場用語 | 解説 |</span></span>
<span id="cb70-37"><a href="#cb70-37"></a><span class="co">|:-- |:-------- |</span></span>
<span id="cb70-38"><a href="#cb70-38"></a><span class="co">| 成行注文 | 値段を指定せず，その時点の最良気配値で取引を希望すること |</span></span>
<span id="cb70-39"><a href="#cb70-39"></a><span class="co">| 指値注文 | 特定の値段を指定して取引を希望すること |</span></span>
<span id="cb70-40"><a href="#cb70-40"></a><span class="co">| 板 | その時点で有効な指値注文を売りと買いで分けて価格ごとにまとめた一覧表のこと |</span></span>
<span id="cb70-41"><a href="#cb70-41"></a><span class="co">| 板寄せ方式 | 取引開始時に板情報(それまでに提出された売りと買いの注文)に 基づいて取引価格を決定する方法のこと |</span></span>
<span id="cb70-42"><a href="#cb70-42"></a><span class="co">| ザラ場寄せ方式 | 取引時間(ザラ場)中に新規注文と板情報に基づいて取引価格を決 定する方法のこと(図 5.1 を参照) |</span></span>
<span id="cb70-43"><a href="#cb70-43"></a><span class="co">| 歩み値 | 取引時間中の売買履歴(約定価格や出来高)に関する時系列データのこと |</span></span>
<span id="cb70-44"><a href="#cb70-44"></a><span class="co">| 証拠金 | 信用取引を行う際に資金の貸し手に差し入れる担保のこと |</span></span>
<span id="cb70-45"><a href="#cb70-45"></a><span class="co">| 値洗い | 保有するポートフォリオ(ポジション)の価値を時価で再評価すること |</span></span>
<span id="cb70-46"><a href="#cb70-46"></a><span class="co">| 追証 | 値洗いの結果，追加の証拠金を求められること |</span></span>
<span id="cb70-47"><a href="#cb70-47"></a><span class="co">| 逆日歩 | 信用売りが殺到し株不足となった銘柄でショート・セラーが追加で 支払う費用のこと |</span></span>
<span id="cb70-48"><a href="#cb70-48"></a><span class="co">| 踏み上げ | 株価上昇で損失を抱えたショート・セラー(2.2.3 節を参照)のロス カットが一段の株高を招くこと | --&gt;</span></span>
<span id="cb70-49"><a href="#cb70-49"></a></span>
<span id="cb70-50"><a href="#cb70-50"></a></span>
<span id="cb70-51"><a href="#cb70-51"></a><span class="fu">### 株価データのダウンロードと読み込み</span></span>
<span id="cb70-52"><a href="#cb70-52"></a></span>
<span id="cb70-53"><a href="#cb70-53"></a>いままでと同じように、<span class="in">`readr`</span>パッケージの<span class="in">`read_csv()`</span>関数でCSVファイルを読み込みます。</span>
<span id="cb70-54"><a href="#cb70-54"></a>ここでは、<span class="in">`ch05_stock_data.csv`</span>を使います。</span>
<span id="cb70-55"><a href="#cb70-55"></a><span class="in">```{r ch05_01, filename="株式データの読み込み"}</span></span>
<span id="cb70-56"><a href="#cb70-56"></a>stock_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ch05_stock_data.csv"</span>)</span>
<span id="cb70-57"><a href="#cb70-57"></a><span class="fu">print</span>(stock_data)</span>
<span id="cb70-58"><a href="#cb70-58"></a><span class="in">```</span></span>
<span id="cb70-59"><a href="#cb70-59"></a>9変数，95,040行という大規模なデータが読み込まれました。</span>
<span id="cb70-60"><a href="#cb70-60"></a>紙面の都合上、長い変数名を短く省略します。変数名を変えるには、<span class="in">`dplyr::rename()`</span>を使います。</span>
<span id="cb70-61"><a href="#cb70-61"></a><span class="in">```{r rename, filename="変数名の変更"}</span></span>
<span id="cb70-62"><a href="#cb70-62"></a>stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-63"><a href="#cb70-63"></a>  <span class="fu">rename</span>(</span>
<span id="cb70-64"><a href="#cb70-64"></a>    <span class="at">n_shares =</span> shares_outstanding, </span>
<span id="cb70-65"><a href="#cb70-65"></a>    <span class="at">adj_coef =</span> adjustment_coefficient</span>
<span id="cb70-66"><a href="#cb70-66"></a>  )</span>
<span id="cb70-67"><a href="#cb70-67"></a><span class="in">```</span></span>
<span id="cb70-68"><a href="#cb70-68"></a></span>
<span id="cb70-69"><a href="#cb70-69"></a>読み込まれたデータ<span class="in">`stock_data`</span>の中には以下の変数が含まれています。</span>
<span id="cb70-70"><a href="#cb70-70"></a></span>
<span id="cb70-71"><a href="#cb70-71"></a><span class="pp">|</span>     列名       <span class="pp">|</span>  データ型    <span class="pp">|</span>           説明        <span class="pp">|</span></span>
<span id="cb70-72"><a href="#cb70-72"></a><span class="pp">| :------------</span> <span class="pp">| :---------</span> <span class="pp">| :--------------------</span> <span class="pp">|</span></span>
<span id="cb70-73"><a href="#cb70-73"></a><span class="pp">|</span> <span class="in">`year`</span>        <span class="pp">|</span> 数値型<span class="in">`dbl`</span> <span class="pp">|</span> 年度                   <span class="pp">|</span></span>
<span id="cb70-74"><a href="#cb70-74"></a><span class="pp">|</span> <span class="in">`month`</span>       <span class="pp">|</span> 数値型<span class="in">`dbl`</span> <span class="pp">|</span> 月                     <span class="pp">|</span></span>
<span id="cb70-75"><a href="#cb70-75"></a><span class="pp">|</span> <span class="in">`month_ID`</span>    <span class="pp">|</span> 数値型<span class="in">`dbl`</span> <span class="pp">|</span> 月ID                   <span class="pp">|</span></span>
<span id="cb70-76"><a href="#cb70-76"></a><span class="pp">|</span> <span class="in">`firm_ID`</span>     <span class="pp">|</span> 数値型<span class="in">`dbl`</span> <span class="pp">|</span> 企業ID                 <span class="pp">|</span></span>
<span id="cb70-77"><a href="#cb70-77"></a><span class="pp">|</span> <span class="in">`stock_price`</span> <span class="pp">|</span> 数値型<span class="in">`dbl`</span> <span class="pp">|</span> 月末時点での終値         <span class="pp">|</span></span>
<span id="cb70-78"><a href="#cb70-78"></a><span class="pp">|</span> <span class="in">`DPS`</span>         <span class="pp">|</span> 数値型<span class="in">`dbl`</span> <span class="pp">|</span> 一株当たり配当額         <span class="pp">|</span></span>
<span id="cb70-79"><a href="#cb70-79"></a><span class="pp">|</span> <span class="in">`n_shares`</span>    <span class="pp">|</span> 数値型<span class="in">`int`</span> <span class="pp">|</span> 月末時点での発行済株式数  <span class="pp">|</span></span>
<span id="cb70-80"><a href="#cb70-80"></a><span class="pp">|</span> <span class="in">`adj_coef`</span>    <span class="pp">|</span> 数値型<span class="in">`int`</span> <span class="pp">|</span> 調整係数               <span class="pp">|</span></span>
<span id="cb70-81"><a href="#cb70-81"></a><span class="pp">|</span> <span class="in">`R_F`</span>         <span class="pp">|</span> 数値型<span class="in">`dbl`</span> <span class="pp">|</span> 月次無リスク金利         <span class="pp">|</span></span>
<span id="cb70-82"><a href="#cb70-82"></a></span>
<span id="cb70-83"><a href="#cb70-83"></a><span class="in">`year`</span>〜<span class="in">`firm_ID`</span>までは，時系列や企業の特定に必要なキーとなり，</span>
<span id="cb70-84"><a href="#cb70-84"></a><span class="in">`stock_price`</span>から<span class="in">`R_F`</span>が分析する対象となる株価や配当，発行済株式数，調整係数，無リスク金利となります。</span>
<span id="cb70-85"><a href="#cb70-85"></a>7列目の<span class="in">`n_shares`</span>は発行済株式数です。</span>
<span id="cb70-86"><a href="#cb70-86"></a>発行済株式数は随時，新株発行や自社株買い，株式分割で変動するため，株式数の変化を調整するためのデータとして<span class="in">`adj_coef`</span>があります。</span>
<span id="cb70-87"><a href="#cb70-87"></a>旧株式1に対して新株式2となる株式分割が行われた場合，この調整係数は2となります。</span>
<span id="cb70-88"><a href="#cb70-88"></a></span>
<span id="cb70-89"><a href="#cb70-89"></a>このような大規模データを前にした場合，とりあえずデータの構造を把握することから始めます。</span>
<span id="cb70-90"><a href="#cb70-90"></a>ここでは基本関数よりも多機能な<span class="in">`tidyverse`</span>の<span class="in">`dplyr`</span>パッケージに含まれる<span class="in">`glimpse`</span>関数を使って，データの構造を確認してみます。</span>
<span id="cb70-91"><a href="#cb70-91"></a></span>
<span id="cb70-94"><a href="#cb70-94"></a><span class="in">```{r}</span></span>
<span id="cb70-95"><a href="#cb70-95"></a><span class="fu">glimpse</span>(stock_data)</span>
<span id="cb70-96"><a href="#cb70-96"></a><span class="in">```</span></span>
<span id="cb70-97"><a href="#cb70-97"></a></span>
<span id="cb70-98"><a href="#cb70-98"></a>データの型が<span class="in">`dbl`</span>という初めて出てきた型になってますが，これは<span class="in">`double`</span>の略で，数値型の一種です。<span class="in">`double`</span>は64ビットの浮動小数点数を表し，小数点以下15桁までの精度を持ちます。</span>
<span id="cb70-99"><a href="#cb70-99"></a></span>
<span id="cb70-100"><a href="#cb70-100"></a>::: {.callout-tip}</span>
<span id="cb70-101"><a href="#cb70-101"></a><span class="fu">## 数値型の種類</span></span>
<span id="cb70-102"><a href="#cb70-102"></a></span>
<span id="cb70-103"><a href="#cb70-103"></a>数値型<span class="in">`numeric`</span>は，<span class="in">`double`</span>と<span class="in">`int`</span>のどちらかになります。</span>
<span id="cb70-104"><a href="#cb70-104"></a><span class="in">`int`</span>は整数(integer)型で，32ビットの整数を表し，小数点以下は切り捨てられます。</span>
<span id="cb70-105"><a href="#cb70-105"></a><span class="in">`dbl`</span>は<span class="in">`int`</span>の上位互換で，小数点以下の桁数が多い場合に使われます。</span>
<span id="cb70-106"><a href="#cb70-106"></a>:::</span>
<span id="cb70-107"><a href="#cb70-107"></a></span>
<span id="cb70-108"><a href="#cb70-108"></a>たとえば，<span class="in">`firm_ID`</span>が74，<span class="in">`month_ID`</span>が29から32（つまり2017年5月から8月）のデータを抽出してみます。</span>
<span id="cb70-109"><a href="#cb70-109"></a></span>
<span id="cb70-110"><a href="#cb70-110"></a><span class="in">```{r ch05_04}</span></span>
<span id="cb70-111"><a href="#cb70-111"></a>stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-112"><a href="#cb70-112"></a>  <span class="fu">filter</span>(firm_ID <span class="sc">==</span> <span class="dv">74</span> , month_ID <span class="sc">%in%</span> <span class="dv">29</span><span class="sc">:</span><span class="dv">32</span>) <span class="sc">|&gt;</span> <span class="co"># filterで条件を指定</span></span>
<span id="cb70-113"><a href="#cb70-113"></a>  <span class="fu">select</span>(year, firm_ID, month, month_ID,stock_price, DPS, n_shares, adj_coef) <span class="co"># selectで必要な変数を指定</span></span>
<span id="cb70-114"><a href="#cb70-114"></a><span class="in">```</span></span>
<span id="cb70-115"><a href="#cb70-115"></a></span>
<span id="cb70-116"><a href="#cb70-116"></a>出力された結果の2行の<span class="in">`adj_coef`</span>が2となっており、同時に<span class="in">`n_shares`</span>が倍になっていることから、この会社は1株を2株に株式分割していることがわかります。</span>
<span id="cb70-117"><a href="#cb70-117"></a></span>
<span id="cb70-118"><a href="#cb70-118"></a><span class="fu">## 時価総額とリターンの計算</span></span>
<span id="cb70-119"><a href="#cb70-119"></a></span>
<span id="cb70-120"><a href="#cb70-120"></a>時価総額(market capitalization)を計算するためには、株式数に株価を掛けて計算します。</span>
<span id="cb70-121"><a href="#cb70-121"></a>新しい変数を作成するときは<span class="in">`dplyr`</span>パッケージの<span class="in">`mutate()`</span>関数を使います。</span>
<span id="cb70-122"><a href="#cb70-122"></a><span class="in">`mutate()`</span>で時価総額を表す新しい変数<span class="in">`ME`</span>を作成します。</span>
<span id="cb70-123"><a href="#cb70-123"></a></span>
<span id="cb70-124"><a href="#cb70-124"></a><span class="in">```{r ch05_05}</span></span>
<span id="cb70-125"><a href="#cb70-125"></a>stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-126"><a href="#cb70-126"></a>  <span class="fu">mutate</span>(<span class="at">ME =</span> stock_price <span class="sc">*</span> n_shares) <span class="co"># 時価総額</span></span>
<span id="cb70-127"><a href="#cb70-127"></a><span class="in">```</span></span>
<span id="cb70-128"><a href="#cb70-128"></a></span>
<span id="cb70-129"><a href="#cb70-129"></a>次に時価総額のヒストグラムを作成してみます。</span>
<span id="cb70-130"><a href="#cb70-130"></a>前節で学習した内容に加えて、いろいろ見た目の指定を増やしてみます。</span>
<span id="cb70-131"><a href="#cb70-131"></a></span>
<span id="cb70-132"><a href="#cb70-132"></a><span class="in">```{r ch05_06}</span></span>
<span id="cb70-133"><a href="#cb70-133"></a><span class="co"># 日本語を含むグラフを作成するときは，dev = "quartz_pdf"を指定する</span></span>
<span id="cb70-134"><a href="#cb70-134"></a></span>
<span id="cb70-135"><a href="#cb70-135"></a><span class="fu">library</span>(scales) <span class="co"># 軸の表記を変えるパッケージを追加</span></span>
<span id="cb70-136"><a href="#cb70-136"></a></span>
<span id="cb70-137"><a href="#cb70-137"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(stock_data) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> ME)</span>
<span id="cb70-138"><a href="#cb70-138"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="co">#基本設定</span></span>
<span id="cb70-139"><a href="#cb70-139"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Market Equity"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="co">#軸ラベル</span></span>
<span id="cb70-140"><a href="#cb70-140"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(</span>
<span id="cb70-141"><a href="#cb70-141"></a>  <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">quantile</span>(stock_data<span class="sc">$</span>ME, <span class="fl">0.95</span>)), <span class="co"># x軸の範囲</span></span>
<span id="cb70-142"><a href="#cb70-142"></a>  <span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">scale =</span> <span class="fl">1e-6</span>) <span class="co"># x軸の表記を百万円単位に</span></span>
<span id="cb70-143"><a href="#cb70-143"></a>  ) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"時価総額"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"度数"</span>) <span class="sc">+</span>  mystyle</span>
<span id="cb70-144"><a href="#cb70-144"></a><span class="fu">print</span>(g) <span class="co"># グラフを出力</span></span>
<span id="cb70-145"><a href="#cb70-145"></a><span class="in">```</span></span>
<span id="cb70-146"><a href="#cb70-146"></a></span>
<span id="cb70-147"><a href="#cb70-147"></a><span class="fu">### トータル・リターンと超過リターンの計算</span></span>
<span id="cb70-148"><a href="#cb70-148"></a></span>
<span id="cb70-149"><a href="#cb70-149"></a>ある株式の$t$期のトータル・リターン$R_t$は、次式で定義されます。</span>
<span id="cb70-150"><a href="#cb70-150"></a></span>
<span id="cb70-151"><a href="#cb70-151"></a>$$</span>
<span id="cb70-152"><a href="#cb70-152"></a>R_t = \frac{(\text{株価}_t + \text{1株当り配当}_t) \times \text{調整係数}_t - \text{株価}_{t-1}}{\text{株価}_{t-1}}</span>
<span id="cb70-153"><a href="#cb70-153"></a>$$</span>
<span id="cb70-154"><a href="#cb70-154"></a></span>
<span id="cb70-155"><a href="#cb70-155"></a>たいていの場合，1株当り配当$DPS_t$はゼロで，調整係数$adjustment<span class="sc">\_</span>coefficient_t$は1となるため，次式のように簡略化できます。</span>
<span id="cb70-156"><a href="#cb70-156"></a></span>
<span id="cb70-157"><a href="#cb70-157"></a>$$</span>
<span id="cb70-158"><a href="#cb70-158"></a>R_t = \frac{\text{株価}_t - \text{株価}_{t-1}}{\text{株価}_{t-1}}</span>
<span id="cb70-159"><a href="#cb70-159"></a>$$</span>
<span id="cb70-160"><a href="#cb70-160"></a></span>
<span id="cb70-161"><a href="#cb70-161"></a>銘柄ごとにリターンを計算するので，<span class="in">`group_by()`</span>と<span class="in">`mutate()`</span>を使って計算します。ここでは，<span class="in">`firm_ID`</span>ごとにトータルリターン<span class="in">`R`</span>と，</span>
<span id="cb70-162"><a href="#cb70-162"></a>トータルリターンから無リスク利子率を除いた超過リターン<span class="in">`Re`</span>を計算しています。</span>
<span id="cb70-163"><a href="#cb70-163"></a></span>
<span id="cb70-164"><a href="#cb70-164"></a><span class="in">```{r ch05_07}</span></span>
<span id="cb70-165"><a href="#cb70-165"></a>stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-166"><a href="#cb70-166"></a>  <span class="fu">group_by</span>(firm_ID) <span class="sc">|&gt;</span> <span class="co"># 企業ごとに</span></span>
<span id="cb70-167"><a href="#cb70-167"></a>  <span class="fu">mutate</span>( <span class="co"># 新しい変数を作成</span></span>
<span id="cb70-168"><a href="#cb70-168"></a>    <span class="co"># トータルリターン</span></span>
<span id="cb70-169"><a href="#cb70-169"></a>    <span class="at">R =</span> ( (stock_price <span class="sc">+</span> DPS) <span class="sc">*</span> adj_coef <span class="sc">-</span> <span class="fu">lag</span>(stock_price)) <span class="sc">/</span> <span class="fu">lag</span>(stock_price),</span>
<span id="cb70-170"><a href="#cb70-170"></a>    <span class="at">Re =</span> R <span class="sc">-</span> R_F <span class="co"># 月次超過リターン</span></span>
<span id="cb70-171"><a href="#cb70-171"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb70-172"><a href="#cb70-172"></a>  <span class="fu">ungroup</span>() <span class="co"># グループ化を解除</span></span>
<span id="cb70-173"><a href="#cb70-173"></a><span class="in">```</span></span>
<span id="cb70-174"><a href="#cb70-174"></a></span>
<span id="cb70-175"><a href="#cb70-175"></a>ここまでの処理で<span class="in">`stock_data`</span>に時価総額<span class="in">`ME`</span>，トータルリターン<span class="in">`R`</span>，超過リターン<span class="in">`Re`</span>が追加されました。</span>
<span id="cb70-176"><a href="#cb70-176"></a>以下では，このデータを使って探索的データ分析を行います。</span>
<span id="cb70-177"><a href="#cb70-177"></a></span>
<span id="cb70-178"><a href="#cb70-178"></a><span class="fu">### 株式データの探索的データ分析</span></span>
<span id="cb70-179"><a href="#cb70-179"></a></span>
<span id="cb70-180"><a href="#cb70-180"></a>探索的データ分析という名の，とりあえず何も考えずに目の前のデータから何が分かるのかを調べ倒してみる，という分析を行います。</span>
<span id="cb70-181"><a href="#cb70-181"></a></span>
<span id="cb70-182"><a href="#cb70-182"></a>とりあえず，<span class="in">`summary()`</span>で基本統計量を確認します。</span>
<span id="cb70-183"><a href="#cb70-183"></a></span>
<span id="cb70-184"><a href="#cb70-184"></a><span class="in">```{r ch05_10}</span></span>
<span id="cb70-185"><a href="#cb70-185"></a><span class="fu">summary</span>(stock_data)</span>
<span id="cb70-186"><a href="#cb70-186"></a><span class="in">```</span></span>
<span id="cb70-187"><a href="#cb70-187"></a></span>
<span id="cb70-188"><a href="#cb70-188"></a>さらに，分散と標準偏差も計算します。データには欠損値が含まれているため，<span class="in">`na.rm = TRUE`</span>オプションをつけています。</span>
<span id="cb70-189"><a href="#cb70-189"></a>教科書とは違いますが，<span class="in">`dplyr::summarize()`</span>関数を使って一気に複数の統計量を計算します。</span>
<span id="cb70-190"><a href="#cb70-190"></a>ここでは，<span class="in">`stock_data &lt;- stock_data`</span>としていないため，<span class="in">`stock_data`</span>には新しい変数は追加されず，結果を表示するだけです。</span>
<span id="cb70-191"><a href="#cb70-191"></a></span>
<span id="cb70-192"><a href="#cb70-192"></a><span class="in">```{r ch05_11}</span></span>
<span id="cb70-193"><a href="#cb70-193"></a>stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-194"><a href="#cb70-194"></a>  <span class="fu">summarise</span>(</span>
<span id="cb70-195"><a href="#cb70-195"></a>    <span class="at">var_R =</span> <span class="fu">var</span>(R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 総リターンの分散</span></span>
<span id="cb70-196"><a href="#cb70-196"></a>    <span class="at">sd_R  =</span> <span class="fu">sd</span>(R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 総リターンの標準偏差</span></span>
<span id="cb70-197"><a href="#cb70-197"></a>    <span class="at">var_Re =</span> <span class="fu">var</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 超過リターンの分散</span></span>
<span id="cb70-198"><a href="#cb70-198"></a>    <span class="at">sd_Re =</span> <span class="fu">sd</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># 超過リターンの標準偏差</span></span>
<span id="cb70-199"><a href="#cb70-199"></a>  )</span>
<span id="cb70-200"><a href="#cb70-200"></a><span class="in">```</span></span>
<span id="cb70-201"><a href="#cb70-201"></a></span>
<span id="cb70-202"><a href="#cb70-202"></a>データの分布の形を表す統計量である，3次のモーメントである歪度(skewness)と4次のモーメントである尖度(kurtosis)も計算してみます。</span>
<span id="cb70-203"><a href="#cb70-203"></a>たとえば確率変数$x$の歪度は</span>
<span id="cb70-204"><a href="#cb70-204"></a>$$</span>
<span id="cb70-205"><a href="#cb70-205"></a>\text{歪度} = \frac 1n \sum _{i = 1}^n \left( \frac{x_i - \bar x}{\hat \sigma_x} \right) ^3</span>
<span id="cb70-206"><a href="#cb70-206"></a>$$</span>
<span id="cb70-207"><a href="#cb70-207"></a>で表され，正の値をとるとき分布が右に歪んでいる(裾が右に長い)ことを示している。</span>
<span id="cb70-208"><a href="#cb70-208"></a>尖度は，</span>
<span id="cb70-209"><a href="#cb70-209"></a>$$</span>
<span id="cb70-210"><a href="#cb70-210"></a>\text{尖度} = \frac 1n \sum _{i = 1}^n \left( \frac{x_i - \bar x}{\hat \sigma_x} \right) ^4</span>
<span id="cb70-211"><a href="#cb70-211"></a>$$</span>
<span id="cb70-212"><a href="#cb70-212"></a>で定義され，尖度が3のとき，正規分布と同じ尖度を持つことを示し，3より小さいとき，正規分布よりとがった分布をしていることを示します。</span>
<span id="cb70-213"><a href="#cb70-213"></a></span>
<span id="cb70-214"><a href="#cb70-214"></a>歪度と尖度を計算するには，<span class="in">`e1071`</span>パッケージの<span class="in">`skewness()`</span>関数を使います。</span>
<span id="cb70-215"><a href="#cb70-215"></a><span class="in">```{r ch05_12}</span></span>
<span id="cb70-216"><a href="#cb70-216"></a>stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-217"><a href="#cb70-217"></a>  <span class="fu">summarise</span>(</span>
<span id="cb70-218"><a href="#cb70-218"></a>    <span class="at">skewness_R =</span> <span class="fu">skewness</span>(R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 総リターンの歪度</span></span>
<span id="cb70-219"><a href="#cb70-219"></a>    <span class="at">kurtosis_R =</span> <span class="fu">kurtosis</span>(R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 総リターンの尖度</span></span>
<span id="cb70-220"><a href="#cb70-220"></a>    <span class="at">skewness_Re =</span> <span class="fu">skewness</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 超過リターンの歪度</span></span>
<span id="cb70-221"><a href="#cb70-221"></a>    <span class="at">kurtosis_Re =</span> <span class="fu">kurtosis</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># 超過リターンの尖度</span></span>
<span id="cb70-222"><a href="#cb70-222"></a>  )</span>
<span id="cb70-223"><a href="#cb70-223"></a><span class="in">```</span></span>
<span id="cb70-224"><a href="#cb70-224"></a></span>
<span id="cb70-225"><a href="#cb70-225"></a>トータルリターンの歪度が$0.507 &gt;0$なので，右に裾の広い分布となっており，尖度が$1.27 &lt; 3$なので正規分布よりもとがった形となっていることがわかります。</span>
<span id="cb70-226"><a href="#cb70-226"></a></span>
<span id="cb70-227"><a href="#cb70-227"></a>図でも確認するために，トータルリターン<span class="in">`R`</span>のヒストグラムを書いてみます。</span>
<span id="cb70-228"><a href="#cb70-228"></a></span>
<span id="cb70-229"><a href="#cb70-229"></a><span class="in">```{r ch05_14}</span></span>
<span id="cb70-230"><a href="#cb70-230"></a><span class="fu">ggplot</span>(stock_data) <span class="sc">+</span></span>
<span id="cb70-231"><a href="#cb70-231"></a>  <span class="fu">aes</span>(<span class="at">x =</span> R) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> <span class="co"># トータルリターンのヒストグラム</span></span>
<span id="cb70-232"><a href="#cb70-232"></a>  <span class="fu">xlab</span>(<span class="st">"Monthly Stock Return"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="co"># 軸ラベル</span></span>
<span id="cb70-233"><a href="#cb70-233"></a><span class="in">```</span></span>
<span id="cb70-234"><a href="#cb70-234"></a></span>
<span id="cb70-235"><a href="#cb70-235"></a>トータルリターンのヒストグラムに正規分布のグラフを重ねてみると，次のようになります。</span>
<span id="cb70-238"><a href="#cb70-238"></a><span class="in">```{r}</span></span>
<span id="cb70-239"><a href="#cb70-239"></a><span class="co"># トータルリターン</span></span>
<span id="cb70-240"><a href="#cb70-240"></a>R <span class="ot">&lt;-</span> stock_data<span class="sc">$</span>R</span>
<span id="cb70-241"><a href="#cb70-241"></a></span>
<span id="cb70-242"><a href="#cb70-242"></a><span class="co"># 正規分布データ作成</span></span>
<span id="cb70-243"><a href="#cb70-243"></a>m <span class="ot">&lt;-</span> <span class="fu">mean</span>(stock_data<span class="sc">$</span>R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-244"><a href="#cb70-244"></a>sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(stock_data<span class="sc">$</span>R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-245"><a href="#cb70-245"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">95040</span>, <span class="at">mean =</span> m, <span class="at">sd =</span> sd)</span>
<span id="cb70-246"><a href="#cb70-246"></a></span>
<span id="cb70-247"><a href="#cb70-247"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(R,x) <span class="sc">|&gt;</span> <span class="fu">drop_na</span>() <span class="co"># 欠損値削除</span></span>
<span id="cb70-248"><a href="#cb70-248"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="fu">everything</span>())</span>
<span id="cb70-249"><a href="#cb70-249"></a><span class="in">```</span></span>
<span id="cb70-250"><a href="#cb70-250"></a></span>
<span id="cb70-253"><a href="#cb70-253"></a><span class="in">```{r}</span></span>
<span id="cb70-254"><a href="#cb70-254"></a><span class="co"># トータルリターン</span></span>
<span id="cb70-255"><a href="#cb70-255"></a>R <span class="ot">&lt;-</span> stock_data<span class="sc">$</span>R</span>
<span id="cb70-256"><a href="#cb70-256"></a><span class="co"># 平均と標準偏差を計算</span></span>
<span id="cb70-257"><a href="#cb70-257"></a>m <span class="ot">&lt;-</span> <span class="fu">mean</span>(stock_data<span class="sc">$</span>R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-258"><a href="#cb70-258"></a>s <span class="ot">&lt;-</span> <span class="fu">sd</span>(stock_data<span class="sc">$</span>R, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-259"><a href="#cb70-259"></a></span>
<span id="cb70-260"><a href="#cb70-260"></a><span class="fu">ggplot</span>(stock_data) <span class="sc">+</span></span>
<span id="cb70-261"><a href="#cb70-261"></a>  <span class="fu">aes</span>(<span class="at">x =</span> R) <span class="sc">+</span></span>
<span id="cb70-262"><a href="#cb70-262"></a>  <span class="co"># y軸を密度(density)に設定</span></span>
<span id="cb70-263"><a href="#cb70-263"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb70-264"><a href="#cb70-264"></a>  <span class="co"># 正規分布の曲線を追加</span></span>
<span id="cb70-265"><a href="#cb70-265"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> m, <span class="at">sd =</span> s), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb70-266"><a href="#cb70-266"></a>  <span class="fu">xlab</span>(<span class="st">"Monthly Stock Return"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb70-267"><a href="#cb70-267"></a>  mystyle</span>
<span id="cb70-268"><a href="#cb70-268"></a><span class="in">```</span></span>
<span id="cb70-269"><a href="#cb70-269"></a></span>
<span id="cb70-270"><a href="#cb70-270"></a>トータルリターンと正規分布のヒストグラムを書いてみる。</span>
<span id="cb70-271"><a href="#cb70-271"></a></span>
<span id="cb70-274"><a href="#cb70-274"></a><span class="in">```{r}</span></span>
<span id="cb70-275"><a href="#cb70-275"></a><span class="co"># dev="quartz_pdf"</span></span>
<span id="cb70-276"><a href="#cb70-276"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> name, <span class="at">group =</span> name) <span class="sc">+</span></span>
<span id="cb70-277"><a href="#cb70-277"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">position=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb70-278"><a href="#cb70-278"></a>  <span class="fu">xlab</span>(<span class="st">"Monthly Stock Return"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Count"</span>)</span>
<span id="cb70-279"><a href="#cb70-279"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">annotate</span>( <span class="co"># 位置を指定して文字列を追加</span></span>
<span id="cb70-280"><a href="#cb70-280"></a>  <span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.3</span>, <span class="at">y =</span> <span class="dv">900</span>, <span class="at">label =</span> <span class="st">"fat tail"</span>) <span class="sc">+</span></span>
<span id="cb70-281"><a href="#cb70-281"></a>  <span class="fu">annotate</span>(<span class="co"># 始点や終点などを指定して矢印を追加</span></span>
<span id="cb70-282"><a href="#cb70-282"></a>  <span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">0.3</span>, <span class="at">xend =</span> <span class="fl">0.3</span>,</span>
<span id="cb70-283"><a href="#cb70-283"></a>  <span class="at">y =</span> <span class="dv">800</span>, <span class="at">yend =</span> <span class="dv">300</span>,</span>
<span id="cb70-284"><a href="#cb70-284"></a>  <span class="at">color =</span> <span class="st">"black"</span>,  <span class="at">size =</span> <span class="fl">0.5</span>,</span>
<span id="cb70-285"><a href="#cb70-285"></a>  <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))</span>
<span id="cb70-286"><a href="#cb70-286"></a>  )</span>
<span id="cb70-287"><a href="#cb70-287"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> <span class="fu">annotate</span>( <span class="co"># 位置を指定して文字列を追加</span></span>
<span id="cb70-288"><a href="#cb70-288"></a>  <span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.3</span>, <span class="at">y =</span> <span class="dv">4200</span>,</span>
<span id="cb70-289"><a href="#cb70-289"></a>  <span class="at">label =</span> <span class="st">"Sharp shape"</span></span>
<span id="cb70-290"><a href="#cb70-290"></a>  ) <span class="sc">+</span></span>
<span id="cb70-291"><a href="#cb70-291"></a>  <span class="fu">annotate</span>(<span class="co"># 始点や終点などを指定して矢印を追加</span></span>
<span id="cb70-292"><a href="#cb70-292"></a>  <span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">0.2</span>, <span class="at">xend =</span> <span class="fl">0.1</span>,</span>
<span id="cb70-293"><a href="#cb70-293"></a>  <span class="at">y =</span> <span class="dv">4200</span>, <span class="at">yend =</span> <span class="dv">4200</span>,</span>
<span id="cb70-294"><a href="#cb70-294"></a>  <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.5</span>,</span>
<span id="cb70-295"><a href="#cb70-295"></a>  <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>))</span>
<span id="cb70-296"><a href="#cb70-296"></a>  )</span>
<span id="cb70-297"><a href="#cb70-297"></a>g <span class="ot">&lt;-</span> g <span class="sc">+</span> mystyle</span>
<span id="cb70-298"><a href="#cb70-298"></a><span class="fu">print</span>(g)</span>
<span id="cb70-299"><a href="#cb70-299"></a><span class="in">```</span></span>
<span id="cb70-300"><a href="#cb70-300"></a>歪度と尖度の結果と整合的に、赤色で表されているトータルリターンのヒストグラムは正規分布よりも右に裾が長く，尖度も正規分布よりもとがった形となっています。</span>
<span id="cb70-301"><a href="#cb70-301"></a></span>
<span id="cb70-302"><a href="#cb70-302"></a><span class="fu"># リターンの累積</span></span>
<span id="cb70-303"><a href="#cb70-303"></a></span>
<span id="cb70-304"><a href="#cb70-304"></a><span class="fu">## バイ・アンド・ホールド・リターンの考え方</span></span>
<span id="cb70-305"><a href="#cb70-305"></a></span>
<span id="cb70-306"><a href="#cb70-306"></a>**バイ・アンド・ホールド・リターン**(buy-and-hold-return)は，ある時点で株式を購入し，そのまま保有し続けたときのリターンのことを指します。</span>
<span id="cb70-307"><a href="#cb70-307"></a>たとえば，$12$月末に株式を購入し，$3$月末に売却したときの、バイ・アンド・ホールド・リターンの累積は，次式で計算できます。ただし配当は無視します。</span>
<span id="cb70-308"><a href="#cb70-308"></a>$$</span>
<span id="cb70-309"><a href="#cb70-309"></a>\begin{aligned}</span>
<span id="cb70-310"><a href="#cb70-310"></a>\left ( \frac{W_{\text{3月}}}{W_{\text{12月}}} \right) =</span>
<span id="cb70-311"><a href="#cb70-311"></a>\underbrace{\left ( \frac{W_{\text{1月}}}{W_{\text{12月}}} \right)}_{1 + R_{\text{1月}}} \times</span>
<span id="cb70-312"><a href="#cb70-312"></a>\underbrace{\left ( \frac{W_{\text{2月}}}{W_{\text{1月}}} \right)}_{1 + R_{\text{2月}}} \times</span>
<span id="cb70-313"><a href="#cb70-313"></a>\underbrace{\left ( \frac{W_{\text{3月}}}{W_{\text{2月}}} \right)}_{1 + R_{\text{3月}}} \times</span>
<span id="cb70-314"><a href="#cb70-314"></a>\end{aligned}</span>
<span id="cb70-315"><a href="#cb70-315"></a>$$</span>
<span id="cb70-316"><a href="#cb70-316"></a></span>
<span id="cb70-317"><a href="#cb70-317"></a>一般的に、月次で$t$時点から$T$時点までの年次リターンは、</span>
<span id="cb70-318"><a href="#cb70-318"></a></span>
<span id="cb70-319"><a href="#cb70-319"></a>$$</span>
<span id="cb70-320"><a href="#cb70-320"></a>\left ( \frac{W_{\text{翌年12月末}}}{W_{\text{12月末}}} \right) = \prod_{t = \text{1月}}^{\text{12月}} (1 + R_t)</span>
<span id="cb70-321"><a href="#cb70-321"></a>$$</span>
<span id="cb70-322"><a href="#cb70-322"></a></span>
<span id="cb70-323"><a href="#cb70-323"></a>と計算できます。</span>
<span id="cb70-324"><a href="#cb70-324"></a></span>
<span id="cb70-325"><a href="#cb70-325"></a><span class="fu">## 年次リターンの計算</span></span>
<span id="cb70-326"><a href="#cb70-326"></a></span>
<span id="cb70-327"><a href="#cb70-327"></a>では、<span class="in">`stock_data`</span>をもとに年次リターンを計算してみましょう。</span>
<span id="cb70-328"><a href="#cb70-328"></a></span>
<span id="cb70-329"><a href="#cb70-329"></a></span>
<span id="cb70-330"><a href="#cb70-330"></a><span class="in">```{r ch05_15}</span></span>
<span id="cb70-331"><a href="#cb70-331"></a>annual_stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-332"><a href="#cb70-332"></a>  <span class="fu">group_by</span>(firm_ID, year) <span class="sc">|&gt;</span> <span class="co"># firm_IDとyearごとにグループ化</span></span>
<span id="cb70-333"><a href="#cb70-333"></a>  <span class="fu">summarise</span>(</span>
<span id="cb70-334"><a href="#cb70-334"></a>    <span class="at">annual_R =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> R) <span class="sc">-</span> <span class="dv">1</span>, <span class="co"># B&amp;H年次リターン</span></span>
<span id="cb70-335"><a href="#cb70-335"></a>    <span class="at">annual_R_F =</span> <span class="fu">prod</span>(<span class="dv">1</span> <span class="sc">+</span> R_F) <span class="sc">-</span> <span class="dv">1</span> <span class="co"># 年次超過リターン</span></span>
<span id="cb70-336"><a href="#cb70-336"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb70-337"><a href="#cb70-337"></a>  <span class="fu">mutate</span>(<span class="at">annual_Re =</span> annual_R <span class="sc">-</span> annual_R_F) <span class="sc">|&gt;</span> <span class="co"># 年次超過リターン</span></span>
<span id="cb70-338"><a href="#cb70-338"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb70-339"><a href="#cb70-339"></a><span class="fu">head</span>(annual_stock_data)</span>
<span id="cb70-340"><a href="#cb70-340"></a><span class="in">```</span></span>
<span id="cb70-341"><a href="#cb70-341"></a></span>
<span id="cb70-342"><a href="#cb70-342"></a><span class="fu"># 株式データと財務データを組み合わせた分析</span></span>
<span id="cb70-343"><a href="#cb70-343"></a></span>
<span id="cb70-344"><a href="#cb70-344"></a>ここでは，株式データと財務データを組み合わせて分析を行います。</span>
<span id="cb70-345"><a href="#cb70-345"></a></span>
<span id="cb70-346"><a href="#cb70-346"></a><span class="fu">## データの結合</span></span>
<span id="cb70-347"><a href="#cb70-347"></a></span>
<span id="cb70-348"><a href="#cb70-348"></a>複数のデータフレームを結合する際に重要なところは、</span>
<span id="cb70-349"><a href="#cb70-349"></a></span>
<span id="cb70-350"><a href="#cb70-350"></a><span class="ss">1. </span>データの頻度の違い</span>
<span id="cb70-351"><a href="#cb70-351"></a><span class="ss">2. </span>タイミングの一致</span>
<span id="cb70-352"><a href="#cb70-352"></a></span>
<span id="cb70-353"><a href="#cb70-353"></a>となる。</span>
<span id="cb70-354"><a href="#cb70-354"></a>今まで使ってきた財務データは年次データであるのに対して，株式データは月次データであるため，データの頻度が異なります。</span>
<span id="cb70-355"><a href="#cb70-355"></a>確認してみましょう。</span>
<span id="cb70-356"><a href="#cb70-356"></a></span>
<span id="cb70-357"><a href="#cb70-357"></a></span>
<span id="cb70-358"><a href="#cb70-358"></a><span class="in">```{r ch05_17}</span></span>
<span id="cb70-359"><a href="#cb70-359"></a>financial_data <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"data/ch04_output.csv"</span>)</span>
<span id="cb70-360"><a href="#cb70-360"></a><span class="fu">nrow</span>(financial_data) <span class="co"># 年次財務データの行数</span></span>
<span id="cb70-361"><a href="#cb70-361"></a><span class="fu">nrow</span>(annual_stock_data) <span class="co"># 年次リターン・データの行数</span></span>
<span id="cb70-362"><a href="#cb70-362"></a><span class="fu">nrow</span>(stock_data) <span class="co"># 月次リターン・データの行数</span></span>
<span id="cb70-363"><a href="#cb70-363"></a><span class="in">```</span></span>
<span id="cb70-364"><a href="#cb70-364"></a></span>
<span id="cb70-365"><a href="#cb70-365"></a>月次リターンの行数が上の年次データとは大きく異なっていることが分かります。</span>
<span id="cb70-366"><a href="#cb70-366"></a></span>
<span id="cb70-367"><a href="#cb70-367"></a>::: {.callout .callout-info}</span>
<span id="cb70-368"><a href="#cb70-368"></a>**先読みバイアス**(look-ahead bias)とは、ある時点での情報を使って、その時点よりも未来の情報を使っていることを指します。12月末決算の会社のディスクロジャージャーは、最速で決算日後45日以内に出される決算短信か、3ヶ月以内に出される有価証券報告書があります。</span>
<span id="cb70-369"><a href="#cb70-369"></a>このため、年次データを使って同時期の年次リターンを計算すると、年次データの発表後に出される有価証券報告書の情報を使っていることになります。これを先読みバイアスといいます。</span>
<span id="cb70-370"><a href="#cb70-370"></a>:::</span>
<span id="cb70-371"><a href="#cb70-371"></a></span>
<span id="cb70-372"><a href="#cb70-372"></a></span>
<span id="cb70-373"><a href="#cb70-373"></a><span class="in">```{r ch05_18}</span></span>
<span id="cb70-374"><a href="#cb70-374"></a>annual_data <span class="ot">&lt;-</span> annual_stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-375"><a href="#cb70-375"></a>  <span class="fu">full_join</span>(financial_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"firm_ID"</span>, <span class="st">"year"</span>)) <span class="co"># firm_IDとyearのペアをキーとして設定</span></span>
<span id="cb70-376"><a href="#cb70-376"></a><span class="in">```</span></span>
<span id="cb70-377"><a href="#cb70-377"></a></span>
<span id="cb70-378"><a href="#cb70-378"></a></span>
<span id="cb70-379"><a href="#cb70-379"></a><span class="in">```{r ch05_19}</span></span>
<span id="cb70-380"><a href="#cb70-380"></a>annual_data <span class="ot">&lt;-</span> annual_stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-381"><a href="#cb70-381"></a>  <span class="fu">full_join</span>(financial_data) <span class="co"># キーを省略した場合，列名が同じ変数がキーになる</span></span>
<span id="cb70-382"><a href="#cb70-382"></a><span class="in">```</span></span>
<span id="cb70-383"><a href="#cb70-383"></a></span>
<span id="cb70-384"><a href="#cb70-384"></a><span class="in">```{r ch05_20}</span></span>
<span id="cb70-385"><a href="#cb70-385"></a>monthly_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-386"><a href="#cb70-386"></a>  <span class="fu">full_join</span>(financial_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"firm_ID"</span>, <span class="st">"year"</span>)) <span class="co"># firm_IDとyearのペアをキーとして設定</span></span>
<span id="cb70-387"><a href="#cb70-387"></a><span class="in">```</span></span>
<span id="cb70-388"><a href="#cb70-388"></a></span>
<span id="cb70-389"><a href="#cb70-389"></a></span>
<span id="cb70-390"><a href="#cb70-390"></a><span class="fu">## バブルチャート</span></span>
<span id="cb70-391"><a href="#cb70-391"></a></span>
<span id="cb70-392"><a href="#cb70-392"></a><span class="in">```{r ch05_24}</span></span>
<span id="cb70-393"><a href="#cb70-393"></a>annual_data <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-394"><a href="#cb70-394"></a>  <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">12</span>) <span class="sc">|&gt;</span> <span class="co"># 12月のみ</span></span>
<span id="cb70-395"><a href="#cb70-395"></a>  <span class="fu">select</span>(year, firm_ID, ME) <span class="sc">|&gt;</span> <span class="co"># 変数を選択</span></span>
<span id="cb70-396"><a href="#cb70-396"></a>  <span class="fu">full_join</span>(annual_data, ., <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"firm_ID"</span>)) <span class="sc">|&gt;</span> <span class="co"># 年次データと結合</span></span>
<span id="cb70-397"><a href="#cb70-397"></a>  <span class="fu">mutate</span>(<span class="at">ME =</span> ME <span class="sc">/</span> <span class="fl">1e6</span>)</span>
<span id="cb70-398"><a href="#cb70-398"></a><span class="in">```</span></span>
<span id="cb70-399"><a href="#cb70-399"></a></span>
<span id="cb70-400"><a href="#cb70-400"></a><span class="in">```{r ch05_25}</span></span>
<span id="cb70-401"><a href="#cb70-401"></a>year2015 <span class="ot">&lt;-</span> annual_data <span class="sc">|&gt;</span></span>
<span id="cb70-402"><a href="#cb70-402"></a>   <span class="fu">filter</span>(</span>
<span id="cb70-403"><a href="#cb70-403"></a>      year <span class="sc">==</span> <span class="dv">2015</span>, <span class="co"># 2015年のみ</span></span>
<span id="cb70-404"><a href="#cb70-404"></a>      firm_ID <span class="sc">%in%</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>, <span class="co"># firm_IDが2から20のデータを抽出</span></span>
<span id="cb70-405"><a href="#cb70-405"></a>      X <span class="sc">&gt;</span> <span class="dv">0</span> <span class="co"># 対数を取るため当期純利益が正のデータのみ抽出</span></span>
<span id="cb70-406"><a href="#cb70-406"></a>      )</span>
<span id="cb70-407"><a href="#cb70-407"></a></span>
<span id="cb70-408"><a href="#cb70-408"></a><span class="fu">ggplot</span>(year2015) <span class="sc">+</span></span>
<span id="cb70-409"><a href="#cb70-409"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(sales), <span class="at">y =</span> <span class="fu">log</span>(X), <span class="at">size =</span> ME, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb70-410"><a href="#cb70-410"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="co"># バブルチャートを描くにはsize引数を指定</span></span>
<span id="cb70-411"><a href="#cb70-411"></a>  <span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>), <span class="at">name =</span> <span class="st">"Market Equity"</span>) <span class="sc">+</span> <span class="co"># rangeでバブルの最小最大面積を指定</span></span>
<span id="cb70-412"><a href="#cb70-412"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">14</span>)) <span class="sc">+</span> <span class="co"># 両軸の範囲を指定</span></span>
<span id="cb70-413"><a href="#cb70-413"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">11</span>)) <span class="sc">+</span> mystyle</span>
<span id="cb70-414"><a href="#cb70-414"></a><span class="in">```</span></span>
<span id="cb70-415"><a href="#cb70-415"></a></span>
<span id="cb70-416"><a href="#cb70-416"></a><span class="fu"># 統計的推論入門</span></span>
<span id="cb70-417"><a href="#cb70-417"></a></span>
<span id="cb70-418"><a href="#cb70-418"></a><span class="fu">## リターン・データに関する仮定</span></span>
<span id="cb70-419"><a href="#cb70-419"></a></span>
<span id="cb70-420"><a href="#cb70-420"></a>統計的推論の内容に入る前に、<span class="in">`firm_ID`</span>が1の企業の超過リターン<span class="in">`Re`</span>のデータを眺めてみます。</span>
<span id="cb70-421"><a href="#cb70-421"></a></span>
<span id="cb70-422"><a href="#cb70-422"></a><span class="in">```{r ch05_27}</span></span>
<span id="cb70-423"><a href="#cb70-423"></a>stock_data_1_month <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-424"><a href="#cb70-424"></a>  <span class="fu">filter</span>(firm_ID <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb70-425"><a href="#cb70-425"></a>  <span class="fu">select</span>(month_ID, Re, R)</span>
<span id="cb70-426"><a href="#cb70-426"></a><span class="fu">ggplot</span>(stock_data_1_month) <span class="sc">+</span></span>
<span id="cb70-427"><a href="#cb70-427"></a>  <span class="fu">aes</span>(<span class="at">x =</span> month_ID, <span class="at">y =</span> Re) <span class="sc">+</span> <span class="co"># 軸の設定</span></span>
<span id="cb70-428"><a href="#cb70-428"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> mystyle <span class="co"># 折れ線グラフ</span></span>
<span id="cb70-429"><a href="#cb70-429"></a><span class="in">```</span></span>
<span id="cb70-430"><a href="#cb70-430"></a></span>
<span id="cb70-431"><a href="#cb70-431"></a>このようなデータは時系列データと呼ばれ、ある個体(ここでは<span class="in">`firm_ID`</span>が1の企業)の一定期間にわたって観測したデータのことを指します。</span>
<span id="cb70-432"><a href="#cb70-432"></a></span>
<span id="cb70-433"><a href="#cb70-433"></a>::: {.callout-important title="仮定"}</span>
<span id="cb70-434"><a href="#cb70-434"></a>月次超過リターンの時系列データは、何らかの確率分布(モデル)から独立に生成されている。</span>
<span id="cb70-435"><a href="#cb70-435"></a>:::</span>
<span id="cb70-436"><a href="#cb70-436"></a></span>
<span id="cb70-437"><a href="#cb70-437"></a><span class="ss">1. </span>株価そのものでは無く変化率であるリターンをモデル化する理由</span>
<span id="cb70-438"><a href="#cb70-438"></a></span>
<span id="cb70-439"><a href="#cb70-439"></a>株価それ自体は株式分割などの要因でも変化するし、会社の成長に応じて上昇するため、その成長率をモデル化する方が、投資のリスクに対するリターンをより明確に評価することができるからである。</span>
<span id="cb70-440"><a href="#cb70-440"></a></span>
<span id="cb70-441"><a href="#cb70-441"></a><span class="ss">2. </span>月次リターンではなく月次超過リターンをモデルかする理由</span>
<span id="cb70-442"><a href="#cb70-442"></a></span>
<span id="cb70-443"><a href="#cb70-443"></a>投資リスクを取って得られる追加的なリターンであるリスクプレミアムを明確に評価するために、無リスク金利を差し引いた超過リターンをモデル化します。</span>
<span id="cb70-444"><a href="#cb70-444"></a></span>
<span id="cb70-445"><a href="#cb70-445"></a><span class="ss">3. </span>月次超過リターンが独立であるとする理由</span>
<span id="cb70-446"><a href="#cb70-446"></a></span>
<span id="cb70-447"><a href="#cb70-447"></a>半強度の効率的市場であれば、過去の情報はすでに株価に織り込まれているので、過去の超過リターンは将来の超過リターンと無関係である、とし、超過リターンに系列相関はない、と仮定します。</span>
<span id="cb70-448"><a href="#cb70-448"></a>しかし、アノマリーの存在などにより、現実には系列相関があると考えられますが、モデルが複雑になるので、ここでは独立の仮定をおいて、モデルを単純化します。</span>
<span id="cb70-449"><a href="#cb70-449"></a></span>
<span id="cb70-450"><a href="#cb70-450"></a><span class="ss">4. </span>月次超過リターンが正規分布に従うとする理由</span>
<span id="cb70-451"><a href="#cb70-451"></a></span>
<span id="cb70-452"><a href="#cb70-452"></a>正規分布を仮定するといろいろ計算が楽になる、という理由とともに、</span>
<span id="cb70-453"><a href="#cb70-453"></a>株価の動きは多くの独立した事象の結果であると考えられ、中心極限定理により、超過リターンは正規分布に従うと考えられます。</span>
<span id="cb70-454"><a href="#cb70-454"></a></span>
<span id="cb70-455"><a href="#cb70-455"></a>これらの仮定を受け入れると、超過リターンの確率分布は次式で表されます。</span>
<span id="cb70-456"><a href="#cb70-456"></a></span>
<span id="cb70-457"><a href="#cb70-457"></a>$$</span>
<span id="cb70-458"><a href="#cb70-458"></a>Re_t \sim N(\mu, \sigma^2)</span>
<span id="cb70-459"><a href="#cb70-459"></a>$$</span>
<span id="cb70-460"><a href="#cb70-460"></a></span>
<span id="cb70-461"><a href="#cb70-461"></a>これにより、母集団分布に対して統計的推論が可能になります。</span>
<span id="cb70-462"><a href="#cb70-462"></a><span class="in">`firm 1`</span>の超過リターンのヒストグラムを書いてみます。</span>
<span id="cb70-463"><a href="#cb70-463"></a></span>
<span id="cb70-466"><a href="#cb70-466"></a><span class="in">```{r}</span></span>
<span id="cb70-467"><a href="#cb70-467"></a><span class="fu">ggplot</span>(stock_data_1_month) <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> Re) <span class="sc">+</span> <span class="co"># データと変数</span></span>
<span id="cb70-468"><a href="#cb70-468"></a>  <span class="fu">geom_histogram</span>()</span>
<span id="cb70-469"><a href="#cb70-469"></a><span class="in">```</span></span>
<span id="cb70-470"><a href="#cb70-470"></a></span>
<span id="cb70-471"><a href="#cb70-471"></a>サンプルサイズが小さいため凸凹しているけれど、もっとサンプルを増やせば、正規分布に近い形をとるはずです。</span>
<span id="cb70-472"><a href="#cb70-472"></a></span>
<span id="cb70-473"><a href="#cb70-473"></a></span>
<span id="cb70-474"><a href="#cb70-474"></a><span class="fu">## 推定量と推定値の違い</span></span>
<span id="cb70-475"><a href="#cb70-475"></a></span>
<span id="cb70-476"><a href="#cb70-476"></a>推定量(estimator)とは、母集団分布の母数(パラメータ)を推定するために使われる統計量のことです。</span>
<span id="cb70-477"><a href="#cb70-477"></a>推定値(estimates)とは、推定量に実際のデータを代入して計算した値のことです。</span>
<span id="cb70-478"><a href="#cb70-478"></a>たとえば母集団分布が正規分布$N(\mu, \sigma^2)$に従うと仮定すると、母数は$\mu$と$\sigma^2$の2つです。この母数を推定するために使われる統計量が、それぞれ標本平均$\bar x$と標本分散$s^2$です。</span>
<span id="cb70-479"><a href="#cb70-479"></a>このときの推定値とは、実際に観察された標本から計算された標本平均$\bar x$と標本分散$s^2$のことを指します。</span>
<span id="cb70-480"><a href="#cb70-480"></a></span>
<span id="cb70-481"><a href="#cb70-481"></a>次の問題を考えます。</span>
<span id="cb70-482"><a href="#cb70-482"></a></span>
<span id="cb70-483"><a href="#cb70-483"></a>::: {.callout-important title="問題"}</span>
<span id="cb70-484"><a href="#cb70-484"></a><span class="in">`firm_ID`</span>が1の銘柄の月次リターン$R_{i,t}^e$は、期待値の意味で、ゼロより大きいのだろうか？</span>
<span id="cb70-485"><a href="#cb70-485"></a>:::</span>
<span id="cb70-486"><a href="#cb70-486"></a></span>
<span id="cb70-487"><a href="#cb70-487"></a>ここで「期待値の意味で」というのは平均的に、と言い換えても問題ないです。</span>
<span id="cb70-488"><a href="#cb70-488"></a>企業1の月次超過リターンの平均は0より大きい、ということは、企業1の月次リターンは平均的に無リスク利子率よりも大きいかどうか、を比べるということです。</span>
<span id="cb70-489"><a href="#cb70-489"></a></span>
<span id="cb70-490"><a href="#cb70-490"></a>この問題を解くために、まずは母集団分布の母数である期待値$\mu$を推定する必要があります。</span>
<span id="cb70-491"><a href="#cb70-491"></a>期待値$\mu$を推定するために使われる推定量は標本平均$\bar x$なので、ここで標本平均を計算します。</span>
<span id="cb70-492"><a href="#cb70-492"></a></span>
<span id="cb70-495"><a href="#cb70-495"></a><span class="in">```{r}</span></span>
<span id="cb70-496"><a href="#cb70-496"></a>stock_data_1_month <span class="sc">|&gt;</span></span>
<span id="cb70-497"><a href="#cb70-497"></a>  <span class="fu">summarise</span>(</span>
<span id="cb70-498"><a href="#cb70-498"></a>    <span class="at">mean_Re =</span> <span class="fu">mean</span>(Re, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-499"><a href="#cb70-499"></a>  )</span>
<span id="cb70-500"><a href="#cb70-500"></a><span class="in">```</span></span>
<span id="cb70-501"><a href="#cb70-501"></a></span>
<span id="cb70-502"><a href="#cb70-502"></a>企業1の平均月次超過リターン<span class="in">`mean_Re`</span>が$0.0291$となりました。</span>
<span id="cb70-503"><a href="#cb70-503"></a>これだけみるとゼロより大きい値ですが、これは母集団から抽出された1つのサンプルの平均ですので、他のサンプルの平均がゼロを超えるかどうかは分かりません。</span>
<span id="cb70-504"><a href="#cb70-504"></a></span>
<span id="cb70-505"><a href="#cb70-505"></a><span class="fu">### 大数の法則</span></span>
<span id="cb70-506"><a href="#cb70-506"></a></span>
<span id="cb70-507"><a href="#cb70-507"></a>母集団から無限個の標本(sample)を抽出して、それぞれの標本平均(sample mean)を計算すると、その標本平均の平均は母集団の期待値$\mu$に一致することが知られています。これを対数の法則(law of large number)といいます。</span>
<span id="cb70-508"><a href="#cb70-508"></a></span>
<span id="cb70-509"><a href="#cb70-509"></a>数式よりも前にシミュレーションで確認してみましょう。</span>
<span id="cb70-510"><a href="#cb70-510"></a>まずは、母集団分布を平均が10、標準偏差が2の正規分布$N(10, 4)$として、母集団から100のデータを抽出して標本を1つ作ります。そしてその標本の平均を計算します。</span>
<span id="cb70-511"><a href="#cb70-511"></a></span>
<span id="cb70-514"><a href="#cb70-514"></a><span class="in">```{r}</span></span>
<span id="cb70-515"><a href="#cb70-515"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># 乱数の種を固定</span></span>
<span id="cb70-516"><a href="#cb70-516"></a>size <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># 標本サイズ</span></span>
<span id="cb70-517"><a href="#cb70-517"></a><span class="co"># 母集団のパラメータの設定</span></span>
<span id="cb70-518"><a href="#cb70-518"></a>mu <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># 平均</span></span>
<span id="cb70-519"><a href="#cb70-519"></a>sigma <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># 標準偏差</span></span>
<span id="cb70-520"><a href="#cb70-520"></a>population <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, mu, sigma) <span class="co"># 母集団からサンプルを抽出</span></span>
<span id="cb70-521"><a href="#cb70-521"></a><span class="fu">mean</span>(population) <span class="co"># 標本平均</span></span>
<span id="cb70-522"><a href="#cb70-522"></a><span class="in">```</span></span>
<span id="cb70-523"><a href="#cb70-523"></a>平均は<span class="in">`r mean(population)`</span>となりました。</span>
<span id="cb70-524"><a href="#cb70-524"></a>母集団の平均10とは異なる数値になっています。</span>
<span id="cb70-525"><a href="#cb70-525"></a>もう一度別の標本でやってみると、</span>
<span id="cb70-526"><a href="#cb70-526"></a></span>
<span id="cb70-529"><a href="#cb70-529"></a><span class="in">```{r}</span></span>
<span id="cb70-530"><a href="#cb70-530"></a>population <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, mu, sigma) <span class="co"># 母集団からサンプルを抽出</span></span>
<span id="cb70-531"><a href="#cb70-531"></a><span class="fu">mean</span>(population) <span class="co"># 標本平均</span></span>
<span id="cb70-532"><a href="#cb70-532"></a><span class="in">```</span></span>
<span id="cb70-533"><a href="#cb70-533"></a></span>
<span id="cb70-534"><a href="#cb70-534"></a>また違う平均が計算されました。</span>
<span id="cb70-535"><a href="#cb70-535"></a>この作業を何度も何度も繰り返し、標本平均をたくさん計算します。</span>
<span id="cb70-536"><a href="#cb70-536"></a>ここでは、100個のデータをもつ標本を100個作って、それぞれの標本平均を計算します。</span>
<span id="cb70-537"><a href="#cb70-537"></a></span>
<span id="cb70-540"><a href="#cb70-540"></a><span class="in">```{r}</span></span>
<span id="cb70-541"><a href="#cb70-541"></a>n_sample <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># サンプル数</span></span>
<span id="cb70-542"><a href="#cb70-542"></a>sample_mean <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_sample) <span class="co"># 標本平均を格納するベクトル</span></span>
<span id="cb70-543"><a href="#cb70-543"></a>sample_sd <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n_sample) <span class="co"># 標本分散を格納するベクトル</span></span>
<span id="cb70-544"><a href="#cb70-544"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sample){</span>
<span id="cb70-545"><a href="#cb70-545"></a>  population <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(size, mu, sigma) <span class="co"># 母集団からサンプルを抽出</span></span>
<span id="cb70-546"><a href="#cb70-546"></a>  sample_mean[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(population) <span class="co"># 標本平均を計算</span></span>
<span id="cb70-547"><a href="#cb70-547"></a>  sample_sd[i] <span class="ot">&lt;-</span> <span class="fu">sd</span>(population)</span>
<span id="cb70-548"><a href="#cb70-548"></a>}</span>
<span id="cb70-549"><a href="#cb70-549"></a><span class="in">```</span></span>
<span id="cb70-550"><a href="#cb70-550"></a></span>
<span id="cb70-551"><a href="#cb70-551"></a>サンプルの平均が100個計算できたので、ヒストグラムを書いてみます。</span>
<span id="cb70-552"><a href="#cb70-552"></a></span>
<span id="cb70-553"><a href="#cb70-553"></a><span class="in">```{r }</span></span>
<span id="cb70-554"><a href="#cb70-554"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> sample_mean) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> mystyle</span>
<span id="cb70-555"><a href="#cb70-555"></a><span class="in">```</span></span>
<span id="cb70-556"><a href="#cb70-556"></a>あまり正規分布のようには見えません。</span>
<span id="cb70-557"><a href="#cb70-557"></a>ではサンプルの平均の平均を計算してみます。</span>
<span id="cb70-558"><a href="#cb70-558"></a></span>
<span id="cb70-561"><a href="#cb70-561"></a><span class="in">```{r}</span></span>
<span id="cb70-562"><a href="#cb70-562"></a><span class="fu">mean</span>(sample_mean) <span class="co"># 標本平均の平均</span></span>
<span id="cb70-563"><a href="#cb70-563"></a><span class="in">```</span></span>
<span id="cb70-564"><a href="#cb70-564"></a></span>
<span id="cb70-565"><a href="#cb70-565"></a>母集団の平均10に近い値になっていることが分かります。もっとサンプルの数を増やしてみます。</span>
<span id="cb70-566"><a href="#cb70-566"></a>データの数が100のサンプルを1,000,000個(100万個)抽出して、それぞれのサンプルの平均値を計算します。</span>
<span id="cb70-567"><a href="#cb70-567"></a></span>
<span id="cb70-570"><a href="#cb70-570"></a><span class="in">```{r}</span></span>
<span id="cb70-571"><a href="#cb70-571"></a>n_sample <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">6</span></span>
<span id="cb70-572"><a href="#cb70-572"></a><span class="co"># 標本平均のシミュレーション</span></span>
<span id="cb70-573"><a href="#cb70-573"></a>sample_mean <span class="ot">&lt;-</span> <span class="fu">replicate</span>(n_sample, <span class="fu">mean</span>(<span class="fu">rnorm</span>(size, mu, sigma)))</span>
<span id="cb70-574"><a href="#cb70-574"></a><span class="co"># 標本標準偏差のシミュレーション（必要な場合）</span></span>
<span id="cb70-575"><a href="#cb70-575"></a>sample_sd <span class="ot">&lt;-</span> <span class="fu">replicate</span>(n_sample, <span class="fu">sd</span>(<span class="fu">rnorm</span>(size, mu, sigma)))</span>
<span id="cb70-576"><a href="#cb70-576"></a><span class="co"># 作図</span></span>
<span id="cb70-577"><a href="#cb70-577"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">aes</span>(<span class="at">x =</span> sample_mean) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> mystyle</span>
<span id="cb70-578"><a href="#cb70-578"></a><span class="in">```</span></span>
<span id="cb70-579"><a href="#cb70-579"></a></span>
<span id="cb70-580"><a href="#cb70-580"></a>ほぼ正規分布のような形をしていることが分かります。ではサンプルの平均の平均を計算してみます。</span>
<span id="cb70-581"><a href="#cb70-581"></a></span>
<span id="cb70-584"><a href="#cb70-584"></a><span class="in">```{r}</span></span>
<span id="cb70-585"><a href="#cb70-585"></a><span class="fu">mean</span>(sample_mean) <span class="co"># 標本平均の平均</span></span>
<span id="cb70-586"><a href="#cb70-586"></a><span class="fu">mean</span>(sample_sd) <span class="co"># 標本分散の平均</span></span>
<span id="cb70-587"><a href="#cb70-587"></a><span class="in">```</span></span>
<span id="cb70-588"><a href="#cb70-588"></a></span>
<span id="cb70-589"><a href="#cb70-589"></a>このように標本の数を無限に大きくしたとき、サンプルの平均の平均は母集団の平均10に一致するし，標本標準偏差は母集団の標準偏差4に一致する，というのが大数の法則です。</span>
<span id="cb70-590"><a href="#cb70-590"></a></span>
<span id="cb70-591"><a href="#cb70-591"></a><span class="fu">## $t$値の計算</span></span>
<span id="cb70-592"><a href="#cb70-592"></a></span>
<span id="cb70-593"><a href="#cb70-593"></a>先ほど計算した<span class="in">`firm_ID`</span>が1の企業の超過リターンの平均値は<span class="in">`r mean(stock_data_1_month$Re)`</span>でした。</span>
<span id="cb70-594"><a href="#cb70-594"></a>これがゼロより大きいかどうかはすぐ分かりますが，この値はたまたま今手元にある1つのサンプルから計算された平均値なので，他の標本ではどうなるか分かりません。</span>
<span id="cb70-595"><a href="#cb70-595"></a>このように推定量にばらつきがある場合には，その推定量の分布を考える必要があります。</span>
<span id="cb70-596"><a href="#cb70-596"></a>ここでは，その分布を**t分布**(t distribution)と仮定して，$t$値(t-value)を計算してみます。</span>
<span id="cb70-597"><a href="#cb70-597"></a>$t$値は次のように定義されます。</span>
<span id="cb70-598"><a href="#cb70-598"></a></span>
<span id="cb70-599"><a href="#cb70-599"></a>$$</span>
<span id="cb70-600"><a href="#cb70-600"></a>t = \frac{\bar{X} - \mu_0}{\sqrt{s^2 / n} } \stackrel{d}{\approx} N(0,1)</span>
<span id="cb70-601"><a href="#cb70-601"></a>$$</span>
<span id="cb70-602"><a href="#cb70-602"></a></span>
<span id="cb70-603"><a href="#cb70-603"></a>ここで，$\bar X$は標本平均，$\mu_0$は帰無仮説(null hypothesis)の値で，ここでは$\mu_0 = 0$とします。$s^2$は標本分散，$n$は標本サイズです。</span>
<span id="cb70-604"><a href="#cb70-604"></a>分子に注目すると，標本平均と帰無仮説の値の差となっており，もし標本平均が0に近いなら，$t$値は0に近い値になります。</span>
<span id="cb70-605"><a href="#cb70-605"></a></span>
<span id="cb70-606"><a href="#cb70-606"></a><span class="in">```{r ch05_29}</span></span>
<span id="cb70-607"><a href="#cb70-607"></a>Re_firm_ID_1 <span class="ot">&lt;-</span> stock_data <span class="sc">|&gt;</span></span>
<span id="cb70-608"><a href="#cb70-608"></a>  <span class="fu">filter</span>(firm_ID <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="co"># firm_IDが1の企業のデータを抽出</span></span>
<span id="cb70-609"><a href="#cb70-609"></a>  <span class="fu">select</span>(Re) <span class="sc">|&gt;</span> <span class="co">#超過リターンのみ選択</span></span>
<span id="cb70-610"><a href="#cb70-610"></a>  <span class="fu">drop_na</span>() <span class="sc">|&gt;</span> <span class="co"># 欠損値を除去</span></span>
<span id="cb70-611"><a href="#cb70-611"></a>  <span class="fu">unlist</span>() <span class="co"># データフレームをベクトルに変換</span></span>
<span id="cb70-612"><a href="#cb70-612"></a></span>
<span id="cb70-613"><a href="#cb70-613"></a>mu0 <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># 帰無仮説の値</span></span>
<span id="cb70-614"><a href="#cb70-614"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(Re_firm_ID_1) <span class="co"># 標本サイズ</span></span>
<span id="cb70-615"><a href="#cb70-615"></a></span>
<span id="cb70-616"><a href="#cb70-616"></a>t_value <span class="ot">&lt;-</span> (<span class="fu">mean</span>(Re_firm_ID_1) <span class="sc">-</span> mu0) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">var</span>(Re_firm_ID_1) <span class="sc">/</span> n) <span class="co"># $t$値の計算</span></span>
<span id="cb70-617"><a href="#cb70-617"></a><span class="fu">print</span>(t_value)</span>
<span id="cb70-618"><a href="#cb70-618"></a><span class="in">```</span></span>
<span id="cb70-619"><a href="#cb70-619"></a></span>
<span id="cb70-620"><a href="#cb70-620"></a></span>
<span id="cb70-621"><a href="#cb70-621"></a><span class="fu">### 統計的検定の考え方</span></span>
<span id="cb70-622"><a href="#cb70-622"></a></span>
<span id="cb70-623"><a href="#cb70-623"></a>あなたがサイコロを投げるゲームをしていて、あるプレイヤーが非常に幸運だと主張しています。彼は6回サイコロを投げて、5回も「6」が出たとします。これはただの偶然なのか、それとも何か他の要因（例えば、サイコロがいかさまであるとか）が関与しているのでしょうか？</span>
<span id="cb70-624"><a href="#cb70-624"></a></span>
<span id="cb70-625"><a href="#cb70-625"></a>この問いに答えるために、我々は**統計的検定**(statistical test)を用いることができます。</span>
<span id="cb70-626"><a href="#cb70-626"></a>まず**帰無仮説**(null hypothesis)を設定します。</span>
<span id="cb70-627"><a href="#cb70-627"></a>この例では、帰無仮説は「サイコロは公正であり、すべての出目が等確率（$1/6$）で出る」とすることが適切です。</span>
<span id="cb70-628"><a href="#cb70-628"></a></span>
<span id="cb70-629"><a href="#cb70-629"></a>次に、この帰無仮説が真(true)である場合に、我々が観察した結果（5回の「6」）がどれほどあり得ないかを計算します。これが$p$値(p value)です。この場合、6回投げて5回「6」が出る確率を計算します。</span>
<span id="cb70-630"><a href="#cb70-630"></a></span>
<span id="cb70-631"><a href="#cb70-631"></a>これを計算すると、$p$値は非常に小さいことが分かり（つまり、この結果は帰無仮説の下ではほぼあり得ない），帰無仮説が棄却されます。</span>
<span id="cb70-632"><a href="#cb70-632"></a>帰無仮説が棄却されるとは，**帰無仮説が正しいと仮定したときに，観測されたデータが得られる確率が小さいことを意味します**。</span>
<span id="cb70-633"><a href="#cb70-633"></a>したがって、我々はこの結果が偶然生じたとは考えにくく、その代わりにサイコロがいかさまである、または何か他の非ランダムな要因が作用している可能性を強く疑うことになります。これが$p$値を用いて統計的検定の考え方です。</span>
<span id="cb70-634"><a href="#cb70-634"></a></span>
<span id="cb70-635"><a href="#cb70-635"></a>$p$値が$0.05$より小さい場合，帰無仮説は棄却され，対立仮説が採択される，というケースが多いです。</span>
<span id="cb70-636"><a href="#cb70-636"></a>この場合，有意水準5%で帰無仮説は棄却されます。</span>
<span id="cb70-637"><a href="#cb70-637"></a>有意水準は，帰無仮説が正しいと仮定したときに，観測されたデータが得られる確率が小さいと判断する基準値です。</span>
<span id="cb70-638"><a href="#cb70-638"></a>有意水準は，5%や1%がよく使われます。</span>
<span id="cb70-639"><a href="#cb70-639"></a></span>
<span id="cb70-640"><a href="#cb70-640"></a>Rでは，<span class="in">`t.test()`</span>関数を使って，$t$値と$p$値を計算することができます。</span>
<span id="cb70-641"><a href="#cb70-641"></a>ここでは，<span class="in">`t.test()`</span>関数を使って，<span class="in">`firm_ID`</span>が1の企業の超過リターンがゼロなのかどうなのか，を検定するために，$t$値と$p$値を計算してみましょう。</span>
<span id="cb70-642"><a href="#cb70-642"></a></span>
<span id="cb70-643"><a href="#cb70-643"></a><span class="in">```{r ch05_30}</span></span>
<span id="cb70-644"><a href="#cb70-644"></a><span class="fu">t.test</span>(Re_firm_ID_1)</span>
<span id="cb70-645"><a href="#cb70-645"></a><span class="in">```</span></span>
<span id="cb70-646"><a href="#cb70-646"></a></span>
<span id="cb70-647"><a href="#cb70-647"></a></span>
<span id="cb70-648"><a href="#cb70-648"></a></span>
<span id="cb70-649"><a href="#cb70-649"></a></span>
<span id="cb70-650"><a href="#cb70-650"></a><span class="fu"># 線形回帰入門</span></span>
<span id="cb70-651"><a href="#cb70-651"></a></span>
<span id="cb70-652"><a href="#cb70-652"></a>年次財務データ<span class="in">`annual_data`</span>を使って線形回帰(linear regression)について学習します。</span>
<span id="cb70-653"><a href="#cb70-653"></a>線形(linear)とは，$X$と$\beta$の積が線形であることを意味します。回帰(regression)とは，$X$と$\beta$の積が$Y$を説明することを意味します。</span>
<span id="cb70-654"><a href="#cb70-654"></a>回帰は，2変数間の間で、一方の変数が他方の変数に対して影響を与えるという関係を想定できる場合に用いられます。</span>
<span id="cb70-655"><a href="#cb70-655"></a>しかし因果関係を直接調べているのではないことに注意しましょう。</span>
<span id="cb70-656"><a href="#cb70-656"></a></span>
<span id="cb70-657"><a href="#cb70-657"></a>影響を与える変数を説明変数(explanatory variable)や独立変数(independent variable)といい、</span>
<span id="cb70-658"><a href="#cb70-658"></a>影響を与えられる変数を目的変数(response variable)や従属変数(dependent variable)といいます。</span>
<span id="cb70-659"><a href="#cb70-659"></a>分野などでどっちを使うのかは異なりますが、ここでは説明変数と目的変数を使います。</span>
<span id="cb70-660"><a href="#cb70-660"></a></span>
<span id="cb70-661"><a href="#cb70-661"></a>線形関係を仮定した関係を式にすると，次のようになります。</span>
<span id="cb70-662"><a href="#cb70-662"></a>$$</span>
<span id="cb70-663"><a href="#cb70-663"></a>Y = \alpha + \beta X</span>
<span id="cb70-664"><a href="#cb70-664"></a>$$</span>
<span id="cb70-665"><a href="#cb70-665"></a>ここで，</span>
<span id="cb70-666"><a href="#cb70-666"></a>$\alpha$は定数項(constant term)と呼ばれ，切片(intercept)とも呼ばれます。</span>
<span id="cb70-667"><a href="#cb70-667"></a>$\beta$は回帰係数(regression coefficient)と呼ばれ，傾き(slope)とも呼ばれます。</span>
<span id="cb70-668"><a href="#cb70-668"></a></span>
<span id="cb70-669"><a href="#cb70-669"></a>実際のデータが上のモデルを満たす、つまりすべてのデータが直線上に並んでいるわけではないのです。</span>
<span id="cb70-670"><a href="#cb70-670"></a>実際のデータとモデルとの間には**ずれ**があることを考慮して、上のモデルを次のように書き換えます。</span>
<span id="cb70-671"><a href="#cb70-671"></a></span>
<span id="cb70-672"><a href="#cb70-672"></a>$$</span>
<span id="cb70-673"><a href="#cb70-673"></a>Y = \alpha + \beta X + u</span>
<span id="cb70-674"><a href="#cb70-674"></a>$$</span>
<span id="cb70-675"><a href="#cb70-675"></a>ここで$u$は誤差項(error term)とか観察不可能項(unobservable term)と呼ばれます。</span>
<span id="cb70-676"><a href="#cb70-676"></a></span>
<span id="cb70-677"><a href="#cb70-677"></a></span>
<span id="cb70-678"><a href="#cb70-678"></a>線形回帰の目的は，$X$と$Y$の関係を表す$\alpha$と$\beta$を推定することです。</span>
<span id="cb70-679"><a href="#cb70-679"></a>推定するために，観測できるデータを使います。</span>
<span id="cb70-680"><a href="#cb70-680"></a>観測できるデータは$X$と$Y$のペアで$(X_i, Y_i)$と表記します。</span>
<span id="cb70-681"><a href="#cb70-681"></a>このペアを**観測値**(observed value)と呼びます。</span>
<span id="cb70-682"><a href="#cb70-682"></a>この観測値は，$X$と$Y$の関係を表す$\alpha$と$\beta$を推定するために使われます。</span>
<span id="cb70-683"><a href="#cb70-683"></a>推定するために使われる$\alpha$と$\beta$を**推定値**(estimated value)と呼びます。</span>
<span id="cb70-684"><a href="#cb70-684"></a>推定値は，$\hat{\alpha}$と$\hat{\beta}$と表記して，観察値と区別します。</span>
<span id="cb70-685"><a href="#cb70-685"></a></span>
<span id="cb70-686"><a href="#cb70-686"></a></span>
<span id="cb70-687"><a href="#cb70-687"></a><span class="fu">## OLS推定</span></span>
<span id="cb70-688"><a href="#cb70-688"></a></span>
<span id="cb70-689"><a href="#cb70-689"></a>推定方法として最も有名なものが**最小二乗法**(ordinary least squares; OLS)です。</span>
<span id="cb70-690"><a href="#cb70-690"></a>最小二乗法では，観測値と推定値の差の二乗の和が最小になるように$\alpha$と$\beta$を推定します。</span>
<span id="cb70-691"><a href="#cb70-691"></a>このとき，観測値と推定値の差を**残差**(residual)と呼びます。</span>
<span id="cb70-692"><a href="#cb70-692"></a>最小二乗法では，残差の二乗の和である**残差平方和**(sum of squared residuals; SSR)が最小になるように$\alpha$と$\beta$を推定します。</span>
<span id="cb70-693"><a href="#cb70-693"></a></span>
<span id="cb70-694"><a href="#cb70-694"></a>$$</span>
<span id="cb70-695"><a href="#cb70-695"></a>\min _{\alpha, \beta} \sum _{i=1}^n (Y_i - \alpha - \beta X_i)^2</span>
<span id="cb70-696"><a href="#cb70-696"></a>$$</span>
<span id="cb70-697"><a href="#cb70-697"></a></span>
<span id="cb70-698"><a href="#cb70-698"></a><span class="in">```{r prep_regression}</span></span>
<span id="cb70-699"><a href="#cb70-699"></a><span class="co"># 線形回帰分析のための事前準備</span></span>
<span id="cb70-700"><a href="#cb70-700"></a><span class="co"># ch05_24ですでにME（時価総額）が結合されていることが前提</span></span>
<span id="cb70-701"><a href="#cb70-701"></a></span>
<span id="cb70-702"><a href="#cb70-702"></a>annual_data <span class="ot">&lt;-</span> annual_data <span class="sc">|&gt;</span></span>
<span id="cb70-703"><a href="#cb70-703"></a>  <span class="fu">arrange</span>(firm_ID, year) <span class="sc">|&gt;</span> <span class="co"># 時系列順に並べ替え（lag計算に必須）</span></span>
<span id="cb70-704"><a href="#cb70-704"></a>  <span class="fu">group_by</span>(firm_ID) <span class="sc">|&gt;</span></span>
<span id="cb70-705"><a href="#cb70-705"></a>  <span class="fu">mutate</span>(</span>
<span id="cb70-706"><a href="#cb70-706"></a>    <span class="at">lag_ME =</span> <span class="fu">lag</span>(ME),</span>
<span id="cb70-707"><a href="#cb70-707"></a>    <span class="at">lagged_BEME =</span> lagged_BE <span class="sc">/</span> lag_ME <span class="co"># ここでBEMEを計算</span></span>
<span id="cb70-708"><a href="#cb70-708"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb70-709"><a href="#cb70-709"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb70-710"><a href="#cb70-710"></a><span class="in">```</span></span>
<span id="cb70-711"><a href="#cb70-711"></a></span>
<span id="cb70-712"><a href="#cb70-712"></a><span class="in">```{r ch05_31}</span></span>
<span id="cb70-713"><a href="#cb70-713"></a>lm_sample_data <span class="ot">&lt;-</span> annual_data <span class="sc">|&gt;</span></span>
<span id="cb70-714"><a href="#cb70-714"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2016</span>, firm_ID <span class="sc">&lt;=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb70-715"><a href="#cb70-715"></a>  <span class="co"># lagged_BEMEは計算済みなので、selectで選ぶだけにする</span></span>
<span id="cb70-716"><a href="#cb70-716"></a>  <span class="fu">select</span>(firm_ID, year, <span class="at">Re =</span> annual_Re, lagged_BEME) <span class="sc">|&gt;</span></span>
<span id="cb70-717"><a href="#cb70-717"></a>  <span class="fu">drop_na</span>() <span class="co"># 欠損値を除去</span></span>
<span id="cb70-718"><a href="#cb70-718"></a></span>
<span id="cb70-719"><a href="#cb70-719"></a><span class="fu">ggplot</span>(lm_sample_data) <span class="sc">+</span></span>
<span id="cb70-720"><a href="#cb70-720"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lagged_BEME, <span class="at">y =</span> Re)) <span class="sc">+</span> <span class="co"># 散布図</span></span>
<span id="cb70-721"><a href="#cb70-721"></a>  <span class="fu">xlab</span>(<span class="st">"簿価時価比率"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"超過リターン"</span>) <span class="sc">+</span> mystyle</span>
<span id="cb70-722"><a href="#cb70-722"></a><span class="in">```</span></span>
<span id="cb70-723"><a href="#cb70-723"></a></span>
<span id="cb70-724"><a href="#cb70-724"></a></span>
<span id="cb70-725"><a href="#cb70-725"></a><span class="in">```{r ch05_32}</span></span>
<span id="cb70-726"><a href="#cb70-726"></a><span class="co"># ch05_32: 簿価時価比率と株式リターンの散布図に回帰直線を追加</span></span>
<span id="cb70-727"><a href="#cb70-727"></a></span>
<span id="cb70-728"><a href="#cb70-728"></a><span class="fu">ggplot</span>(lm_sample_data) <span class="sc">+</span></span>
<span id="cb70-729"><a href="#cb70-729"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> lagged_BEME, <span class="at">y =</span> Re)) <span class="sc">+</span></span>
<span id="cb70-730"><a href="#cb70-730"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">x =</span> lagged_BEME, <span class="at">y =</span> Re), <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="co"># 回帰直線を追加するにはgeom_smooth()関数を用いる</span></span>
<span id="cb70-731"><a href="#cb70-731"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"BE/ME at the End of Year t"</span>, <span class="at">y =</span> <span class="st">"Excess Return for Year t + 1"</span>) <span class="sc">+</span></span>
<span id="cb70-732"><a href="#cb70-732"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb70-733"><a href="#cb70-733"></a><span class="in">```</span></span>
<span id="cb70-734"><a href="#cb70-734"></a></span>
<span id="cb70-735"><a href="#cb70-735"></a></span>
<span id="cb70-736"><a href="#cb70-736"></a><span class="in">```{r ch05_33}</span></span>
<span id="cb70-737"><a href="#cb70-737"></a><span class="co"># ch05_33: lm()関数を用いた線形回帰</span></span>
<span id="cb70-738"><a href="#cb70-738"></a></span>
<span id="cb70-739"><a href="#cb70-739"></a>lm_results <span class="ot">&lt;-</span> <span class="fu">lm</span>(Re <span class="sc">~</span> lagged_BEME, <span class="at">data =</span> lm_sample_data) <span class="co"># 従属変数 ~ 独立変数</span></span>
<span id="cb70-740"><a href="#cb70-740"></a><span class="fu">names</span>(lm_results)</span>
<span id="cb70-741"><a href="#cb70-741"></a><span class="in">```</span></span>
<span id="cb70-742"><a href="#cb70-742"></a></span>
<span id="cb70-743"><a href="#cb70-743"></a></span>
<span id="cb70-744"><a href="#cb70-744"></a><span class="in">```{r ch05_34}</span></span>
<span id="cb70-745"><a href="#cb70-745"></a><span class="fu">print</span>(lm_results<span class="sc">$</span>coefficients)</span>
<span id="cb70-746"><a href="#cb70-746"></a><span class="in">```</span></span>
<span id="cb70-747"><a href="#cb70-747"></a></span>
<span id="cb70-748"><a href="#cb70-748"></a></span>
<span id="cb70-749"><a href="#cb70-749"></a><span class="in">```{r ch05_35}</span></span>
<span id="cb70-750"><a href="#cb70-750"></a><span class="co"># ch05_35: broomパッケージのtidy()関数で係数の推定値に関する結果を確認</span></span>
<span id="cb70-751"><a href="#cb70-751"></a><span class="fu">tidy</span>(lm_results)</span>
<span id="cb70-752"><a href="#cb70-752"></a><span class="in">```</span></span>
<span id="cb70-753"><a href="#cb70-753"></a></span>
<span id="cb70-754"><a href="#cb70-754"></a></span>
<span id="cb70-755"><a href="#cb70-755"></a><span class="in">```{r ch05_36}</span></span>
<span id="cb70-756"><a href="#cb70-756"></a><span class="fu">glance</span>(lm_results)</span>
<span id="cb70-757"><a href="#cb70-757"></a><span class="in">```</span></span>
<span id="cb70-758"><a href="#cb70-758"></a></span>
<span id="cb70-759"><a href="#cb70-759"></a><span class="fu">## 対数回帰モデル</span></span>
<span id="cb70-760"><a href="#cb70-760"></a></span>
<span id="cb70-761"><a href="#cb70-761"></a>独立変数$X$が変化したときの従属変数$Y$への影響は一定(つまり傾きが一定)と仮定してきましたが、</span>
<span id="cb70-762"><a href="#cb70-762"></a>実際には傾きが一定でない場合もあります。</span>
<span id="cb70-763"><a href="#cb70-763"></a>回帰式が非線形であることが想定される場合、対処法として</span>
<span id="cb70-764"><a href="#cb70-764"></a></span>
<span id="cb70-765"><a href="#cb70-765"></a><span class="ss">- </span>多項式回帰(polynomial regression) ：独立変数に$X^2$とか$X^3$を加える</span>
<span id="cb70-766"><a href="#cb70-766"></a><span class="ss">- </span>**対数回帰**(logarithmic regression) ：独立変数や従属変数の対数をとる</span>
<span id="cb70-767"><a href="#cb70-767"></a></span>
<span id="cb70-768"><a href="#cb70-768"></a>たとえば、独立変数を対数変換した場合は、次のようなモデルになる。</span>
<span id="cb70-769"><a href="#cb70-769"></a></span>
<span id="cb70-770"><a href="#cb70-770"></a>$$</span>
<span id="cb70-771"><a href="#cb70-771"></a>Y_i = \beta_0 + \beta_1 \log (X_i) + \varepsilon_i</span>
<span id="cb70-772"><a href="#cb70-772"></a>$$</span>
<span id="cb70-773"><a href="#cb70-773"></a></span>
<span id="cb70-774"><a href="#cb70-774"></a></span>
<span id="cb70-775"><a href="#cb70-775"></a></span>
<span id="cb70-776"><a href="#cb70-776"></a><span class="in">```{r ch05_37, filename="線形・対数モデルによる推定"}</span></span>
<span id="cb70-777"><a href="#cb70-777"></a><span class="fu">tidy</span>(<span class="fu">lm</span>(Re <span class="sc">~</span> <span class="fu">log</span>(lagged_BEME), <span class="at">data =</span> lm_sample_data)) <span class="co"># 右辺のみlog()関数で自然対数を取る</span></span>
<span id="cb70-778"><a href="#cb70-778"></a><span class="in">```</span></span>
<span id="cb70-779"><a href="#cb70-779"></a></span>
<span id="cb70-780"><a href="#cb70-780"></a>作成したデータフレームをcsvファイルとして保存するには，<span class="in">`write_csv()`</span>関数を用います。</span>
<span id="cb70-781"><a href="#cb70-781"></a>前処理が終わった後や新しい変数を作った後に、データを保存しておくと便利です。</span>
<span id="cb70-782"><a href="#cb70-782"></a>6章以降では、以下のデータを継続して使うので、csvファイルとして保存しておきます。</span>
<span id="cb70-783"><a href="#cb70-783"></a></span>
<span id="cb70-784"><a href="#cb70-784"></a><span class="in">```{r ch05_38, filename="データの保存"}</span></span>
<span id="cb70-785"><a href="#cb70-785"></a><span class="fu">write_csv</span>(monthly_data, <span class="st">"data/ch05_output1.csv"</span>)</span>
<span id="cb70-786"><a href="#cb70-786"></a><span class="fu">write_csv</span>(annual_data, <span class="st">"data/ch05_output2.csv"</span>)</span>
<span id="cb70-787"><a href="#cb70-787"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Soichi Matsuura</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link" href="https://so-ichi.com/r.html">
      <i class="bi bi-house" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ma2ura">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/matsuura_rits">
      <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>